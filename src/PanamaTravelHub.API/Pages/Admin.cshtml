@page "/Admin"
@model PanamaTravelHub.API.Pages.AdminModel
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Panel Administrativo ‚Äî ToursPanama</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="stylesheet" href="/css/main.css" />
  <link rel="stylesheet" href="/css/admin.css" />
  <link rel="stylesheet" href="/css/loading.css" />
  <script src="https://cdn.jsdelivr.net/npm/tinymce@6.8.3/tinymce.min.js"></script>
</head>
<body>
  <nav class="nav">
    <div class="nav-inner wrap">
      <div class="brand">
        <div class="mark"></div>
        <span class="brand-text">ToursPanama</span>
      </div>
      <div class="nav-links">
        <a href="/" class="nav-link">Inicio</a>
        <a href="/Admin" class="nav-link active">Admin</a>
        <button class="btn-primary" id="logoutBtn">Cerrar Sesi√≥n</button>
      </div>
    </div>
  </nav>

  <main class="wrap admin-container">
    <div class="admin-header">
      <h1>Panel Administrativo</h1>
      <p>Gestiona tours, reservas, usuarios y contenido</p>
    </div>

    <!-- Tabs -->
      <div class="admin-tabs">
      <button class="admin-tab active" onclick="switchTab('tours', event)">Tours</button>
      <button class="admin-tab" onclick="switchTab('bookings', event)">Reservas</button>
      <button class="admin-tab" onclick="switchTab('users', event)">Usuarios</button>
      <button class="admin-tab" onclick="switchTab('cms', event)">CMS</button>
      <button class="admin-tab" onclick="switchTab('media', event)">Media</button>
      <button class="admin-tab" onclick="switchTab('pages', event)">P√°ginas</button>
      <button class="admin-tab" onclick="switchTab('stats', event)">Estad√≠sticas</button>
      </div>

    <!-- Content -->
    <div id="adminContent">
      <!-- Tours Tab -->
      <div id="tours" class="admin-content active">
        <div class="admin-header">
          <h2>Tours</h2>
          <button class="btn-primary" onclick="showAddTourModal()">+ Nuevo Tour</button>
        </div>
        <div class="admin-card">
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Imagen</th>
                  <th>Nombre</th>
                  <th>Precio</th>
                  <th>Capacidad</th>
                  <th>Disponibles</th>
                  <th>Estado</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody id="toursTableBody">
                <tr>
                  <td colspan="7" style="text-align: center; color: var(--text-muted);">Cargando...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Bookings Tab -->
      <div id="bookings" class="admin-content">
        <div class="admin-header">
          <h2>Reservas</h2>
        </div>
        <div class="admin-card">
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Tour</th>
                  <th>Cliente</th>
                  <th>Email</th>
                  <th>Participantes</th>
                  <th>Total</th>
                  <th>Estado</th>
                  <th>Fecha</th>
                </tr>
              </thead>
              <tbody id="bookingsTableBody">
                <tr>
                  <td colspan="7" style="text-align: center; color: var(--text-muted);">Cargando...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Users Tab -->
      <div id="users" class="admin-content">
        <div class="admin-header">
          <h2>Usuarios</h2>
        </div>
        <div class="admin-card">
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Email</th>
                  <th>Nombre</th>
                  <th>Tel√©fono</th>
                  <th>Roles</th>
                  <th>Estado</th>
                  <th>Reservas</th>
                  <th>√öltimo Login</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody id="usersTableBody">
                <tr>
                  <td colspan="8" style="text-align: center; color: var(--text-muted);">Cargando...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- CMS Tab -->
      <div id="cms" class="admin-content">
        <div class="admin-header">
          <h2>Gesti√≥n de Contenido (CMS)</h2>
        </div>
        <div class="admin-card">
          <p>Cargando contenido...</p>
              </div>
            </div>

      <!-- Media Tab -->
      <div id="media" class="admin-content">
        <div class="admin-header">
          <h2>Media</h2>
        </div>
        <div class="admin-card">
          <p>Cargando media...</p>
        </div>
      </div>

      <!-- Pages Tab -->
      <div id="pages" class="admin-content">
        <div class="admin-header">
          <h2>P√°ginas</h2>
        </div>
        <div class="admin-card">
          <p>Cargando p√°ginas...</p>
        </div>
      </div>

      <!-- Stats Tab -->
      <div id="stats" class="admin-content">
        <div class="admin-header">
          <h2>Estad√≠sticas</h2>
        </div>
        <div class="admin-card">
          <p>Cargando estad√≠sticas...</p>
        </div>
      </div>
    </div>
  </main>

  <script src="/js/loading.js"></script>
  <script src="/js/logger.js"></script>
  <script src="/js/api.js"></script>
  <script>
    // Helper function para formatear precios
    function formatPrice(value, fallbackText = '$0.00') {
      const rawPrice = value ?? null;
      let price = Number(rawPrice ?? 0);
      
      if (typeof price !== 'number' || isNaN(price) || !isFinite(price)) {
        console.warn('‚ö†Ô∏è [formatPrice] Precio inv√°lido, usando 0:', { value, rawPrice, price });
        price = 0;
      }
      
      const formattedPrice = price.toFixed(2);
      return price > 0 ? `$${formattedPrice}` : fallbackText;
    }

    let currentTourId = null;
    let tourImages = [];

    // Switch tabs
    function switchTab(tabName, e) {
      const clickedTab = e ? e.target : (window.event ? window.event.target : null);
      document.querySelectorAll('.admin-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      if (clickedTab) {
        clickedTab.classList.add('active');
      }

      document.querySelectorAll('.admin-content').forEach(content => {
        content.classList.remove('active');
      });
      document.getElementById(tabName).classList.add('active');

      // Load tab data
      if (tabName === 'tours') loadTours();
      if (tabName === 'bookings') loadBookings();
      if (tabName === 'users') loadUsers();
      if (tabName === 'cms') loadHomePageContent();
      if (tabName === 'media') loadMediaFiles();
      if (tabName === 'pages') loadPages();
      if (tabName === 'stats') loadStats();
    }

    // Load Users
    async function loadUsers() {
      try {
        const users = await api.getAdminUsers();
        const tbody = document.getElementById('usersTableBody');
        
        if (!users || users.length === 0) {
          tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: var(--text-muted);">No hay usuarios disponibles</td></tr>';
          return;
        }

        tbody.innerHTML = users.map(user => {
          const rolesBadges = user.roles.map(role => 
            `<span class="badge ${role === 'Admin' ? 'active' : 'inactive'}" style="margin-right: 4px;">${role}</span>`
          ).join('');
          
          const isLocked = user.lockedUntil && new Date(user.lockedUntil) > new Date();
          const statusBadge = user.isActive 
            ? `<span class="badge active">Activo</span>`
            : `<span class="badge inactive">Inactivo</span>`;
          
          const lockedBadge = isLocked 
            ? `<span class="badge" style="background: #ef4444; margin-left: 4px;">Bloqueado</span>`
            : '';

          return `
            <tr>
              <td>${user.email}</td>
              <td>${user.firstName} ${user.lastName}</td>
              <td>${user.phone || '‚Äî'}</td>
              <td>${rolesBadges}</td>
              <td>${statusBadge}${lockedBadge}</td>
              <td>${user.totalBookings}</td>
              <td>${user.lastLoginAt ? new Date(user.lastLoginAt).toLocaleDateString('es-PA') : 'Nunca'}</td>
              <td>
                <div class="action-buttons">
                  <button class="btn-sm btn-primary" onclick="viewUser('${user.id}')">Ver</button>
                  <button class="btn-sm btn-secondary" onclick="editUser('${user.id}')">Editar</button>
                  ${isLocked ? `<button class="btn-sm" style="background: #10b981;" onclick="unlockUser('${user.id}')">Desbloquear</button>` : ''}
                </div>
              </td>
            </tr>
          `;
        }).join('');
      } catch (error) {
        console.error('Error loading users:', error);
        document.getElementById('usersTableBody').innerHTML = 
          '<tr><td colspan="8" style="text-align: center; color: var(--error);">Error al cargar usuarios</td></tr>';
      }
    }

    // Load Tours
    async function loadTours() {
      const tbody = document.getElementById('toursTableBody');
      const loaderId = loadingManager.showInline(tbody, 'Cargando tours...');
      
      try {
        const tours = await api.getAdminTours();
        loadingManager.hideInline(tbody);
        
        if (!tours || tours.length === 0) {
          tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--text-muted);">No hay tours disponibles</td></tr>';
          return;
        }

        tbody.innerHTML = tours.map(tour => `
          <tr>
            <td>
              ${tour.imageUrl ? `<img src="${tour.imageUrl}" class="tour-image-preview" alt="${tour.name}" />` : '‚Äî'}
            </td>
            <td>${tour.name}</td>
            <td>${formatPrice(tour.price ?? tour.Price)}</td>
            <td>${tour.maxCapacity}</td>
            <td>${tour.availableSpots}</td>
            <td>
              <span class="badge ${tour.isActive ? 'active' : 'inactive'}">
                ${tour.isActive ? 'Activo' : 'Inactivo'}
              </span>
            </td>
            <td>
              <div class="action-buttons">
                <button class="btn-sm btn-primary" onclick="editTour('${tour.id}')">Editar</button>
                <button class="btn-sm" style="background: var(--primary-light);" onclick="manageTourDates('${tour.id}')">Fechas</button>
                <button class="btn-sm btn-secondary" onclick="deleteTour('${tour.id}')">Eliminar</button>
              </div>
            </td>
          </tr>
        `).join('');
      } catch (error) {
        console.error('Error loading tours:', error);
        loadingManager.hideInline(tbody);
        document.getElementById('toursTableBody').innerHTML = 
          '<tr><td colspan="7" style="text-align: center; color: var(--error);">Error al cargar tours</td></tr>';
      }
    }

    // Load Bookings
    async function loadBookings() {
      try {
        const bookings = await api.getAdminBookings();
        const tbody = document.getElementById('bookingsTableBody');
        
        if (!bookings || bookings.length === 0) {
          tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--text-muted);">No hay reservas disponibles</td></tr>';
          return;
        }

        tbody.innerHTML = bookings.map(booking => `
          <tr>
            <td>${booking.tourName || 'N/A'}</td>
            <td>${booking.userName || 'N/A'}</td>
            <td>${booking.userEmail || 'N/A'}</td>
            <td>${booking.numberOfParticipants}</td>
            <td>${formatPrice(booking.totalAmount)}</td>
            <td>
              <span class="badge ${booking.status === 'Confirmed' ? 'active' : 'inactive'}">
                ${booking.status}
              </span>
            </td>
            <td>${new Date(booking.createdAt).toLocaleDateString('es-PA')}</td>
          </tr>
        `).join('');
      } catch (error) {
        console.error('Error loading bookings:', error);
        document.getElementById('bookingsTableBody').innerHTML = 
          '<tr><td colspan="7" style="text-align: center; color: var(--error);">Error al cargar reservas</td></tr>';
      }
    }

    // Load Stats
    async function loadStats() {
      try {
        const stats = await api.getAdminStats();
        const content = document.getElementById('stats');
        content.innerHTML = `
          <div class="stats-grid">
            <div class="stat-card">
              <h3>${stats.totalTours}</h3>
              <p>Tours Totales</p>
            </div>
            <div class="stat-card">
              <h3>${stats.totalBookings}</h3>
              <p>Reservas Totales</p>
            </div>
            <div class="stat-card">
              <h3>${formatPrice(stats.totalRevenue)}</h3>
              <p>Ingresos Totales</p>
            </div>
            <div class="stat-card">
              <h3>${stats.totalUsers}</h3>
              <p>Usuarios</p>
            </div>
          </div>
        `;
      } catch (error) {
        console.error('Error loading stats:', error);
        document.getElementById('stats').innerHTML = 
          '<p style="color: var(--error);">Error al cargar estad√≠sticas</p>';
      }
    }

    // Tour Functions
    function showAddTourModal() {
      // Inicializar array de im√°genes vac√≠o
      tourImages = [];
      const modal = document.createElement('div');
      modal.className = 'modal active';
      modal.innerHTML = `
        <div class="modal-content" style="max-width: 800px;">
          <div class="modal-header">
            <h3>Nuevo Tour</h3>
            <button class="modal-close" onclick="closeTourModal()">√ó</button>
          </div>
          <form id="tourForm" onsubmit="saveTour(event)">
            <div class="form-grid">
              <div class="form-group">
                <label>Nombre *</label>
                <input type="text" id="tourName" class="form-input" required />
        </div>
              <div class="form-group">
                <label>Precio *</label>
                <input type="number" id="tourPrice" class="form-input" step="0.01" min="0" required />
        </div>
              <div class="form-group">
                <label>Capacidad M√°xima *</label>
                <input type="number" id="tourMaxCapacity" class="form-input" min="1" required />
              </div>
              <div class="form-group">
                <label>Duraci√≥n (horas) *</label>
                <input type="number" id="tourDurationHours" class="form-input" min="1" required />
              </div>
              <div class="form-group">
                <label>Ubicaci√≥n</label>
                <input type="text" id="tourLocation" class="form-input" />
              </div>
              <div class="form-group full-width">
                <label>Descripci√≥n *</label>
                <textarea id="tourDescription" class="form-input" rows="5" required></textarea>
              </div>
              <div class="form-group full-width">
                <label>Itinerario</label>
                <textarea id="tourItinerary" class="form-input" rows="5"></textarea>
              </div>
              <div class="form-group full-width">
                <label>Im√°genes del Tour (m√°ximo 5)</label>
                <div id="tourImagesContainer" style="margin-bottom: var(--spacing-md);">
                  <div class="tour-images-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: var(--spacing-md);">
                    <!-- Las im√°genes se agregar√°n aqu√≠ din√°micamente -->
                  </div>
                </div>
                <div style="display: flex; gap: 8px; align-items: center;">
                  <input type="file" id="tourImageFileInput" accept="image/*" multiple style="display: none;" onchange="handleTourImageFiles(event)" />
                  <button type="button" class="btn-sm btn-primary" onclick="document.getElementById('tourImageFileInput').click()">üì§ Subir Im√°genes</button>
                  <button type="button" class="btn-sm btn-secondary" onclick="showTourImageSelectionModal()">üìÅ Seleccionar de Media</button>
                  <span id="tourImageCount" style="color: var(--text-muted); font-size: 0.875rem;">0/5 im√°genes</span>
                </div>
                <small style="color: var(--text-muted); margin-top: 4px; display: block;">Puedes subir m√∫ltiples im√°genes a la vez. La primera imagen ser√° la imagen principal.</small>
                <textarea id="tourImages" class="form-input" style="display: none;" rows="1"></textarea>
              </div>
              <div class="form-group">
                <label>
                  <input type="checkbox" id="tourIsActive" checked /> Activo
                </label>
              </div>
            </div>
            <div style="margin-top: var(--spacing-lg); display: flex; gap: var(--spacing-md);">
              <button type="submit" class="btn-primary">Guardar</button>
              <button type="button" class="btn-secondary" onclick="closeTourModal()">Cancelar</button>
            </div>
          </form>
        </div>
      `;
      document.body.appendChild(modal);
      document.getElementById('tourForm').dataset.mode = 'create';
      // Inicializar display de im√°genes
      setTimeout(() => updateTourImagesDisplay(), 100);
    }
    
    function updateTourImagesDisplay() {
      const container = document.querySelector('#tourImagesContainer .tour-images-grid');
      if (!container) return;
      
      container.innerHTML = tourImages.map((imgUrl, index) => `
        <div class="tour-image-item" data-image-url="${imgUrl}" style="position: relative;">
          <img src="${imgUrl}" alt="Tour image ${index + 1}" style="width: 100%; height: 150px; object-fit: cover; border-radius: var(--radius); border: ${index === 0 ? '3px solid var(--primary)' : '1px solid var(--stroke)'};" />
          ${index === 0 ? '<span style="position: absolute; top: 4px; left: 4px; background: var(--primary); color: white; padding: 2px 8px; border-radius: var(--radius-sm); font-size: 0.75rem;">Principal</span>' : ''}
          <button type="button" class="image-remove-btn" onclick="removeTourImage('${imgUrl}')" title="Eliminar">√ó</button>
          ${index !== 0 ? `<button type="button" class="btn-sm" style="position: absolute; bottom: 4px; left: 4px; background: var(--primary); color: white; border: none; padding: 4px 8px; border-radius: var(--radius-sm); font-size: 0.75rem; cursor: pointer;" onclick="setPrimaryTourImage('${imgUrl}')">Establecer como principal</button>` : ''}
        </div>
      `).join('');
      
      // Actualizar textarea oculto
      document.getElementById('tourImages').value = tourImages.join('\n');
      
      // Actualizar contador
      const countElement = document.getElementById('tourImageCount');
      if (countElement) {
        countElement.textContent = `${tourImages.length}/5 im√°genes`;
      }
    }
    
    async function handleTourImageFiles(event) {
      const files = Array.from(event.target.files);
      if (files.length === 0) return;
      
      if (tourImages.length + files.length > 5) {
        alert('‚ùå Solo puedes tener m√°ximo 5 im√°genes. Ya tienes ' + tourImages.length + ' im√°genes.');
        event.target.value = '';
        return;
      }
      
      try {
        // Subir todas las im√°genes
        const uploadPromises = files.map(file => api.uploadTourImage(file));
        const results = await Promise.all(uploadPromises);
        
        // Agregar URLs a la lista
        results.forEach(result => {
          if (!tourImages.includes(result.url)) {
            tourImages.push(result.url);
          }
        });
        
        updateTourImagesDisplay();
        alert(`‚úÖ ${results.length} imagen(es) subida(s) exitosamente`);
      } catch (error) {
        console.error('Error uploading images:', error);
        alert('‚ùå Error al subir las im√°genes: ' + (error.message || 'Error desconocido'));
      }
      
      // Limpiar input
      event.target.value = '';
    }
    
    function removeTourImage(imageUrl) {
      if (confirm('¬øEst√°s seguro de eliminar esta imagen?')) {
        tourImages = tourImages.filter(url => url !== imageUrl);
        updateTourImagesDisplay();
      }
    }
    
    function setPrimaryTourImage(imageUrl) {
      tourImages = tourImages.filter(url => url !== imageUrl);
      tourImages.unshift(imageUrl);
      updateTourImagesDisplay();
    }
    
    async function showTourImageSelectionModal() {
      try {
        const mediaFiles = await api.getAdminMedia(null, true, 1, 50);
        
        if (mediaFiles.length === 0) {
          alert('No hay im√°genes en la biblioteca de medios. Por favor, sube una imagen primero en la pesta√±a Media.');
          return;
        }
        
        const modal = document.createElement('div');
        modal.className = 'modal active';
        modal.innerHTML = `
          <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
              <h3>Seleccionar Im√°genes para el Tour</h3>
              <button class="modal-close" onclick="this.closest('.modal').remove()">√ó</button>
            </div>
            <div class="media-selection-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 16px; max-height: 60vh; overflow-y: auto; padding: 16px;">
              ${mediaFiles.map(file => `
                <div class="media-selection-item" style="border: 2px solid ${tourImages.includes(file.fileUrl) ? 'var(--primary)' : 'var(--stroke)'}; border-radius: var(--radius); overflow: hidden; cursor: pointer; transition: all 0.2s; position: relative;" 
                     onmouseover="this.style.borderColor='var(--primary)'" 
                     onmouseout="this.style.borderColor='${tourImages.includes(file.fileUrl) ? 'var(--primary)' : 'var(--stroke)'}'"
                     onclick="selectTourImageFromLibrary('${file.fileUrl}')">
                  ${tourImages.includes(file.fileUrl) ? '<span style="position: absolute; top: 4px; right: 4px; background: var(--primary); color: white; padding: 2px 6px; border-radius: var(--radius-sm); font-size: 0.75rem; z-index: 1;">‚úì</span>' : ''}
                  <img src="${file.fileUrl}" alt="${file.fileName}" style="width: 100%; height: 150px; object-fit: cover;" />
                  <div style="padding: 8px; font-size: 0.875rem; color: var(--text-muted);">${file.fileName}</div>
                </div>
              `).join('')}
            </div>
            <div style="padding: 16px; border-top: 1px solid var(--stroke);">
              <button type="button" class="btn-primary" onclick="document.querySelector('.modal').remove()">Cerrar</button>
            </div>
          </div>
        `;
        document.body.appendChild(modal);
      } catch (error) {
        console.error('Error loading media files:', error);
        alert('‚ùå Error al cargar la biblioteca de medios');
      }
    }
    
    function selectTourImageFromLibrary(imageUrl) {
      if (tourImages.length >= 5) {
        alert('‚ùå Solo puedes tener m√°ximo 5 im√°genes. Elimina una imagen primero.');
        return;
      }
      
      if (!tourImages.includes(imageUrl)) {
        tourImages.push(imageUrl);
        updateTourImagesDisplay();
      }
    }

    async function editTour(id) {
      try {
        const tour = await api.getAdminTour(id);
        currentTourId = id;
        // Inicializar array de im√°genes
        tourImages = tour.images || [];
        const modal = document.createElement('div');
        modal.className = 'modal active';
        modal.innerHTML = `
          <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
              <h3>Editar Tour</h3>
              <button class="modal-close" onclick="closeTourModal()">√ó</button>
              </div>
            <form id="tourForm" onsubmit="saveTour(event)">
              <div class="form-grid">
                <div class="form-group">
                  <label>Nombre *</label>
                  <input type="text" id="tourName" class="form-input" value="${tour.name}" required />
            </div>
                <div class="form-group">
                  <label>Precio *</label>
                  <input type="number" id="tourPrice" class="form-input" step="0.01" min="0" value="${tour.price}" required />
                </div>
                <div class="form-group">
                  <label>Capacidad M√°xima *</label>
                  <input type="number" id="tourMaxCapacity" class="form-input" min="1" value="${tour.maxCapacity}" required />
                </div>
                <div class="form-group">
                  <label>Duraci√≥n (horas) *</label>
                  <input type="number" id="tourDurationHours" class="form-input" min="1" value="${tour.durationHours}" required />
                </div>
                <div class="form-group">
                  <label>Ubicaci√≥n</label>
                  <input type="text" id="tourLocation" class="form-input" value="${tour.location || ''}" />
                </div>
                <div class="form-group full-width">
                  <label>Descripci√≥n *</label>
                  <textarea id="tourDescription" class="form-input" rows="5" required>${tour.description || ''}</textarea>
                </div>
                <div class="form-group full-width">
                  <label>Itinerario</label>
                  <textarea id="tourItinerary" class="form-input" rows="5">${tour.itinerary || ''}</textarea>
                </div>
                <div class="form-group full-width">
                  <label>Im√°genes del Tour (m√°ximo 5)</label>
                  <div id="tourImagesContainer" style="margin-bottom: var(--spacing-md);">
                    <div class="tour-images-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: var(--spacing-md);">
                      ${(tour.images || []).map((imgUrl, index) => `
                        <div class="tour-image-item" data-image-url="${imgUrl}" style="position: relative;">
                          <img src="${imgUrl}" alt="Tour image ${index + 1}" style="width: 100%; height: 150px; object-fit: cover; border-radius: var(--radius); border: ${index === 0 ? '3px solid var(--primary)' : '1px solid var(--stroke)'};" />
                          ${index === 0 ? '<span style="position: absolute; top: 4px; left: 4px; background: var(--primary); color: white; padding: 2px 8px; border-radius: var(--radius-sm); font-size: 0.75rem;">Principal</span>' : ''}
                          <button type="button" class="image-remove-btn" onclick="removeTourImage('${imgUrl}')" title="Eliminar">√ó</button>
                          ${index !== 0 ? `<button type="button" class="btn-sm" style="position: absolute; bottom: 4px; left: 4px; background: var(--primary); color: white; border: none; padding: 4px 8px; border-radius: var(--radius-sm); font-size: 0.75rem; cursor: pointer;" onclick="setPrimaryTourImage('${imgUrl}')">Establecer como principal</button>` : ''}
                        </div>
                      `).join('')}
                    </div>
                  </div>
                  <div style="display: flex; gap: 8px; align-items: center;">
                    <input type="file" id="tourImageFileInput" accept="image/*" multiple style="display: none;" onchange="handleTourImageFiles(event)" />
                    <button type="button" class="btn-sm btn-primary" onclick="document.getElementById('tourImageFileInput').click()">üì§ Subir Im√°genes</button>
                    <button type="button" class="btn-sm btn-secondary" onclick="showTourImageSelectionModal()">üìÅ Seleccionar de Media</button>
                    <span id="tourImageCount" style="color: var(--text-muted); font-size: 0.875rem;">${(tour.images || []).length}/5 im√°genes</span>
                  </div>
                  <small style="color: var(--text-muted); margin-top: 4px; display: block;">Puedes subir m√∫ltiples im√°genes a la vez. La primera imagen ser√° la imagen principal.</small>
                  <textarea id="tourImages" class="form-input" style="display: none;" rows="1">${(tour.images || []).join('\n')}</textarea>
                </div>
                <div class="form-group">
                  <label>
                    <input type="checkbox" id="tourIsActive" ${tour.isActive ? 'checked' : ''} /> Activo
                  </label>
                </div>
              </div>
              <div style="margin-top: var(--spacing-lg); display: flex; gap: var(--spacing-md);">
                <button type="submit" class="btn-primary">Guardar</button>
                <button type="button" class="btn-secondary" onclick="closeTourModal()">Cancelar</button>
              </div>
            </form>
          </div>
        `;
        document.body.appendChild(modal);
        document.getElementById('tourForm').dataset.mode = 'edit';
        document.getElementById('tourForm').dataset.tourId = id;
        // Inicializar display de im√°genes
        setTimeout(() => updateTourImagesDisplay(), 100);
      } catch (error) {
        console.error('Error loading tour:', error);
        alert('‚ùå Error al cargar el tour: ' + (error.message || 'Error desconocido'));
      }
    }

    function closeTourModal() {
      const modal = document.querySelector('.modal');
      if (modal) modal.remove();
      currentTourId = null;
      tourImages = []; // Limpiar im√°genes al cerrar
    }

    async function saveTour(event) {
      event.preventDefault();
      try {
        const form = event.target;
        const mode = form.dataset.mode;
        
        // Obtener im√°genes del array tourImages o del textarea como fallback
        const images = tourImages.length > 0 ? tourImages : 
          (document.getElementById('tourImages').value.split('\n').map(url => url.trim()).filter(url => url));

      const tourData = {
          name: document.getElementById('tourName').value,
          description: document.getElementById('tourDescription').value,
          itinerary: document.getElementById('tourItinerary').value || null,
        price: parseFloat(document.getElementById('tourPrice').value),
        maxCapacity: parseInt(document.getElementById('tourMaxCapacity').value),
        durationHours: parseInt(document.getElementById('tourDurationHours').value),
          location: document.getElementById('tourLocation').value || null,
          isActive: document.getElementById('tourIsActive').checked,
        images: images.length > 0 ? images : null
      };

        if (mode === 'edit') {
          const tourId = form.dataset.tourId;
          await api.updateTour(tourId, tourData);
        } else {
          await api.createTour(tourData);
        }
        
        alert('‚úÖ Tour guardado exitosamente');
        closeTourModal();
        loadTours();
      } catch (error) {
        console.error('Error saving tour:', error);
        alert('‚ùå Error al guardar el tour: ' + (error.message || 'Error desconocido'));
      }
    }

    async function deleteTour(id) {
      if (!confirm('¬øEst√°s seguro de eliminar este tour? Se desactivar√° si tiene reservas activas.')) return;
      try {
        await api.deleteTour(id);
        alert('‚úÖ Tour eliminado/desactivado exitosamente');
        loadTours();
      } catch (error) {
        console.error('Error deleting tour:', error);
        alert('‚ùå Error al eliminar el tour: ' + (error.message || 'Error desconocido'));
      }
    }

    // User Functions
    async function viewUser(id) {
      try {
        const user = await api.getAdminUser(id);
        const modal = document.createElement('div');
        modal.className = 'modal active';
        modal.innerHTML = `
          <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
              <h3>Detalles del Usuario</h3>
              <button class="modal-close" onclick="this.closest('.modal').remove()">√ó</button>
            </div>
            <div class="admin-card">
              <h4>${user.firstName} ${user.lastName}</h4>
              <p><strong>Email:</strong> ${user.email}</p>
              <p><strong>Tel√©fono:</strong> ${user.phone || 'N/A'}</p>
              <p><strong>Roles:</strong> ${user.roles.join(', ')}</p>
              <p><strong>Estado:</strong> ${user.isActive ? 'Activo' : 'Inactivo'}</p>
              <p><strong>Reservas Totales:</strong> ${user.totalBookings || 0}</p>
              <p><strong>√öltimo Login:</strong> ${user.lastLoginAt ? new Date(user.lastLoginAt).toLocaleString('es-PA') : 'Nunca'}</p>
              ${user.lockedUntil && new Date(user.lockedUntil) > new Date() ? 
                `<p><strong>Bloqueado hasta:</strong> ${new Date(user.lockedUntil).toLocaleString('es-PA')}</p>` : ''}
              ${user.bookings && user.bookings.length > 0 ? `
                <h5>Reservas:</h5>
                <ul>
                  ${user.bookings.map(b => `<li>${b.tourName} - ${b.status} - ${formatPrice(b.totalAmount)}</li>`).join('')}
                </ul>
              ` : ''}
            </div>
          </div>
        `;
        document.body.appendChild(modal);
      } catch (error) {
        console.error('Error loading user:', error);
        alert('‚ùå Error al cargar el usuario: ' + (error.message || 'Error desconocido'));
      }
    }

    async function editUser(id) {
      try {
        const user = await api.getAdminUser(id);
        const roles = await api.getAdminRoles();
        
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.innerHTML = `
          <div class="modal-content">
            <div class="modal-header">
              <h3>Editar Usuario</h3>
              <button class="modal-close" onclick="this.closest('.modal').remove()">√ó</button>
            </div>
            <form onsubmit="saveUser(event, '${id}')">
              <div class="form-grid">
                <div class="form-group">
                  <label>Nombre</label>
                  <input type="text" id="userFirstName" class="form-input" value="${user.firstName}" />
                </div>
                <div class="form-group">
                  <label>Apellido</label>
                  <input type="text" id="userLastName" class="form-input" value="${user.lastName}" />
                </div>
                <div class="form-group">
                  <label>Tel√©fono</label>
                  <input type="text" id="userPhone" class="form-input" value="${user.phone || ''}" />
                </div>
                <div class="form-group full-width">
                  <label>Roles</label>
                  ${roles.map(role => `
                    <label style="display: block; margin-bottom: 8px;">
                      <input type="checkbox" name="userRoles" value="${role.name}" 
                        ${user.roles.includes(role.name) ? 'checked' : ''} />
                      ${role.name}
                    </label>
                  `).join('')}
                </div>
                <div class="form-group">
                  <label>
                    <input type="checkbox" id="userIsActive" ${user.isActive ? 'checked' : ''} /> Activo
                  </label>
                </div>
              </div>
              <div style="margin-top: var(--spacing-lg); display: flex; gap: var(--spacing-md);">
                <button type="submit" class="btn-primary">Guardar</button>
                <button type="button" class="btn-secondary" onclick="this.closest('.modal').remove()">Cancelar</button>
              </div>
            </form>
          </div>
        `;
        document.body.appendChild(modal);
      } catch (error) {
        console.error('Error loading user:', error);
        alert('‚ùå Error al cargar el usuario: ' + (error.message || 'Error desconocido'));
      }
    }

    async function saveUser(event, userId) {
      event.preventDefault();
      try {
        const roles = Array.from(document.querySelectorAll('input[name="userRoles"]:checked')).map(cb => cb.value);
        
        const userData = {
          firstName: document.getElementById('userFirstName').value || null,
          lastName: document.getElementById('userLastName').value || null,
          phone: document.getElementById('userPhone').value || null,
          isActive: document.getElementById('userIsActive').checked,
          roles: roles
        };
        
        await api.updateAdminUser(userId, userData);
        alert('‚úÖ Usuario actualizado exitosamente');
        document.querySelector('.modal').remove();
        loadUsers();
      } catch (error) {
        console.error('Error saving user:', error);
        alert('‚ùå Error al guardar el usuario: ' + (error.message || 'Error desconocido'));
      }
    }

    async function unlockUser(id) {
      if (!confirm('¬øEst√°s seguro de desbloquear este usuario?')) return;
      try {
        await api.unlockAdminUser(id);
        alert('‚úÖ Usuario desbloqueado exitosamente');
        loadUsers();
      } catch (error) {
        console.error('Error unlocking user:', error);
        alert('‚ùå Error al desbloquear el usuario: ' + (error.message || 'Error desconocido'));
      }
    }

    // Tour Dates Management
    async function manageTourDates(tourId) {
      try {
        const tour = await api.getAdminTour(tourId);
        const dates = await api.getAdminTourDates(tourId);
        
        const modal = document.createElement('div');
        modal.className = 'modal active';
        modal.innerHTML = `
          <div class="modal-content" style="max-width: 900px;" data-tour-id="${tourId}">
            <div class="modal-header">
              <h3>Gesti√≥n de Fechas - ${tour.name}</h3>
              <button class="modal-close" onclick="closeTourDatesModal()">√ó</button>
            </div>
            <div class="admin-card">
              <div class="admin-header">
                <h4>Fechas del Tour</h4>
                <button class="btn-primary" onclick="showAddTourDateModal('${tourId}')">+ Agregar Fecha</button>
              </div>
              <div class="table-container">
                <table>
                  <thead>
                    <tr>
                      <th>Fecha y Hora</th>
                      <th>Cupos Disponibles</th>
                      <th>Estado</th>
                      <th>Acciones</th>
                    </tr>
                  </thead>
                  <tbody id="tourDatesTableBody">
                    ${dates.length === 0 ? '<tr><td colspan="4" style="text-align: center; color: var(--text-muted);">No hay fechas programadas</td></tr>' : ''}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        `;
        document.body.appendChild(modal);
        
        if (dates.length > 0) {
          const tbody = document.getElementById('tourDatesTableBody');
          tbody.innerHTML = dates.map(date => `
            <tr>
              <td>${new Date(date.tourDateTime).toLocaleString('es-PA')}</td>
              <td>${date.availableSpots}</td>
              <td><span class="badge ${date.isActive ? 'active' : 'inactive'}">${date.isActive ? 'Activa' : 'Inactiva'}</span></td>
              <td>
                <div class="action-buttons">
                  <button class="btn-sm btn-primary" onclick="editTourDate('${date.id}', '${tourId}')">Editar</button>
                  <button class="btn-sm btn-secondary" onclick="deleteTourDateConfirm('${date.id}')">Eliminar</button>
                </div>
              </td>
            </tr>
          `).join('');
        }
      } catch (error) {
        console.error('Error loading tour dates:', error);
        alert('‚ùå Error al cargar las fechas: ' + (error.message || 'Error desconocido'));
      }
    }

    function closeTourDatesModal() {
      const modal = document.querySelector('.modal');
      if (modal) modal.remove();
    }

    function showAddTourDateModal(tourId) {
      const modal = document.createElement('div');
      modal.className = 'modal active';
      modal.innerHTML = `
        <div class="modal-content">
          <div class="modal-header">
            <h3>Agregar Fecha al Tour</h3>
            <button class="modal-close" onclick="this.closest('.modal').remove()">√ó</button>
          </div>
          <form onsubmit="saveTourDate(event, '${tourId}', null)">
            <div class="form-grid">
              <div class="form-group">
                <label>Fecha y Hora *</label>
                <input type="datetime-local" id="tourDateDateTime" class="form-input" required />
              </div>
              <div class="form-group">
                <label>Cupos Disponibles *</label>
                <input type="number" id="tourDateSpots" class="form-input" min="0" required />
              </div>
              <div class="form-group">
                <label>
                  <input type="checkbox" id="tourDateIsActive" checked /> Activa
                </label>
              </div>
            </div>
            <div style="margin-top: var(--spacing-lg); display: flex; gap: var(--spacing-md);">
              <button type="submit" class="btn-primary">Guardar</button>
              <button type="button" class="btn-secondary" onclick="this.closest('.modal').remove()">Cancelar</button>
            </div>
          </form>
        </div>
      `;
      document.body.appendChild(modal);
    }

    async function editTourDate(dateId, tourId) {
      try {
        const dates = await api.getAdminTourDates(tourId);
        const date = dates.find(d => d.id === dateId);
        if (!date) {
          alert('Fecha no encontrada');
          return;
        }
        
        // Convertir fecha a formato datetime-local
        const dateTimeLocal = new Date(date.tourDateTime).toISOString().slice(0, 16);
        
        const modal = document.createElement('div');
        modal.className = 'modal active';
        modal.innerHTML = `
          <div class="modal-content">
            <div class="modal-header">
              <h3>Editar Fecha</h3>
              <button class="modal-close" onclick="this.closest('.modal').remove()">√ó</button>
            </div>
            <form onsubmit="saveTourDate(event, '${tourId}', '${dateId}')">
              <div class="form-grid">
                <div class="form-group">
                  <label>Fecha y Hora *</label>
                  <input type="datetime-local" id="tourDateDateTime" class="form-input" value="${dateTimeLocal}" required />
                </div>
                <div class="form-group">
                  <label>Cupos Disponibles *</label>
                  <input type="number" id="tourDateSpots" class="form-input" min="0" value="${date.availableSpots}" required />
                </div>
                <div class="form-group">
                  <label>
                    <input type="checkbox" id="tourDateIsActive" ${date.isActive ? 'checked' : ''} /> Activa
                  </label>
                </div>
              </div>
              <div style="margin-top: var(--spacing-lg); display: flex; gap: var(--spacing-md);">
                <button type="submit" class="btn-primary">Guardar</button>
                <button type="button" class="btn-secondary" onclick="this.closest('.modal').remove()">Cancelar</button>
              </div>
            </form>
          </div>
        `;
        document.body.appendChild(modal);
      } catch (error) {
        console.error('Error loading tour date:', error);
        alert('‚ùå Error al cargar la fecha: ' + (error.message || 'Error desconocido'));
      }
    }

    async function saveTourDate(event, tourId, dateId) {
      event.preventDefault();
      try {
        const dateTimeInput = document.getElementById('tourDateDateTime').value;
        const dateTime = new Date(dateTimeInput);
        
        const dateData = {
          tourDateTime: dateTime.toISOString(),
          availableSpots: parseInt(document.getElementById('tourDateSpots').value),
          isActive: document.getElementById('tourDateIsActive').checked
        };
        
        if (dateId) {
          await api.updateTourDate(dateId, dateData);
        } else {
          await api.createTourDate(tourId, dateData);
        }
        
        alert('‚úÖ Fecha guardada exitosamente');
        // Cerrar modal de formulario
        document.querySelector('.modal').remove();
        // Recargar modal de fechas si existe, sino cerrar todo
        const datesModal = document.querySelector('.modal-content[data-tour-id]');
        if (datesModal) {
          const modalTourId = datesModal.dataset.tourId;
          if (modalTourId) {
            // Cerrar modal actual y recargar
            document.querySelector('.modal')?.remove();
            manageTourDates(modalTourId);
          }
        } else {
          closeTourDatesModal();
          manageTourDates(tourId);
        }
      } catch (error) {
        console.error('Error saving tour date:', error);
        alert('‚ùå Error al guardar la fecha: ' + (error.message || 'Error desconocido'));
      }
    }

    async function deleteTourDateConfirm(dateId) {
      if (!confirm('¬øEst√°s seguro de eliminar esta fecha? Se desactivar√° si tiene reservas confirmadas.')) return;
      try {
        await api.deleteTourDate(dateId);
        alert('‚úÖ Fecha eliminada/desactivada exitosamente');
        // Recargar modal de fechas
        const modalContent = document.querySelector('.modal-content[data-tour-id]');
        const tourId = modalContent?.dataset.tourId;
        if (tourId) {
          manageTourDates(tourId);
        } else {
          closeTourDatesModal();
          loadTours();
        }
      } catch (error) {
        console.error('Error deleting tour date:', error);
        alert('‚ùå Error al eliminar la fecha: ' + (error.message || 'Error desconocido'));
      }
    }

    async function loadHomePageContent() {
      try {
        const cmsContent = await api.getAdminHomePageContent();
        const contentDiv = document.getElementById('cms');
        
        contentDiv.innerHTML = `
          <div class="admin-card">
            <h2>Contenido de la P√°gina de Inicio</h2>
            <form id="cmsForm" onsubmit="saveHomePageContent(event)">
              
              <!-- Secci√≥n: Im√°genes y Branding -->
              <div class="form-section" style="margin-bottom: var(--spacing-xl);">
                <h3>üñºÔ∏è Im√°genes y Branding</h3>
                <div class="form-grid">
                  <div class="form-group full-width">
                    <label>Logo Principal</label>
                    <div class="image-upload-container">
                      <div class="image-preview-wrapper" id="logoPreviewWrapper">
                        ${cmsContent.logoUrl ? `
                          <img src="${cmsContent.logoUrl}" alt="Logo preview" id="logoPreview" class="image-preview" />
                          <button type="button" class="image-remove-btn" onclick="removeCMSImage('cmsLogoUrl', 'logoPreviewWrapper')" title="Eliminar">√ó</button>
                        ` : `
                          <div class="image-placeholder">
                            <span>Sin imagen</span>
                          </div>
                        `}
                      </div>
                      <div style="display: flex; gap: 8px; margin-top: 8px;">
                        <input type="text" id="cmsLogoUrl" class="form-input" value="${cmsContent.logoUrl || ''}" placeholder="URL de la imagen o sube una nueva" style="flex: 1;" />
                        <input type="file" id="cmsLogoUrlFile" accept="image/*" style="display: none;" onchange="uploadCMSImage('cmsLogoUrlFile', 'cmsLogoUrl', 'logoPreviewWrapper', 'logoPreview')" />
                        <button type="button" class="btn-sm btn-primary" onclick="document.getElementById('cmsLogoUrlFile').click()">üì§ Subir</button>
                        <button type="button" class="btn-sm btn-secondary" onclick="selectMediaForCMS('cmsLogoUrl', 'logoPreviewWrapper', 'logoPreview')">üìÅ Seleccionar</button>
                      </div>
                      <small style="color: var(--text-muted); margin-top: 4px; display: block;">Recomendado: 200x60px, formato PNG con fondo transparente</small>
                    </div>
                  </div>
                  
                  <div class="form-group">
                    <label>Favicon</label>
                    <div class="image-upload-container">
                      <div class="image-preview-wrapper" id="faviconPreviewWrapper" style="width: 64px; height: 64px;">
                        ${cmsContent.faviconUrl ? `
                          <img src="${cmsContent.faviconUrl}" alt="Favicon preview" id="faviconPreview" class="image-preview" />
                          <button type="button" class="image-remove-btn" onclick="removeCMSImage('cmsFaviconUrl', 'faviconPreviewWrapper')" title="Eliminar">√ó</button>
                        ` : `
                          <div class="image-placeholder">
                            <span>16x16</span>
                          </div>
                        `}
                      </div>
                      <div style="display: flex; gap: 8px; margin-top: 8px;">
                        <input type="text" id="cmsFaviconUrl" class="form-input" value="${cmsContent.faviconUrl || ''}" placeholder="URL del favicon" style="flex: 1;" />
                        <input type="file" id="cmsFaviconUrlFile" accept="image/*,.ico" style="display: none;" onchange="uploadCMSImage('cmsFaviconUrlFile', 'cmsFaviconUrl', 'faviconPreviewWrapper', 'faviconPreview')" />
                        <button type="button" class="btn-sm btn-primary" onclick="document.getElementById('cmsFaviconUrlFile').click()">üì§ Subir</button>
                      </div>
                      <small style="color: var(--text-muted); margin-top: 4px; display: block;">Recomendado: 32x32px o 16x16px, formato ICO</small>
                    </div>
                  </div>
                  
                  <div class="form-group">
                    <label>Logo Redes Sociales (Open Graph)</label>
                    <div class="image-upload-container">
                      <div class="image-preview-wrapper" id="socialLogoPreviewWrapper">
                        ${cmsContent.logoUrlSocial ? `
                          <img src="${cmsContent.logoUrlSocial}" alt="Social logo preview" id="socialLogoPreview" class="image-preview" />
                          <button type="button" class="image-remove-btn" onclick="removeCMSImage('cmsLogoUrlSocial', 'socialLogoPreviewWrapper')" title="Eliminar">√ó</button>
                        ` : `
                          <div class="image-placeholder">
                            <span>Sin imagen</span>
                          </div>
                        `}
                      </div>
                      <div style="display: flex; gap: 8px; margin-top: 8px;">
                        <input type="text" id="cmsLogoUrlSocial" class="form-input" value="${cmsContent.logoUrlSocial || ''}" placeholder="URL de la imagen" style="flex: 1;" />
                        <input type="file" id="cmsLogoUrlSocialFile" accept="image/*" style="display: none;" onchange="uploadCMSImage('cmsLogoUrlSocialFile', 'cmsLogoUrlSocial', 'socialLogoPreviewWrapper', 'socialLogoPreview')" />
                        <button type="button" class="btn-sm btn-primary" onclick="document.getElementById('cmsLogoUrlSocialFile').click()">üì§ Subir</button>
                      </div>
                      <small style="color: var(--text-muted); margin-top: 4px; display: block;">Recomendado: 1200x630px para Open Graph</small>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Secci√≥n: Hero Section -->
              <div class="form-section" style="margin-bottom: var(--spacing-xl);">
                <h3>üéØ Hero Section (Banner Principal)</h3>
                <div class="form-grid">
                <div class="form-group full-width">
                  <label>T√≠tulo del Hero</label>
                  <input type="text" id="cmsHeroTitle" class="form-input" value="${cmsContent.heroTitle || ''}" placeholder="T√≠tulo principal" />
                </div>
                <div class="form-group full-width">
                  <label>Subt√≠tulo del Hero</label>
                  <textarea id="cmsHeroSubtitle" class="form-input" rows="3" placeholder="Subt√≠tulo del hero">${cmsContent.heroSubtitle || ''}</textarea>
                </div>
                <div class="form-group">
                  <label>Placeholder de B√∫squeda</label>
                  <input type="text" id="cmsHeroSearchPlaceholder" class="form-input" value="${cmsContent.heroSearchPlaceholder || ''}" placeholder="Buscar tours..." />
                </div>
                <div class="form-group">
                  <label>Texto del Bot√≥n de B√∫squeda</label>
                  <input type="text" id="cmsHeroSearchButton" class="form-input" value="${cmsContent.heroSearchButton || ''}" placeholder="Buscar" />
                </div>
                <div class="form-group full-width">
                  <label>T√≠tulo de la Secci√≥n de Tours</label>
                  <input type="text" id="cmsToursSectionTitle" class="form-input" value="${cmsContent.toursSectionTitle || ''}" placeholder="Nuestros Tours" />
                </div>
                <div class="form-group full-width">
                  <label>Subt√≠tulo de la Secci√≥n de Tours</label>
                  <textarea id="cmsToursSectionSubtitle" class="form-input" rows="2" placeholder="Descubre nuestras ofertas">${cmsContent.toursSectionSubtitle || ''}</textarea>
                </div>
                <div class="form-group">
                  <label>Texto: Cargando Tours</label>
                  <input type="text" id="cmsLoadingToursText" class="form-input" value="${cmsContent.loadingToursText || ''}" placeholder="Cargando tours..." />
                </div>
                <div class="form-group">
                  <label>Texto: Error Cargando Tours</label>
                  <input type="text" id="cmsErrorLoadingToursText" class="form-input" value="${cmsContent.errorLoadingToursText || ''}" placeholder="Error al cargar tours" />
                </div>
                <div class="form-group">
                  <label>Texto: No Hay Tours</label>
                  <input type="text" id="cmsNoToursFoundText" class="form-input" value="${cmsContent.noToursFoundText || ''}" placeholder="No se encontraron tours" />
                </div>
                </div>
              </div>
              
              <!-- Secci√≥n: Navegaci√≥n -->
              <div class="form-section" style="margin-bottom: var(--spacing-xl);">
                <h3>üß≠ Navegaci√≥n</h3>
                <div class="form-grid">
                <div class="form-group">
                  <label>Texto de la Marca en Nav</label>
                  <input type="text" id="cmsNavBrandText" class="form-input" value="${cmsContent.navBrandText || ''}" placeholder="ToursPanama" />
                </div>
                <div class="form-group">
                  <label>Link Nav: Tours</label>
                  <input type="text" id="cmsNavToursLink" class="form-input" value="${cmsContent.navToursLink || ''}" placeholder="Tours" />
                </div>
                <div class="form-group">
                  <label>Link Nav: Reservas</label>
                  <input type="text" id="cmsNavBookingsLink" class="form-input" value="${cmsContent.navBookingsLink || ''}" placeholder="Mis Reservas" />
                </div>
                <div class="form-group">
                  <label>Link Nav: Login</label>
                  <input type="text" id="cmsNavLoginLink" class="form-input" value="${cmsContent.navLoginLink || ''}" placeholder="Iniciar Sesi√≥n" />
                </div>
                <div class="form-group">
                  <label>Bot√≥n Nav: Logout</label>
                  <input type="text" id="cmsNavLogoutButton" class="form-input" value="${cmsContent.navLogoutButton || ''}" placeholder="Cerrar Sesi√≥n" />
                </div>
                </div>
              </div>
              
              <!-- Secci√≥n: Footer -->
              <div class="form-section" style="margin-bottom: var(--spacing-xl);">
                <h3>üìÑ Footer</h3>
                <div class="form-grid">
                <div class="form-group full-width">
                  <label>Texto de la Marca del Footer</label>
                  <input type="text" id="cmsFooterBrandText" class="form-input" value="${cmsContent.footerBrandText || ''}" placeholder="ToursPanama" />
                </div>
                <div class="form-group full-width">
                  <label>Descripci√≥n del Footer</label>
                  <textarea id="cmsFooterDescription" class="form-input" rows="3" placeholder="Descripci√≥n del footer">${cmsContent.footerDescription || ''}</textarea>
                </div>
                <div class="form-group full-width">
                  <label>Copyright del Footer</label>
                  <input type="text" id="cmsFooterCopyright" class="form-input" value="${cmsContent.footerCopyright || ''}" placeholder="¬© 2024 ToursPanama" />
                </div>
                </div>
              </div>
              
              <!-- Secci√≥n: SEO -->
              <div class="form-section" style="margin-bottom: var(--spacing-xl);">
                <h3>üîç SEO (Optimizaci√≥n para Motores de B√∫squeda)</h3>
                <div class="form-grid">
                <div class="form-group full-width">
                  <label>T√≠tulo de la P√°gina (SEO)</label>
                  <input type="text" id="cmsPageTitle" class="form-input" value="${cmsContent.pageTitle || ''}" placeholder="ToursPanama ‚Äî Descubre los Mejores Tours" />
                  <small style="color: var(--text-muted); margin-top: 4px; display: block;">Aparece en la pesta√±a del navegador y en los resultados de b√∫squeda</small>
                </div>
                <div class="form-group full-width">
                  <label>Meta Description (SEO)</label>
                  <textarea id="cmsMetaDescription" class="form-input" rows="2" placeholder="Meta descripci√≥n para SEO">${cmsContent.metaDescription || ''}</textarea>
                  <small style="color: var(--text-muted); margin-top: 4px; display: block;">Descripci√≥n que aparece en los resultados de b√∫squeda (m√°x. 160 caracteres)</small>
                </div>
                </div>
              </div>
              <div style="margin-top: var(--spacing-xl);">
                <button type="submit" class="btn-primary">Guardar Cambios</button>
              </div>
            </form>
          </div>
        `;
      } catch (error) {
        console.error('Error loading CMS content:', error);
        document.getElementById('cms').innerHTML = 
          '<div class="admin-card"><p style="color: var(--error);">Error al cargar el contenido del CMS</p></div>';
      }
    }

    async function saveHomePageContent(event) {
      event.preventDefault();
      try {
        // Funci√≥n helper para convertir string vac√≠o a null
        const toNullIfEmpty = (value) => {
          const trimmed = value?.trim();
          return trimmed === '' ? null : (trimmed || null);
        };
        
        const contentData = {
          // Campos de im√°genes: convertir string vac√≠o a null expl√≠citamente
          logoUrl: toNullIfEmpty(document.getElementById('cmsLogoUrl').value),
          faviconUrl: toNullIfEmpty(document.getElementById('cmsFaviconUrl').value),
          logoUrlSocial: toNullIfEmpty(document.getElementById('cmsLogoUrlSocial').value),
          // Campos de texto: solo enviar si tienen contenido (backend solo actualiza si no est√° vac√≠o)
          heroTitle: toNullIfEmpty(document.getElementById('cmsHeroTitle').value),
          heroSubtitle: toNullIfEmpty(document.getElementById('cmsHeroSubtitle').value),
          heroSearchPlaceholder: toNullIfEmpty(document.getElementById('cmsHeroSearchPlaceholder').value),
          heroSearchButton: toNullIfEmpty(document.getElementById('cmsHeroSearchButton').value),
          toursSectionTitle: toNullIfEmpty(document.getElementById('cmsToursSectionTitle').value),
          toursSectionSubtitle: toNullIfEmpty(document.getElementById('cmsToursSectionSubtitle').value),
          loadingToursText: toNullIfEmpty(document.getElementById('cmsLoadingToursText').value),
          errorLoadingToursText: toNullIfEmpty(document.getElementById('cmsErrorLoadingToursText').value),
          noToursFoundText: toNullIfEmpty(document.getElementById('cmsNoToursFoundText').value),
          footerBrandText: toNullIfEmpty(document.getElementById('cmsFooterBrandText').value),
          footerDescription: toNullIfEmpty(document.getElementById('cmsFooterDescription').value),
          footerCopyright: toNullIfEmpty(document.getElementById('cmsFooterCopyright').value),
          navBrandText: toNullIfEmpty(document.getElementById('cmsNavBrandText').value),
          navToursLink: toNullIfEmpty(document.getElementById('cmsNavToursLink').value),
          navBookingsLink: toNullIfEmpty(document.getElementById('cmsNavBookingsLink').value),
          navLoginLink: toNullIfEmpty(document.getElementById('cmsNavLoginLink').value),
          navLogoutButton: toNullIfEmpty(document.getElementById('cmsNavLogoutButton').value),
          pageTitle: toNullIfEmpty(document.getElementById('cmsPageTitle').value),
          metaDescription: toNullIfEmpty(document.getElementById('cmsMetaDescription').value)
        };
        
        await api.updateAdminHomePageContent(contentData);
        alert('‚úÖ Contenido guardado exitosamente');
        loadHomePageContent(); // Recargar para mostrar datos actualizados
      } catch (error) {
        console.error('Error saving CMS content:', error);
        alert('‚ùå Error al guardar el contenido: ' + (error.message || 'Error desconocido'));
      }
    }

    // Funci√≥n para subir imagen directamente desde CMS
    async function uploadCMSImage(fileInputId, urlInputId, previewWrapperId, previewImgId) {
      const fileInput = document.getElementById(fileInputId);
      const file = fileInput.files[0];
      if (!file) return;
      
      try {
        // Subir usando el endpoint de media
        const result = await api.uploadMediaFile(file, null, null, 'cms');
        
        // Actualizar el input con la URL
        document.getElementById(urlInputId).value = result.fileUrl;
        
        // Actualizar preview
        const previewWrapper = document.getElementById(previewWrapperId);
        if (previewWrapper && previewImgId) {
          previewWrapper.innerHTML = `
            <img src="${result.fileUrl}" alt="Preview" id="${previewImgId}" class="image-preview" />
            <button type="button" class="image-remove-btn" onclick="removeCMSImage('${urlInputId}', '${previewWrapperId}')" title="Eliminar">√ó</button>
          `;
        } else if (previewWrapper) {
          previewWrapper.innerHTML = `
            <img src="${result.fileUrl}" alt="Preview" class="image-preview" />
            <button type="button" class="image-remove-btn" onclick="removeCMSImage('${urlInputId}', '${previewWrapperId}')" title="Eliminar">√ó</button>
          `;
        }
        
        alert('‚úÖ Imagen subida exitosamente');
      } catch (error) {
        console.error('Error uploading CMS image:', error);
        alert('‚ùå Error al subir la imagen: ' + (error.message || 'Error desconocido'));
      }
      
      // Limpiar input file
      fileInput.value = '';
    }
    
    // Funci√≥n para eliminar imagen del CMS
    function removeCMSImage(inputId, previewWrapperId) {
      if (confirm('¬øEst√°s seguro de eliminar esta imagen?')) {
        document.getElementById(inputId).value = '';
        const previewWrapper = document.getElementById(previewWrapperId);
        if (previewWrapper) {
          previewWrapper.innerHTML = `
            <div class="image-placeholder">
              <span>Sin imagen</span>
            </div>
          `;
        }
      }
    }

    // Funci√≥n para seleccionar im√°genes de la media library
    async function selectMediaForCMS(inputId, previewWrapperId, previewImgId) {
      try {
        const mediaFiles = await api.getAdminMedia(null, true, 1, 50); // Solo im√°genes, primera p√°gina
        
        if (mediaFiles.length === 0) {
          alert('No hay im√°genes en la biblioteca de medios. Por favor, sube una imagen primero en la pesta√±a Media.');
          return;
        }
        
        const modal = document.createElement('div');
        modal.className = 'modal active';
        modal.innerHTML = `
          <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
              <h3>Seleccionar Imagen</h3>
              <button class="modal-close" onclick="this.closest('.modal').remove()">√ó</button>
            </div>
            <div class="media-selection-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 16px; max-height: 60vh; overflow-y: auto; padding: 16px;">
              ${mediaFiles.map(file => `
                <div class="media-selection-item" style="border: 2px solid var(--stroke); border-radius: var(--radius); overflow: hidden; cursor: pointer; transition: all 0.2s;" 
                     onmouseover="this.style.borderColor='var(--primary)'" 
                     onmouseout="this.style.borderColor='var(--stroke)'"
                     onclick="selectCMSImageFromLibrary('${file.fileUrl}', '${inputId}', '${previewWrapperId}', '${previewImgId}')">
                  <img src="${file.fileUrl}" alt="${file.fileName}" style="width: 100%; height: 150px; object-fit: cover;" />
                  <div style="padding: 8px; font-size: 0.875rem; color: var(--text-muted);">${file.fileName}</div>
                </div>
              `).join('')}
            </div>
          </div>
        `;
        document.body.appendChild(modal);
      } catch (error) {
        console.error('Error loading media files:', error);
        alert('‚ùå Error al cargar la biblioteca de medios');
      }
    }
    
    // Funci√≥n para seleccionar imagen de la biblioteca
    function selectCMSImageFromLibrary(imageUrl, inputId, previewWrapperId, previewImgId) {
      document.getElementById(inputId).value = imageUrl;
      
      // Actualizar preview
      const previewWrapper = document.getElementById(previewWrapperId);
      if (previewWrapper && previewImgId) {
        previewWrapper.innerHTML = `
          <img src="${imageUrl}" alt="Preview" id="${previewImgId}" class="image-preview" />
          <button type="button" class="image-remove-btn" onclick="removeCMSImage('${inputId}', '${previewWrapperId}')" title="Eliminar">√ó</button>
        `;
      } else if (previewWrapper) {
        previewWrapper.innerHTML = `
          <img src="${imageUrl}" alt="Preview" class="image-preview" />
          <button type="button" class="image-remove-btn" onclick="removeCMSImage('${inputId}', '${previewWrapperId}')" title="Eliminar">√ó</button>
        `;
      }
      
      // Cerrar modal
      document.querySelector('.modal').remove();
    }

    async function loadMediaFiles() {
      try {
        const mediaFiles = await api.getAdminMedia();
        const contentDiv = document.getElementById('media');
        
        contentDiv.innerHTML = `
          <div class="admin-card">
            <div class="admin-header">
              <h2>Biblioteca de Medios</h2>
              <button class="btn-primary" onclick="showUploadMediaModal()">+ Subir Archivo</button>
            </div>
            <div class="media-grid" id="mediaGrid">
              ${mediaFiles.length === 0 ? '<p style="text-align: center; color: var(--text-muted);">No hay archivos de media</p>' : ''}
            </div>
          </div>
        `;
        
        if (mediaFiles.length > 0) {
          const grid = document.getElementById('mediaGrid');
      grid.innerHTML = mediaFiles.map(file => `
            <div class="media-item">
              ${file.isImage ? `<img src="${file.fileUrl}" alt="${file.altText || file.fileName}" />` : 
                `<div class="media-file-icon">üìÑ ${file.fileName}</div>`}
              <div class="media-item-info">
                <div class="media-item-name">${file.fileName}</div>
                <div class="media-item-meta">${(file.fileSize / 1024).toFixed(2)} KB</div>
                ${file.category ? `<div class="media-item-category">${file.category}</div>` : ''}
            </div>
              <div class="media-item-actions">
                <button class="btn-sm btn-primary" onclick="selectMediaFile('${file.fileUrl}')">Seleccionar</button>
                <button class="btn-sm btn-secondary" onclick="deleteMediaFile('${file.id}')">Eliminar</button>
          </div>
        </div>
      `).join('');
    }
      } catch (error) {
        console.error('Error loading media files:', error);
        document.getElementById('media').innerHTML = 
          '<div class="admin-card"><p style="color: var(--error);">Error al cargar archivos de media</p></div>';
      }
    }

    function showUploadMediaModal() {
      const modal = document.createElement('div');
      modal.className = 'modal active';
      modal.innerHTML = `
        <div class="modal-content">
          <div class="modal-header">
            <h3>Subir Archivo</h3>
            <button class="modal-close" onclick="this.closest('.modal').remove()">√ó</button>
          </div>
          <form onsubmit="uploadMediaFile(event)">
            <div class="form-group">
              <label>Archivo</label>
              <input type="file" id="mediaFileInput" class="form-input" required />
            </div>
            <div class="form-group">
              <label>Texto Alternativo (Alt Text)</label>
              <input type="text" id="mediaAltText" class="form-input" placeholder="Descripci√≥n de la imagen" />
            </div>
            <div class="form-group">
              <label>Descripci√≥n</label>
              <textarea id="mediaDescription" class="form-input" rows="3" placeholder="Descripci√≥n del archivo"></textarea>
            </div>
            <div class="form-group">
              <label>Categor√≠a</label>
              <input type="text" id="mediaCategory" class="form-input" placeholder="Tours, General, etc." />
            </div>
            <div style="margin-top: var(--spacing-lg); display: flex; gap: var(--spacing-md);">
              <button type="submit" class="btn-primary">Subir</button>
              <button type="button" class="btn-secondary" onclick="this.closest('.modal').remove()">Cancelar</button>
            </div>
          </form>
        </div>
      `;
      document.body.appendChild(modal);
    }

    async function uploadMediaFile(event) {
      event.preventDefault();
      try {
      const fileInput = document.getElementById('mediaFileInput');
        const file = fileInput.files[0];
      if (!file) {
        alert('Por favor selecciona un archivo');
        return;
      }

        const altText = document.getElementById('mediaAltText').value || null;
        const description = document.getElementById('mediaDescription').value || null;
        const category = document.getElementById('mediaCategory').value || null;
        
        await api.uploadMediaFile(file, altText, description, category);
        alert('‚úÖ Archivo subido exitosamente');
        document.querySelector('.modal').remove();
        loadMediaFiles();
      } catch (error) {
        console.error('Error uploading media file:', error);
        alert('‚ùå Error al subir el archivo: ' + (error.message || 'Error desconocido'));
      }
    }

    function selectMediaFile(url) {
      // Esta funci√≥n puede usarse para seleccionar archivos en otros formularios
      console.log('Archivo seleccionado:', url);
      alert('URL copiada: ' + url);
    }

    async function deleteMediaFile(mediaId) {
      if (!confirm('¬øEst√°s seguro de eliminar este archivo?')) return;
      try {
        await api.deleteMediaFile(mediaId);
        alert('‚úÖ Archivo eliminado exitosamente');
        loadMediaFiles();
      } catch (error) {
        console.error('Error deleting media file:', error);
        alert('‚ùå Error al eliminar el archivo: ' + (error.message || 'Error desconocido'));
      }
    }

    async function loadPages() {
      try {
        const pages = await api.getAdminPages();
        const contentDiv = document.getElementById('pages');
        
        contentDiv.innerHTML = `
          <div class="admin-card">
            <div class="admin-header">
              <h2>Gesti√≥n de P√°ginas</h2>
              <button class="btn-primary" onclick="showAddPageModal()">+ Nueva P√°gina</button>
            </div>
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>T√≠tulo</th>
                    <th>Slug</th>
                    <th>Estado</th>
                    <th>Fecha</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody id="pagesTableBody">
                  ${pages.length === 0 ? '<tr><td colspan="5" style="text-align: center; color: var(--text-muted);">No hay p√°ginas</td></tr>' : ''}
                </tbody>
              </table>
            </div>
          </div>
        `;
        
        if (pages.length > 0) {
      const tbody = document.getElementById('pagesTableBody');
      tbody.innerHTML = pages.map(page => `
        <tr>
              <td>${page.title}</td>
              <td>${page.slug}</td>
          <td><span class="badge ${page.isPublished ? 'active' : 'inactive'}">${page.isPublished ? 'Publicada' : 'Borrador'}</span></td>
              <td>${new Date(page.createdAt).toLocaleDateString('es-PA')}</td>
              <td>
                <div class="action-buttons">
                  <button class="btn-sm btn-primary" onclick="editPage('${page.id}')">Editar</button>
                  <button class="btn-sm btn-secondary" onclick="deletePage('${page.id}')">Eliminar</button>
                </div>
          </td>
        </tr>
      `).join('');
        }
      } catch (error) {
        console.error('Error loading pages:', error);
        document.getElementById('pages').innerHTML = 
          '<div class="admin-card"><p style="color: var(--error);">Error al cargar p√°ginas</p></div>';
      }
    }

    function showAddPageModal() {
      const modal = document.createElement('div');
      modal.className = 'modal active';
      modal.innerHTML = `
        <div class="modal-content" style="max-width: 800px;">
          <div class="modal-header">
            <h3>Nueva P√°gina</h3>
            <button class="modal-close" onclick="closePageModal()">√ó</button>
          </div>
          <form id="pageForm" onsubmit="savePage(event)">
            <div class="form-grid">
              <div class="form-group">
                <label>T√≠tulo *</label>
                <input type="text" id="pageTitle" class="form-input" required />
              </div>
              <div class="form-group">
                <label>Slug *</label>
                <input type="text" id="pageSlug" class="form-input" required />
              </div>
              <div class="form-group full-width">
                <label>Contenido</label>
                <textarea id="pageContent" class="form-input" rows="10"></textarea>
              </div>
              <div class="form-group">
                <label>Resumen (Excerpt)</label>
                <textarea id="pageExcerpt" class="form-input" rows="2"></textarea>
              </div>
              <div class="form-group">
                <label>Meta T√≠tulo (SEO)</label>
                <input type="text" id="pageMetaTitle" class="form-input" />
              </div>
              <div class="form-group">
                <label>Meta Description (SEO)</label>
                <textarea id="pageMetaDescription" class="form-input" rows="2"></textarea>
              </div>
              <div class="form-group">
                <label>
                  <input type="checkbox" id="pageIsPublished" /> Publicada
                </label>
              </div>
            </div>
            <div style="margin-top: var(--spacing-lg); display: flex; gap: var(--spacing-md);">
              <button type="submit" class="btn-primary">Guardar</button>
              <button type="button" class="btn-secondary" onclick="closePageModal()">Cancelar</button>
            </div>
          </form>
        </div>
      `;
      document.body.appendChild(modal);
      document.getElementById('pageForm').dataset.mode = 'create';
    }

    function closePageModal() {
      const modal = document.querySelector('.modal');
      if (modal) modal.remove();
    }

    async function editPage(pageId) {
      try {
        const page = await api.getAdminPage(pageId);
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.innerHTML = `
          <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
              <h3>Editar P√°gina</h3>
              <button class="modal-close" onclick="closePageModal()">√ó</button>
            </div>
            <form id="pageForm" onsubmit="savePage(event)">
              <input type="hidden" id="pageId" value="${page.id}" />
              <div class="form-grid">
                <div class="form-group">
                  <label>T√≠tulo *</label>
                  <input type="text" id="pageTitle" class="form-input" value="${page.title}" required />
                </div>
                <div class="form-group">
                  <label>Slug *</label>
                  <input type="text" id="pageSlug" class="form-input" value="${page.slug}" required />
                </div>
                <div class="form-group full-width">
                  <label>Contenido</label>
                  <textarea id="pageContent" class="form-input" rows="10">${page.content || ''}</textarea>
                </div>
                <div class="form-group">
                  <label>Resumen (Excerpt)</label>
                  <textarea id="pageExcerpt" class="form-input" rows="2">${page.excerpt || ''}</textarea>
                </div>
                <div class="form-group">
                  <label>Meta T√≠tulo (SEO)</label>
                  <input type="text" id="pageMetaTitle" class="form-input" value="${page.metaTitle || ''}" />
                </div>
                <div class="form-group">
                  <label>Meta Description (SEO)</label>
                  <textarea id="pageMetaDescription" class="form-input" rows="2">${page.metaDescription || ''}</textarea>
                </div>
                <div class="form-group">
                  <label>
                    <input type="checkbox" id="pageIsPublished" ${page.isPublished ? 'checked' : ''} /> Publicada
                  </label>
                </div>
              </div>
              <div style="margin-top: var(--spacing-lg); display: flex; gap: var(--spacing-md);">
                <button type="submit" class="btn-primary">Guardar</button>
                <button type="button" class="btn-secondary" onclick="closePageModal()">Cancelar</button>
              </div>
            </form>
          </div>
        `;
        document.body.appendChild(modal);
        document.getElementById('pageForm').dataset.mode = 'edit';
        document.getElementById('pageForm').dataset.pageId = pageId;
      } catch (error) {
        console.error('Error loading page:', error);
        alert('‚ùå Error al cargar la p√°gina: ' + (error.message || 'Error desconocido'));
      }
    }

    async function savePage(event) {
      event.preventDefault();
      try {
        const form = event.target;
        const mode = form.dataset.mode;
      const pageData = {
          title: document.getElementById('pageTitle').value,
          slug: document.getElementById('pageSlug').value,
          content: document.getElementById('pageContent').value || null,
          excerpt: document.getElementById('pageExcerpt').value || null,
          metaTitle: document.getElementById('pageMetaTitle').value || null,
          metaDescription: document.getElementById('pageMetaDescription').value || null,
        isPublished: document.getElementById('pageIsPublished').checked
      };

        if (mode === 'edit') {
          const pageId = form.dataset.pageId;
          await api.updatePage(pageId, pageData);
        } else {
          await api.createPage(pageData);
        }
        
        alert('‚úÖ P√°gina guardada exitosamente');
        closePageModal();
        loadPages();
      } catch (error) {
        console.error('Error saving page:', error);
        alert('‚ùå Error al guardar la p√°gina: ' + (error.message || 'Error desconocido'));
      }
    }

    async function deletePage(pageId) {
      if (!confirm('¬øEst√°s seguro de eliminar esta p√°gina?')) return;
      try {
        await api.deletePage(pageId);
        alert('‚úÖ P√°gina eliminada exitosamente');
        loadPages();
      } catch (error) {
        console.error('Error deleting page:', error);
        alert('‚ùå Error al eliminar la p√°gina: ' + (error.message || 'Error desconocido'));
      }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', async () => {
      // Esperar un momento para asegurar que localStorage est√© disponible
      await new Promise(resolve => setTimeout(resolve, 100));
      
      // Verificar token ANTES de hacer cualquier request
      const token = localStorage.getItem('accessToken') || localStorage.getItem('authToken');
      if (!token) {
        console.warn('‚ö†Ô∏è No hay token, redirigiendo a login');
        window.location.href = '/login.html';
        return;
      }

      console.log('‚úÖ Token encontrado, cargando datos...');

      // Cargar datos
      loadTours();
      loadStats();

      // Logout button
      const logoutBtn = document.getElementById('logoutBtn');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', async () => {
          try {
            await api.logout();
          } catch (error) {
            console.error('Error en logout:', error);
          }
          localStorage.clear();
          window.location.href = '/';
        });
      }
    });
  </script>
</body>
</html>

