@page "/Admin"
@model PanamaTravelHub.API.Pages.AdminModel
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Panel Administrativo ‚Äî ToursPanama</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="stylesheet" href="/css/main.css" />
  <link rel="stylesheet" href="/css/admin.css" />
  <link rel="stylesheet" href="/css/loading.css" />
  <script src="https://cdn.jsdelivr.net/npm/tinymce@6.8.3/tinymce.min.js"></script>
</head>
<body>
  <nav class="nav">
    <div class="nav-inner wrap">
      <div class="brand">
        <div class="mark"></div>
        <span class="brand-text">ToursPanama</span>
      </div>
      <div class="nav-links">
        <a href="/" class="nav-link">Inicio</a>
        <a href="/Admin" class="nav-link active">Admin</a>
        <button class="btn-primary" id="logoutBtn">Cerrar Sesi√≥n</button>
      </div>
    </div>
  </nav>

  <main class="wrap admin-container">
    <div class="admin-header">
      <h1>Panel Administrativo</h1>
      <p>Gestiona tours, reservas, usuarios y contenido</p>
    </div>

    <!-- Tabs -->
      <div class="admin-tabs">
      <button class="admin-tab active" onclick="switchTab('tours', event)">Tours</button>
      <button class="admin-tab" onclick="switchTab('bookings', event)">Reservas</button>
      <button class="admin-tab" onclick="switchTab('users', event)">Usuarios</button>
      <button class="admin-tab" onclick="switchTab('cms', event)">CMS</button>
      @* <button class="admin-tab" onclick="switchTab('media', event)">Media</button> *@
      @* <button class="admin-tab" onclick="switchTab('pages', event)">P√°ginas</button> *@
      @* <button class="admin-tab" onclick="switchTab('stats', event)">Estad√≠sticas</button> *@
      </div>

    <!-- Content -->
    <div id="adminContent">
      <!-- Tours Tab -->
      <div id="tours" class="admin-content active">
        <div class="admin-header">
          <h2>Tours</h2>
          <button class="btn-primary" onclick="showAddTourModal()">+ Nuevo Tour</button>
        </div>
        <div class="admin-card">
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Imagen</th>
                  <th>Nombre</th>
                  <th>Precio</th>
                  <th>Capacidad</th>
                  <th>Disponibles</th>
                  <th>Estado</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody id="toursTableBody">
                <tr>
                  <td colspan="7" style="text-align: center; color: var(--text-muted);">Cargando...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Bookings Tab -->
      <div id="bookings" class="admin-content">
        <div class="admin-header">
          <h2>Reservas</h2>
        </div>
        <div class="admin-card">
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Tour</th>
                  <th>Cliente</th>
                  <th>Email</th>
                  <th>Participantes</th>
                  <th>Total</th>
                  <th>Estado</th>
                  <th>Fecha</th>
                </tr>
              </thead>
              <tbody id="bookingsTableBody">
                <tr>
                  <td colspan="7" style="text-align: center; color: var(--text-muted);">Cargando...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Users Tab -->
      <div id="users" class="admin-content">
        <div class="admin-header">
          <h2>Usuarios</h2>
        </div>
        <div class="admin-card">
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Email</th>
                  <th>Nombre</th>
                  <th>Tel√©fono</th>
                  <th>Roles</th>
                  <th>Estado</th>
                  <th>Reservas</th>
                  <th>√öltimo Login</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody id="usersTableBody">
                <tr>
                  <td colspan="8" style="text-align: center; color: var(--text-muted);">Cargando...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- CMS Tab -->
      <div id="cms" class="admin-content">
        <div class="admin-header">
          <h2>Gesti√≥n de Contenido (CMS)</h2>
        </div>
        <div class="admin-card">
          <p>Cargando contenido...</p>
              </div>
            </div>

      @* <!-- Media Tab -->
      <div id="media" class="admin-content">
        <div class="admin-header">
          <h2>Media</h2>
        </div>
        <div class="admin-card">
          <p>Cargando media...</p>
        </div>
      </div>

      <!-- Pages Tab -->
      <div id="pages" class="admin-content">
        <div class="admin-header">
          <h2>P√°ginas</h2>
        </div>
        <div class="admin-card">
          <p>Cargando p√°ginas...</p>
        </div>
      </div>

      <!-- Stats Tab -->
      <div id="stats" class="admin-content">
        <div class="admin-header">
          <h2>Estad√≠sticas</h2>
        </div>
        <div class="admin-card">
          <p>Cargando estad√≠sticas...</p>
        </div>
      </div> *@
    </div>
  </main>

  <script src="/js/loading.js"></script>
  <script src="/js/logger.js"></script>
  <script src="/js/api.js"></script>
  <script src="/js/notifications.js"></script>
  <script>
    // Helper function para formatear precios
    function formatPrice(value, fallbackText = '$0.00') {
      const rawPrice = value ?? null;
      let price = Number(rawPrice ?? 0);
      
      if (typeof price !== 'number' || isNaN(price) || !isFinite(price)) {
        console.warn('‚ö†Ô∏è [formatPrice] Precio inv√°lido, usando 0:', { value, rawPrice, price });
        price = 0;
      }
      
      const formattedPrice = price.toFixed(2);
      return price > 0 ? `$${formattedPrice}` : fallbackText;
    }

    let currentTourId = null;
    let tourImages = [];

    // Utility functions
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function formatPrice(price) {
      if (price === null || price === undefined) return '$0.00';
      const numPrice = typeof price === 'string' ? parseFloat(price) : price;
      return '$' + numPrice.toFixed(2);
    }

    // Switch tabs
    function switchTab(tabName, e) {
      const clickedTab = e ? e.target : (window.event ? window.event.target : null);
      document.querySelectorAll('.admin-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      if (clickedTab) {
        clickedTab.classList.add('active');
      }

      document.querySelectorAll('.admin-content').forEach(content => {
        content.classList.remove('active');
      });
      document.getElementById(tabName).classList.add('active');

      // Load tab data
      if (tabName === 'tours') loadTours();
      if (tabName === 'bookings') loadBookings();
      if (tabName === 'users') loadUsers();
      if (tabName === 'cms') loadHomePageContent();
      // if (tabName === 'media') loadMediaFiles();
      // if (tabName === 'pages') loadPages();
      // if (tabName === 'stats') loadStats();
    }

    // Load Users
    async function loadUsers() {
      const tbody = document.getElementById('usersTableBody');
      const loaderId = loadingManager.showInline(tbody, 'Cargando usuarios...');
      
      try {
        const users = await api.getAdminUsers();
        loadingManager.hideInline(tbody);
        
        if (!users || users.length === 0) {
          tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: var(--text-muted); padding: 40px;">No hay usuarios disponibles</td></tr>';
          return;
        }

        tbody.innerHTML = users.map(user => {
          const roles = user.roles || [];
          const rolesBadges = roles.map(role => 
            `<span class="badge ${role === 'Admin' || role === 'admin' ? 'active' : 'inactive'}" style="margin-right: 4px;">${escapeHtml(role)}</span>`
          ).join('');
          
          const isLocked = user.lockedUntil && new Date(user.lockedUntil) > new Date();
          const statusBadge = user.isActive 
            ? `<span class="badge active">Activo</span>`
            : `<span class="badge inactive">Inactivo</span>`;
          
          const lockedBadge = isLocked 
            ? `<span class="badge" style="background: #ef4444; margin-left: 4px;">Bloqueado</span>`
            : '';

          return `
            <tr>
              <td>${escapeHtml(user.email || 'N/A')}</td>
              <td>${escapeHtml((user.firstName || '') + ' ' + (user.lastName || ''))}</td>
              <td>${escapeHtml(user.phone || '‚Äî')}</td>
              <td>${rolesBadges || '<span class="badge inactive">Sin roles</span>'}</td>
              <td>${statusBadge}${lockedBadge}</td>
              <td>${user.totalBookings || 0}</td>
              <td>${user.lastLoginAt ? new Date(user.lastLoginAt).toLocaleDateString('es-PA') : 'Nunca'}</td>
              <td>
                <div class="action-buttons">
                  <button class="btn-sm btn-primary" onclick="viewUser('${user.id || ''}')">Ver</button>
                  <button class="btn-sm btn-secondary" onclick="editUser('${user.id || ''}')">Editar</button>
                  ${isLocked ? `<button class="btn-sm" style="background: #10b981; color: white;" onclick="unlockUser('${user.id || ''}')">Desbloquear</button>` : ''}
                </div>
              </td>
            </tr>
          `;
        }).join('');
      } catch (error) {
        console.error('Error loading users:', error);
        loadingManager.hideInline(tbody);
        const errorMessage = error.message || error.detail || 'Error desconocido al cargar usuarios';
        const errorMsg = 'Error al cargar usuarios: ' + errorMessage;
        if (typeof notificationManager !== 'undefined' && notificationManager) {
          notificationManager.error(errorMsg);
        } else if (typeof window !== 'undefined' && window.notificationManager) {
          window.notificationManager.error(errorMsg);
        } else {
          console.error(errorMsg);
        }
        tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: var(--danger); padding: 40px;">Error al cargar usuarios. Por favor, intenta de nuevo.</td></tr>';
      }
    }

    // Load Tours
    async function loadTours() {
      const tbody = document.getElementById('toursTableBody');
      const loaderId = loadingManager.showInline(tbody, 'Cargando tours...');
      
      try {
        const tours = await api.getAdminTours();
        loadingManager.hideInline(tbody);
        
        if (!tours || tours.length === 0) {
          tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--text-muted);">No hay tours disponibles</td></tr>';
          return;
        }

        tbody.innerHTML = tours.map(tour => {
          const tourId = tour.id || tour.Id || '';
          if (!tourId) {
            console.warn('Tour sin ID v√°lido:', tour);
            return '';
          }
          return `
          <tr>
            <td>
              ${tour.imageUrl || tour.image_url ? `<img src="${tour.imageUrl || tour.image_url}" class="tour-image-preview" alt="${tour.name || tour.Name || ''}" />` : '‚Äî'}
            </td>
            <td>${tour.name || tour.Name || ''}</td>
            <td>${formatPrice(tour.price ?? tour.Price)}</td>
            <td>${tour.maxCapacity ?? tour.MaxCapacity ?? ''}</td>
            <td>${tour.availableSpots ?? tour.AvailableSpots ?? ''}</td>
            <td>
              <span class="badge ${(tour.isActive ?? tour.IsActive ?? true) ? 'active' : 'inactive'}">
                ${(tour.isActive ?? tour.IsActive ?? true) ? 'Activo' : 'Inactivo'}
              </span>
            </td>
            <td>
              <div class="action-buttons">
                <button class="btn-sm btn-primary" onclick="editTour('${tourId}')">Editar</button>
                <button class="btn-sm" style="background: var(--primary-light);" onclick="manageTourDates('${tourId}')">Fechas</button>
                <button class="btn-sm btn-secondary" onclick="deleteTour('${tourId}')">Eliminar</button>
              </div>
            </td>
          </tr>
        `;
        }).filter(row => row !== '').join('');
      } catch (error) {
        console.error('Error loading tours:', error);
        loadingManager.hideInline(tbody);
        document.getElementById('toursTableBody').innerHTML = 
          '<tr><td colspan="7" style="text-align: center; color: var(--error);">Error al cargar tours</td></tr>';
      }
    }

    // Load Bookings
    async function loadBookings() {
      const tbody = document.getElementById('bookingsTableBody');
      const loaderId = loadingManager.showInline(tbody, 'Cargando reservas...');
      
      try {
        const bookings = await api.getAdminBookings();
        loadingManager.hideInline(tbody);
        
        if (!bookings || bookings.length === 0) {
          tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--text-muted); padding: 40px;">No hay reservas disponibles</td></tr>';
          return;
        }

        tbody.innerHTML = bookings.map(booking => {
          const statusClass = booking.status === 'Confirmed' || booking.status === 2 ? 'active' : 
                            booking.status === 'Pending' || booking.status === 1 ? 'warning' : 'inactive';
          const statusText = booking.status === 1 ? 'Pendiente' :
                           booking.status === 2 ? 'Confirmada' :
                           booking.status === 3 ? 'Cancelada' :
                           booking.status === 4 ? 'Expirada' :
                           booking.status === 5 ? 'Completada' : booking.status;
          
          return `
          <tr>
            <td>${escapeHtml(booking.tourName || booking.tour?.name || 'N/A')}</td>
            <td>${escapeHtml(booking.userName || booking.user?.firstName + ' ' + booking.user?.lastName || 'N/A')}</td>
            <td>${escapeHtml(booking.userEmail || booking.user?.email || 'N/A')}</td>
            <td>${booking.numberOfParticipants || 0}</td>
            <td>${formatPrice(booking.totalAmount || 0)}</td>
            <td>
              <span class="badge ${statusClass}">
                ${statusText}
              </span>
            </td>
            <td>${booking.createdAt ? new Date(booking.createdAt).toLocaleDateString('es-PA') : 'N/A'}</td>
          </tr>
        `;
        }).join('');
      } catch (error) {
        console.error('Error loading bookings:', error);
        loadingManager.hideInline(tbody);
        const errorMessage = error.message || error.detail || 'Error desconocido al cargar reservas';
        notificationManager.error('Error al cargar reservas: ' + errorMessage);
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--danger); padding: 40px;">Error al cargar reservas. Por favor, intenta de nuevo.</td></tr>';
      }
    }

    // Load Stats
    async function loadStats() {
      try {
        const stats = await api.getAdminStats();
        const content = document.getElementById('stats');
        content.innerHTML = `
          <div class="stats-grid">
            <div class="stat-card">
              <h3>${stats.totalTours}</h3>
              <p>Tours Totales</p>
            </div>
            <div class="stat-card">
              <h3>${stats.totalBookings}</h3>
              <p>Reservas Totales</p>
            </div>
            <div class="stat-card">
              <h3>${formatPrice(stats.totalRevenue)}</h3>
              <p>Ingresos Totales</p>
            </div>
            <div class="stat-card">
              <h3>${stats.totalUsers}</h3>
              <p>Usuarios</p>
            </div>
          </div>
        `;
      } catch (error) {
        console.error('Error loading stats:', error);
        document.getElementById('stats').innerHTML = 
          '<p style="color: var(--error);">Error al cargar estad√≠sticas</p>';
      }
    }

    // Tour Functions
    function showAddTourModal() {
      // Inicializar array de im√°genes vac√≠o
      tourImages = [];
      const modal = document.createElement('div');
      modal.className = 'modal active';
      modal.innerHTML = `
        <div class="modal-content tour-form-modal">
          <div class="modal-header">
            <div class="modal-header-content">
              <h2>Nuevo Tour</h2>
              <p class="modal-subtitle">Crea y administra la informaci√≥n del tour</p>
            </div>
            <button class="modal-close" onclick="closeTourModal()" aria-label="Cerrar">√ó</button>
          </div>
          <form id="tourForm" class="tour-form" onsubmit="saveTour(event)">
            <div class="modal-body">
              <!-- Secci√≥n: Informaci√≥n General -->
              <div class="form-section">
                <div class="form-section-header">
                  <h3>üìã Informaci√≥n General</h3>
                </div>
                <div class="form-grid form-grid-2">
                  <div class="form-group">
                    <label class="form-label">
                      <span class="label-text">Nombre del Tour</span>
                      <span class="label-required">*</span>
                    </label>
                    <input type="text" id="tourName" class="form-input" placeholder="Ej: Tour al Canal de Panam√°" required />
                    <div class="field-error" id="tourNameError" style="display: none;"></div>
                  </div>
                  <div class="form-group">
                    <label class="form-label">
                      <span class="label-text">Precio</span>
                      <span class="label-required">*</span>
                    </label>
                    <div class="input-with-icon">
                      <span class="input-icon">$</span>
                      <input type="number" id="tourPrice" class="form-input" step="0.01" min="0" placeholder="0.00" required />
                    </div>
                    <div class="field-error" id="tourPriceError" style="display: none;"></div>
                  </div>
                  <div class="form-group">
                    <label class="form-label">
                      <span class="label-text">Duraci√≥n</span>
                      <span class="label-required">*</span>
                      <span class="label-optional">(horas)</span>
                    </label>
                    <input type="number" id="tourDurationHours" class="form-input" min="1" placeholder="Ej: 4" required />
                    <div class="field-error" id="tourDurationHoursError" style="display: none;"></div>
                  </div>
                  <div class="form-group">
                    <label class="form-label">
                      <span class="label-text">Capacidad M√°xima</span>
                      <span class="label-required">*</span>
                    </label>
                    <input type="number" id="tourMaxCapacity" class="form-input" min="1" placeholder="Ej: 20" required />
                    <div class="field-error" id="tourMaxCapacityError" style="display: none;"></div>
                  </div>
                </div>
              </div>

              <!-- Secci√≥n: Imagen del Tour -->
              <div class="form-section">
                <div class="form-section-header">
                  <h3>üñºÔ∏è Imagen del Tour</h3>
                  <p class="form-section-description">La primera imagen ser√° la imagen principal del tour</p>
                </div>
                <div id="tourImagesContainer">
                  <div class="tour-images-grid" id="tourImagesGrid">
                    <!-- Las im√°genes se agregar√°n aqu√≠ din√°micamente -->
                  </div>
                  <div class="drop-zone" id="tourImageDropZone" onclick="document.getElementById('tourImageFileInput').click()">
                    <div class="drop-zone-content">
                      <svg class="drop-zone-icon" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="17 8 12 3 7 8"></polyline>
                        <line x1="12" y1="3" x2="12" y2="15"></line>
                      </svg>
                      <p class="drop-zone-text">üì∏ Arrastra y suelta im√°genes aqu√≠</p>
                      <p class="drop-zone-hint">o haz clic para seleccionar archivos</p>
                      <p class="drop-zone-info">‚úÖ Formatos: JPG, PNG, WEBP | üìè Tama√±o m√°ximo: 5MB | üñºÔ∏è M√°ximo 5 im√°genes | ‚ö†Ô∏è Requerido: al menos 1 imagen</p>
                    </div>
                  </div>
                  <input type="file" id="tourImageFileInput" accept="image/jpeg,image/png,image/webp" multiple style="display: none;" onchange="handleTourImageFiles(event)" />
                  <div class="image-upload-actions">
                    <button type="button" class="btn-secondary btn-sm" onclick="showTourImageSelectionModal()">üìÅ Seleccionar de Media</button>
                    <span class="image-count-badge" id="tourImageCount">0/5 im√°genes</span>
                  </div>
                  <div class="field-error" id="tourImagesError" style="display: none;"></div>
                </div>
                <textarea id="tourImages" class="form-input" style="display: none;" rows="1"></textarea>
              </div>

              <!-- Secci√≥n: Ubicaci√≥n -->
              <div class="form-section">
                <div class="form-section-header">
                  <h3>üìç Ubicaci√≥n</h3>
                </div>
                <div class="form-grid form-grid-2">
                  <div class="form-group full-width">
                    <label class="form-label">
                      <span class="label-text">Ubicaci√≥n</span>
                      <span class="label-optional">(Opcional)</span>
                    </label>
                    <input type="text" id="tourLocation" class="form-input" placeholder="Ej: Ciudad de Panam√°" />
                  </div>
                </div>
              </div>

              <!-- Secci√≥n: Descripci√≥n -->
              <div class="form-section">
                <div class="form-section-header">
                  <h3>üìù Descripci√≥n</h3>
                </div>
                <div class="form-group full-width">
                  <label class="form-label">
                    <span class="label-text">Descripci√≥n del Tour</span>
                    <span class="label-required">*</span>
                  </label>
                  <textarea id="tourDescription" class="form-input form-textarea" rows="6" minlength="50" placeholder="Describe los detalles del tour, qu√© incluye, qu√© ver√°s, etc..." required></textarea>
                  <div class="form-hint">
                    <span id="tourDescriptionCharCount">0</span> caracteres (m√≠nimo 50)
                  </div>
                  <div class="field-error" id="tourDescriptionError" style="display: none;"></div>
                </div>
                <div class="form-group full-width">
                  <label class="form-label">
                    <span class="label-text">Itinerario</span>
                    <span class="label-optional">(Opcional)</span>
                  </label>
                  <textarea id="tourItinerary" class="form-input form-textarea" rows="5" placeholder="Detalla el itinerario del tour, horarios, actividades, etc..."></textarea>
                </div>
              </div>

              <!-- Secci√≥n: Estado -->
              <div class="form-section">
                <div class="form-group">
                  <label class="form-label">
                    <input type="checkbox" id="tourIsActive" checked style="margin-right: 8px;" />
                    <span class="label-text">Tour Activo</span>
                  </label>
                  <p class="form-hint">Los tours inactivos no se mostrar√°n en el sitio p√∫blico</p>
                </div>
              </div>
            </div>
            <div class="form-actions">
              <button type="button" class="btn-cancel" onclick="closeTourModal()">Cancelar</button>
              <button type="submit" class="btn-save" id="tourFormSubmitBtn">
                Guardar Tour
              </button>
            </div>
            </form>
        </div>
      `;
      document.body.appendChild(modal);
      document.body.style.overflow = 'hidden'; // Prevenir scroll del body
      document.getElementById('tourForm').dataset.mode = 'create';
      
      // Inicializar drag & drop
      initializeTourImageDropZone();
      
      // Inicializar contador de caracteres
      const descriptionTextarea = document.getElementById('tourDescription');
      const charCount = document.getElementById('tourDescriptionCharCount');
      if (descriptionTextarea && charCount) {
        descriptionTextarea.addEventListener('input', function() {
          charCount.textContent = this.value.length;
        });
      }
      
      // Inicializar display de im√°genes
      setTimeout(() => updateTourImagesDisplay(), 100);
    }
    
    function updateTourImagesDisplay() {
      const grid = document.getElementById('tourImagesGrid');
      if (!grid) return;
      
      if (tourImages.length === 0) {
        grid.innerHTML = '';
        // Mostrar drop zone si est√° oculta
        const dropZone = document.getElementById('tourImageDropZone');
        if (dropZone) dropZone.style.display = 'block';
        return;
      }
      
      // Ocultar drop zone si hay im√°genes
      const dropZone = document.getElementById('tourImageDropZone');
      if (dropZone) dropZone.style.display = tourImages.length >= 5 ? 'none' : 'block';
      
      grid.innerHTML = tourImages.map((imgUrl, index) => `
        <div class="image-preview-item ${index === 0 ? 'primary' : ''}" data-image-url="${imgUrl}">
          <img src="${imgUrl}" alt="Tour image ${index + 1}" />
          ${index === 0 ? '<span class="primary-badge">Principal</span>' : ''}
          <button type="button" class="preview-remove-btn" onclick="removeTourImage('${imgUrl}')" title="Eliminar" aria-label="Eliminar imagen">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
          ${index !== 0 ? `
            <button type="button" class="preview-set-primary-btn" onclick="setPrimaryTourImage('${imgUrl}')" title="Establecer como principal">
              Establecer como principal
            </button>
          ` : ''}
        </div>
      `).join('');
      
      // Actualizar textarea oculto
      const hiddenTextarea = document.getElementById('tourImages');
      if (hiddenTextarea) {
        hiddenTextarea.value = tourImages.join('\n');
      }
      
      // Actualizar contador
      const countElement = document.getElementById('tourImageCount');
      if (countElement) {
        countElement.textContent = `${tourImages.length}/5 im√°genes`;
        if (tourImages.length >= 5) {
          countElement.classList.add('max-reached');
        } else {
          countElement.classList.remove('max-reached');
        }
      }
    }
    
    async function handleTourImageFiles(event) {
      const files = event.dataTransfer ? Array.from(event.dataTransfer.files) : Array.from(event.target.files);
      if (files.length === 0) return;
      
      // Filtrar solo im√°genes
      const imageFiles = files.filter(file => file.type.startsWith('image/'));
      if (imageFiles.length === 0) {
        showImageError('Por favor selecciona solo archivos de imagen (JPG, PNG, WEBP)');
        return;
      }
      
      if (tourImages.length + imageFiles.length > 5) {
        showImageError(`Solo puedes tener m√°ximo 5 im√°genes. Ya tienes ${tourImages.length} im√°genes.`);
        if (event.target) event.target.value = '';
        return;
      }
      
      // Deshabilitar bot√≥n de submit mientras se suben
      const submitBtn = document.getElementById('tourFormSubmitBtn');
      if (submitBtn) submitBtn.disabled = true;
      
      // Mostrar indicador de progreso
      const dropZone = document.getElementById('tourImageDropZone');
      const originalDropZoneContent = dropZone ? dropZone.innerHTML : '';
      if (dropZone) {
        dropZone.innerHTML = `
          <div style="text-align: center; padding: 20px;">
            <div style="margin-bottom: 12px;">üì§ Subiendo ${imageFiles.length} imagen(es)...</div>
            <div style="background: rgba(0,0,0,0.1); border-radius: 8px; height: 8px; overflow: hidden;">
              <div id="uploadProgress" style="background: linear-gradient(135deg, #0ea5e9 0%, #0891b2 100%); height: 100%; width: 0%; transition: width 0.3s;"></div>
            </div>
          </div>
        `;
      }
      
      try {
        // Subir todas las im√°genes con progreso
        const totalFiles = imageFiles.length;
        let uploadedCount = 0;
        
        const uploadPromises = imageFiles.map(async (file, index) => {
          try {
            const result = await api.uploadTourImage(file);
            uploadedCount++;
            
            // Actualizar progreso
            if (dropZone) {
              const progressBar = document.getElementById('uploadProgress');
              if (progressBar) {
                progressBar.style.width = ((uploadedCount / totalFiles) * 100) + '%';
              }
            }
            
            return result;
          } catch (error) {
            console.error(`Error uploading file ${index + 1}:`, error);
            throw error;
          }
        });
        
        const results = await Promise.all(uploadPromises);
        
        // Agregar URLs a la lista (manejar tanto url como Url por compatibilidad)
        let addedCount = 0;
        results.forEach(result => {
          const imageUrl = result.url || result.Url;
          if (imageUrl && !tourImages.includes(imageUrl)) {
            tourImages.push(imageUrl);
            addedCount++;
          }
        });
        
        // Mostrar √©xito
        if (addedCount > 0) {
          notificationManager.success(`${addedCount} imagen(es) subida(s) exitosamente`);
        }
        
        updateTourImagesDisplay();
        clearImageError();
        
        // Restaurar drop zone
        if (dropZone && originalDropZoneContent) {
          setTimeout(() => {
            dropZone.innerHTML = originalDropZoneContent;
          }, 500);
        }
      } catch (error) {
        console.error('Error uploading images:', error);
        const errorMessage = error.message || error.detail || 'Error desconocido';
        notificationManager.error(`Error al subir las im√°genes: ${errorMessage}. Por favor, verifica que el archivo sea una imagen v√°lida (JPG, PNG, WEBP) y que no exceda 5MB.`);
        showImageError(`Error al subir las im√°genes: ${errorMessage}`);
        
        // Restaurar drop zone en caso de error
        if (dropZone && originalDropZoneContent) {
          dropZone.innerHTML = originalDropZoneContent;
        }
      } finally {
        if (submitBtn) submitBtn.disabled = false;
        // Limpiar input
        if (event.target) event.target.value = '';
      }
    }
    
    function showImageError(message) {
      const errorEl = document.getElementById('tourImagesError');
      if (errorEl) {
        errorEl.textContent = message;
        errorEl.style.display = 'flex';
      }
    }
    
    function clearImageError() {
      const errorEl = document.getElementById('tourImagesError');
      if (errorEl) {
        errorEl.style.display = 'none';
      }
    }
    
    function initializeTourImageDropZone() {
      const dropZone = document.getElementById('tourImageDropZone');
      const fileInput = document.getElementById('tourImageFileInput');
      
      if (!dropZone || !fileInput) return;
      
      // Prevenir comportamiento por defecto
      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, preventDefaults, false);
        document.body.addEventListener(eventName, preventDefaults, false);
      });
      
      function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
      }
      
      // Highlight cuando arrastra sobre
      ['dragenter', 'dragover'].forEach(eventName => {
        dropZone.addEventListener(eventName, () => {
          dropZone.classList.add('drag-over');
        }, false);
      });
      
      ['dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, () => {
          dropZone.classList.remove('drag-over');
        }, false);
      });
      
      // Handle drop
      dropZone.addEventListener('drop', (e) => {
        const dt = e.dataTransfer;
        const files = dt.files;
        fileInput.files = files;
        handleTourImageFiles({ dataTransfer: dt });
      }, false);
    }
    
    function removeTourImage(imageUrl) {
      if (confirm('¬øEst√°s seguro de eliminar esta imagen?')) {
        tourImages = tourImages.filter(url => url !== imageUrl);
        updateTourImagesDisplay();
      }
    }
    
    function setPrimaryTourImage(imageUrl) {
      tourImages = tourImages.filter(url => url !== imageUrl);
      tourImages.unshift(imageUrl);
      updateTourImagesDisplay();
    }
    
    async function showTourImageSelectionModal() {
      try {
        const mediaFiles = await api.getAdminMedia(null, true, 1, 50);
        
        if (mediaFiles.length === 0) {
          notificationManager.warning('No hay im√°genes en la biblioteca de medios. Por favor, sube una imagen primero en la pesta√±a Media.');
          return;
        }
        
        const modal = document.createElement('div');
        modal.className = 'modal active';
        modal.innerHTML = `
          <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
              <h3>Seleccionar Im√°genes para el Tour</h3>
              <button class="modal-close" onclick="this.closest('.modal').remove()">√ó</button>
            </div>
            <div class="media-selection-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 16px; max-height: 60vh; overflow-y: auto; padding: 16px;">
              ${mediaFiles.map(file => `
                <div class="media-selection-item" style="border: 2px solid ${tourImages.includes(file.fileUrl) ? 'var(--primary)' : 'var(--stroke)'}; border-radius: var(--radius); overflow: hidden; cursor: pointer; transition: all 0.2s; position: relative;" 
                     onmouseover="this.style.borderColor='var(--primary)'" 
                     onmouseout="this.style.borderColor='${tourImages.includes(file.fileUrl) ? 'var(--primary)' : 'var(--stroke)'}'"
                     onclick="selectTourImageFromLibrary('${file.fileUrl}')">
                  ${tourImages.includes(file.fileUrl) ? '<span style="position: absolute; top: 4px; right: 4px; background: var(--primary); color: white; padding: 2px 6px; border-radius: var(--radius-sm); font-size: 0.75rem; z-index: 1;">‚úì</span>' : ''}
                  <img src="${file.fileUrl}" alt="${file.fileName}" style="width: 100%; height: 150px; object-fit: cover;" />
                  <div style="padding: 8px; font-size: 0.875rem; color: var(--text-muted);">${file.fileName}</div>
                </div>
              `).join('')}
            </div>
            <div style="padding: 16px; border-top: 1px solid var(--stroke);">
              <button type="button" class="btn-primary" onclick="document.querySelector('.modal').remove()">Cerrar</button>
            </div>
          </div>
        `;
        document.body.appendChild(modal);
      } catch (error) {
        console.error('Error loading media files:', error);
        notificationManager.error('Error al cargar la biblioteca de medios');
      }
    }
    
    function selectTourImageFromLibrary(imageUrl) {
      if (tourImages.length >= 5) {
        notificationManager.warning('Solo puedes tener m√°ximo 5 im√°genes. Elimina una imagen primero.');
        return;
      }
      
      if (!tourImages.includes(imageUrl)) {
        tourImages.push(imageUrl);
        updateTourImagesDisplay();
      }
    }

    async function editTour(id) {
      try {
        // Validar que el ID existe y no est√° vac√≠o
        if (!id || id === 'undefined' || id === 'null' || (typeof id === 'string' && id.trim() === '')) {
          throw new Error('ID de tour no v√°lido');
        }
        
        const tour = await api.getAdminTour(id);
        if (!tour || (!tour.id && !tour.Id)) {
          throw new Error('Tour no encontrado');
        }
        
        // Usar el ID del tour obtenido (puede estar en diferentes formatos)
        const tourId = tour.id || tour.Id || id;
        currentTourId = tourId;
        
        // Inicializar array de im√°genes
        tourImages = tour.images || tour.Images || [];
        const modal = document.createElement('div');
        modal.className = 'modal active';
        modal.innerHTML = `
          <div class="modal-content tour-form-modal" style="max-width: 1100px;">
            <div class="modal-header">
              <div class="modal-header-content">
                <h2>Editar Tour</h2>
                <p class="modal-subtitle">Actualiza la informaci√≥n del tour</p>
              </div>
              <button class="modal-close" onclick="closeTourModal()" aria-label="Cerrar">√ó</button>
            </div>
            <form id="tourForm" class="tour-form" onsubmit="saveTour(event)" data-mode="edit" data-tour-id="${tourId}">
              <div class="modal-body">
                <!-- Secci√≥n: Informaci√≥n General -->
                <div class="form-section">
                  <div class="form-section-header">
                    <h3>üìã Informaci√≥n General</h3>
                  </div>
                  <div class="form-grid form-grid-2">
                    <div class="form-group">
                      <label class="form-label">
                        <span class="label-text">Nombre del Tour</span>
                        <span class="label-required">*</span>
                      </label>
                      <input type="text" id="tourName" class="form-input" value="${(tour.name || tour.Name || '').replace(/"/g, '&quot;')}" placeholder="Ej: Tour al Canal de Panam√°" required />
                      <div class="field-error" id="tourNameError" style="display: none;"></div>
                    </div>
                    <div class="form-group">
                      <label class="form-label">
                        <span class="label-text">Precio</span>
                        <span class="label-required">*</span>
                      </label>
                      <div class="input-with-icon">
                        <span class="input-icon">$</span>
                        <input type="number" id="tourPrice" class="form-input" step="0.01" min="0" value="${tour.price ?? tour.Price ?? ''}" placeholder="0.00" required />
                      </div>
                      <div class="field-error" id="tourPriceError" style="display: none;"></div>
                    </div>
                    <div class="form-group">
                      <label class="form-label">
                        <span class="label-text">Duraci√≥n</span>
                        <span class="label-required">*</span>
                        <span class="label-optional">(horas)</span>
                      </label>
                      <input type="number" id="tourDurationHours" class="form-input" min="1" max="48" value="${tour.durationHours ?? tour.DurationHours ?? ''}" placeholder="Ej: 4" required />
                      <div class="field-error" id="tourDurationHoursError" style="display: none;"></div>
                    </div>
                    <div class="form-group">
                      <label class="form-label">
                        <span class="label-text">Capacidad M√°xima</span>
                        <span class="label-required">*</span>
                      </label>
                      <input type="number" id="tourMaxCapacity" class="form-input" min="1" value="${tour.maxCapacity ?? tour.MaxCapacity ?? ''}" placeholder="Ej: 20" required />
                      <div class="field-error" id="tourMaxCapacityError" style="display: none;"></div>
                    </div>
                  </div>
                </div>

                <!-- Secci√≥n: Imagen del Tour -->
                <div class="form-section">
                  <div class="form-section-header">
                    <h3>üñºÔ∏è Imagen del Tour</h3>
                    <p class="form-section-description">La primera imagen ser√° la imagen principal del tour</p>
                  </div>
                  <div id="tourImagesContainer">
                    <div class="tour-images-grid" id="tourImagesGrid">
                      <!-- Las im√°genes se agregar√°n aqu√≠ din√°micamente -->
                    </div>
                    ${tourImages.length < 5 ? `
                    <div class="drop-zone" id="tourImageDropZone" onclick="document.getElementById('tourImageFileInput').click()">
                      <div class="drop-zone-content">
                        <svg class="drop-zone-icon" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                          <polyline points="17 8 12 3 7 8"></polyline>
                          <line x1="12" y1="3" x2="12" y2="15"></line>
                        </svg>
                        <p class="drop-zone-text">Arrastra y suelta im√°genes aqu√≠</p>
                        <p class="drop-zone-hint">o haz clic para seleccionar archivos</p>
                        <p class="drop-zone-info">Formatos: JPG, PNG, WEBP | Tama√±o recomendado: 1200x800px | M√°ximo 5 im√°genes</p>
                      </div>
                    </div>
                    ` : ''}
                    <input type="file" id="tourImageFileInput" accept="image/jpeg,image/png,image/webp" multiple style="display: none;" onchange="handleTourImageFiles(event)" />
                    <div class="image-upload-actions">
                      <button type="button" class="btn-secondary btn-sm" onclick="showTourImageSelectionModal()">üìÅ Seleccionar de Media</button>
                      <span class="image-count-badge" id="tourImageCount">${tourImages.length}/5 im√°genes</span>
                    </div>
                    <div class="field-error" id="tourImagesError" style="display: none;"></div>
                  </div>
                  <textarea id="tourImages" class="form-input" style="display: none;" rows="1">${(tour.images || tour.Images || []).join('\n')}</textarea>
                </div>

                <!-- Secci√≥n: Ubicaci√≥n -->
                <div class="form-section">
                  <div class="form-section-header">
                    <h3>üìç Ubicaci√≥n</h3>
                  </div>
                  <div class="form-grid form-grid-2">
                    <div class="form-group full-width">
                      <label class="form-label">
                        <span class="label-text">Ubicaci√≥n</span>
                        <span class="label-optional">(Opcional)</span>
                      </label>
                      <input type="text" id="tourLocation" class="form-input" value="${(tour.location || tour.Location || '').replace(/"/g, '&quot;')}" placeholder="Ej: Ciudad de Panam√°" />
                    </div>
                  </div>
                </div>

                <!-- Secci√≥n: Descripci√≥n -->
                <div class="form-section">
                  <div class="form-section-header">
                    <h3>üìù Descripci√≥n</h3>
                  </div>
                  <div class="form-group full-width">
                    <label class="form-label">
                      <span class="label-text">Descripci√≥n del Tour</span>
                      <span class="label-required">*</span>
                    </label>
                    <textarea id="tourDescription" class="form-input form-textarea" rows="6" minlength="50" placeholder="Describe los detalles del tour, qu√© incluye, qu√© ver√°s, etc..." required>${(tour.description || tour.Description || '').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</textarea>
                    <div class="form-hint">
                      <span id="tourDescriptionCharCount">${(tour.description || tour.Description || '').length}</span> caracteres (m√≠nimo 50)
                    </div>
                    <div class="field-error" id="tourDescriptionError" style="display: none;"></div>
                  </div>
                  <div class="form-group full-width">
                    <label class="form-label">
                      <span class="label-text">Itinerario</span>
                      <span class="label-optional">(Opcional)</span>
                    </label>
                    <textarea id="tourItinerary" class="form-input form-textarea" rows="5" placeholder="Detalla el itinerario del tour, horarios, actividades, etc...">${(tour.itinerary || tour.Itinerary || '').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</textarea>
                  </div>
                </div>

                <!-- Secci√≥n: Estado -->
                <div class="form-section">
                  <div class="form-group">
                    <label class="form-label">
                      <input type="checkbox" id="tourIsActive" ${(tour.isActive ?? tour.IsActive ?? true) ? 'checked' : ''} style="margin-right: 8px;" />
                      <span class="label-text">Tour Activo</span>
                    </label>
                    <p class="form-hint">Los tours inactivos no se mostrar√°n en el sitio p√∫blico</p>
                  </div>
                </div>
              </div>
              <div class="form-actions">
                <button type="button" class="btn-cancel" onclick="closeTourModal()">Cancelar</button>
                <button type="submit" class="btn-save" id="tourFormSubmitBtn">
                  Guardar Cambios
                </button>
              </div>
              </form>
          </div>
        `;
        document.body.appendChild(modal);
        document.body.style.overflow = 'hidden'; // Prevenir scroll del body
        
        // Asegurar que los atributos data est√©n establecidos correctamente
        const form = document.getElementById('tourForm');
        if (form) {
          form.dataset.mode = 'edit';
          form.dataset.tourId = tourId;
        }
        
        // Inicializar drag & drop
        initializeTourImageDropZone();
        
        // Inicializar contador de caracteres
        const descriptionTextarea = document.getElementById('tourDescription');
        const charCount = document.getElementById('tourDescriptionCharCount');
        if (descriptionTextarea && charCount) {
          descriptionTextarea.addEventListener('input', function() {
            charCount.textContent = this.value.length;
          });
        }
        
        // Inicializar display de im√°genes
        setTimeout(() => updateTourImagesDisplay(), 100);
      } catch (error) {
        console.error('Error loading tour:', error);
        const errorMessage = error.message || error.detail || 'Error desconocido';
        notificationManager.error('Error al cargar el tour: ' + errorMessage);
      }
    }

    function closeTourModal() {
      const modals = document.querySelectorAll('.modal.active, .modal');
      modals.forEach(modal => {
        if (modal) {
          modal.classList.remove('active');
          modal.style.display = 'none';
          setTimeout(() => {
            modal.remove();
          }, 300);
        }
      });
      currentTourId = null;
      tourImages = []; // Limpiar im√°genes al cerrar
      document.body.style.overflow = ''; // Restaurar scroll del body
    }

    async function saveTour(event) {
      event.preventDefault();
      
      // Limpiar errores previos
      clearAllErrors();
      
      // Validar formulario
      if (!validateTourForm()) {
        return;
      }
      
      const form = event.target;
      const mode = form.dataset.mode || 'create';
      const submitBtn = document.getElementById('tourFormSubmitBtn');
      
      try {
        // Deshabilitar bot√≥n mientras se guarda
        if (submitBtn) {
          submitBtn.disabled = true;
          submitBtn.classList.add('btn-loading');
          submitBtn.textContent = 'Guardando...';
        }
        
        // Obtener im√°genes del array tourImages o del textarea como fallback
        let images = [];
        if (tourImages && tourImages.length > 0) {
          // Si tourImages contiene objetos, extraer las URLs; si son strings, usarlos directamente
          images = tourImages.map(img => {
            if (typeof img === 'string') {
              return img;
            } else if (img && (img.url || img.imageUrl || img.ImageUrl)) {
              return img.url || img.imageUrl || img.ImageUrl;
            }
            return null;
          }).filter(url => url && typeof url === 'string' && url.trim().length > 0);
        } else {
          const tourImagesTextarea = document.getElementById('tourImages');
          if (tourImagesTextarea && tourImagesTextarea.value) {
            images = tourImagesTextarea.value.split('\n')
              .map(url => url.trim())
              .filter(url => url && url.length > 0);
          }
        }
        
        // Convertir URLs relativas a absolutas para que pasen la validaci√≥n
        const baseUrl = window.location.origin;
        images = images.map(url => {
          // Si ya es una URL absoluta, devolverla tal cual
          if (url.startsWith('http://') || url.startsWith('https://')) {
            return url;
          }
          // Si es una ruta relativa que empieza con /, convertirla a absoluta
          if (url.startsWith('/')) {
            return baseUrl + url;
          }
          // Si es una ruta relativa sin /, agregar /
          return baseUrl + '/' + url;
        });
        
        // Validar que todas las URLs sean v√°lidas
        const invalidUrls = images.filter(url => {
          try {
            const urlObj = new URL(url);
            return !urlObj.protocol || (!urlObj.protocol.startsWith('http') && !urlObj.protocol.startsWith('https'));
          } catch {
            return true; // Si no se puede parsear, es inv√°lida
          }
        });
        
        if (invalidUrls.length > 0) {
          throw new Error('Algunas URLs de im√°genes no son v√°lidas. Por favor, aseg√∫rate de que todas las im√°genes est√©n subidas correctamente.');
        }

        const tourData = {
          name: document.getElementById('tourName').value.trim(),
          description: document.getElementById('tourDescription').value.trim(),
          itinerary: document.getElementById('tourItinerary').value.trim() || null,
          price: parseFloat(document.getElementById('tourPrice').value),
          maxCapacity: parseInt(document.getElementById('tourMaxCapacity').value),
          durationHours: parseInt(document.getElementById('tourDurationHours').value),
          location: document.getElementById('tourLocation').value.trim() || null,
          isActive: document.getElementById('tourIsActive').checked,
          images: images.length > 0 ? images : []
        };

        if (mode === 'edit') {
          const tourId = form.dataset.tourId;
          if (!tourId) {
            throw new Error('ID de tour no encontrado');
          }
          await api.updateTour(tourId, tourData);
        } else {
          await api.createTour(tourData);
        }
        
        if (typeof notificationManager !== 'undefined' && notificationManager) {
          notificationManager.success('Tour guardado exitosamente');
        } else if (typeof window !== 'undefined' && window.notificationManager) {
          window.notificationManager.success('Tour guardado exitosamente');
        }
        closeTourModal();
        loadTours();
      } catch (error) {
        console.error('Error saving tour:', error);
        const errorMessage = error.message || error.detail || 'Error desconocido';
        if (typeof notificationManager !== 'undefined' && notificationManager) {
          notificationManager.error('Error al guardar el tour: ' + errorMessage);
        } else if (typeof window !== 'undefined' && window.notificationManager) {
          window.notificationManager.error('Error al guardar el tour: ' + errorMessage);
        } else {
          alert('Error al guardar el tour: ' + errorMessage);
        }
      } finally {
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.classList.remove('btn-loading');
          submitBtn.textContent = mode === 'edit' ? 'Guardar Cambios' : 'Guardar Tour';
        }
      }
    }
    
    function validateTourForm() {
      let isValid = true;
      
      // Validar nombre
      const name = document.getElementById('tourName').value.trim();
      if (!name || name.length < 3) {
        showFieldError('tourNameError', 'El nombre del tour debe tener al menos 3 caracteres');
        isValid = false;
      }
      
      // Validar precio
      const price = parseFloat(document.getElementById('tourPrice').value);
      if (isNaN(price) || price <= 0) {
        showFieldError('tourPriceError', 'El precio debe ser mayor a 0');
        isValid = false;
      }
      
      // Validar duraci√≥n
      const duration = parseInt(document.getElementById('tourDurationHours').value);
      if (isNaN(duration) || duration <= 0) {
        showFieldError('tourDurationHoursError', 'La duraci√≥n debe ser mayor a 0 horas');
        isValid = false;
      }
      
      // Validar capacidad
      const capacity = parseInt(document.getElementById('tourMaxCapacity').value);
      if (isNaN(capacity) || capacity <= 0) {
        showFieldError('tourMaxCapacityError', 'La capacidad debe ser mayor a 0');
        isValid = false;
      }
      
      // Validar descripci√≥n
      const description = document.getElementById('tourDescription').value.trim();
      if (!description || description.length < 50) {
        showFieldError('tourDescriptionError', 'La descripci√≥n debe tener al menos 50 caracteres');
        isValid = false;
      }
      
      // Validar im√°genes (obligatorio al menos 1)
      if (tourImages.length === 0) {
        showImageError('‚ö†Ô∏è Debes agregar al menos una imagen al tour. Puedes arrastrar y soltar im√°genes o hacer clic en el √°rea de carga.');
        isValid = false;
      }
      
      return isValid;
    }
    
    function showFieldError(fieldId, message) {
      const errorEl = document.getElementById(fieldId);
      if (errorEl) {
        errorEl.textContent = message;
        errorEl.style.display = 'flex';
      }
      // Agregar clase de error al input
      const fieldName = fieldId.replace('Error', '');
      const input = document.getElementById(fieldName);
      if (input) {
        input.classList.add('input-error');
      }
    }
    
    function clearAllErrors() {
      const errorFields = ['tourNameError', 'tourPriceError', 'tourDurationHoursError', 'tourMaxCapacityError', 'tourDescriptionError', 'tourImagesError'];
      errorFields.forEach(fieldId => {
        const errorEl = document.getElementById(fieldId);
        if (errorEl) errorEl.style.display = 'none';
      });
      
      // Remover clases de error de los inputs
      const inputs = ['tourName', 'tourPrice', 'tourDurationHours', 'tourMaxCapacity', 'tourDescription'];
      inputs.forEach(inputId => {
        const input = document.getElementById(inputId);
        if (input) input.classList.remove('input-error');
      });
      
      clearImageError();
    }

    async function deleteTour(id) {
      // Validar que el ID existe y no est√° vac√≠o
      if (!id || id === 'undefined' || id === 'null' || (typeof id === 'string' && id.trim() === '')) {
        notificationManager.error('ID de tour no v√°lido');
        return;
      }
      
      if (!confirm('¬øEst√°s seguro de eliminar este tour? Se desactivar√° si tiene reservas activas.')) return;
      
      try {
        await api.deleteTour(id);
        if (typeof notificationManager !== 'undefined' && notificationManager) {
          notificationManager.success('Tour eliminado/desactivado exitosamente');
        } else if (typeof window !== 'undefined' && window.notificationManager) {
          window.notificationManager.success('Tour eliminado/desactivado exitosamente');
        } else {
          alert('Tour eliminado/desactivado exitosamente');
        }
        loadTours();
      } catch (error) {
        console.error('Error deleting tour:', error);
        const errorMessage = error.message || error.detail || 'Error desconocido';
        if (typeof notificationManager !== 'undefined' && notificationManager) {
          notificationManager.error('Error al eliminar el tour: ' + errorMessage);
        } else if (typeof window !== 'undefined' && window.notificationManager) {
          window.notificationManager.error('Error al eliminar el tour: ' + errorMessage);
        } else {
          alert('Error al eliminar el tour: ' + errorMessage);
        }
      }
    }

    // User Functions
    async function viewUser(id) {
      try {
        const user = await api.getAdminUser(id);
        const modal = document.createElement('div');
        modal.className = 'modal active';
        modal.innerHTML = `
          <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
              <h3>Detalles del Usuario</h3>
              <button class="modal-close" onclick="this.closest('.modal').remove()">√ó</button>
            </div>
            <div class="admin-card">
              <h4>${user.firstName} ${user.lastName}</h4>
              <p><strong>Email:</strong> ${user.email}</p>
              <p><strong>Tel√©fono:</strong> ${user.phone || 'N/A'}</p>
              <p><strong>Roles:</strong> ${user.roles.join(', ')}</p>
              <p><strong>Estado:</strong> ${user.isActive ? 'Activo' : 'Inactivo'}</p>
              <p><strong>Reservas Totales:</strong> ${user.totalBookings || 0}</p>
              <p><strong>√öltimo Login:</strong> ${user.lastLoginAt ? new Date(user.lastLoginAt).toLocaleString('es-PA') : 'Nunca'}</p>
              ${user.lockedUntil && new Date(user.lockedUntil) > new Date() ? 
                `<p><strong>Bloqueado hasta:</strong> ${new Date(user.lockedUntil).toLocaleString('es-PA')}</p>` : ''}
              ${user.bookings && user.bookings.length > 0 ? `
                <h5>Reservas:</h5>
                <ul>
                  ${user.bookings.map(b => `<li>${b.tourName} - ${b.status} - ${formatPrice(b.totalAmount)}</li>`).join('')}
                </ul>
              ` : ''}
            </div>
          </div>
        `;
        document.body.appendChild(modal);
      } catch (error) {
        console.error('Error loading user:', error);
        const errorMessage = error.message || error.detail || 'Error desconocido';
        notificationManager.error('Error al cargar el usuario: ' + errorMessage);
      }
    }

    async function editUser(id) {
      if (!id || id === 'undefined') {
        console.error('ID de usuario inv√°lido:', id);
        return;
      }
      try {
        const user = await api.getAdminUser(id);
        const roles = await api.getAdminRoles();
        
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.innerHTML = `
          <div class="modal-content">
            <div class="modal-header">
              <h3>Editar Usuario</h3>
              <button class="modal-close" onclick="this.closest('.modal').remove()">√ó</button>
            </div>
            <form onsubmit="saveUser(event, '${id}')">
              <div class="form-grid">
                <div class="form-group">
                  <label>Nombre</label>
                  <input type="text" id="userFirstName" class="form-input" value="${user.firstName}" />
                </div>
                <div class="form-group">
                  <label>Apellido</label>
                  <input type="text" id="userLastName" class="form-input" value="${user.lastName}" />
                </div>
                <div class="form-group">
                  <label>Tel√©fono</label>
                  <input type="text" id="userPhone" class="form-input" value="${user.phone || ''}" />
                </div>
                <div class="form-group full-width">
                  <label>Roles</label>
                  ${roles.map(role => `
                    <label style="display: block; margin-bottom: 8px;">
                      <input type="checkbox" name="userRoles" value="${role.name}" 
                        ${user.roles.includes(role.name) ? 'checked' : ''} />
                      ${role.name}
                    </label>
                  `).join('')}
                </div>
                <div class="form-group">
                  <label>
                    <input type="checkbox" id="userIsActive" ${user.isActive ? 'checked' : ''} /> Activo
                  </label>
                </div>
              </div>
              <div style="margin-top: var(--spacing-lg); display: flex; gap: var(--spacing-md);">
                <button type="submit" class="btn-primary">Guardar</button>
                <button type="button" class="btn-secondary" onclick="this.closest('.modal').remove()">Cancelar</button>
              </div>
            </form>
          </div>
        `;
        document.body.appendChild(modal);
      } catch (error) {
        console.error('Error loading user:', error);
        const errorMessage = error.message || error.detail || 'Error desconocido';
        notificationManager.error('Error al cargar el usuario: ' + errorMessage);
      }
    }

    async function saveUser(event, userId) {
      event.preventDefault();
      try {
        const roles = Array.from(document.querySelectorAll('input[name="userRoles"]:checked')).map(cb => cb.value);
        
        const userData = {
          firstName: document.getElementById('userFirstName').value || null,
          lastName: document.getElementById('userLastName').value || null,
          phone: document.getElementById('userPhone').value || null,
          isActive: document.getElementById('userIsActive').checked,
          roles: roles
        };
        
        await api.updateAdminUser(userId, userData);
        notificationManager.success('Usuario actualizado exitosamente');
        document.querySelector('.modal').remove();
        loadUsers();
      } catch (error) {
        console.error('Error saving user:', error);
        const errorMessage = error.message || error.detail || 'Error desconocido';
        notificationManager.error('Error al guardar el usuario: ' + errorMessage);
      }
    }

    async function unlockUser(id) {
      if (!confirm('¬øEst√°s seguro de desbloquear este usuario?')) return;
      try {
        await api.unlockAdminUser(id);
        notificationManager.success('Usuario desbloqueado exitosamente');
        loadUsers();
      } catch (error) {
        console.error('Error unlocking user:', error);
        const errorMessage = error.message || error.detail || 'Error desconocido';
        notificationManager.error('Error al desbloquear el usuario: ' + errorMessage);
      }
    }

    // Tour Dates Management
    async function manageTourDates(tourId) {
      try {
        const tour = await api.getAdminTour(tourId);
        const dates = await api.getAdminTourDates(tourId);
        
        const modal = document.createElement('div');
        modal.className = 'modal active';
        modal.innerHTML = `
          <div class="modal-content" style="max-width: 900px;" data-tour-id="${tourId}">
            <div class="modal-header">
              <h3>Gesti√≥n de Fechas - ${tour.name}</h3>
              <button class="modal-close" onclick="closeTourDatesModal()">√ó</button>
            </div>
            <div class="admin-card">
              <div class="admin-header">
                <h4>Fechas del Tour</h4>
                <button class="btn-primary" onclick="showAddTourDateModal('${tourId}')">+ Agregar Fecha</button>
              </div>
              <div class="table-container">
                <table>
                  <thead>
                    <tr>
                      <th>Fecha y Hora</th>
                      <th>Cupos Disponibles</th>
                      <th>Estado</th>
                      <th>Acciones</th>
                    </tr>
                  </thead>
                  <tbody id="tourDatesTableBody">
                    ${dates.length === 0 ? '<tr><td colspan="4" style="text-align: center; color: var(--text-muted);">No hay fechas programadas</td></tr>' : ''}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        `;
        document.body.appendChild(modal);
        
        if (dates.length > 0) {
          const tbody = document.getElementById('tourDatesTableBody');
          tbody.innerHTML = dates.map(date => `
            <tr>
              <td>${new Date(date.tourDateTime).toLocaleString('es-PA')}</td>
              <td>${date.availableSpots}</td>
              <td><span class="badge ${date.isActive ? 'active' : 'inactive'}">${date.isActive ? 'Activa' : 'Inactiva'}</span></td>
              <td>
                <div class="action-buttons">
                  <button class="btn-sm btn-primary" onclick="editTourDate('${date.id}', '${tourId}')">Editar</button>
                  <button class="btn-sm btn-secondary" onclick="deleteTourDateConfirm('${date.id}')">Eliminar</button>
                </div>
              </td>
            </tr>
          `).join('');
        }
      } catch (error) {
        console.error('Error loading tour dates:', error);
        const errorMessage = error.message || error.detail || 'Error desconocido';
        notificationManager.error('Error al cargar las fechas: ' + errorMessage);
      }
    }

    function closeTourDatesModal() {
      const modal = document.querySelector('.modal');
      if (modal) modal.remove();
    }

    function showAddTourDateModal(tourId) {
      const modal = document.createElement('div');
      modal.className = 'modal active';
      modal.innerHTML = `
        <div class="modal-content">
          <div class="modal-header">
            <h3>Agregar Fecha al Tour</h3>
            <button class="modal-close" onclick="this.closest('.modal').remove()">√ó</button>
          </div>
          <form onsubmit="saveTourDate(event, '${tourId}', null)">
            <div class="form-grid">
              <div class="form-group">
                <label>Fecha y Hora *</label>
                <input type="datetime-local" id="tourDateDateTime" class="form-input" required />
              </div>
              <div class="form-group">
                <label>Cupos Disponibles *</label>
                <input type="number" id="tourDateSpots" class="form-input" min="0" required />
              </div>
              <div class="form-group">
                <label>
                  <input type="checkbox" id="tourDateIsActive" checked /> Activa
                </label>
              </div>
            </div>
            <div style="margin-top: var(--spacing-lg); display: flex; gap: var(--spacing-md);">
              <button type="submit" class="btn-primary">Guardar</button>
              <button type="button" class="btn-secondary" onclick="this.closest('.modal').remove()">Cancelar</button>
            </div>
          </form>
        </div>
      `;
      document.body.appendChild(modal);
    }

    async function editTourDate(dateId, tourId) {
      try {
        const dates = await api.getAdminTourDates(tourId);
        const date = dates.find(d => d.id === dateId);
        if (!date) {
          notificationManager.warning('Fecha no encontrada');
          return;
        }
        
        // Convertir fecha a formato datetime-local
        const dateTimeLocal = new Date(date.tourDateTime).toISOString().slice(0, 16);
        
        const modal = document.createElement('div');
        modal.className = 'modal active';
        modal.innerHTML = `
          <div class="modal-content">
            <div class="modal-header">
              <h3>Editar Fecha</h3>
              <button class="modal-close" onclick="this.closest('.modal').remove()">√ó</button>
            </div>
            <form onsubmit="saveTourDate(event, '${tourId}', '${dateId}')">
              <div class="form-grid">
                <div class="form-group">
                  <label>Fecha y Hora *</label>
                  <input type="datetime-local" id="tourDateDateTime" class="form-input" value="${dateTimeLocal}" required />
                </div>
                <div class="form-group">
                  <label>Cupos Disponibles *</label>
                  <input type="number" id="tourDateSpots" class="form-input" min="0" value="${date.availableSpots}" required />
                </div>
                <div class="form-group">
                  <label>
                    <input type="checkbox" id="tourDateIsActive" ${date.isActive ? 'checked' : ''} /> Activa
                  </label>
                </div>
              </div>
              <div style="margin-top: var(--spacing-lg); display: flex; gap: var(--spacing-md);">
                <button type="submit" class="btn-primary">Guardar</button>
                <button type="button" class="btn-secondary" onclick="this.closest('.modal').remove()">Cancelar</button>
              </div>
            </form>
          </div>
        `;
        document.body.appendChild(modal);
      } catch (error) {
        console.error('Error loading tour date:', error);
        const errorMessage = error.message || error.detail || 'Error desconocido';
        notificationManager.error('Error al cargar la fecha: ' + errorMessage);
      }
    }

    async function saveTourDate(event, tourId, dateId) {
      event.preventDefault();
      try {
        const dateTimeInput = document.getElementById('tourDateDateTime').value;
        const dateTime = new Date(dateTimeInput);
        
        const dateData = {
          tourDateTime: dateTime.toISOString(),
          availableSpots: parseInt(document.getElementById('tourDateSpots').value),
          isActive: document.getElementById('tourDateIsActive').checked
        };
        
        if (dateId) {
          await api.updateTourDate(dateId, dateData);
        } else {
          await api.createTourDate(tourId, dateData);
        }
        
        notificationManager.success('Fecha guardada exitosamente');
        // Cerrar modal de formulario
        document.querySelector('.modal').remove();
        // Recargar modal de fechas si existe, sino cerrar todo
        const datesModal = document.querySelector('.modal-content[data-tour-id]');
        if (datesModal) {
          const modalTourId = datesModal.dataset.tourId;
          if (modalTourId) {
            // Cerrar modal actual y recargar
            document.querySelector('.modal')?.remove();
            manageTourDates(modalTourId);
          }
        } else {
          closeTourDatesModal();
          manageTourDates(tourId);
        }
      } catch (error) {
        console.error('Error saving tour date:', error);
        const errorMessage = error.message || error.detail || 'Error desconocido';
        notificationManager.error('Error al guardar la fecha: ' + errorMessage);
      }
    }

    async function deleteTourDateConfirm(dateId) {
      if (!confirm('¬øEst√°s seguro de eliminar esta fecha? Se desactivar√° si tiene reservas confirmadas.')) return;
      try {
        await api.deleteTourDate(dateId);
        notificationManager.success('Fecha eliminada/desactivada exitosamente');
        // Recargar modal de fechas
        const modalContent = document.querySelector('.modal-content[data-tour-id]');
        const tourId = modalContent?.dataset.tourId;
        if (tourId) {
          manageTourDates(tourId);
        } else {
          closeTourDatesModal();
          loadTours();
        }
      } catch (error) {
        console.error('Error deleting tour date:', error);
        const errorMessage = error.message || error.detail || 'Error desconocido';
        notificationManager.error('Error al eliminar la fecha: ' + errorMessage);
      }
    }

    async function loadHomePageContent() {
      try {
        const cmsContent = await api.getAdminHomePageContent();
        const contentDiv = document.getElementById('cms');
        
        contentDiv.innerHTML = `
          <div class="admin-card">
            <h2>Contenido de la P√°gina de Inicio</h2>
            <form id="cmsForm" onsubmit="saveHomePageContent(event)">
              
              <!-- Secci√≥n: Im√°genes y Branding -->
              <div class="form-section" style="margin-bottom: var(--spacing-xl);">
                <h3>üñºÔ∏è Im√°genes y Branding</h3>
                <div class="form-grid">
                  <div class="form-group full-width">
                    <label>Logo Principal</label>
                    <div class="image-upload-container">
                      <div class="image-preview-wrapper" id="logoPreviewWrapper">
                        ${cmsContent.logoUrl ? `
                          <img src="${cmsContent.logoUrl}" alt="Logo preview" id="logoPreview" class="image-preview" />
                          <button type="button" class="image-remove-btn" onclick="removeCMSImage('cmsLogoUrl', 'logoPreviewWrapper')" title="Eliminar">√ó</button>
                        ` : `
                          <div class="image-placeholder">
                            <span>Sin imagen</span>
                          </div>
                        `}
                      </div>
                      <div style="display: flex; gap: 8px; margin-top: 8px;">
                        <input type="text" id="cmsLogoUrl" class="form-input" value="${cmsContent.logoUrl || ''}" placeholder="URL de la imagen o sube una nueva" style="flex: 1;" />
                        <input type="file" id="cmsLogoUrlFile" accept="image/*" style="display: none;" onchange="uploadCMSImage('cmsLogoUrlFile', 'cmsLogoUrl', 'logoPreviewWrapper', 'logoPreview')" />
                        <button type="button" class="btn-sm btn-primary" onclick="document.getElementById('cmsLogoUrlFile').click()">üì§ Subir</button>
                        <button type="button" class="btn-sm btn-secondary" onclick="selectMediaForCMS('cmsLogoUrl', 'logoPreviewWrapper', 'logoPreview')">üìÅ Seleccionar</button>
                      </div>
                      <small style="color: var(--text-muted); margin-top: 4px; display: block;">Recomendado: 200x60px, formato PNG con fondo transparente</small>
                    </div>
                  </div>
                  
                  <div class="form-group">
                    <label>Favicon</label>
                    <div class="image-upload-container">
                      <div class="image-preview-wrapper" id="faviconPreviewWrapper" style="width: 64px; height: 64px;">
                        ${cmsContent.faviconUrl ? `
                          <img src="${cmsContent.faviconUrl}" alt="Favicon preview" id="faviconPreview" class="image-preview" />
                          <button type="button" class="image-remove-btn" onclick="removeCMSImage('cmsFaviconUrl', 'faviconPreviewWrapper')" title="Eliminar">√ó</button>
                        ` : `
                          <div class="image-placeholder">
                            <span>16x16</span>
                          </div>
                        `}
                      </div>
                      <div style="display: flex; gap: 8px; margin-top: 8px;">
                        <input type="text" id="cmsFaviconUrl" class="form-input" value="${cmsContent.faviconUrl || ''}" placeholder="URL del favicon" style="flex: 1;" />
                        <input type="file" id="cmsFaviconUrlFile" accept="image/*,.ico" style="display: none;" onchange="uploadCMSImage('cmsFaviconUrlFile', 'cmsFaviconUrl', 'faviconPreviewWrapper', 'faviconPreview')" />
                        <button type="button" class="btn-sm btn-primary" onclick="document.getElementById('cmsFaviconUrlFile').click()">üì§ Subir</button>
                      </div>
                      <small style="color: var(--text-muted); margin-top: 4px; display: block;">Recomendado: 32x32px o 16x16px, formato ICO</small>
                    </div>
                  </div>
                  
                  <div class="form-group">
                    <label>Logo Redes Sociales (Open Graph)</label>
                    <div class="image-upload-container">
                      <div class="image-preview-wrapper" id="socialLogoPreviewWrapper">
                        ${cmsContent.logoUrlSocial ? `
                          <img src="${cmsContent.logoUrlSocial}" alt="Social logo preview" id="socialLogoPreview" class="image-preview" />
                          <button type="button" class="image-remove-btn" onclick="removeCMSImage('cmsLogoUrlSocial', 'socialLogoPreviewWrapper')" title="Eliminar">√ó</button>
                        ` : `
                          <div class="image-placeholder">
                            <span>Sin imagen</span>
                          </div>
                        `}
                      </div>
                      <div style="display: flex; gap: 8px; margin-top: 8px;">
                        <input type="text" id="cmsLogoUrlSocial" class="form-input" value="${cmsContent.logoUrlSocial || ''}" placeholder="URL de la imagen" style="flex: 1;" />
                        <input type="file" id="cmsLogoUrlSocialFile" accept="image/*" style="display: none;" onchange="uploadCMSImage('cmsLogoUrlSocialFile', 'cmsLogoUrlSocial', 'socialLogoPreviewWrapper', 'socialLogoPreview')" />
                        <button type="button" class="btn-sm btn-primary" onclick="document.getElementById('cmsLogoUrlSocialFile').click()">üì§ Subir</button>
                      </div>
                      <small style="color: var(--text-muted); margin-top: 4px; display: block;">Recomendado: 1200x630px para Open Graph</small>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Secci√≥n: Hero Section -->
              <div class="form-section" style="margin-bottom: var(--spacing-xl);">
                <h3>üéØ Hero Section (Banner Principal)</h3>
                <div class="form-grid">
                <div class="form-group full-width">
                  <label>T√≠tulo del Hero</label>
                  <input type="text" id="cmsHeroTitle" class="form-input" value="${cmsContent.heroTitle || ''}" placeholder="T√≠tulo principal" />
                </div>
                <div class="form-group full-width">
                  <label>Subt√≠tulo del Hero</label>
                  <textarea id="cmsHeroSubtitle" class="form-input" rows="3" placeholder="Subt√≠tulo del hero">${cmsContent.heroSubtitle || ''}</textarea>
                </div>
                <div class="form-group">
                  <label>Placeholder de B√∫squeda</label>
                  <input type="text" id="cmsHeroSearchPlaceholder" class="form-input" value="${cmsContent.heroSearchPlaceholder || ''}" placeholder="Buscar tours..." />
                </div>
                <div class="form-group">
                  <label>Texto del Bot√≥n de B√∫squeda</label>
                  <input type="text" id="cmsHeroSearchButton" class="form-input" value="${cmsContent.heroSearchButton || ''}" placeholder="Buscar" />
                </div>
                <div class="form-group full-width">
                  <label>T√≠tulo de la Secci√≥n de Tours</label>
                  <input type="text" id="cmsToursSectionTitle" class="form-input" value="${cmsContent.toursSectionTitle || ''}" placeholder="Nuestros Tours" />
                </div>
                <div class="form-group full-width">
                  <label>Subt√≠tulo de la Secci√≥n de Tours</label>
                  <textarea id="cmsToursSectionSubtitle" class="form-input" rows="2" placeholder="Descubre nuestras ofertas">${cmsContent.toursSectionSubtitle || ''}</textarea>
                </div>
                <div class="form-group">
                  <label>Texto: Cargando Tours</label>
                  <input type="text" id="cmsLoadingToursText" class="form-input" value="${cmsContent.loadingToursText || ''}" placeholder="Cargando tours..." />
                </div>
                <div class="form-group">
                  <label>Texto: Error Cargando Tours</label>
                  <input type="text" id="cmsErrorLoadingToursText" class="form-input" value="${cmsContent.errorLoadingToursText || ''}" placeholder="Error al cargar tours" />
                </div>
                <div class="form-group">
                  <label>Texto: No Hay Tours</label>
                  <input type="text" id="cmsNoToursFoundText" class="form-input" value="${cmsContent.noToursFoundText || ''}" placeholder="No se encontraron tours" />
                </div>
                </div>
              </div>
              
              <!-- Secci√≥n: Navegaci√≥n -->
              <div class="form-section" style="margin-bottom: var(--spacing-xl);">
                <h3>üß≠ Navegaci√≥n</h3>
                <div class="form-grid">
                <div class="form-group">
                  <label>Texto de la Marca en Nav</label>
                  <input type="text" id="cmsNavBrandText" class="form-input" value="${cmsContent.navBrandText || ''}" placeholder="ToursPanama" />
                </div>
                <div class="form-group">
                  <label>Link Nav: Tours</label>
                  <input type="text" id="cmsNavToursLink" class="form-input" value="${cmsContent.navToursLink || ''}" placeholder="Tours" />
                </div>
                <div class="form-group">
                  <label>Link Nav: Reservas</label>
                  <input type="text" id="cmsNavBookingsLink" class="form-input" value="${cmsContent.navBookingsLink || ''}" placeholder="Mis Reservas" />
                </div>
                <div class="form-group">
                  <label>Link Nav: Login</label>
                  <input type="text" id="cmsNavLoginLink" class="form-input" value="${cmsContent.navLoginLink || ''}" placeholder="Iniciar Sesi√≥n" />
                </div>
                <div class="form-group">
                  <label>Bot√≥n Nav: Logout</label>
                  <input type="text" id="cmsNavLogoutButton" class="form-input" value="${cmsContent.navLogoutButton || ''}" placeholder="Cerrar Sesi√≥n" />
                </div>
                </div>
              </div>
              
              <!-- Secci√≥n: Footer -->
              <div class="form-section" style="margin-bottom: var(--spacing-xl);">
                <h3>üìÑ Footer</h3>
                <div class="form-grid">
                <div class="form-group full-width">
                  <label>Texto de la Marca del Footer</label>
                  <input type="text" id="cmsFooterBrandText" class="form-input" value="${cmsContent.footerBrandText || ''}" placeholder="ToursPanama" />
                </div>
                <div class="form-group full-width">
                  <label>Descripci√≥n del Footer</label>
                  <textarea id="cmsFooterDescription" class="form-input" rows="3" placeholder="Descripci√≥n del footer">${cmsContent.footerDescription || ''}</textarea>
                </div>
                <div class="form-group full-width">
                  <label>Copyright del Footer</label>
                  <input type="text" id="cmsFooterCopyright" class="form-input" value="${cmsContent.footerCopyright || ''}" placeholder="¬© 2024 ToursPanama" />
                </div>
                </div>
              </div>
              
              <!-- Secci√≥n: SEO -->
              <div class="form-section" style="margin-bottom: var(--spacing-xl);">
                <h3>üîç SEO (Optimizaci√≥n para Motores de B√∫squeda)</h3>
                <div class="form-grid">
                <div class="form-group full-width">
                  <label>T√≠tulo de la P√°gina (SEO)</label>
                  <input type="text" id="cmsPageTitle" class="form-input" value="${cmsContent.pageTitle || ''}" placeholder="ToursPanama ‚Äî Descubre los Mejores Tours" />
                  <small style="color: var(--text-muted); margin-top: 4px; display: block;">Aparece en la pesta√±a del navegador y en los resultados de b√∫squeda</small>
                </div>
                <div class="form-group full-width">
                  <label>Meta Description (SEO)</label>
                  <textarea id="cmsMetaDescription" class="form-input" rows="2" placeholder="Meta descripci√≥n para SEO">${cmsContent.metaDescription || ''}</textarea>
                  <small style="color: var(--text-muted); margin-top: 4px; display: block;">Descripci√≥n que aparece en los resultados de b√∫squeda (m√°x. 160 caracteres)</small>
                </div>
                </div>
              </div>
              <div style="margin-top: var(--spacing-xl);">
                <button type="submit" class="btn-primary">Guardar Cambios</button>
              </div>
            </form>
          </div>
        `;
      } catch (error) {
        console.error('Error loading CMS content:', error);
        document.getElementById('cms').innerHTML = 
          '<div class="admin-card"><p style="color: var(--error);">Error al cargar el contenido del CMS</p></div>';
      }
    }

    async function saveHomePageContent(event) {
      event.preventDefault();
      try {
        // Funci√≥n helper para convertir string vac√≠o a null
        const toNullIfEmpty = (value) => {
          const trimmed = value?.trim();
          return trimmed === '' ? null : (trimmed || null);
        };
        
        const contentData = {
          // Campos de im√°genes: convertir string vac√≠o a null expl√≠citamente
          logoUrl: toNullIfEmpty(document.getElementById('cmsLogoUrl').value),
          faviconUrl: toNullIfEmpty(document.getElementById('cmsFaviconUrl').value),
          logoUrlSocial: toNullIfEmpty(document.getElementById('cmsLogoUrlSocial').value),
          // Campos de texto: solo enviar si tienen contenido (backend solo actualiza si no est√° vac√≠o)
          heroTitle: toNullIfEmpty(document.getElementById('cmsHeroTitle').value),
          heroSubtitle: toNullIfEmpty(document.getElementById('cmsHeroSubtitle').value),
          heroSearchPlaceholder: toNullIfEmpty(document.getElementById('cmsHeroSearchPlaceholder').value),
          heroSearchButton: toNullIfEmpty(document.getElementById('cmsHeroSearchButton').value),
          toursSectionTitle: toNullIfEmpty(document.getElementById('cmsToursSectionTitle').value),
          toursSectionSubtitle: toNullIfEmpty(document.getElementById('cmsToursSectionSubtitle').value),
          loadingToursText: toNullIfEmpty(document.getElementById('cmsLoadingToursText').value),
          errorLoadingToursText: toNullIfEmpty(document.getElementById('cmsErrorLoadingToursText').value),
          noToursFoundText: toNullIfEmpty(document.getElementById('cmsNoToursFoundText').value),
          footerBrandText: toNullIfEmpty(document.getElementById('cmsFooterBrandText').value),
          footerDescription: toNullIfEmpty(document.getElementById('cmsFooterDescription').value),
          footerCopyright: toNullIfEmpty(document.getElementById('cmsFooterCopyright').value),
          navBrandText: toNullIfEmpty(document.getElementById('cmsNavBrandText').value),
          navToursLink: toNullIfEmpty(document.getElementById('cmsNavToursLink').value),
          navBookingsLink: toNullIfEmpty(document.getElementById('cmsNavBookingsLink').value),
          navLoginLink: toNullIfEmpty(document.getElementById('cmsNavLoginLink').value),
          navLogoutButton: toNullIfEmpty(document.getElementById('cmsNavLogoutButton').value),
          pageTitle: toNullIfEmpty(document.getElementById('cmsPageTitle').value),
          metaDescription: toNullIfEmpty(document.getElementById('cmsMetaDescription').value)
        };
        
        await api.updateAdminHomePageContent(contentData);
        notificationManager.success('Contenido guardado exitosamente');
        loadHomePageContent(); // Recargar para mostrar datos actualizados
      } catch (error) {
        console.error('Error saving CMS content:', error);
        const errorMessage = error.message || error.detail || 'Error desconocido';
        notificationManager.error('Error al guardar el contenido: ' + errorMessage);
      }
    }

    // Funci√≥n para subir imagen directamente desde CMS
    async function uploadCMSImage(fileInputId, urlInputId, previewWrapperId, previewImgId) {
      const fileInput = document.getElementById(fileInputId);
      const file = fileInput.files[0];
      if (!file) return;
      
      try {
        // Subir usando el endpoint de media
        const result = await api.uploadMediaFile(file, null, null, 'cms');
        
        // Actualizar el input con la URL
        document.getElementById(urlInputId).value = result.fileUrl;
        
        // Actualizar preview
        const previewWrapper = document.getElementById(previewWrapperId);
        if (previewWrapper && previewImgId) {
          previewWrapper.innerHTML = `
            <img src="${result.fileUrl}" alt="Preview" id="${previewImgId}" class="image-preview" />
            <button type="button" class="image-remove-btn" onclick="removeCMSImage('${urlInputId}', '${previewWrapperId}')" title="Eliminar">√ó</button>
          `;
        } else if (previewWrapper) {
          previewWrapper.innerHTML = `
            <img src="${result.fileUrl}" alt="Preview" class="image-preview" />
            <button type="button" class="image-remove-btn" onclick="removeCMSImage('${urlInputId}', '${previewWrapperId}')" title="Eliminar">√ó</button>
          `;
        }
        
        notificationManager.success('Imagen subida exitosamente');
      } catch (error) {
        console.error('Error uploading CMS image:', error);
        const errorMessage = error.message || error.detail || 'Error desconocido';
        notificationManager.error('Error al subir la imagen: ' + errorMessage);
      }
      
      // Limpiar input file
      fileInput.value = '';
    }
    
    // Funci√≥n para eliminar imagen del CMS
    function removeCMSImage(inputId, previewWrapperId) {
      if (confirm('¬øEst√°s seguro de eliminar esta imagen?')) {
        document.getElementById(inputId).value = '';
        const previewWrapper = document.getElementById(previewWrapperId);
        if (previewWrapper) {
          previewWrapper.innerHTML = `
            <div class="image-placeholder">
              <span>Sin imagen</span>
            </div>
          `;
        }
      }
    }

    // Funci√≥n para seleccionar im√°genes de la media library
    async function selectMediaForCMS(inputId, previewWrapperId, previewImgId) {
      try {
        const mediaFiles = await api.getAdminMedia(null, true, 1, 50); // Solo im√°genes, primera p√°gina
        
        if (mediaFiles.length === 0) {
          notificationManager.warning('No hay im√°genes en la biblioteca de medios. Por favor, sube una imagen primero en la pesta√±a Media.');
          return;
        }
        
        const modal = document.createElement('div');
        modal.className = 'modal active';
        modal.innerHTML = `
          <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
              <h3>Seleccionar Imagen</h3>
              <button class="modal-close" onclick="this.closest('.modal').remove()">√ó</button>
            </div>
            <div class="media-selection-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 16px; max-height: 60vh; overflow-y: auto; padding: 16px;">
              ${mediaFiles.map(file => `
                <div class="media-selection-item" style="border: 2px solid var(--stroke); border-radius: var(--radius); overflow: hidden; cursor: pointer; transition: all 0.2s;" 
                     onmouseover="this.style.borderColor='var(--primary)'" 
                     onmouseout="this.style.borderColor='var(--stroke)'"
                     onclick="selectCMSImageFromLibrary('${file.fileUrl}', '${inputId}', '${previewWrapperId}', '${previewImgId}')">
                  <img src="${file.fileUrl}" alt="${file.fileName}" style="width: 100%; height: 150px; object-fit: cover;" />
                  <div style="padding: 8px; font-size: 0.875rem; color: var(--text-muted);">${file.fileName}</div>
                </div>
              `).join('')}
            </div>
          </div>
        `;
        document.body.appendChild(modal);
      } catch (error) {
        console.error('Error loading media files:', error);
        notificationManager.error('Error al cargar la biblioteca de medios');
      }
    }
    
    // Funci√≥n para seleccionar imagen de la biblioteca
    function selectCMSImageFromLibrary(imageUrl, inputId, previewWrapperId, previewImgId) {
      document.getElementById(inputId).value = imageUrl;
      
      // Actualizar preview
      const previewWrapper = document.getElementById(previewWrapperId);
      if (previewWrapper && previewImgId) {
        previewWrapper.innerHTML = `
          <img src="${imageUrl}" alt="Preview" id="${previewImgId}" class="image-preview" />
          <button type="button" class="image-remove-btn" onclick="removeCMSImage('${inputId}', '${previewWrapperId}')" title="Eliminar">√ó</button>
        `;
      } else if (previewWrapper) {
        previewWrapper.innerHTML = `
          <img src="${imageUrl}" alt="Preview" class="image-preview" />
          <button type="button" class="image-remove-btn" onclick="removeCMSImage('${inputId}', '${previewWrapperId}')" title="Eliminar">√ó</button>
        `;
      }
      
      // Cerrar modal
      document.querySelector('.modal').remove();
    }

    async function loadMediaFiles() {
      try {
        const mediaFiles = await api.getAdminMedia();
        const contentDiv = document.getElementById('media');
        
        contentDiv.innerHTML = `
          <div class="admin-card">
            <div class="admin-header">
              <h2>Biblioteca de Medios</h2>
              <button class="btn-primary" onclick="showUploadMediaModal()">+ Subir Archivo</button>
            </div>
            <div class="media-grid" id="mediaGrid">
              ${mediaFiles.length === 0 ? '<p style="text-align: center; color: var(--text-muted);">No hay archivos de media</p>' : ''}
            </div>
          </div>
        `;
        
        if (mediaFiles.length > 0) {
          const grid = document.getElementById('mediaGrid');
      grid.innerHTML = mediaFiles.map(file => `
            <div class="media-item">
              ${file.isImage ? `<img src="${file.fileUrl}" alt="${file.altText || file.fileName}" />` : 
                `<div class="media-file-icon">üìÑ ${file.fileName}</div>`}
              <div class="media-item-info">
                <div class="media-item-name">${file.fileName}</div>
                <div class="media-item-meta">${(file.fileSize / 1024).toFixed(2)} KB</div>
                ${file.category ? `<div class="media-item-category">${file.category}</div>` : ''}
            </div>
              <div class="media-item-actions">
                <button class="btn-sm btn-primary" onclick="selectMediaFile('${file.fileUrl}')">Seleccionar</button>
                <button class="btn-sm btn-secondary" onclick="deleteMediaFile('${file.id}')">Eliminar</button>
          </div>
        </div>
      `).join('');
    }
      } catch (error) {
        console.error('Error loading media files:', error);
        document.getElementById('media').innerHTML = 
          '<div class="admin-card"><p style="color: var(--error);">Error al cargar archivos de media</p></div>';
      }
    }

    function showUploadMediaModal() {
      const modal = document.createElement('div');
      modal.className = 'modal active';
      modal.innerHTML = `
        <div class="modal-content">
          <div class="modal-header">
            <h3>Subir Archivo</h3>
            <button class="modal-close" onclick="this.closest('.modal').remove()">√ó</button>
          </div>
          <form onsubmit="uploadMediaFile(event)">
            <div class="form-group">
              <label>Archivo</label>
              <input type="file" id="mediaFileInput" class="form-input" required />
            </div>
            <div class="form-group">
              <label>Texto Alternativo (Alt Text)</label>
              <input type="text" id="mediaAltText" class="form-input" placeholder="Descripci√≥n de la imagen" />
            </div>
            <div class="form-group">
              <label>Descripci√≥n</label>
              <textarea id="mediaDescription" class="form-input" rows="3" placeholder="Descripci√≥n del archivo"></textarea>
            </div>
            <div class="form-group">
              <label>Categor√≠a</label>
              <input type="text" id="mediaCategory" class="form-input" placeholder="Tours, General, etc." />
            </div>
            <div style="margin-top: var(--spacing-lg); display: flex; gap: var(--spacing-md);">
              <button type="submit" class="btn-primary">Subir</button>
              <button type="button" class="btn-secondary" onclick="this.closest('.modal').remove()">Cancelar</button>
            </div>
          </form>
        </div>
      `;
      document.body.appendChild(modal);
    }

    async function uploadMediaFile(event) {
      event.preventDefault();
      try {
      const fileInput = document.getElementById('mediaFileInput');
        const file = fileInput.files[0];
      if (!file) {
        notificationManager.warning('Por favor selecciona un archivo');
        return;
      }

        const altText = document.getElementById('mediaAltText').value || null;
        const description = document.getElementById('mediaDescription').value || null;
        const category = document.getElementById('mediaCategory').value || null;
        
        await api.uploadMediaFile(file, altText, description, category);
        notificationManager.success('Archivo subido exitosamente');
        document.querySelector('.modal').remove();
        loadMediaFiles();
      } catch (error) {
        console.error('Error uploading media file:', error);
        const errorMessage = error.message || error.detail || 'Error desconocido';
        notificationManager.error('Error al subir el archivo: ' + errorMessage);
      }
    }

    function selectMediaFile(url) {
      // Esta funci√≥n puede usarse para seleccionar archivos en otros formularios
      console.log('Archivo seleccionado:', url);
      notificationManager.success('URL copiada al portapapeles: ' + url);
    }

    async function deleteMediaFile(mediaId) {
      if (!confirm('¬øEst√°s seguro de eliminar este archivo?')) return;
      try {
        await api.deleteMediaFile(mediaId);
        notificationManager.success('Archivo eliminado exitosamente');
        loadMediaFiles();
      } catch (error) {
        console.error('Error deleting media file:', error);
        const errorMessage = error.message || error.detail || 'Error desconocido';
        notificationManager.error('Error al eliminar el archivo: ' + errorMessage);
      }
    }

    async function loadPages() {
      try {
        const pages = await api.getAdminPages();
        const contentDiv = document.getElementById('pages');
        
        contentDiv.innerHTML = `
          <div class="admin-card">
            <div class="admin-header">
              <h2>Gesti√≥n de P√°ginas</h2>
              <button class="btn-primary" onclick="showAddPageModal()">+ Nueva P√°gina</button>
            </div>
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>T√≠tulo</th>
                    <th>Slug</th>
                    <th>Estado</th>
                    <th>Fecha</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody id="pagesTableBody">
                  ${pages.length === 0 ? '<tr><td colspan="5" style="text-align: center; color: var(--text-muted);">No hay p√°ginas</td></tr>' : ''}
                </tbody>
              </table>
            </div>
          </div>
        `;
        
        if (pages.length > 0) {
      const tbody = document.getElementById('pagesTableBody');
      tbody.innerHTML = pages.map(page => `
        <tr>
              <td>${page.title}</td>
              <td>${page.slug}</td>
          <td><span class="badge ${page.isPublished ? 'active' : 'inactive'}">${page.isPublished ? 'Publicada' : 'Borrador'}</span></td>
              <td>${new Date(page.createdAt).toLocaleDateString('es-PA')}</td>
              <td>
                <div class="action-buttons">
                  <button class="btn-sm btn-primary" onclick="editPage('${page.id}')">Editar</button>
                  <button class="btn-sm btn-secondary" onclick="deletePage('${page.id}')">Eliminar</button>
                </div>
          </td>
        </tr>
      `).join('');
        }
      } catch (error) {
        console.error('Error loading pages:', error);
        document.getElementById('pages').innerHTML = 
          '<div class="admin-card"><p style="color: var(--error);">Error al cargar p√°ginas</p></div>';
      }
    }

    function showAddPageModal() {
      const modal = document.createElement('div');
      modal.className = 'modal active';
      modal.innerHTML = `
        <div class="modal-content" style="max-width: 800px;">
          <div class="modal-header">
            <h3>Nueva P√°gina</h3>
            <button class="modal-close" onclick="closePageModal()">√ó</button>
          </div>
          <form id="pageForm" onsubmit="savePage(event)">
            <div class="form-grid">
              <div class="form-group">
                <label>T√≠tulo *</label>
                <input type="text" id="pageTitle" class="form-input" required />
              </div>
              <div class="form-group">
                <label>Slug *</label>
                <input type="text" id="pageSlug" class="form-input" required />
              </div>
              <div class="form-group full-width">
                <label>Contenido</label>
                <textarea id="pageContent" class="form-input" rows="10"></textarea>
              </div>
              <div class="form-group">
                <label>Resumen (Excerpt)</label>
                <textarea id="pageExcerpt" class="form-input" rows="2"></textarea>
              </div>
              <div class="form-group">
                <label>Meta T√≠tulo (SEO)</label>
                <input type="text" id="pageMetaTitle" class="form-input" />
              </div>
              <div class="form-group">
                <label>Meta Description (SEO)</label>
                <textarea id="pageMetaDescription" class="form-input" rows="2"></textarea>
              </div>
              <div class="form-group">
                <label>
                  <input type="checkbox" id="pageIsPublished" /> Publicada
                </label>
              </div>
            </div>
            <div style="margin-top: var(--spacing-lg); display: flex; gap: var(--spacing-md);">
              <button type="submit" class="btn-primary">Guardar</button>
              <button type="button" class="btn-secondary" onclick="closePageModal()">Cancelar</button>
            </div>
          </form>
        </div>
      `;
      document.body.appendChild(modal);
      document.getElementById('pageForm').dataset.mode = 'create';
    }

    function closePageModal() {
      const modal = document.querySelector('.modal');
      if (modal) modal.remove();
    }

    async function editPage(pageId) {
      try {
        const page = await api.getAdminPage(pageId);
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.innerHTML = `
          <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
              <h3>Editar P√°gina</h3>
              <button class="modal-close" onclick="closePageModal()">√ó</button>
            </div>
            <form id="pageForm" onsubmit="savePage(event)">
              <input type="hidden" id="pageId" value="${page.id}" />
              <div class="form-grid">
                <div class="form-group">
                  <label>T√≠tulo *</label>
                  <input type="text" id="pageTitle" class="form-input" value="${page.title}" required />
                </div>
                <div class="form-group">
                  <label>Slug *</label>
                  <input type="text" id="pageSlug" class="form-input" value="${page.slug}" required />
                </div>
                <div class="form-group full-width">
                  <label>Contenido</label>
                  <textarea id="pageContent" class="form-input" rows="10">${page.content || ''}</textarea>
                </div>
                <div class="form-group">
                  <label>Resumen (Excerpt)</label>
                  <textarea id="pageExcerpt" class="form-input" rows="2">${page.excerpt || ''}</textarea>
                </div>
                <div class="form-group">
                  <label>Meta T√≠tulo (SEO)</label>
                  <input type="text" id="pageMetaTitle" class="form-input" value="${page.metaTitle || ''}" />
                </div>
                <div class="form-group">
                  <label>Meta Description (SEO)</label>
                  <textarea id="pageMetaDescription" class="form-input" rows="2">${page.metaDescription || ''}</textarea>
                </div>
                <div class="form-group">
                  <label>
                    <input type="checkbox" id="pageIsPublished" ${page.isPublished ? 'checked' : ''} /> Publicada
                  </label>
                </div>
              </div>
              <div style="margin-top: var(--spacing-lg); display: flex; gap: var(--spacing-md);">
                <button type="submit" class="btn-primary">Guardar</button>
                <button type="button" class="btn-secondary" onclick="closePageModal()">Cancelar</button>
              </div>
            </form>
          </div>
        `;
        document.body.appendChild(modal);
        document.getElementById('pageForm').dataset.mode = 'edit';
        document.getElementById('pageForm').dataset.pageId = pageId;
      } catch (error) {
        console.error('Error loading page:', error);
        const errorMessage = error.message || error.detail || 'Error desconocido';
        notificationManager.error('Error al cargar la p√°gina: ' + errorMessage);
      }
    }

    async function savePage(event) {
      event.preventDefault();
      try {
        const form = event.target;
        const mode = form.dataset.mode;
      const pageData = {
          title: document.getElementById('pageTitle').value,
          slug: document.getElementById('pageSlug').value,
          content: document.getElementById('pageContent').value || null,
          excerpt: document.getElementById('pageExcerpt').value || null,
          metaTitle: document.getElementById('pageMetaTitle').value || null,
          metaDescription: document.getElementById('pageMetaDescription').value || null,
        isPublished: document.getElementById('pageIsPublished').checked
      };

        if (mode === 'edit') {
          const pageId = form.dataset.pageId;
          await api.updatePage(pageId, pageData);
        } else {
          await api.createPage(pageData);
        }
        
        notificationManager.success('P√°gina guardada exitosamente');
        closePageModal();
        loadPages();
      } catch (error) {
        console.error('Error saving page:', error);
        const errorMessage = error.message || error.detail || 'Error desconocido';
        notificationManager.error('Error al guardar la p√°gina: ' + errorMessage);
      }
    }

    async function deletePage(pageId) {
      if (!confirm('¬øEst√°s seguro de eliminar esta p√°gina?')) return;
      try {
        await api.deletePage(pageId);
        notificationManager.success('P√°gina eliminada exitosamente');
        loadPages();
      } catch (error) {
        console.error('Error deleting page:', error);
        const errorMessage = error.message || error.detail || 'Error desconocido';
        notificationManager.error('Error al eliminar la p√°gina: ' + errorMessage);
      }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', async () => {
      // Esperar un momento para asegurar que localStorage est√© disponible
      await new Promise(resolve => setTimeout(resolve, 100));
      
      // Verificar token ANTES de hacer cualquier request
      const token = localStorage.getItem('accessToken') || localStorage.getItem('authToken');
      if (!token) {
        console.warn('‚ö†Ô∏è No hay token, redirigiendo a login');
        window.location.href = '/login.html';
        return;
      }

      console.log('‚úÖ Token encontrado, cargando datos...');

      // Cargar datos
      loadTours();
      // loadStats();

      // Logout button
      const logoutBtn = document.getElementById('logoutBtn');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', async () => {
          try {
            await api.logout();
          } catch (error) {
            console.error('Error en logout:', error);
          }
          localStorage.clear();
          window.location.href = '/';
        });
      }
    });
  </script>
</body>
</html>

