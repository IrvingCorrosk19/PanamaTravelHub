<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Detalle del Tour ‚Äî ToursPanama</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="stylesheet" href="/css/main.css" />
  <link rel="stylesheet" href="/css/detail.css" />
  <link rel="stylesheet" href="/css/loading.css" />
</head>
<body>
  <nav class="nav">
    <div class="nav-inner wrap">
      <div class="brand">
        <div class="mark"></div>
        <a href="/"><span class="brand-text">ToursPanama</span></a>
      </div>
      <div class="nav-links">
        <a href="/" class="nav-link">Tours</a>
        <a href="/reservas.html" class="nav-link">Mis Reservas</a>
        <span class="nav-user-greeting" id="userGreeting" style="display:none;"></span>
        <a href="/login.html" class="nav-link" id="loginLink">Iniciar Sesi√≥n</a>
      </div>
    </div>
  </nav>

  <main class="tour-detail wrap">
    <div id="loadingState" class="loading">
      <div class="spinner"></div>
      <p>Cargando tour...</p>
    </div>

    <div id="tourContent" style="display:none;">
      <!-- Breadcrumb -->
      <div class="breadcrumb">
        <a href="/" class="breadcrumb-link">Inicio</a>
        <span class="breadcrumb-separator">/</span>
        <a href="/" class="breadcrumb-link">Tours</a>
        <span class="breadcrumb-separator">/</span>
        <span class="breadcrumb-current" id="breadcrumbTourName">Tour</span>
      </div>

      <!-- Hero Image Section -->
      <div class="tour-hero">
        <div class="tour-hero-image-container">
          <img id="tourImage" class="tour-hero-image" src="" alt="Tour Image" />
          <div class="tour-hero-overlay"></div>
          <div class="tour-hero-content">
            <div class="tour-badge-large" id="tourBadge">Disponible</div>
            <h1 id="tourTitle" class="tour-hero-title"></h1>
            <div class="tour-hero-meta">
              <div class="tour-meta-item">
                <span class="tour-meta-icon">üìç</span>
                <span id="tourLocation"></span>
              </div>
              <div class="tour-meta-item">
                <span class="tour-meta-icon">‚è±</span>
                <span id="tourDuration"></span>
              </div>
              <div class="tour-meta-item">
                <span class="tour-meta-icon">üë•</span>
                <span id="tourCapacity"></span>
              </div>
              <div class="tour-meta-item" id="tourDateMeta" style="display: none;">
                <span class="tour-meta-icon">üìÖ</span>
                <span id="tourDateDisplay"></span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Image Gallery Section -->
      <div id="imageGallerySection" class="image-gallery-section" style="display:none;">
        <h2 class="gallery-title">Galer√≠a de Im√°genes</h2>
        <div id="imageGallery" class="image-gallery"></div>
      </div>

      <!-- Main Content Grid -->
      <div class="tour-detail-grid">
        <!-- Left Column - Information -->
        <div class="tour-info-section">
          <!-- Description -->
          <section class="info-block">
            <h2 class="info-block-title">Sobre este Tour</h2>
            <p id="tourDescription" class="info-block-text"></p>
          </section>

          <!-- Itinerary -->
          <section class="info-block" id="itinerarySection" style="display:none;">
            <h2 class="info-block-title">Itinerario</h2>
            <div id="tourItinerary" class="itinerary-list"></div>
          </section>

          <!-- What's Included -->
          <section class="info-block" id="includesSection">
            <h2 class="info-block-title">Qu√© Incluye</h2>
            <ul id="includedList" class="included-list">
              <!-- Se cargar√° din√°micamente desde la base de datos -->
              <li class="included-item">
                <span class="included-icon">‚úì</span>
                <span>Cargando...</span>
              </li>
            </ul>
          </section>

          <!-- Important Information -->
          <section class="info-block">
            <h2 class="info-block-title">Informaci√≥n Importante</h2>
            <div class="important-info">
              <div class="important-item">
                <strong>Cancelaci√≥n:</strong> Gratis hasta 24 horas antes
              </div>
              <div class="important-item">
                <strong>Confirmaci√≥n:</strong> Recibir√°s confirmaci√≥n inmediata
              </div>
              <div class="important-item">
                <strong>Idioma:</strong> Espa√±ol e Ingl√©s
              </div>
            </div>
          </section>
        </div>

        <!-- Right Column - Booking Card -->
        <aside class="booking-sidebar">
          <div class="booking-card-sticky">
            <div class="booking-price-section">
              <div class="price-label">Precio por persona</div>
              <div class="price-amount" id="tourPrice"></div>
              <div class="price-note">Impuestos incluidos</div>
            </div>

            <div class="booking-info-grid">
              <div class="booking-info-item">
                <div class="booking-info-label">Duraci√≥n</div>
                <div class="booking-info-value" id="bookingDuration"></div>
              </div>
              <div class="booking-info-item">
                <div class="booking-info-label">Disponibilidad</div>
                <div class="booking-info-value" id="bookingAvailability"></div>
              </div>
              <div class="booking-info-item" id="bookingDateItem" style="display: none;">
                <div class="booking-info-label">Fecha del Tour</div>
                <div class="booking-info-value" id="bookingDate"></div>
              </div>
            </div>

            <div class="booking-divider"></div>

            <button class="btn-booking" onclick="bookTour()">
              <span class="btn-booking-text">Reservar Ahora</span>
              <span class="btn-booking-icon">‚Üí</span>
            </button>

            <div class="booking-guarantee">
              <span class="guarantee-icon">üõ°Ô∏è</span>
              <span class="guarantee-text">Reserva segura con garant√≠a de reembolso</span>
            </div>
          </div>
        </aside>
      </div>
    </div>
  </main>

  <footer class="footer">
    <div class="wrap">
      <div class="footer-content">
        <div class="footer-brand">
          <div class="mark"></div>
          <span>ToursPanama</span>
        </div>
        <p class="footer-text">Tu plataforma de confianza para descubrir Panam√°</p>
        <p class="footer-copy">&copy; 2024 ToursPanama. Todos los derechos reservados.</p>
      </div>
    </div>
  </footer>

  <script src="/js/loading.js"></script>
  <script src="/js/logger.js"></script>
  <script src="/js/notifications.js"></script>
  <script src="/js/api.js"></script>
  <script>
    let currentTour = null;

    async function loadTour() {
      const urlParams = new URLSearchParams(window.location.search);
      const tourId = urlParams.get('id');

      if (!tourId) {
        window.location.href = '/';
        return;
      }

      const loaderId = loadingManager.showInElement(document.querySelector('.tour-detail-container') || document.body, 'Cargando informaci√≥n del tour...');
      try {
        // Llamar a la API real
        try {
          currentTour = await api.getTour(tourId);
          loadingManager.hideInElement(loaderId);
        } catch (error) {
          loadingManager.hideInElement(loaderId);
          // Si falla, usar datos mock
          console.warn('API no disponible, usando datos mock:', error);
          currentTour = {
            id: tourId,
            name: 'Tour del Canal de Panam√°',
            description: 'Descubre la maravilla de la ingenier√≠a mundial. Visita las esclusas de Miraflores y aprende sobre la historia del canal que conecta dos oc√©anos. Este tour te llevar√° a trav√©s de uno de los logros de ingenier√≠a m√°s impresionantes del mundo, donde podr√°s observar de cerca c√≥mo los barcos transitan entre los oc√©anos Atl√°ntico y Pac√≠fico.',
            itinerary: '1. Recogida en hotel\n2. Visita al Centro de Visitantes de Miraflores\n3. Observaci√≥n de barcos transitando\n4. Museo del Canal\n5. Regreso al hotel',
            price: 75.00,
            durationHours: 4,
            location: 'Ciudad de Panam√°',
            availableSpots: 15,
            maxCapacity: 20,
            tourImages: [{ imageUrl: 'https://images.unsplash.com/photo-1559827260-dc66d52bef19?w=1200', isPrimary: true }]
          };
        }

        // Actualizar UI
        console.log('üé¥ [loadTour] === PROCESANDO TOUR ===', { currentTour });
        
        // Normalizar propiedades (el backend ASP.NET Core retorna PascalCase por defecto)
        // Priorizar PascalCase que es lo que devuelve el backend
        const tourName = currentTour.Name || currentTour.name || 'Tour sin nombre';
        const tourLocation = currentTour.Location || currentTour.location || 'Ubicaci√≥n no especificada';
        const tourDescription = currentTour.Description || currentTour.description || 'Sin descripci√≥n disponible';
        const durationHours = currentTour.DurationHours || currentTour.durationHours || 0;
        const availableSpots = currentTour.AvailableSpots !== undefined ? currentTour.AvailableSpots : 
                               (currentTour.availableSpots !== undefined ? currentTour.availableSpots : 0);
        const maxCapacity = currentTour.MaxCapacity !== undefined ? currentTour.MaxCapacity : 
                            (currentTour.maxCapacity !== undefined ? currentTour.maxCapacity : 0);
        
        // ‚úÖ SOLUCI√ìN ROBUSTA: Normalizar precio de forma segura
        // Priorizar PascalCase (backend ASP.NET Core)
        console.log('üí∞ [loadTour] === PROCESANDO PRECIO ===');
        const rawPrice = currentTour.Price ?? currentTour.price ?? null;
        console.log('1Ô∏è‚É£ [loadTour] Raw price obtenido:', {
          'currentTour.Price': currentTour.Price,
          'currentTour.price': currentTour.price,
          rawPrice,
          rawPriceType: typeof rawPrice,
          hasPrice: 'price' in currentTour,
          hasPriceUpper: 'Price' in currentTour
        });
        
        // Convertir a n√∫mero con fallback a 0 (evita crash con toFixed)
        let price = Number(rawPrice ?? 0);
        console.log('2Ô∏è‚É£ [loadTour] Price despu√©s de Number():', {
          price,
          priceType: typeof price,
          isNaN: isNaN(price),
          isFinite: isFinite(price)
        });
        
        // Validaci√≥n estricta: asegurar que price es un n√∫mero v√°lido y finito
        if (typeof price !== 'number' || isNaN(price) || !isFinite(price)) {
          console.warn('‚ö†Ô∏è [loadTour] Precio inv√°lido detectado, usando 0:', { 
            tourId,
            tourName, 
            rawPrice, 
            rawPriceType: typeof rawPrice,
            priceBeforeFix: price,
            priceType: typeof price
          });
          price = 0;
        } else {
          console.log('‚úÖ [loadTour] Validaci√≥n pasada: price es n√∫mero v√°lido');
        }
        
        // üõ°Ô∏è VALIDACI√ìN FINAL: Asegurar que price es n√∫mero v√°lido antes de toFixed
        if (typeof price !== 'number' || isNaN(price) || !isFinite(price)) {
          console.error('‚ùå [loadTour] ERROR CR√çTICO: price inv√°lido antes de toFixed, usando 0', {
            tourId,
            tourName,
            price,
            priceType: typeof price
          });
          price = 0;
        }
        
        // Formatear precio (price siempre es un n√∫mero v√°lido aqu√≠)
        console.log('3Ô∏è‚É£ [loadTour] Llamando a toFixed(2) con price:', price);
        const formattedPrice = price.toFixed(2);
        console.log('‚úÖ [loadTour] formattedPrice obtenido:', formattedPrice);
        
        // Fallback visual elegante si el precio es 0
        const priceText = price > 0 ? `$${formattedPrice}` : 'Consultar precio';
        console.log('4Ô∏è‚É£ [loadTour] priceText final:', priceText);
        
        document.getElementById('tourTitle').textContent = tourName;
        document.getElementById('breadcrumbTourName').textContent = tourName;
        document.getElementById('tourLocation').textContent = tourLocation;
        document.getElementById('tourDuration').textContent = `${durationHours} horas`;
        document.getElementById('tourCapacity').textContent = `${availableSpots} de ${maxCapacity} disponibles`;
        document.getElementById('tourDescription').textContent = tourDescription;
        document.getElementById('tourPrice').textContent = priceText;
        document.getElementById('bookingDuration').textContent = `${durationHours} horas`;
        document.getElementById('bookingAvailability').textContent = availableSpots > 0 ? `${availableSpots} cupos` : 'Agotado';
        
        // Mostrar fecha del tour si existe (priorizar PascalCase del backend)
        const tourDate = currentTour.TourDate || currentTour.tourDate;
        if (tourDate) {
          try {
            const dateObj = new Date(tourDate);
            if (!isNaN(dateObj.getTime())) {
              const formattedDate = dateObj.toLocaleDateString('es-PA', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
              });
              document.getElementById('tourDateDisplay').textContent = formattedDate;
              document.getElementById('tourDateMeta').style.display = 'flex';
              document.getElementById('bookingDate').textContent = formattedDate;
              document.getElementById('bookingDateItem').style.display = 'block';
            }
          } catch (e) {
            console.warn('Error al formatear fecha del tour:', e);
          }
        }
        
        console.log('‚úÖ [loadTour] === UI ACTUALIZADA EXITOSAMENTE ===');
        
        // Im√°genes de referencia para fallback
        const DEFAULT_TOUR_IMAGES = [
          'https://images.unsplash.com/photo-1559827260-dc66d52bef19?w=1200',
          'https://images.unsplash.com/photo-1578662996442-48f60103fc96?w=1200',
          'https://images.unsplash.com/photo-1507525428034-b723cf961d3e?w=1200',
          'https://images.unsplash.com/photo-1514565131-fce0801e5785?w=1200',
          'https://images.unsplash.com/photo-1441974231531-c6227db76b6e?w=1200',
          'https://images.unsplash.com/photo-1504674900247-0877df9cc836?w=1200'
        ];
        
        function getDefaultTourImage(tourId = '') {
          if (!tourId) return DEFAULT_TOUR_IMAGES[0];
          const hash = tourId.toString().split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
          return DEFAULT_TOUR_IMAGES[hash % DEFAULT_TOUR_IMAGES.length];
        }
        
        // Normalizar im√°genes: el backend ASP.NET Core retorna TourImages (PascalCase) por defecto
        const tourImages = currentTour.TourImages || currentTour.tourImages || [];
        
        // Obtener la imagen principal (IsPrimary = true) o la primera disponible
        // Priorizar PascalCase que es lo que devuelve el backend
        let primaryImage = null;
        if (tourImages && tourImages.length > 0) {
          primaryImage = tourImages.find(img => img.IsPrimary === true || img.isPrimary === true) || tourImages[0];
        }
        const imageUrl = primaryImage?.ImageUrl || primaryImage?.imageUrl || getDefaultTourImage(currentTour.Id || currentTour.id);
        
        const img = document.getElementById('tourImage');
        img.src = imageUrl;
        img.onerror = function() {
          this.src = getDefaultTourImage(currentTour.id);
        };

        // Mostrar galer√≠a si hay m√°s de una imagen
        if (tourImages.length > 1) {
          const gallerySection = document.getElementById('imageGallerySection');
          const gallery = document.getElementById('imageGallery');
          
          // Limpiar galer√≠a anterior
          gallery.innerHTML = '';
          
          // Agregar todas las im√°genes a la galer√≠a
          // Priorizar PascalCase (ImageUrl) que es lo que devuelve el backend
          tourImages.forEach((image, index) => {
            const imgUrl = image.ImageUrl || image.imageUrl;
            if (imgUrl) {
              const galleryItem = document.createElement('div');
              galleryItem.className = 'gallery-item';
              galleryItem.innerHTML = `
                <img src="${imgUrl}" alt="${tourName} - Imagen ${index + 1}" class="gallery-image" />
              `;
              galleryItem.onclick = () => {
                // Al hacer clic, cambiar la imagen del hero
                img.src = imgUrl;
                // Scroll suave al hero
                document.querySelector('.tour-hero').scrollIntoView({ behavior: 'smooth', block: 'start' });
              };
              gallery.appendChild(galleryItem);
            }
          });
          
          gallerySection.style.display = 'block';
        }

        // Itinerario (priorizar PascalCase del backend)
        const itinerary = currentTour.Itinerary || currentTour.itinerary;
        if (itinerary) {
          const itinerarySection = document.getElementById('itinerarySection');
          const itineraryList = document.getElementById('tourItinerary');
          
          // Procesar el itinerario: puede venir con n√∫meros, guiones, o simplemente texto
          // Separar por saltos de l√≠nea y limpiar formato
          let items = itinerary.split('\n').filter(item => item.trim());
          
          // Limpiar formato com√∫n (n√∫meros al inicio, guiones, etc.)
          items = items.map(item => {
            // Remover n√∫meros al inicio seguidos de punto, gui√≥n o espacio
            item = item.trim().replace(/^\d+[\.\-\s)]+\s*/, '');
            // Remover guiones al inicio
            item = item.replace(/^[\-\‚Ä¢]\s*/, '');
            return item.trim();
          }).filter(item => item.length > 0);
          
          if (items.length > 0) {
            itineraryList.innerHTML = items.map((item, index) => `
              <div class="itinerary-item">
                <div class="itinerary-number">${index + 1}</div>
                <div class="itinerary-content">${item}</div>
              </div>
            `).join('');
            itinerarySection.style.display = 'block';
          }
        }

        // Qu√© Incluye (priorizar PascalCase del backend)
        const includes = currentTour.Includes || currentTour.includes;
        const includedList = document.getElementById('includedList');
        const includesSection = document.getElementById('includesSection');
        
        if (includes && includes.trim()) {
          // Procesar el contenido: separar por saltos de l√≠nea
          let includeItems = includes.split('\n').filter(item => item.trim());
          
          // Limpiar formato com√∫n
          includeItems = includeItems.map(item => {
            item = item.trim().replace(/^[\-\‚Ä¢\d+[\.\-\s)]+\s*/, '');
            return item.trim();
          }).filter(item => item.length > 0);
          
          if (includeItems.length > 0) {
            includedList.innerHTML = includeItems.map(item => `
              <li class="included-item">
                <span class="included-icon">‚úì</span>
                <span>${item}</span>
              </li>
            `).join('');
          } else {
            // Si no hay items v√°lidos, ocultar la secci√≥n
            includesSection.style.display = 'none';
          }
        } else {
          // Si no hay contenido, mostrar valores por defecto
          includedList.innerHTML = `
            <li class="included-item">
              <span class="included-icon">‚úì</span>
              <span>Gu√≠a tur√≠stico profesional</span>
            </li>
            <li class="included-item">
              <span class="included-icon">‚úì</span>
              <span>Transporte ida y vuelta</span>
            </li>
            <li class="included-item">
              <span class="included-icon">‚úì</span>
              <span>Entradas a atracciones</span>
            </li>
            <li class="included-item">
              <span class="included-icon">‚úì</span>
              <span>Seguro de viaje b√°sico</span>
            </li>
          `;
        }

        // Badge (usar variable normalizada availableSpots en lugar de currentTour.availableSpots)
        const badge = document.getElementById('tourBadge');
        console.log('üè∑Ô∏è [loadTour] Actualizando badge:', { 
          availableSpots, 
          currentTourAvailableSpots: currentTour.availableSpots,
          currentTourAvailableSpotsUpper: currentTour.AvailableSpots,
          badgeExists: !!badge 
        });
        if (availableSpots > 0) {
          if (badge) {
            badge.textContent = 'Disponible';
            badge.className = 'tour-badge-large available';
            console.log('‚úÖ [loadTour] Badge actualizado a: Disponible');
          }
        } else {
          if (badge) {
            badge.textContent = 'Agotado';
            badge.className = 'tour-badge-large sold-out';
            console.log('‚ö†Ô∏è [loadTour] Badge actualizado a: Agotado');
          }
        }

        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('tourContent').style.display = 'block';
      } catch (error) {
        console.error('Error loading tour:', error);
        if (typeof notificationManager !== 'undefined' && notificationManager) {
          notificationManager.error('Error al cargar el tour. Por favor, intenta de nuevo.');
        } else if (typeof window !== 'undefined' && window.notificationManager) {
          window.notificationManager.error('Error al cargar el tour. Por favor, intenta de nuevo.');
        } else {
          // Fallback si no hay notificationManager disponible
          console.error('Error al cargar el tour:', error);
        }
      }
    }

    function bookTour() {
      const token = localStorage.getItem('authToken');
      if (!token) {
        window.location.href = '/login.html?redirect=' + encodeURIComponent(window.location.href);
        return;
      }
      // Redirigir a checkout (priorizar PascalCase del backend)
      const tourId = currentTour.Id || currentTour.id;
      window.location.href = `/checkout.html?tourId=${tourId}`;
    }

    // Cargar informaci√≥n del usuario autenticado
    async function loadUserInfo() {
      const token = localStorage.getItem('authToken') || localStorage.getItem('accessToken');
      const userGreeting = document.getElementById('userGreeting');
      const loginLink = document.getElementById('loginLink');
      
      if (!token || !userGreeting) {
        if (userGreeting) userGreeting.style.display = 'none';
        if (loginLink) loginLink.style.display = 'block';
        return;
      }

      try {
        // Ocultar link de login si est√° autenticado
        if (loginLink) loginLink.style.display = 'none';
        
        // Intentar obtener el nombre desde localStorage primero
        let userName = localStorage.getItem('userName');
        
        // Si no hay nombre guardado, obtenerlo de la API
        if (!userName) {
          const currentUser = await api.getCurrentUser();
          if (currentUser) {
            const firstName = currentUser.FirstName || currentUser.firstName || '';
            const lastName = currentUser.LastName || currentUser.lastName || '';
            userName = `${firstName} ${lastName}`.trim();
            
            // Guardar en localStorage para futuras cargas
            if (userName) {
              localStorage.setItem('userName', userName);
            }
          }
        }
        
        // Mostrar el saludo si hay nombre
        if (userName) {
          userGreeting.textContent = `Hola, ${userName}`;
          userGreeting.style.display = 'inline-flex';
        } else {
          userGreeting.style.display = 'none';
        }
      } catch (error) {
        console.warn('No se pudo cargar la informaci√≥n del usuario:', error);
        if (userGreeting) userGreeting.style.display = 'none';
        if (loginLink) loginLink.style.display = 'block';
        localStorage.removeItem('userName');
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      loadTour();
      loadUserInfo();
    });
  </script>
</body>
</html>