<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Detalle del Tour | ToursPanama</title>
  <meta name="description" content="Descubre los detalles de este tour en Panam√°. Reserva ahora y vive una experiencia √∫nica." />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="stylesheet" href="/css/main.css" />
  <link rel="stylesheet" href="/css/design-system.css" />
  <link rel="stylesheet" href="/css/detail.css" />
  <link rel="stylesheet" href="/css/carousel.css" />
  <link rel="stylesheet" href="/css/loading.css" />
  <link rel="stylesheet" href="/css/enhancements.css" />
</head>
<body>
  <nav class="nav">
    <div class="nav-inner wrap">
      <div class="brand">
        <div class="mark"></div>
        <a href="/"><span class="brand-text">ToursPanama</span></a>
      </div>
      <div class="nav-links">
        <a href="/" class="nav-link">Tours</a>
        <a href="/blog.html" class="nav-link">Blog</a>
        <a href="/reservas.html" class="nav-link">Mis Reservas</a>
        <span class="nav-user-greeting" id="userGreeting" style="display:none;"></span>
        <a href="/login.html" class="nav-link" id="loginLink">Iniciar Sesi√≥n</a>
        <a href="/profile.html" class="nav-link" id="profileLink" style="display:none;">Mi Perfil</a>
        <button class="btn-primary" id="logoutBtn" style="display:none;">Cerrar Sesi√≥n</button>
      </div>
    </div>
  </nav>

  <main class="tour-detail wrap">
    <div id="loadingState" class="loading">
      <div class="spinner"></div>
      <p>Cargando tour...</p>
    </div>

    <div id="tourContent" style="display:none;">
      <!-- Breadcrumb -->
      <div class="breadcrumb">
        <a href="/" class="breadcrumb-link">Inicio</a>
        <span class="breadcrumb-separator">/</span>
        <a href="/" class="breadcrumb-link">Tours</a>
        <span class="breadcrumb-separator">/</span>
        <span class="breadcrumb-current" id="breadcrumbTourName">Tour</span>
      </div>

      <!-- Container para bloques CMS (se renderizan din√°micamente) -->
      <div id="cmsBlocksContainer"></div>
      
      <!-- Sticky CTA de Disponibilidad (siempre visible) -->
      <div id="stickyAvailabilityCta" class="sticky-availability-cta" style="display:none;">
        <div class="wrap">
          <div class="sticky-cta-content">
            <div class="sticky-cta-info">
              <span class="sticky-cta-price" id="stickyPrice">$0.00</span>
              <span class="sticky-cta-availability" id="stickyAvailability">- cupos</span>
            </div>
            <button class="btn-booking" onclick="bookTour()">
              <span class="btn-booking-text">Reservar Ahora</span>
              <span class="btn-booking-icon">‚Üí</span>
            </button>
          </div>
        </div>
      </div>

      <!-- Image Gallery Section - Se puede agregar como bloque CMS adicional si se necesita -->
      <div id="imageGallerySection" class="image-gallery-section" style="display:none;">
        <h2 class="gallery-title">Galer√≠a de Im√°genes</h2>
        <div class="image-carousel-container">
          <div class="carousel-main">
            <button class="carousel-nav carousel-prev" id="carouselPrev" aria-label="Imagen anterior">‚Äπ</button>
            <div class="carousel-viewport">
              <div class="carousel-track" id="carouselTrack"></div>
            </div>
            <button class="carousel-nav carousel-next" id="carouselNext" aria-label="Imagen siguiente">‚Ä∫</button>
            <div class="carousel-indicator">
              <span id="currentImageIndex">1</span>
              <span class="separator">/</span>
              <span id="totalImages">1</span>
            </div>
            <button class="carousel-zoom" id="carouselZoom" aria-label="Ver en pantalla completa">üîç</button>
          </div>
          <div class="carousel-thumbnails-wrapper">
            <button class="thumb-nav thumb-prev" id="thumbPrev">‚Äπ</button>
            <div class="carousel-thumbnails" id="carouselThumbnails"></div>
            <button class="thumb-nav thumb-next" id="thumbNext">‚Ä∫</button>
          </div>
        </div>
      </div>

      <!-- Modal de Imagen en Pantalla Completa -->
      <div id="imageModal" class="image-modal" style="display:none;">
        <div class="modal-overlay" onclick="closeImageModal()"></div>
        <div class="modal-content">
          <button class="modal-close" onclick="closeImageModal()" aria-label="Cerrar">‚úï</button>
          <button class="modal-nav modal-prev" id="modalPrev" aria-label="Imagen anterior">‚Äπ</button>
          <img id="modalImage" class="modal-image" src="" alt="" />
          <button class="modal-nav modal-next" id="modalNext" aria-label="Imagen siguiente">‚Ä∫</button>
          <div class="modal-info">
            <span id="modalImageIndex">1</span> / <span id="modalTotalImages">1</span>
          </div>
        </div>
      </div>

      <!-- Sidebar de Reserva (Sticky) - Se mantiene para compatibilidad -->
      <aside class="booking-sidebar" id="bookingSidebar" style="display:none;">
        <div class="booking-card-sticky">
          <div class="booking-price-section">
            <div class="price-label">Precio por persona</div>
            <div class="price-amount" id="tourPrice"></div>
            <div class="price-note">Impuestos incluidos</div>
          </div>

          <div class="booking-info-grid">
            <div class="booking-info-item">
              <div class="booking-info-label">Duraci√≥n</div>
              <div class="booking-info-value" id="bookingDuration"></div>
            </div>
            <div class="booking-info-item">
              <div class="booking-info-label">Disponibilidad</div>
              <div class="booking-info-value" id="bookingAvailability"></div>
            </div>
            <div class="booking-info-item" id="bookingDateItem" style="display: none;">
              <div class="booking-info-label">Fecha del Tour</div>
              <div class="booking-info-value" id="bookingDate"></div>
            </div>
          </div>

          <div class="booking-divider"></div>

          <!-- Favorite Button -->
          <button class="btn-secondary" id="favoriteBtn" onclick="toggleFavorite()" style="width: 100%; margin-bottom: 12px; display:none;">
            <span id="favoriteBtnText">Agregar a Favoritos</span>
            <span id="favoriteBtnIcon">‚ô°</span>
          </button>

          <!-- Microcopy de riesgo cero -->
          <div class="risk-free-microcopy" style="margin-bottom: var(--space-md);">
            <div style="font-size: 0.85rem; color: var(--text-muted); line-height: 1.6;">
              ‚úî Cancelaci√≥n flexible<br>
              ‚úî Sin cargos ocultos<br>
              ‚úî Soporte local en Panam√°
            </div>
          </div>

          <button class="btn-booking" onclick="bookTour()">
            <span class="btn-booking-text">Reservar Ahora</span>
            <span class="btn-booking-icon">‚Üí</span>
          </button>

          <!-- Trust Badges -->
          <div class="trust-badges" style="margin-top: var(--space-md); padding-top: var(--space-md); border-top: 1px solid var(--border);">
            <div style="display: flex; flex-direction: column; gap: var(--space-xs); font-size: 0.85rem; color: var(--text-muted);">
              <span>üîí Pago 100% seguro</span>
              <span>üìß Confirmaci√≥n inmediata</span>
              <span>üí≥ Stripe ¬∑ PayPal ¬∑ Yappy</span>
            </div>
          </div>

          <!-- Actividad reciente (oculto si no hay data) -->
          <div id="recentActivity" class="recent-activity" style="display:none; margin-top: var(--space-md); padding-top: var(--space-md); border-top: 1px solid var(--border);">
            <div style="font-size: 0.85rem; color: var(--text-muted);">
              üëÄ <span id="recentActivityText"></span>
            </div>
          </div>

          <div class="booking-guarantee" style="margin-top: var(--space-md);">
            <span class="guarantee-icon">üõ°Ô∏è</span>
            <span class="guarantee-text">Reserva segura con garant√≠a de reembolso</span>
          </div>
        </div>
      </aside>
    </div>
  </main>

  <footer class="footer">
    <div class="wrap">
      <div class="footer-content">
        <div class="footer-brand">
          <div class="mark"></div>
          <span>ToursPanama</span>
        </div>
        <p class="footer-text">Tu plataforma de confianza para descubrir Panam√°</p>
        <p class="footer-copy">&copy; 2024 ToursPanama. Todos los derechos reservados.</p>
      </div>
    </div>
  </footer>

    <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&libraries=places" async defer></script>
    <script src="/js/loading.js"></script>
    <script src="/js/logger.js"></script>
    <script src="/js/notifications.js"></script>
    <script src="/js/api.js"></script>
    <style>
      /* Sticky CTA de Disponibilidad */
      .sticky-availability-cta {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: white;
        border-top: 2px solid var(--border);
        box-shadow: 0 -4px 12px rgba(0,0,0,0.1);
        z-index: 1000;
        padding: var(--space-md) 0;
        display: none; /* Se muestra con JS cuando availability sale de vista */
      }
      
      .sticky-cta-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: var(--space-lg);
      }
      
      .sticky-cta-info {
        display: flex;
        flex-direction: column;
        gap: var(--space-xs);
      }
      
      .sticky-cta-price {
        font-size: 1.5rem;
        font-weight: var(--font-weight-bold);
        color: var(--primary);
      }
      
      .sticky-cta-availability {
        font-size: 0.9rem;
        color: var(--text-secondary);
      }
      
      /* Bloque Availability Premium */
      .tour-availability {
        background: white;
        padding: var(--space-2xl);
        border-radius: var(--radius-lg);
        box-shadow: 0 8px 24px rgba(0,0,0,0.08);
        margin-bottom: var(--space-2xl);
      }
      
      .availability-content {
        max-width: 500px;
        margin: 0 auto;
      }
      
      .availability-row {
        display: flex;
        flex-direction: column;
        gap: var(--space-sm);
        margin-bottom: var(--space-lg);
      }
      
      .availability-label {
        font-weight: var(--font-weight-semibold);
        color: var(--text);
        font-size: 0.95rem;
      }
      
      .availability-input {
        padding: var(--space-md);
        border: 2px solid var(--border);
        border-radius: var(--radius);
        font-size: 1rem;
        transition: border-color 0.2s;
      }
      
      .availability-input:focus {
        outline: none;
        border-color: var(--primary);
      }
      
      .availability-price {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--space-lg);
        background: var(--bg-secondary);
        border-radius: var(--radius);
        margin: var(--space-xl) 0;
      }
      
      .availability-price-label {
        font-size: 1.1rem;
        color: var(--text-secondary);
      }
      
      .availability-price-amount {
        font-size: 1.75rem;
        font-weight: var(--font-weight-bold);
        color: var(--primary);
      }
      
      .availability-urgency {
        background: #fff5e5;
        color: #a85b00;
        padding: var(--space-md);
        border-radius: var(--radius);
        margin-bottom: var(--space-lg);
        font-size: 0.95rem;
        text-align: center;
        border-left: 4px solid #ff9800;
      }
      
      .availability-urgency strong {
        font-weight: var(--font-weight-bold);
        color: #d97706;
      }
      
      .availability-microcopy {
        text-align: center;
        font-size: 0.9rem;
        color: var(--text-secondary);
        margin-top: var(--space-md);
        line-height: 1.6;
      }
      
      @media (max-width: 768px) {
        .sticky-cta-content {
          flex-direction: column;
          gap: var(--space-md);
        }
        
        .tour-availability {
          padding: var(--space-xl);
        }
      }
      
      /* Bloques CMS */
      .cms-block {
        margin-bottom: var(--space-2xl);
      }
      
      .cms-block-hero {
        position: relative;
        margin-bottom: var(--space-2xl);
      }
      
      .cms-block-social-proof {
        padding: var(--space-xl);
        background: var(--bg-secondary);
        border-radius: var(--radius-lg);
        text-align: center;
      }
      
      .cms-block-highlights {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: var(--space-lg);
        padding: var(--space-xl);
        background: var(--card);
        border-radius: var(--radius-lg);
      }
      
      .cms-block-story {
        padding: var(--space-xl);
      }
      
      .cms-block-story h2 {
        margin-bottom: var(--space-lg);
      }
      
      .cms-block-includes-excludes {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: var(--space-xl);
        padding: var(--space-xl);
        background: var(--card);
        border-radius: var(--radius-lg);
      }
      
      @media (max-width: 768px) {
        .cms-block-includes-excludes {
          grid-template-columns: 1fr;
        }
        .sticky-cta-content {
          flex-direction: column;
        }
      }
      
      .cms-block-final-cta {
        text-align: center;
        padding: var(--space-3xl);
        background: var(--gradient-subtle);
        border-radius: var(--radius-lg);
      }
      
      .social-badge {
        padding: var(--space-sm) var(--space-md);
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        font-size: 0.9rem;
        color: var(--text);
      }
      
      .highlight-item {
        display: flex;
        gap: var(--space-md);
        align-items: start;
      }
      
      .highlight-icon {
        font-size: 2rem;
        flex-shrink: 0;
      }
      
      .excluded-list {
        list-style: none;
        padding: 0;
      }
      
      .excluded-item {
        display: flex;
        gap: var(--space-sm);
        margin-bottom: var(--space-sm);
        color: var(--text-secondary);
      }
      
      .excluded-icon {
        color: var(--danger);
      }
      
      .story-content {
        line-height: 1.8;
        color: var(--text);
      }
      
      .story-content p {
        margin-bottom: var(--space-md);
      }
      
      .story-content img {
        max-width: 100%;
        height: auto;
        border-radius: var(--radius);
        margin: var(--space-lg) 0;
      }
    </style>
    <!-- Variables globales para el carrusel -->
    <script>
      // Variables globales para el carrusel (se inicializar√°n en loadTour)
      window.carouselImages = [];
      window.currentCarouselIndex = 0;
      let tourMap = null;
    </script>
  <script>
    let currentTour = null;
    let currentCarouselIndex = 0;
    let carouselImages = [];
    
    // Orden por defecto de bloques CMS
    const DEFAULT_BLOCK_ORDER = [
      'hero', 'social', 'highlights', 'story', 
      'includes', 'availability', 'map', 'reviews', 'faq', 'final_cta'
    ];

    async function loadTour() {
      const urlParams = new URLSearchParams(window.location.search);
      const tourId = urlParams.get('id');

      if (!tourId) {
        window.location.href = '/';
        return;
      }

      const loaderId = loadingManager.showInElement(document.querySelector('.tour-detail-container') || document.body, 'Cargando informaci√≥n del tour...');
      try {
        // Llamar a la API real
        try {
          currentTour = await api.getTour(tourId);
          loadingManager.hideInElement(loaderId);
        } catch (error) {
          loadingManager.hideInElement(loaderId);
          // Si falla, usar datos mock
          console.warn('API no disponible, usando datos mock:', error);
          currentTour = {
            id: tourId,
            name: 'Tour del Canal de Panam√°',
            description: 'Descubre la maravilla de la ingenier√≠a mundial. Visita las esclusas de Miraflores y aprende sobre la historia del canal que conecta dos oc√©anos. Este tour te llevar√° a trav√©s de uno de los logros de ingenier√≠a m√°s impresionantes del mundo, donde podr√°s observar de cerca c√≥mo los barcos transitan entre los oc√©anos Atl√°ntico y Pac√≠fico.',
            itinerary: '1. Recogida en hotel\n2. Visita al Centro de Visitantes de Miraflores\n3. Observaci√≥n de barcos transitando\n4. Museo del Canal\n5. Regreso al hotel',
            price: 75.00,
            durationHours: 4,
            location: 'Ciudad de Panam√°',
            availableSpots: 15,
            maxCapacity: 20,
            tourImages: [{ imageUrl: 'https://images.unsplash.com/photo-1559827260-dc66d52bef19?w=1200', isPrimary: true }]
          };
        }

        // Track: tour_viewed
        const tourId = currentTour.Id || currentTour.id;
        if (window.track && tourId) {
          window.track('tour_viewed', {
            entityType: 'tour',
            entityId: tourId,
            metadata: {
              tourName: currentTour.Name || currentTour.name,
              price: currentTour.Price || currentTour.price,
              location: currentTour.Location || currentTour.location
            }
          });
        }

        // Actualizar UI
        console.log('üé¥ [loadTour] === PROCESANDO TOUR ===', { currentTour });
        
        // Normalizar propiedades (el backend ASP.NET Core retorna PascalCase por defecto)
        // Priorizar PascalCase que es lo que devuelve el backend
        const tourName = currentTour.Name || currentTour.name || 'Tour sin nombre';
        const tourLocation = currentTour.Location || currentTour.location || 'Ubicaci√≥n no especificada';
        const tourDescription = currentTour.Description || currentTour.description || 'Sin descripci√≥n disponible';
        const durationHours = currentTour.DurationHours || currentTour.durationHours || 0;
        const availableSpots = currentTour.AvailableSpots !== undefined ? currentTour.AvailableSpots : 
                               (currentTour.availableSpots !== undefined ? currentTour.availableSpots : 0);
        const maxCapacity = currentTour.MaxCapacity !== undefined ? currentTour.MaxCapacity : 
                            (currentTour.maxCapacity !== undefined ? currentTour.maxCapacity : 0);
        
        // ‚úÖ SOLUCI√ìN ROBUSTA: Normalizar precio de forma segura
        // Priorizar PascalCase (backend ASP.NET Core)
        console.log('üí∞ [loadTour] === PROCESANDO PRECIO ===');
        const rawPrice = currentTour.Price ?? currentTour.price ?? null;
        console.log('1Ô∏è‚É£ [loadTour] Raw price obtenido:', {
          'currentTour.Price': currentTour.Price,
          'currentTour.price': currentTour.price,
          rawPrice,
          rawPriceType: typeof rawPrice,
          hasPrice: 'price' in currentTour,
          hasPriceUpper: 'Price' in currentTour
        });
        
        // Convertir a n√∫mero con fallback a 0 (evita crash con toFixed)
        let price = Number(rawPrice ?? 0);
        console.log('2Ô∏è‚É£ [loadTour] Price despu√©s de Number():', {
          price,
          priceType: typeof price,
          isNaN: isNaN(price),
          isFinite: isFinite(price)
        });
        
        // Validaci√≥n estricta: asegurar que price es un n√∫mero v√°lido y finito
        if (typeof price !== 'number' || isNaN(price) || !isFinite(price)) {
          console.warn('‚ö†Ô∏è [loadTour] Precio inv√°lido detectado, usando 0:', { 
            tourId,
            tourName, 
            rawPrice, 
            rawPriceType: typeof rawPrice,
            priceBeforeFix: price,
            priceType: typeof price
          });
          price = 0;
        } else {
          console.log('‚úÖ [loadTour] Validaci√≥n pasada: price es n√∫mero v√°lido');
        }
        
        // üõ°Ô∏è VALIDACI√ìN FINAL: Asegurar que price es n√∫mero v√°lido antes de toFixed
        if (typeof price !== 'number' || isNaN(price) || !isFinite(price)) {
          console.error('‚ùå [loadTour] ERROR CR√çTICO: price inv√°lido antes de toFixed, usando 0', {
            tourId,
            tourName,
            price,
            priceType: typeof price
          });
          price = 0;
        }
        
        // Formatear precio (price siempre es un n√∫mero v√°lido aqu√≠)
        console.log('3Ô∏è‚É£ [loadTour] Llamando a toFixed(2) con price:', price);
        const formattedPrice = price.toFixed(2);
        console.log('‚úÖ [loadTour] formattedPrice obtenido:', formattedPrice);
        
        // Fallback visual elegante si el precio es 0
        const priceText = price > 0 ? `$${formattedPrice}` : 'Consultar precio';
        console.log('4Ô∏è‚É£ [loadTour] priceText final:', priceText);
        
        // Actualizar breadcrumb (siempre existe)
        const breadcrumbEl = document.getElementById('breadcrumbTourName');
        if (breadcrumbEl) breadcrumbEl.textContent = tourName;

        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('tourContent').style.display = 'block';

        // Renderizar bloques CMS
        renderCmsBlocks(currentTour);
        
        // Actualizar sticky CTA
        updateStickyCta(currentTour);

        // Cargar reviews y favoritos (despu√©s de renderizar bloques)
        const reviewsBlock = document.getElementById('reviewsBlock');
        if (reviewsBlock) {
          await loadReviewsForBlock(tourId);
        }
        await checkFavoriteStatus(tourId);
        
        // Cargar mapa si hay ubicaci√≥n (se renderiza en bloque CMS)
        if (tourLocation && tourLocation.trim() !== '') {
          // El mapa se inicializar√° en el bloque CMS
        }
      } catch (error) {
        console.error('Error loading tour:', error);
        const errorMsg = error.message && error.message.includes('401')
          ? 'Tu sesi√≥n expir√≥. Por favor, inicia sesi√≥n nuevamente.'
          : error.message && (error.message.includes('network') || error.message.includes('fetch'))
          ? 'Algo sali√≥ mal. Int√©ntalo de nuevo en unos segundos.'
          : 'Error al cargar el tour. Por favor, intenta de nuevo.';
        if (typeof notificationManager !== 'undefined' && notificationManager) {
          notificationManager.error(errorMsg);
        } else if (typeof window !== 'undefined' && window.notificationManager) {
          window.notificationManager.error(errorMsg);
        } else {
          // Fallback si no hay notificationManager disponible
          console.error('Error al cargar el tour:', error);
        }
      }
    }

    function bookTour() {
      const token = localStorage.getItem('authToken') || localStorage.getItem('accessToken');
      if (!token) {
        window.location.href = '/login.html?redirect=' + encodeURIComponent(window.location.href);
        return;
      }
      
      // Obtener fecha y personas seleccionadas
      const tourId = currentTour.Id || currentTour.id;
      const dateSelect = document.getElementById('tourDateSelect');
      const participantsSelect = document.getElementById('participantsSelect');
      
      let checkoutUrl = `/checkout.html?tourId=${tourId}`;
      
      if (dateSelect && dateSelect.value) {
        checkoutUrl += `&date=${encodeURIComponent(dateSelect.value)}`;
      }
      
      if (participantsSelect && participantsSelect.value) {
        checkoutUrl += `&participants=${encodeURIComponent(participantsSelect.value)}`;
      }
      
      window.location.href = checkoutUrl;
    }

    // Cargar informaci√≥n del usuario autenticado
    async function loadUserInfo() {
      const token = localStorage.getItem('authToken') || localStorage.getItem('accessToken');
      const userGreeting = document.getElementById('userGreeting');
      const loginLink = document.getElementById('loginLink');
      
      if (!token || !userGreeting) {
        if (userGreeting) userGreeting.style.display = 'none';
        if (loginLink) loginLink.style.display = 'block';
        return;
      }

      try {
        // Ocultar link de login si est√° autenticado
        if (loginLink) loginLink.style.display = 'none';
        
        // Intentar obtener el nombre desde localStorage primero
        let userName = localStorage.getItem('userName');
        
        // Si no hay nombre guardado, obtenerlo de la API
        if (!userName) {
          const currentUser = await api.getCurrentUser();
          if (currentUser) {
            const firstName = currentUser.FirstName || currentUser.firstName || '';
            const lastName = currentUser.LastName || currentUser.lastName || '';
            userName = `${firstName} ${lastName}`.trim();
            
            // Guardar en localStorage para futuras cargas
            if (userName) {
              localStorage.setItem('userName', userName);
            }
          }
        }
        
        // Mostrar el saludo si hay nombre
        if (userName) {
          userGreeting.textContent = `Hola, ${userName}`;
          userGreeting.style.display = 'inline-flex';
        } else {
          userGreeting.style.display = 'none';
        }
      } catch (error) {
        console.warn('No se pudo cargar la informaci√≥n del usuario:', error);
        if (userGreeting) userGreeting.style.display = 'none';
        if (loginLink) loginLink.style.display = 'block';
        localStorage.removeItem('userName');
      }
    }

    // Funcionalidad del Carrusel (variables declaradas arriba, solo funciones aqu√≠)
    function initCarouselNavigation() {
      const prevBtn = document.getElementById('carouselPrev');
      const nextBtn = document.getElementById('carouselNext');
      const thumbPrevBtn = document.getElementById('thumbPrev');
      const thumbNextBtn = document.getElementById('thumbNext');
      const zoomBtn = document.getElementById('carouselZoom');
      
      if (prevBtn) prevBtn.onclick = () => previousImage();
      if (nextBtn) nextBtn.onclick = () => nextImage();
      if (thumbPrevBtn) thumbPrevBtn.onclick = () => scrollThumbnails(-1);
      if (thumbNextBtn) thumbNextBtn.onclick = () => scrollThumbnails(1);
      if (zoomBtn) zoomBtn.onclick = () => openImageModal(currentCarouselIndex);
      
      // Navegaci√≥n con teclado
      document.addEventListener('keydown', (e) => {
        if (document.getElementById('imageModal')?.style.display === 'block') {
          // En modal: navegar con flechas
          if (e.key === 'ArrowLeft') previousImageModal();
          if (e.key === 'ArrowRight') nextImageModal();
          if (e.key === 'Escape') closeImageModal();
        } else if (document.getElementById('imageGallerySection')?.style.display === 'block') {
          // En carrusel: navegar con flechas
          if (e.key === 'ArrowLeft') previousImage();
          if (e.key === 'ArrowRight') nextImage();
        }
      });
      
      updateCarouselState();
    }

    function goToImage(index) {
      const totalImages = carouselImages?.length || 0;
      if (totalImages === 0) return;
      
      currentCarouselIndex = Math.max(0, Math.min(index, totalImages - 1));
      updateCarouselPosition();
      updateCarouselState();
      updateActiveThumbnail();
    }

    function nextImage() {
      const totalImages = carouselImages?.length || 0;
      if (totalImages === 0) return;
      
      currentCarouselIndex = (currentCarouselIndex + 1) % totalImages;
      updateCarouselPosition();
      updateCarouselState();
      updateActiveThumbnail();
    }

    function previousImage() {
      const totalImages = carouselImages?.length || 0;
      if (totalImages === 0) return;
      
      currentCarouselIndex = currentCarouselIndex === 0 ? totalImages - 1 : currentCarouselIndex - 1;
      updateCarouselPosition();
      updateCarouselState();
      updateActiveThumbnail();
    }

    function updateCarouselPosition() {
      const carouselTrack = document.getElementById('carouselTrack');
      if (!carouselTrack) return;
      
      const translateX = -(currentCarouselIndex * 100);
      carouselTrack.style.transform = `translateX(${translateX}%)`;
    }

    function updateCarouselState() {
      const totalImages = carouselImages?.length || 0;
      const currentIndexEl = document.getElementById('currentImageIndex');
      const prevBtn = document.getElementById('carouselPrev');
      const nextBtn = document.getElementById('carouselNext');
      
      if (currentIndexEl) currentIndexEl.textContent = currentCarouselIndex + 1;
      
      // Actualizar estado de botones (siempre habilitados para carrusel infinito)
      if (prevBtn) prevBtn.disabled = false;
      if (nextBtn) nextBtn.disabled = false;
    }

    function updateActiveThumbnail() {
      const thumbnails = document.querySelectorAll('.carousel-thumbnail');
      thumbnails.forEach((thumb, index) => {
        if (index === currentCarouselIndex) {
          thumb.classList.add('active');
          // Scroll autom√°tico al thumbnail activo
          thumb.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
        } else {
          thumb.classList.remove('active');
        }
      });
    }

    function scrollThumbnails(direction) {
      const thumbnailsContainer = document.getElementById('carouselThumbnails');
      if (!thumbnailsContainer) return;
      
      const scrollAmount = 140; // 120px (thumbnail) + 20px (gap)
      thumbnailsContainer.scrollBy({
        left: direction * scrollAmount,
        behavior: 'smooth'
      });
    }

    // Modal de Imagen en Pantalla Completa
    function openImageModal(index) {
      const modal = document.getElementById('imageModal');
      const modalImage = document.getElementById('modalImage');
      const modalImageIndex = document.getElementById('modalImageIndex');
      
      if (!modal || !modalImage || !carouselImages || carouselImages.length === 0) return;
      
      currentCarouselIndex = Math.max(0, Math.min(index, carouselImages.length - 1));
      const image = carouselImages[currentCarouselIndex];
      
      modalImage.src = image.url;
      modalImage.alt = image.alt;
      if (modalImageIndex) modalImageIndex.textContent = currentCarouselIndex + 1;
      
      modal.style.display = 'flex';
      document.body.style.overflow = 'hidden';
      
      // Inicializar navegaci√≥n del modal
      const modalPrev = document.getElementById('modalPrev');
      const modalNext = document.getElementById('modalNext');
      if (modalPrev) modalPrev.onclick = previousImageModal;
      if (modalNext) modalNext.onclick = nextImageModal;
    }

    function closeImageModal() {
      const modal = document.getElementById('imageModal');
      if (modal) modal.style.display = 'none';
      document.body.style.overflow = '';
    }

    function nextImageModal() {
      const totalImages = carouselImages?.length || 0;
      if (totalImages === 0) return;
      
      currentCarouselIndex = (currentCarouselIndex + 1) % totalImages;
      const image = carouselImages[currentCarouselIndex];
      const modalImage = document.getElementById('modalImage');
      const modalImageIndex = document.getElementById('modalImageIndex');
      
      if (modalImage) modalImage.src = image.url;
      if (modalImageIndex) modalImageIndex.textContent = currentCarouselIndex + 1;
    }

    function previousImageModal() {
      const totalImages = carouselImages?.length || 0;
      if (totalImages === 0) return;
      
      currentCarouselIndex = currentCarouselIndex === 0 ? totalImages - 1 : currentCarouselIndex - 1;
      const image = carouselImages[currentCarouselIndex];
      const modalImage = document.getElementById('modalImage');
      const modalImageIndex = document.getElementById('modalImageIndex');
      
      if (modalImage) modalImage.src = image.url;
      if (modalImageIndex) modalImageIndex.textContent = currentCarouselIndex + 1;
    }

    // Inicializar mapa de Google Maps
    function initTourMap(location) {
      const mapSection = document.getElementById('mapSection');
      const mapDiv = document.getElementById('tourMap');
      const mapLocation = document.getElementById('mapLocation');
      
      if (!mapSection || !mapDiv) return;
      
      // Mostrar secci√≥n de mapa
      mapSection.style.display = 'block';
      mapLocation.textContent = `üìç ${location}`;
      
      // Verificar si Google Maps est√° cargado
      if (typeof google === 'undefined' || typeof google.maps === 'undefined') {
        // Si no hay API key o no est√° cargado, mostrar mensaje
        mapDiv.innerHTML = `
          <div style="display: flex; align-items: center; justify-content: center; height: 100%; background: var(--bg-secondary); color: var(--text-muted);">
            <div style="text-align: center;">
              <p>üìç ${location}</p>
              <p style="font-size: var(--text-sm); margin-top: var(--space-sm);">Mapa interactivo disponible con Google Maps API</p>
            </div>
          </div>
        `;
        return;
      }
      
      // Geocodificar ubicaci√≥n
      const geocoder = new google.maps.Geocoder();
      geocoder.geocode({ address: location }, (results, status) => {
        if (status === 'OK' && results[0]) {
          const location_coords = results[0].geometry.location;
          
          // Crear mapa
          tourMap = new google.maps.Map(mapDiv, {
            center: location_coords,
            zoom: 14,
            mapTypeControl: true,
            streetViewControl: true,
            fullscreenControl: true
          });
          
          // Agregar marcador
          new google.maps.Marker({
            position: location_coords,
            map: tourMap,
            title: currentTour.Name || currentTour.name || 'Tour'
          });
        } else {
          // Si falla la geocodificaci√≥n, usar coordenadas por defecto de Panam√°
          const defaultCoords = { lat: 8.9824, lng: -79.5199 }; // Ciudad de Panam√°
          
          tourMap = new google.maps.Map(mapDiv, {
            center: defaultCoords,
            zoom: 12,
            mapTypeControl: true
          });
          
          mapDiv.innerHTML = `
            <div style="display: flex; align-items: center; justify-content: center; height: 100%; background: var(--bg-secondary); color: var(--text-muted);">
              <div style="text-align: center;">
                <p>üìç ${location}</p>
                <p style="font-size: var(--text-sm); margin-top: var(--space-sm);">No se pudo cargar el mapa. Ubicaci√≥n: ${location}</p>
              </div>
            </div>
          `;
        }
      });
    }

    // Hacer funciones globales para onclick
    window.goToImage = goToImage;
    window.openImageModal = openImageModal;
    window.closeImageModal = closeImageModal;
    window.previousImageModal = previousImageModal;
    window.nextImageModal = nextImageModal;

    // Renderizar bloques CMS din√°micamente
    function renderCmsBlocks(tour) {
      const container = document.getElementById('cmsBlocksContainer');
      if (!container) return;
      
      // Obtener orden y estado de bloques desde CMS
      let blockOrder = DEFAULT_BLOCK_ORDER;
      let blockEnabled = {};
      
      try {
        if (tour.BlockOrder || tour.blockOrder) {
          const orderJson = tour.BlockOrder || tour.blockOrder;
          blockOrder = JSON.parse(orderJson);
        }
        if (tour.BlockEnabled || tour.blockEnabled) {
          const enabledJson = tour.BlockEnabled || tour.blockEnabled;
          blockEnabled = JSON.parse(enabledJson);
        }
      } catch (e) {
        console.warn('Error parsing block order/enabled:', e);
      }
      
      // Renderizar cada bloque en el orden especificado
      blockOrder.forEach(blockName => {
        // Verificar si el bloque est√° habilitado (por defecto true si no est√° definido)
        const isEnabled = blockEnabled[blockName] !== false;
        if (!isEnabled) return;
        
        let blockHTML = '';
        
        switch(blockName) {
          case 'hero':
            blockHTML = renderHeroBlock(tour);
            break;
          case 'social':
            blockHTML = renderSocialProofBlock(tour);
            break;
          case 'highlights':
            blockHTML = renderHighlightsBlock(tour);
            break;
          case 'story':
            blockHTML = renderStoryBlock(tour);
            break;
          case 'includes':
            blockHTML = renderIncludesExcludesBlock(tour);
            break;
          case 'availability':
            blockHTML = renderAvailabilityBlock(tour);
            break;
          case 'map':
            blockHTML = renderMapBlock(tour);
            break;
          case 'reviews':
            blockHTML = renderReviewsBlock(tour);
            break;
          case 'faq':
            blockHTML = renderFaqBlock(tour);
            break;
          case 'final_cta':
            blockHTML = renderFinalCtaBlock(tour);
            break;
        }
        
        if (blockHTML) {
          container.innerHTML += blockHTML;
        }
      });
      
      // Inicializar funcionalidades despu√©s de renderizar
      initializeBlocksAfterRender(tour);
    }
    
    // BLOQUE 1: Hero
    function renderHeroBlock(tour) {
      const heroTitle = tour.HeroTitle || tour.heroTitle || tour.Name || tour.name || 'Tour';
      const heroSubtitle = tour.HeroSubtitle || tour.heroSubtitle || '';
      const heroCtaText = tour.HeroCtaText || tour.heroCtaText || 'Ver fechas disponibles';
      const price = tour.Price ?? tour.price ?? 0;
      const priceText = price > 0 ? `Desde $${price.toFixed(2)}` : 'Consultar precio';
      const availableSpots = tour.AvailableSpots ?? tour.availableSpots ?? 0;
      
      // Imagen principal
      const tourImages = tour.TourImages || tour.tourImages || [];
      let primaryImage = null;
      if (tourImages.length > 0) {
        primaryImage = tourImages.find(img => img.IsPrimary || img.isPrimary) || tourImages[0];
      }
      const imageUrl = primaryImage?.ImageUrl || primaryImage?.imageUrl || 'https://images.unsplash.com/photo-1559827260-dc66d52bef19?w=1200';
      
      // Badge de disponibilidad
      const badgeText = availableSpots > 0 ? 'Disponible' : 'Agotado';
      const badgeClass = availableSpots > 0 ? 'available' : 'sold-out';
      
      return `
        <div class="cms-block cms-block-hero" data-block="hero">
          <div class="tour-hero">
            <div class="tour-hero-image-container">
              <img class="tour-hero-image" src="${imageUrl}" alt="${heroTitle}" onerror="this.src='https://images.unsplash.com/photo-1559827260-dc66d52bef19?w=1200'" />
              <div class="tour-hero-overlay"></div>
              <div class="tour-hero-content">
                <div class="tour-badge-large ${badgeClass}" id="tourBadge">${badgeText}</div>
                <h1 class="tour-hero-title">${heroTitle}</h1>
                ${heroSubtitle ? `<p class="tour-hero-subtitle" style="font-size: 1.2rem; margin-top: var(--space-md); color: rgba(255,255,255,0.95);">${heroSubtitle}</p>` : ''}
                <div class="tour-hero-meta">
                  <div class="tour-meta-item">
                    <span class="tour-meta-icon">üí∞</span>
                    <span>${priceText}</span>
                  </div>
                  <div class="tour-meta-item" data-rating="true" style="display:none;">
                    <span class="tour-meta-icon">‚≠ê</span>
                    <span id="heroRating">-</span>
                  </div>
                </div>
                <button class="btn-booking" onclick="bookTour()" style="margin-top: var(--space-lg);">
                  <span class="btn-booking-text">${heroCtaText}</span>
                  <span class="btn-booking-icon">‚Üí</span>
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
    }
    
    // BLOQUE 2: Prueba Social
    function renderSocialProofBlock(tour) {
      const socialText = tour.SocialProofText || tour.socialProofText || '';
      const hasCertifiedGuide = tour.HasCertifiedGuide ?? tour.hasCertifiedGuide ?? true;
      const hasFlexibleCancellation = tour.HasFlexibleCancellation ?? tour.hasFlexibleCancellation ?? true;
      const languages = tour.AvailableLanguages || tour.availableLanguages || '["Espa√±ol", "Ingl√©s"]';
      
      let languagesList = [];
      try {
        languagesList = JSON.parse(languages);
      } catch (e) {
        languagesList = ['Espa√±ol', 'Ingl√©s'];
      }
      
      return `
        <div class="cms-block cms-block-social-proof" data-block="social">
          ${socialText ? `<p style="font-size: 1.1rem; margin-bottom: var(--space-lg);">${socialText}</p>` : ''}
          <div style="display: flex; flex-wrap: wrap; gap: var(--space-md); justify-content: center;">
            ${hasCertifiedGuide ? `<div class="social-badge">‚úì Gu√≠a Certificado</div>` : ''}
            ${hasFlexibleCancellation ? `<div class="social-badge">‚Ü©Ô∏è Cancelaci√≥n Flexible</div>` : ''}
            ${languagesList.length > 0 ? `<div class="social-badge">üåê ${languagesList.join(', ')}</div>` : ''}
          </div>
        </div>
      `;
    }
    
    // BLOQUE 3: Highlights R√°pidos
    function renderHighlightsBlock(tour) {
      const duration = tour.HighlightsDuration || tour.highlightsDuration || `${tour.DurationHours || tour.durationHours || 0} horas`;
      const groupType = tour.HighlightsGroupType || tour.highlightsGroupType || 'Grupo peque√±o';
      const physicalLevel = tour.HighlightsPhysicalLevel || tour.highlightsPhysicalLevel || 'Moderado';
      const meetingPoint = tour.HighlightsMeetingPoint || tour.highlightsMeetingPoint || tour.Location || tour.location || '';
      
      return `
        <div class="cms-block cms-block-highlights" data-block="highlights">
          <div class="highlight-item">
            <div class="highlight-icon">‚è±</div>
            <div>
              <strong>Duraci√≥n</strong>
              <p>${duration}</p>
            </div>
          </div>
          <div class="highlight-item">
            <div class="highlight-icon">üë•</div>
            <div>
              <strong>Tipo de Grupo</strong>
              <p>${groupType}</p>
            </div>
          </div>
          <div class="highlight-item">
            <div class="highlight-icon">üèÉ</div>
            <div>
              <strong>Nivel F√≠sico</strong>
              <p>${physicalLevel}</p>
            </div>
          </div>
          ${meetingPoint ? `
          <div class="highlight-item">
            <div class="highlight-icon">üìç</div>
            <div>
              <strong>Punto de Encuentro</strong>
              <p>${meetingPoint}</p>
            </div>
          </div>
          ` : ''}
        </div>
      `;
    }
    
    // BLOQUE 4: Historia del Tour (WYSIWYG)
    function renderStoryBlock(tour) {
      const storyContent = tour.StoryContent || tour.storyContent || tour.Description || tour.description || '';
      
      return `
        <div class="cms-block cms-block-story" data-block="story">
          <h2>La Experiencia</h2>
          <div class="story-content">
            ${storyContent}
          </div>
        </div>
      `;
    }
    
    // BLOQUE 5: Qu√© Incluye / No Incluye
    function renderIncludesExcludesBlock(tour) {
      const includesList = tour.IncludesList || tour.includesList || tour.Includes || tour.includes || '';
      const excludesList = tour.ExcludesList || tour.excludesList || '';
      
      // Procesar listas (pueden ser JSON o texto separado por l√≠neas)
      let includes = [];
      let excludes = [];
      
      try {
        if (includesList.trim().startsWith('[')) {
          includes = JSON.parse(includesList);
        } else {
          includes = includesList.split('\n').filter(i => i.trim());
        }
      } catch (e) {
        includes = includesList.split('\n').filter(i => i.trim());
      }
      
      try {
        if (excludesList && excludesList.trim().startsWith('[')) {
          excludes = JSON.parse(excludesList);
        } else if (excludesList) {
          excludes = excludesList.split('\n').filter(i => i.trim());
        }
      } catch (e) {
        if (excludesList) {
          excludes = excludesList.split('\n').filter(i => i.trim());
        }
      }
      
      return `
        <div class="cms-block cms-block-includes-excludes" data-block="includes">
          <div>
            <h3>‚úÖ Incluye</h3>
            <ul class="included-list">
              ${includes.map(item => `<li class="included-item"><span class="included-icon">‚úì</span><span>${item}</span></li>`).join('')}
            </ul>
          </div>
          ${excludes.length > 0 ? `
          <div>
            <h3>‚ùå No Incluye</h3>
            <ul class="excluded-list">
              ${excludes.map(item => `<li class="excluded-item"><span class="excluded-icon">‚úó</span><span>${item}</span></li>`).join('')}
            </ul>
          </div>
          ` : ''}
        </div>
      `;
    }
    
    // BLOQUE 6: Disponibilidad y Precio (Sistema)
    function renderAvailabilityBlock(tour) {
      const price = tour.Price ?? tour.price ?? 0;
      const pricePerPerson = price > 0 ? price : 0;
      const availableSpots = tour.AvailableSpots ?? tour.availableSpots ?? 0;
      const maxCapacity = tour.MaxCapacity ?? tour.maxCapacity ?? 0;
      const durationHours = tour.DurationHours ?? tour.durationHours ?? 0;
      const tourId = tour.Id ?? tour.id;
      
      // Urgencia elegante: solo si quedan ‚â§5 cupos y >0 (se mostrar√° din√°micamente cuando haya fecha seleccionada)
      
      // Obtener fecha m√≠nima (ma√±ana)
      const tomorrow = new Date();
      tomorrow.setDate(tomorrow.getDate() + 1);
      const minDate = tomorrow.toISOString().split('T')[0];
      
      // Generar opciones de personas (1 a maxCapacity o 10, lo que sea menor)
      const maxPersons = Math.min(maxCapacity || 10, 10);
      const personOptions = Array.from({ length: maxPersons }, (_, i) => i + 1)
        .map(num => `<option value="${num}">${num} persona${num === 1 ? '' : 's'}</option>`)
        .join('');
      
      return `
        <section class="tour-availability cms-block" data-block="availability" id="availabilityBlock">
          <div class="availability-content">
            <h2 class="info-block-title" style="margin-bottom: var(--space-xl);">Disponibilidad y Precio</h2>
            
            <div class="availability-row">
              <label for="tourDateSelect" class="availability-label">Fecha</label>
              <input 
                type="date" 
                id="tourDateSelect" 
                class="availability-input"
                min="${minDate}"
                onchange="updateAvailabilityPrice()"
              />
            </div>
            
            <div class="availability-row">
              <label for="participantsSelect" class="availability-label">Personas</label>
              <select 
                id="participantsSelect" 
                class="availability-input"
                onchange="updateAvailabilityPrice()"
              >
                ${personOptions}
              </select>
            </div>
            
            <div class="availability-price">
              <span class="availability-price-label">Total</span>
              <strong class="availability-price-amount" id="totalPriceDisplay">$${pricePerPerson.toFixed(2)}</strong>
            </div>
            
            ${urgencyMessage ? `
              <div class="availability-urgency" id="urgencyMsg" data-urgency-tracked="false">
                ${urgencyMessage}
              </div>
            ` : ''}
            
            <button class="btn-booking btn-reserve" onclick="bookTour()" style="width: 100%; margin-top: var(--space-lg);">
              <span class="btn-booking-text">Reservar Ahora</span>
              <span class="btn-booking-icon">‚Üí</span>
            </button>
            
            <p class="availability-microcopy">
              ‚úî Confirmaci√≥n inmediata por email ¬∑ Cancelaci√≥n flexible
            </p>
          </div>
        </section>
      `;
    }
    
    // BLOQUE 7: Mapa
    function renderMapBlock(tour) {
      const coordinates = tour.MapCoordinates || tour.mapCoordinates || '';
      const referenceText = tour.MapReferenceText || tour.mapReferenceText || tour.Location || tour.location || '';
      
      return `
        <div class="cms-block" data-block="map">
          <h2 class="info-block-title">üìç Ubicaci√≥n</h2>
          <div id="tourMap" style="width: 100%; height: 400px; border-radius: var(--radius); overflow: hidden; margin-top: var(--space-md);"></div>
          ${referenceText ? `<p style="margin-top: var(--space-sm); color: var(--text-secondary);">${referenceText}</p>` : ''}
        </div>
      `;
    }
    
    // BLOQUE 8: Reviews (se renderiza despu√©s de cargar)
    function renderReviewsBlock(tour) {
      return `
        <div class="cms-block" data-block="reviews" id="reviewsBlock">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 class="info-block-title">Rese√±as y Calificaciones</h2>
            <button class="btn-secondary" id="writeReviewBtn" onclick="showReviewForm()" style="display:none;">
              Escribir Rese√±a
            </button>
          </div>
          
          <!-- Review Statistics -->
          <div id="reviewStats" class="review-stats" style="display:none;">
            <div class="review-stats-main">
              <div class="review-average">
                <span id="reviewAverage" class="review-average-number">0.0</span>
                <div class="review-stars-large" id="reviewStarsLarge"></div>
                <span class="review-count-text" id="reviewCountText">0 rese√±as</span>
              </div>
              <div class="review-distribution" id="reviewDistribution"></div>
            </div>
          </div>

          <!-- Review Form (hidden by default) -->
          <div id="reviewForm" class="review-form" style="display:none;">
            <h3>Escribe tu Rese√±a</h3>
            <div class="form-group">
              <label>Calificaci√≥n</label>
              <div class="star-rating-input" id="starRatingInput">
                <span class="star" data-rating="1">‚òÜ</span>
                <span class="star" data-rating="2">‚òÜ</span>
                <span class="star" data-rating="3">‚òÜ</span>
                <span class="star" data-rating="4">‚òÜ</span>
                <span class="star" data-rating="5">‚òÜ</span>
              </div>
              <input type="hidden" id="selectedRating" value="0" />
            </div>
            <div class="form-group">
              <label for="reviewTitle">T√≠tulo (opcional)</label>
              <input type="text" id="reviewTitle" class="form-input" placeholder="Resumen de tu experiencia" maxlength="200" />
            </div>
            <div class="form-group">
              <label for="reviewComment">Comentario</label>
              <textarea id="reviewComment" class="form-input" rows="4" placeholder="Comparte tu experiencia..." maxlength="2000"></textarea>
            </div>
            <div style="display: flex; gap: 10px;">
              <button class="btn-primary" onclick="submitReview()">Enviar Rese√±a</button>
              <button class="btn-secondary" onclick="hideReviewForm()">Cancelar</button>
            </div>
          </div>

          <!-- Reviews List -->
          <div id="reviewsList" class="reviews-list"></div>
          <div id="reviewsPagination" class="reviews-pagination" style="display:none;"></div>
        </div>
      `;
    }
    
    // BLOQUE 9: FAQ Contextual
    function renderFaqBlock(tour) {
      return `
        <div class="cms-block" data-block="faq" id="faqBlock">
          <h2 class="info-block-title">Preguntas Frecuentes</h2>
          <div class="faq-list" style="margin-top: var(--space-lg);">
            <details class="faq-item" style="margin-bottom: var(--space-md); padding: var(--space-md); background: var(--bg-secondary); border-radius: var(--radius-sm);">
              <summary style="font-weight: var(--font-weight-semibold); cursor: pointer; color: var(--text);">
                ¬øQu√© incluye el tour?
              </summary>
              <p style="margin-top: var(--space-md); color: var(--text-muted); line-height: 1.6;">
                Incluye transporte, gu√≠a certificado y entradas seg√∫n el tour. Los detalles espec√≠ficos se confirman al momento de la reserva.
              </p>
            </details>
            <details class="faq-item" style="margin-bottom: var(--space-md); padding: var(--space-md); background: var(--bg-secondary); border-radius: var(--radius-sm);">
              <summary style="font-weight: var(--font-weight-semibold); cursor: pointer; color: var(--text);">
                ¬øQu√© pasa si llueve?
              </summary>
              <p style="margin-top: var(--space-md); color: var(--text-muted); line-height: 1.6;">
                El tour se realiza normalmente o se reprograma sin costo adicional, seg√∫n las condiciones clim√°ticas y el tipo de actividad.
              </p>
            </details>
            <details class="faq-item" style="margin-bottom: var(--space-md); padding: var(--space-md); background: var(--bg-secondary); border-radius: var(--radius-sm);">
              <summary style="font-weight: var(--font-weight-semibold); cursor: pointer; color: var(--text);">
                ¬øPuedo cambiar la fecha?
              </summary>
              <p style="margin-top: var(--space-md); color: var(--text-muted); line-height: 1.6;">
                S√≠, puedes cambiar la fecha sujeto a disponibilidad. Contacta con nuestro equipo de soporte para realizar el cambio.
              </p>
            </details>
            <details class="faq-item" style="margin-bottom: var(--space-md); padding: var(--space-md); background: var(--bg-secondary); border-radius: var(--radius-sm);">
              <summary style="font-weight: var(--font-weight-semibold); cursor: pointer; color: var(--text);">
                ¬øCu√°l es la pol√≠tica de cancelaci√≥n?
              </summary>
              <p style="margin-top: var(--space-md); color: var(--text-muted); line-height: 1.6;">
                Ofrecemos cancelaci√≥n flexible. Puedes cancelar hasta 24 horas antes del tour sin penalizaci√≥n. Consulta los t√©rminos espec√≠ficos al reservar.
              </p>
            </details>
          </div>
        </div>
      `;
    }
    
    // BLOQUE 10: CTA Final
    function renderFinalCtaBlock(tour) {
      const ctaText = tour.FinalCtaText || tour.finalCtaText || '¬øListo para vivir esta experiencia?';
      const ctaButtonText = tour.FinalCtaButtonText || tour.finalCtaButtonText || 'Ver fechas disponibles';
      
      return `
        <div class="cms-block cms-block-final-cta" data-block="final_cta">
          <h2 style="font-size: 2rem; margin-bottom: var(--space-md);">${ctaText}</h2>
          <button class="btn-booking" onclick="bookTour()" style="font-size: 1.2rem; padding: var(--space-lg) var(--space-2xl);">
            <span class="btn-booking-text">${ctaButtonText}</span>
            <span class="btn-booking-icon">‚Üí</span>
          </button>
        </div>
      `;
    }
    
    // Inicializar funcionalidades despu√©s de renderizar bloques
    function initializeBlocksAfterRender(tour) {
      // Inicializar mapa si existe el bloque
      const mapBlock = document.querySelector('[data-block="map"]');
      if (mapBlock) {
        const location = tour.Location || tour.location || '';
        const coordinates = tour.MapCoordinates || tour.mapCoordinates || '';
        if (location || coordinates) {
          setTimeout(() => {
            initTourMap(location, coordinates);
          }, 500);
        }
      }
      
      // Inicializar carrusel de im√°genes si hay m√∫ltiples im√°genes
      const tourImages = tour.TourImages || tour.tourImages || [];
      if (tourImages.length > 1) {
        initializeImageCarousel(tourImages, tour.Name || tour.name || 'Tour');
      }
      
      // Inicializar rating stars en formulario de review
      const starRatingInput = document.getElementById('starRatingInput');
      if (starRatingInput) {
        const stars = starRatingInput.querySelectorAll('.star');
        stars.forEach((star, index) => {
          star.onclick = () => {
            const rating = index + 1;
            document.getElementById('selectedRating').value = rating;
            stars.forEach((s, i) => {
              s.textContent = i < rating ? '‚≠ê' : '‚òÜ';
            });
          };
        });
      }
    }
    
    // Inicializar carrusel de im√°genes
    function initializeImageCarousel(tourImages, tourName) {
      const gallerySection = document.getElementById('imageGallerySection');
      const carouselTrack = document.getElementById('carouselTrack');
      const carouselThumbnails = document.getElementById('carouselThumbnails');
      
      if (!gallerySection || !carouselTrack || !carouselThumbnails) return;
      
      // Limpiar carrusel anterior
      carouselTrack.innerHTML = '';
      carouselThumbnails.innerHTML = '';
      
      // Filtrar im√°genes v√°lidas
      const validImages = tourImages.filter(image => {
        const imgUrl = image.ImageUrl || image.imageUrl;
        return imgUrl && imgUrl.trim() !== '';
      });
      
      if (validImages.length > 1) {
        validImages.forEach((image, index) => {
          const imgUrl = image.ImageUrl || image.imageUrl;
          const altText = image.AltText || image.altText || `${tourName} - Imagen ${index + 1}`;
          
          // Slide principal
          const slide = document.createElement('div');
          slide.className = 'carousel-slide';
          slide.dataset.index = index;
          slide.innerHTML = `<img src="${imgUrl}" alt="${altText}" loading="lazy" />`;
          carouselTrack.appendChild(slide);
          
          // Thumbnail
          const thumbnail = document.createElement('div');
          thumbnail.className = 'carousel-thumbnail';
          thumbnail.dataset.index = index;
          if (index === 0) thumbnail.classList.add('active');
          thumbnail.innerHTML = `<img src="${imgUrl}" alt="${altText}" loading="lazy" />`;
          thumbnail.onclick = () => goToImage(index);
          carouselThumbnails.appendChild(thumbnail);
        });
        
        // Actualizar indicadores
        const totalImagesEl = document.getElementById('totalImages');
        const modalTotalImagesEl = document.getElementById('modalTotalImages');
        if (totalImagesEl) totalImagesEl.textContent = validImages.length;
        if (modalTotalImagesEl) modalTotalImagesEl.textContent = validImages.length;
        
        // Guardar im√°genes para uso global
        const imagesData = validImages.map(img => ({
          url: img.ImageUrl || img.imageUrl,
          alt: img.AltText || img.altText || tourName
        }));
        window.carouselImages = imagesData;
        window.currentCarouselIndex = 0;
        carouselImages = imagesData;
        currentCarouselIndex = 0;
        
        // Inicializar navegaci√≥n
        initCarouselNavigation();
        
        // Mostrar secci√≥n de galer√≠a
        gallerySection.style.display = 'block';
      }
    }
    
    // Actualizar precio din√°mico seg√∫n personas seleccionadas
    function updateAvailabilityPrice() {
      if (!currentTour) return;
      
      const pricePerPerson = currentTour.Price ?? currentTour.price ?? 0;
      const participantsSelect = document.getElementById('participantsSelect');
      const totalPriceDisplay = document.getElementById('totalPriceDisplay');
      
      if (!participantsSelect || !totalPriceDisplay) return;
      
      const participants = parseInt(participantsSelect.value) || 1;
      const totalPrice = pricePerPerson * participants;
      
      totalPriceDisplay.textContent = `$${totalPrice.toFixed(2)}`;
      
      // Actualizar sticky CTA tambi√©n
      updateStickyCtaPrice(totalPrice, participants);
      
      // Actualizar urgencia
      updateUrgencyMessage();
    }
    
    // Actualizar mensaje de urgencia (solo si hay fecha seleccionada y cupos ‚â§ 5)
    function updateUrgencyMessage() {
      if (!currentTour) return;
      
      const dateSelect = document.getElementById('tourDateSelect');
      const urgencyMsg = document.getElementById('urgencyMsg');
      
      if (!urgencyMsg || !dateSelect) return;
      
      const hasDate = dateSelect.value && dateSelect.value.trim() !== '';
      const availableSpots = currentTour.AvailableSpots ?? currentTour.availableSpots ?? 0;
      const showUrgency = hasDate && availableSpots > 0 && availableSpots <= 5;
      
      if (showUrgency) {
        urgencyMsg.style.display = 'block';
        urgencyMsg.innerHTML = `‚ö†Ô∏è Quedan solo <strong>${availableSpots}</strong> cupo${availableSpots === 1 ? '' : 's'} para esta fecha`;
      } else {
        urgencyMsg.style.display = 'none';
      }
    }
    
    // Actualizar precio en sticky CTA
    function updateStickyCtaPrice(totalPrice, participants) {
      const stickyPrice = document.getElementById('stickyPrice');
      if (stickyPrice) {
        stickyPrice.textContent = `$${totalPrice.toFixed(2)}`;
      }
      const stickyAvailability = document.getElementById('stickyAvailability');
      if (stickyAvailability && currentTour) {
        const availableSpots = currentTour.AvailableSpots ?? currentTour.availableSpots ?? 0;
        stickyAvailability.textContent = `${participants} persona${participants === 1 ? '' : 's'} ¬∑ ${availableSpots} cupos`;
      }
    }
    
    // Actualizar Sticky CTA
    function updateStickyCta(tour) {
      const stickyCta = document.getElementById('stickyAvailabilityCta');
      if (!stickyCta) return;
      
      const price = tour.Price ?? tour.price ?? 0;
      const priceText = price > 0 ? `$${price.toFixed(2)}` : 'Consultar precio';
      const availableSpots = tour.AvailableSpots ?? tour.availableSpots ?? 0;
      
      document.getElementById('stickyPrice').textContent = priceText;
      document.getElementById('stickyAvailability').textContent = `1 persona ¬∑ ${availableSpots} cupos disponibles`;
      
      // Mostrar sticky CTA cuando el bloque availability sale de vista
      const availabilityBlock = document.getElementById('availabilityBlock');
      if (!availabilityBlock) {
        // Fallback: mostrar despu√©s de 300px de scroll
        window.addEventListener('scroll', () => {
          if (window.scrollY > 300) {
            stickyCta.style.display = 'flex';
          } else {
            stickyCta.style.display = 'none';
          }
        });
        return;
      }
      
      // L√≥gica premium: mostrar cuando availability sale de vista
      let stickyCtaTracked = false;
      let scrollHandler = null;
      scrollHandler = () => {
        const rect = availabilityBlock.getBoundingClientRect();
        // Si el bloque est√° fuera de la vista (arriba), mostrar sticky
        if (rect.bottom < 0) {
          stickyCta.style.display = 'flex';
          
          // Track: sticky_cta_shown (solo primera vez)
          if (!stickyCtaTracked && window.track) {
            const tourId = tour.Id || tour.id;
            window.track('sticky_cta_shown', {
              entityType: 'tour',
              entityId: tourId
            });
            stickyCtaTracked = true;
          }
        } else {
          stickyCta.style.display = 'none';
        }
      };
      
      window.addEventListener('scroll', scrollHandler, { passive: true });
      
      // Tambi√©n verificar en resize
      window.addEventListener('resize', scrollHandler, { passive: true });
    }
    
    // Actualizar initTourMap para aceptar coordenadas
    function initTourMap(location, coordinates) {
      const mapDiv = document.getElementById('tourMap');
      if (!mapDiv) return;
      
      if (typeof google === 'undefined' || typeof google.maps === 'undefined') {
        mapDiv.innerHTML = `
          <div style="display: flex; align-items: center; justify-content: center; height: 100%; background: var(--bg-secondary); color: var(--text-muted);">
            <div style="text-align: center;">
              <p>üìç ${location || 'Ubicaci√≥n'}</p>
              <p style="font-size: var(--text-sm); margin-top: var(--space-sm);">Mapa interactivo disponible con Google Maps API</p>
            </div>
          </div>
        `;
        return;
      }
      
      // Si hay coordenadas, usarlas directamente
      if (coordinates) {
        const [lat, lng] = coordinates.split(',').map(c => parseFloat(c.trim()));
        if (!isNaN(lat) && !isNaN(lng)) {
          tourMap = new google.maps.Map(mapDiv, {
            center: { lat, lng },
            zoom: 14
          });
          new google.maps.Marker({
            position: { lat, lng },
            map: tourMap,
            title: currentTour?.Name || currentTour?.name || 'Tour'
          });
          return;
        }
      }
      
      // Si no hay coordenadas, geocodificar ubicaci√≥n
      if (location) {
        const geocoder = new google.maps.Geocoder();
        geocoder.geocode({ address: location }, (results, status) => {
          if (status === 'OK' && results[0]) {
            const location_coords = results[0].geometry.location;
            tourMap = new google.maps.Map(mapDiv, {
              center: location_coords,
              zoom: 14
            });
            new google.maps.Marker({
              position: location_coords,
              map: tourMap,
              title: currentTour?.Name || currentTour?.name || 'Tour'
            });
          }
        });
      }
    }

    // Funci√≥n para cargar reviews en el bloque CMS
    async function loadReviewsForBlock(tourId) {
      const reviewsBlock = document.getElementById('reviewsBlock');
      if (!reviewsBlock) return;
      
      try {
        const response = await api.getTourReviews(tourId, 1, 5); // Top 5 reviews
        const reviews = response.Reviews || response.reviews || [];
        const statistics = response.Statistics || response.statistics;
        
        // Calcular rating promedio
        let averageRating = 0;
        if (statistics && statistics.AverageRating !== undefined) {
          averageRating = statistics.AverageRating || statistics.averageRating || 0;
        } else if (reviews && reviews.length > 0) {
          const sum = reviews.reduce((acc, r) => acc + (r.Rating || r.rating || 0), 0);
          averageRating = sum / reviews.length;
        }
        
        // Actualizar rating en hero si existe
        const heroRatingEl = document.getElementById('heroRating');
        const heroRatingMeta = document.querySelector('.tour-meta-item[data-rating]');
        if (heroRatingEl && averageRating > 0) {
          heroRatingEl.textContent = averageRating.toFixed(1);
          if (heroRatingMeta) heroRatingMeta.style.display = 'flex';
        }
        
        // Mostrar top 3-5 reviews
        const topReviews = reviews.slice(0, 5);
        const reviewsList = document.getElementById('reviewsList');
        if (reviewsList) {
          if (topReviews.length === 0) {
            reviewsList.innerHTML = ''; // El empty state se maneja arriba
          } else {
            reviewsList.innerHTML = topReviews.map(review => {
              const rating = review.Rating || review.rating || 0;
              const comment = review.Comment || review.comment || '';
              const title = review.Title || review.title || '';
              const userName = review.UserName || review.userName || 'Usuario';
              const createdAt = review.CreatedAt || review.createdAt;
              const dateStr = createdAt ? new Date(createdAt).toLocaleDateString('es-PA') : '';
              
              return `
                <div class="review-item" style="padding: var(--space-lg); background: var(--card); border-radius: var(--radius); margin-bottom: var(--space-md); border: 1px solid var(--border);">
                  <div style="display: flex; justify-content: space-between; margin-bottom: var(--space-sm);">
                    <div>
                      <strong>${userName}</strong>
                      ${review.IsVerified || review.isVerified ? '<span style="color: var(--accent); font-size: 0.85rem; margin-left: 8px;">‚úì Verificado</span>' : ''}
                      <div class="review-stars" style="margin-top: 4px;">
                        ${'‚≠ê'.repeat(Math.floor(rating))}${rating % 1 >= 0.5 ? '‚≠ê' : ''}
                      </div>
                    </div>
                    ${dateStr ? `<span style="color: var(--text-muted); font-size: 0.9rem;">${dateStr}</span>` : ''}
                  </div>
                  ${title ? `<h4 style="margin: var(--space-sm) 0; color: var(--text);">${title}</h4>` : ''}
                  ${comment ? `<p style="color: var(--text); margin-top: var(--space-sm); line-height: 1.6;">${comment}</p>` : ''}
                </div>
              `;
            }).join('');
            
            const totalCount = response.TotalCount || response.totalCount || reviews.length;
            if (totalCount > 5) {
              reviewsList.innerHTML += `
                <div style="text-align: center; margin-top: var(--space-lg);">
                  <button class="btn-secondary" onclick="showAllReviews('${tourId}')">Ver todas las rese√±as (${totalCount})</button>
                </div>
              `;
            }
          }
        }
        
        // Actualizar estad√≠sticas (solo mostrar si hay reviews)
        const reviewStats = document.getElementById('reviewStats');
        const reviewAverage = document.getElementById('reviewAverage');
        const reviewCountText = document.getElementById('reviewCountText');
        const reviewStarsLarge = document.getElementById('reviewStarsLarge');
        const emptyReviewsState = document.getElementById('emptyReviewsState');
        
        if (reviews.length === 0 || averageRating === 0) {
          // No mostrar 0 estrellas - mostrar empty state
          if (reviewStats) reviewStats.style.display = 'none';
          if (emptyReviewsState) emptyReviewsState.style.display = 'block';
        } else {
          // Mostrar estad√≠sticas solo si hay reviews
          if (reviewStats) reviewStats.style.display = 'block';
          if (emptyReviewsState) emptyReviewsState.style.display = 'none';
          if (reviewAverage) reviewAverage.textContent = averageRating.toFixed(1);
          if (reviewCountText) {
            const totalCount = statistics?.TotalReviews || statistics?.totalReviews || reviews.length;
            reviewCountText.textContent = `${totalCount} ${totalCount === 1 ? 'rese√±a' : 'rese√±as'}`;
          }
          if (reviewStarsLarge) {
            reviewStarsLarge.innerHTML = '‚≠ê'.repeat(Math.floor(averageRating));
          }
        }
        
        // Mostrar bot√≥n de escribir rese√±a si est√° autenticado
        const token = localStorage.getItem('authToken') || localStorage.getItem('accessToken');
        const writeReviewBtn = document.getElementById('writeReviewBtn');
        if (writeReviewBtn && token) {
          writeReviewBtn.style.display = 'block';
        }
      } catch (error) {
        console.error('Error loading reviews:', error);
        const reviewsList = document.getElementById('reviewsList');
        if (reviewsList) {
          reviewsList.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: var(--space-xl);">No se pudieron cargar las rese√±as en este momento.</p>';
        }
      }
    }
    
    function showAllReviews(tourId) {
      // Redirigir a p√°gina de reviews completa o mostrar modal
      window.location.href = `/tour-detail.html?id=${tourId}#reviews`;
    }
    
    function showReviewForm() {
      const token = localStorage.getItem('authToken') || localStorage.getItem('accessToken');
      if (!token) {
        window.location.href = '/login.html?redirect=' + encodeURIComponent(window.location.href);
        return;
      }
      
      const form = document.getElementById('reviewForm');
      if (form) {
        form.style.display = 'block';
        // Inicializar estrellas
        const stars = form.querySelectorAll('.star');
        stars.forEach((star, index) => {
          star.onclick = () => {
            const rating = index + 1;
            document.getElementById('selectedRating').value = rating;
            stars.forEach((s, i) => {
              s.textContent = i < rating ? '‚≠ê' : '‚òÜ';
            });
          };
        });
      }
    }
    
    function hideReviewForm() {
      const form = document.getElementById('reviewForm');
      if (form) {
        form.style.display = 'none';
        // Resetear formulario
        document.getElementById('reviewTitle').value = '';
        document.getElementById('reviewComment').value = '';
        document.getElementById('selectedRating').value = '0';
        document.querySelectorAll('#starRatingInput .star').forEach(star => {
          star.textContent = '‚òÜ';
        });
      }
    }
    
    async function submitReview() {
      const tourId = currentTour?.Id || currentTour?.id;
      if (!tourId) return;
      
      const rating = parseInt(document.getElementById('selectedRating')?.value || '0');
      const title = document.getElementById('reviewTitle')?.value.trim() || '';
      const comment = document.getElementById('reviewComment')?.value.trim() || '';
      
      if (rating === 0) {
        alert('Por favor selecciona una calificaci√≥n');
        return;
      }
      
      if (!comment) {
        alert('Por favor escribe un comentario');
        return;
      }
      
      try {
        await api.createReview(tourId, rating, title, comment);
        hideReviewForm();
        // Limpiar formulario
        document.getElementById('reviewTitle').value = '';
        document.getElementById('reviewComment').value = '';
        document.getElementById('selectedRating').value = '0';
        // Resetear estrellas
        document.querySelectorAll('#starRatingInput .star').forEach(star => {
          star.textContent = '‚òÜ';
        });
        
        await loadReviewsForBlock(tourId);
        if (typeof notificationManager !== 'undefined') {
          notificationManager.success('Rese√±a enviada exitosamente. Estar√° visible despu√©s de la moderaci√≥n.');
        } else {
          alert('Rese√±a enviada exitosamente. Estar√° visible despu√©s de la moderaci√≥n.');
        }
      } catch (error) {
        console.error('Error submitting review:', error);
        const errorMsg = error.message || 'Error al enviar la rese√±a. Por favor intenta de nuevo.';
        if (typeof notificationManager !== 'undefined') {
          notificationManager.error(errorMsg);
        } else {
          alert(errorMsg);
        }
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      loadTour();
      loadUserInfo();
    });
  </script>
</body>
</html>