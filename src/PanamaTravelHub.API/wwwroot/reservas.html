<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mis Reservas ‚Äî ToursPanama</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="stylesheet" href="/css/main.css" />
  <link rel="stylesheet" href="/css/reservations.css" />
  <link rel="stylesheet" href="/css/loading.css" />
  <style>
  </style>
</head>
<body>
  <nav class="nav">
    <div class="nav-inner wrap">
      <div class="brand">
        <div class="mark"></div>
        <a href="/"><span class="brand-text">ToursPanama</span></a>
      </div>
      <div class="nav-links">
        <a href="/" class="nav-link">Tours</a>
        <a href="/reservas.html" class="nav-link active">Mis Reservas</a>
        <span class="nav-user-greeting" id="userGreeting" style="display:none;"></span>
        <a href="/login.html" class="nav-link" id="loginLink">Iniciar Sesi√≥n</a>
        <button class="btn-primary" id="logoutBtn" style="display:none;">Cerrar Sesi√≥n</button>
      </div>
    </div>
  </nav>

  <main class="reservations-container wrap">
    <div class="section-header">
      <h1>Mis Reservas</h1>
      <p class="section-subtitle">Gestiona tus reservas de tours</p>
    </div>

    <!-- Mensaje cuando no est√° autenticado -->
    <div id="authRequired" class="auth-required-container" style="display:none;">
      <div class="auth-required-content">
        <div class="auth-required-icon">üîí</div>
        <h2 class="auth-required-title">
          Inicia Sesi√≥n para Ver tus Reservas
        </h2>
        <p class="auth-required-message">
          Necesitas iniciar sesi√≥n para acceder a tus reservas y gestionar tus tours.
        </p>
        <a href="/login.html?redirect=/reservas.html" class="btn-primary">
          Iniciar Sesi√≥n
        </a>
      </div>
    </div>

    <!-- Contenido cuando est√° autenticado -->
    <div id="authenticatedContent" style="display:none;">
      <div id="loadingState" class="loading" style="display:none;">
        <div class="spinner"></div>
        <p>Cargando reservas...</p>
      </div>

      <div id="reservationsList"></div>

      <div id="emptyState" class="empty-state empty-state-container" style="display:none;">
        <div class="empty-state-icon">üìã</div>
        <h2 class="empty-state-title">
          No tienes reservas a√∫n
        </h2>
        <p class="empty-state-message">
          Explora nuestros tours y reserva tu pr√≥xima aventura en Panam√°.
        </p>
        <a href="/" class="btn-primary">Explorar Tours</a>
      </div>
    </div>
  </main>

  <script src="/js/loading.js"></script>
  <script src="/js/logger.js"></script>
  <script src="/js/api.js"></script>
  <script>
    // ‚úÖ Funci√≥n helper para formatear precios de forma segura
    function formatPrice(value, fallbackText = '$0.00') {
      const rawPrice = value ?? null;
      let price = Number(rawPrice ?? 0);
      
      // Validaci√≥n: asegurar que price es un n√∫mero v√°lido y finito
      if (typeof price !== 'number' || isNaN(price) || !isFinite(price)) {
        console.warn('‚ö†Ô∏è [formatPrice] Precio inv√°lido, usando 0:', { value, rawPrice, price });
        price = 0;
      }
      
      // Formatear precio
      const formattedPrice = price.toFixed(2);
      return price > 0 ? `$${formattedPrice}` : fallbackText;
    }

    document.addEventListener('DOMContentLoaded', () => {
      // Primero verificar autenticaci√≥n
      const isAuthenticated = checkAuth();
      // Solo cargar reservas si est√° autenticado
      if (isAuthenticated) {
        loadReservations();
      }
    });

    // Cargar informaci√≥n del usuario autenticado
    async function loadUserInfo() {
      const token = localStorage.getItem('authToken') || localStorage.getItem('accessToken');
      const userGreeting = document.getElementById('userGreeting');
      
      if (!token || !userGreeting) {
        if (userGreeting) userGreeting.style.display = 'none';
        return;
      }

      try {
        // Intentar obtener el nombre desde localStorage primero
        let userName = localStorage.getItem('userName');
        
        // Si no hay nombre guardado, obtenerlo de la API
        if (!userName) {
          const currentUser = await api.getCurrentUser();
          if (currentUser) {
            const firstName = currentUser.FirstName || currentUser.firstName || '';
            const lastName = currentUser.LastName || currentUser.lastName || '';
            userName = `${firstName} ${lastName}`.trim();
            
            // Guardar en localStorage para futuras cargas
            if (userName) {
              localStorage.setItem('userName', userName);
            }
          }
        }
        
        // Mostrar el saludo si hay nombre
        if (userName) {
          userGreeting.textContent = `Hola, ${userName}`;
          userGreeting.style.display = 'inline-flex';
        } else {
          userGreeting.style.display = 'none';
        }
      } catch (error) {
        console.warn('No se pudo cargar la informaci√≥n del usuario:', error);
        if (userGreeting) userGreeting.style.display = 'none';
        localStorage.removeItem('userName');
      }
    }

    function checkAuth() {
      const token = localStorage.getItem('authToken') || localStorage.getItem('accessToken');
      const loginLink = document.getElementById('loginLink');
      const logoutBtn = document.getElementById('logoutBtn');
      const authRequired = document.getElementById('authRequired');
      const authenticatedContent = document.getElementById('authenticatedContent');
      const userGreeting = document.getElementById('userGreeting');

      if (!token) {
        // No autenticado: mostrar mensaje de login
        authRequired.style.display = 'block';
        authenticatedContent.style.display = 'none';
        if (loginLink) loginLink.style.display = 'block';
        if (logoutBtn) logoutBtn.style.display = 'none';
        if (userGreeting) userGreeting.style.display = 'none';
        localStorage.removeItem('userName');
        return false;
      }

      // Verificar si el usuario es admin - si es admin, redirigir al panel de administraci√≥n
      const userRoles = JSON.parse(localStorage.getItem('userRoles') || '[]');
      const isAdmin = Array.isArray(userRoles) && (
        userRoles.some(role => role && role.toLowerCase() === 'admin')
      );

      if (isAdmin) {
        console.log('‚ö†Ô∏è [reservas] Usuario admin intentando acceder a reservas, redirigiendo a Admin');
        window.location.href = '/Admin';
        return false;
      }

      // Autenticado y NO es admin: mostrar contenido
      authRequired.style.display = 'none';
      authenticatedContent.style.display = 'block';
      if (loginLink) loginLink.style.display = 'none';
      if (logoutBtn) logoutBtn.style.display = 'block';
      
      // Cargar informaci√≥n del usuario para mostrar su nombre
      loadUserInfo();
      
      return true;
    }

    async function loadReservations() {
      // Verificar autenticaci√≥n primero
      const isAuthenticated = checkAuth();
      if (!isAuthenticated) {
        return; // No cargar nada si no est√° autenticado
      }

      const loadingState = document.getElementById('loadingState');
      const emptyState = document.getElementById('emptyState');
      const reservationsList = document.getElementById('reservationsList');

      try {
        loadingState.style.display = 'block';
        emptyState.style.display = 'none';
        const loaderId = loadingManager.showInline(reservationsList, 'Cargando tus reservas...');

        // Llamar a la API real
        let reservations = [];
        try {
          reservations = await api.getMyBookings();
          loadingManager.hideInline(reservationsList);
        } catch (error) {
          console.warn('Error al cargar reservas:', error);
          // Si es error 401 (no autorizado), limpiar token y redirigir
          if (error.message && error.message.includes('401')) {
            await api.logout();
            window.location.href = '/';
            return;
          }
          reservations = [];
        }

        loadingState.style.display = 'none';

        if (reservations.length === 0) {
          emptyState.style.display = 'block';
          return;
        }

        reservationsList.innerHTML = reservations.map(res => createReservationCard(res)).join('');
      } catch (error) {
        console.error('Error loading reservations:', error);
        loadingState.style.display = 'none';
        emptyState.style.display = 'block';
      }
    }

    function createReservationCard(reservation) {
      // Helper para obtener valores manejando PascalCase y camelCase
      const getValue = (obj, pascalKey, camelKey, defaultValue = null) => {
        return obj[pascalKey] ?? obj[camelKey] ?? defaultValue;
      };
      
      // Extraer valores manejando ambos casos
      const status = getValue(reservation, 'Status', 'status', 'Pending');
      const tourName = getValue(reservation, 'TourName', 'tourName', 'Tour sin nombre');
      const reservationId = getValue(reservation, 'Id', 'id', '');
      const createdAt = getValue(reservation, 'CreatedAt', 'createdAt');
      const numberOfParticipants = getValue(reservation, 'NumberOfParticipants', 'numberOfParticipants', 0);
      const totalAmount = getValue(reservation, 'TotalAmount', 'totalAmount', 0);
      const tourDate = getValue(reservation, 'TourDate', 'tourDate');
      
      // Normalizar status a min√∫sculas para la clase CSS
      const statusLower = (status || '').toLowerCase();
      const statusClass = `status-${statusLower}`;
      
      // Mapeo de estados
      const statusText = {
        'pending': 'Pendiente',
        'confirmed': 'Confirmada',
        'cancelled': 'Cancelada',
        'expired': 'Expirada',
        'completed': 'Completada'
      }[statusLower] || status || 'Desconocido';

      // Formatear ID de reserva (solo si existe)
      const reservationIdDisplay = reservationId ? `#${reservationId.substring(0, 8)}` : '#N/A';
      
      // Formatear fecha de creaci√≥n
      const createdAtDisplay = createdAt ? new Date(createdAt).toLocaleDateString('es-PA') : 'N/A';
      
      // Formatear fecha del tour
      const tourDateDisplay = tourDate ? new Date(tourDate).toLocaleDateString('es-PA') : 'Por definir';

      return `
        <div class="reservation-card">
          <div class="reservation-header">
            <div>
              <h3 style="margin-bottom: var(--spacing-xs);">${tourName}</h3>
              <p style="color: var(--text-muted);">Reserva ${reservationIdDisplay}</p>
            </div>
            <span class="reservation-status ${statusClass}">${statusText}</span>
          </div>
          <div class="reservation-details">
            <div class="detail-item">
              <div class="detail-label">Fecha de Reserva</div>
              <div class="detail-value">${createdAtDisplay}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Participantes</div>
              <div class="detail-value">${numberOfParticipants}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Total</div>
              <div class="detail-value">${formatPrice(totalAmount)}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Fecha del Tour</div>
              <div class="detail-value">${tourDateDisplay}</div>
            </div>
          </div>
        </div>
      `;
    }

    if (document.getElementById('logoutBtn')) {
      document.getElementById('logoutBtn').addEventListener('click', async () => {
        await api.logout();
        window.location.href = '/';
      });
    }
  </script>
</body>
</html>
