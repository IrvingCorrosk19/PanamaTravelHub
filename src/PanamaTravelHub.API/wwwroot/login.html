<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Iniciar Sesión — ToursPanama</title>
  <link rel="stylesheet" href="/css/main.css" />
  <link rel="stylesheet" href="/css/auth.css" />
</head>
<body>
  <nav class="nav">
    <div class="nav-inner wrap">
      <div class="brand">
        <div class="mark"></div>
        <a href="/"><span class="brand-text">ToursPanama</span></a>
      </div>
      <div class="nav-links">
        <a href="/" class="nav-link">Tours</a>
      </div>
    </div>
  </nav>

  <div class="auth-container">
    <div class="auth-card">
      <div class="auth-header">
        <h1 id="authTitle">Iniciar Sesión</h1>
        <p id="authSubtitle">Accede a tu cuenta para reservar tours</p>
      </div>

      <div id="errorMessage" class="error-message"></div>

      <form id="authForm" onsubmit="handleSubmit(event)">
        <div class="form-group">
          <label class="form-label" for="email">Correo Electrónico</label>
          <input type="email" id="email" class="form-input" required autocomplete="email" placeholder="tu@email.com" />
        </div>

        <div class="form-group">
          <label class="form-label" for="password">Contraseña</label>
          <input type="password" id="password" class="form-input" required autocomplete="current-password" placeholder="••••••••" />
        </div>

        <div class="form-group" id="confirmPasswordGroup" style="display:none;">
          <label class="form-label" for="confirmPassword">Confirmar Contraseña</label>
          <input type="password" id="confirmPassword" class="form-input" autocomplete="new-password" placeholder="••••••••" />
        </div>

        <div class="form-group" id="nameGroup" style="display:none;">
          <label class="form-label" for="firstName">Nombre</label>
          <input type="text" id="firstName" class="form-input" autocomplete="given-name" placeholder="Tu nombre" />
        </div>

        <div class="form-group" id="lastNameGroup" style="display:none;">
          <label class="form-label" for="lastName">Apellido</label>
          <input type="text" id="lastName" class="form-input" autocomplete="family-name" placeholder="Tu apellido" />
        </div>

        <button type="submit" class="btn-primary" style="width: 100%; margin-top: 8px;">
          <span id="submitText">Iniciar Sesión</span>
        </button>
      </form>

      <div class="form-toggle">
        <span id="toggleText">¿No tienes cuenta? </span>
        <a href="#" id="toggleLink" onclick="toggleMode(event)">Regístrate</a>
      </div>
    </div>
  </div>

  <script src="/js/api.js"></script>
  <script>
    let isLoginMode = true;

    function toggleMode(e) {
      e.preventDefault();
      isLoginMode = !isLoginMode;

      const title = document.getElementById('authTitle');
      const subtitle = document.getElementById('authSubtitle');
      const submitText = document.getElementById('submitText');
      const toggleText = document.getElementById('toggleText');
      const toggleLink = document.getElementById('toggleLink');
      const confirmPasswordGroup = document.getElementById('confirmPasswordGroup');
      const nameGroup = document.getElementById('nameGroup');
      const lastNameGroup = document.getElementById('lastNameGroup');
      const confirmPassword = document.getElementById('confirmPassword');
      const firstName = document.getElementById('firstName');
      const lastName = document.getElementById('lastName');

      if (isLoginMode) {
        title.textContent = 'Iniciar Sesión';
        subtitle.textContent = 'Accede a tu cuenta para reservar tours';
        submitText.textContent = 'Iniciar Sesión';
        toggleText.textContent = '¿No tienes cuenta? ';
        toggleLink.textContent = 'Regístrate';
        confirmPasswordGroup.style.display = 'none';
        nameGroup.style.display = 'none';
        lastNameGroup.style.display = 'none';
        confirmPassword.removeAttribute('required');
        firstName.removeAttribute('required');
        lastName.removeAttribute('required');
      } else {
        title.textContent = 'Crear Cuenta';
        subtitle.textContent = 'Únete a ToursPanama y descubre Panamá';
        submitText.textContent = 'Registrarse';
        toggleText.textContent = '¿Ya tienes cuenta? ';
        toggleLink.textContent = 'Inicia Sesión';
        confirmPasswordGroup.style.display = 'block';
        nameGroup.style.display = 'block';
        lastNameGroup.style.display = 'block';
        confirmPassword.setAttribute('required', 'required');
        firstName.setAttribute('required', 'required');
        lastName.setAttribute('required', 'required');
      }
    }

    async function handleSubmit(e) {
      e.preventDefault();
      const errorDiv = document.getElementById('errorMessage');
      errorDiv.style.display = 'none';

      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;

      // Validación básica
      if (!email || !password) {
        errorDiv.textContent = 'Por favor completa todos los campos requeridos';
        errorDiv.style.display = 'block';
        return;
      }

      try {
        if (isLoginMode) {
          await api.login(email, password);
        } else {
          const firstName = document.getElementById('firstName').value.trim();
          const lastName = document.getElementById('lastName').value.trim();
          const confirmPassword = document.getElementById('confirmPassword').value;

          // Validaciones de registro
          if (!firstName || !lastName) {
            errorDiv.textContent = 'Por favor completa todos los campos';
            errorDiv.style.display = 'block';
            return;
          }

          // Comparar contraseñas sin espacios
          const passwordTrimmed = password.trim();
          const confirmPasswordTrimmed = confirmPassword.trim();

          if (passwordTrimmed !== confirmPasswordTrimmed) {
            errorDiv.textContent = 'Las contraseñas no coinciden. Por favor verifica que ambas sean iguales.';
            errorDiv.style.display = 'block';
            return;
          }

          if (passwordTrimmed.length < 6) {
            errorDiv.textContent = 'La contraseña debe tener al menos 6 caracteres';
            errorDiv.style.display = 'block';
            return;
          }

          await api.register({ 
            email, 
            password: passwordTrimmed, 
            confirmPassword: confirmPasswordTrimmed,
            firstName, 
            lastName 
          });
        }

        // Redirect
        const urlParams = new URLSearchParams(window.location.search);
        const redirect = urlParams.get('redirect') || '/';
        window.location.href = redirect;
      } catch (error) {
        errorDiv.textContent = error.message || 'Error al procesar la solicitud';
        errorDiv.style.display = 'block';
      }
    }
  </script>
</body>
</html>