<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Iniciar Sesi√≥n ‚Äî ToursPanama</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="stylesheet" href="/css/main.css" />
  <link rel="stylesheet" href="/css/auth.css" />
  <link rel="stylesheet" href="/css/loading.css" />
</head>
<body>
  <nav class="nav">
    <div class="nav-inner wrap">
      <div class="brand">
        <div class="mark"></div>
        <a href="/"><span class="brand-text">ToursPanama</span></a>
      </div>
      <div class="nav-links">
        <a href="/" class="nav-link">Tours</a>
      </div>
    </div>
  </nav>

  <div class="auth-container">
    <div class="auth-card">
      <div class="auth-header">
        <h1 id="authTitle">Iniciar Sesi√≥n</h1>
        <p id="authSubtitle">Accede a tu cuenta para reservar tours</p>
      </div>

      <div id="errorMessage" class="error-message"></div>

      <form id="authForm" onsubmit="handleSubmit(event)">
        <div class="form-group">
          <label class="form-label" for="email">Correo Electr√≥nico</label>
          <input type="email" id="email" class="form-input" required autocomplete="email" placeholder="tu@email.com" />
          <span class="field-error" id="emailError"></span>
        </div>

        <div class="form-group">
          <label class="form-label" for="password">Contrase√±a</label>
          <input type="password" id="password" class="form-input" required autocomplete="current-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" minlength="8" />
          <span class="field-error" id="passwordError"></span>
          <!-- Indicador de fortaleza de contrase√±a (solo en modo registro) -->
          <div id="passwordStrength" style="display:none; margin-top: 8px;">
            <div class="password-strength-bar">
              <div id="passwordStrengthFill" class="password-strength-fill"></div>
            </div>
            <div id="passwordStrengthText" class="password-strength-text"></div>
            <ul id="passwordRequirements" class="password-requirements">
              <li id="req-length">Al menos 8 caracteres</li>
              <li id="req-uppercase">1 may√∫scula</li>
              <li id="req-lowercase">1 min√∫scula</li>
              <li id="req-number">1 n√∫mero</li>
            </ul>
          </div>
        </div>

        <div class="form-group" id="confirmPasswordGroup" style="display:none;">
          <label class="form-label" for="confirmPassword">Confirmar Contrase√±a</label>
          <input type="password" id="confirmPassword" class="form-input" autocomplete="new-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" minlength="8" />
          <span class="field-error" id="confirmPasswordError"></span>
          <div id="passwordMatchIndicator" class="password-match-indicator" style="display:none;"></div>
        </div>

        <div class="form-group" id="nameGroup" style="display:none;">
          <label class="form-label" for="firstName">Nombre</label>
          <input type="text" id="firstName" class="form-input" autocomplete="given-name" placeholder="Tu nombre" pattern="[a-zA-Z√°√©√≠√≥√∫√Å√â√ç√ì√ö√±√ë\s]+" maxlength="100" />
          <span class="field-error" id="firstNameError"></span>
        </div>

        <div class="form-group" id="lastNameGroup" style="display:none;">
          <label class="form-label" for="lastName">Apellido</label>
          <input type="text" id="lastName" class="form-input" autocomplete="family-name" placeholder="Tu apellido" pattern="[a-zA-Z√°√©√≠√≥√∫√Å√â√ç√ì√ö√±√ë\s]+" maxlength="100" />
          <span class="field-error" id="lastNameError"></span>
        </div>

        <button type="submit" class="btn-primary" style="width: 100%; margin-top: 8px;">
          <span id="submitText">Iniciar Sesi√≥n</span>
        </button>
      </form>

      <div class="form-toggle">
        <span id="toggleText">¬øNo tienes cuenta? </span>
        <a href="#" id="toggleLink" onclick="toggleMode(event)">Reg√≠strate</a>
      </div>

      <div class="form-toggle" style="margin-top: var(--space-md);">
        <a href="/forgot-password.html">¬øOlvidaste tu contrase√±a?</a>
      </div>
    </div>
  </div>

  <script src="/js/loading.js"></script>
  <script src="/js/logger.js"></script>
  <script src="/js/api.js"></script>
  <script>
    let isLoginMode = true;

    function toggleMode(e) {
      e.preventDefault();
      isLoginMode = !isLoginMode;

      const title = document.getElementById('authTitle');
      const subtitle = document.getElementById('authSubtitle');
      const submitText = document.getElementById('submitText');
      const toggleText = document.getElementById('toggleText');
      const toggleLink = document.getElementById('toggleLink');
      const confirmPasswordGroup = document.getElementById('confirmPasswordGroup');
      const nameGroup = document.getElementById('nameGroup');
      const lastNameGroup = document.getElementById('lastNameGroup');
      const confirmPassword = document.getElementById('confirmPassword');
      const firstName = document.getElementById('firstName');
      const lastName = document.getElementById('lastName');

      const passwordStrength = document.getElementById('passwordStrength');
      const passwordMatchIndicator = document.getElementById('passwordMatchIndicator');

      if (isLoginMode) {
        title.textContent = 'Iniciar Sesi√≥n';
        subtitle.textContent = 'Accede a tu cuenta para reservar tours';
        submitText.textContent = 'Iniciar Sesi√≥n';
        toggleText.textContent = '¬øNo tienes cuenta? ';
        toggleLink.textContent = 'Reg√≠strate';
        confirmPasswordGroup.style.display = 'none';
        nameGroup.style.display = 'none';
        lastNameGroup.style.display = 'none';
        confirmPassword.removeAttribute('required');
        firstName.removeAttribute('required');
        lastName.removeAttribute('required');
        // Ocultar indicadores de registro
        if (passwordStrength) passwordStrength.style.display = 'none';
        if (passwordMatchIndicator) passwordMatchIndicator.style.display = 'none';
      } else {
        title.textContent = 'Crear Cuenta';
        subtitle.textContent = '√önete a ToursPanama y descubre Panam√°';
        submitText.textContent = 'Registrarse';
        toggleText.textContent = '¬øYa tienes cuenta? ';
        toggleLink.textContent = 'Inicia Sesi√≥n';
        confirmPasswordGroup.style.display = 'block';
        nameGroup.style.display = 'block';
        lastNameGroup.style.display = 'block';
        confirmPassword.setAttribute('required', 'required');
        firstName.setAttribute('required', 'required');
        lastName.setAttribute('required', 'required');
        // Mostrar indicador de fortaleza si hay texto en password
        if (passwordStrength && password.value.length > 0) {
          passwordStrength.style.display = 'block';
        }
      }
      
      // Actualizar estado del bot√≥n
      updateSubmitButtonState();
    }

    // Validaci√≥n en tiempo real
    function setupValidation() {
      const email = document.getElementById('email');
      const password = document.getElementById('password');
      const confirmPassword = document.getElementById('confirmPassword');
      const firstName = document.getElementById('firstName');
      const lastName = document.getElementById('lastName');

      // Validar email con debounce para verificar disponibilidad (solo en modo registro)
      let emailCheckTimeout = null;
      email.addEventListener('input', function() {
        const emailValue = this.value.trim();
        const emailError = document.getElementById('emailError');
        
        // Limpiar timeout anterior
        if (emailCheckTimeout) {
          clearTimeout(emailCheckTimeout);
        }

        // Validaci√≥n b√°sica de formato
        if (!emailValue) {
          emailError.textContent = '';
          this.classList.remove('input-error');
          updateSubmitButtonState();
          return;
        }

        if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(emailValue)) {
          emailError.textContent = 'El email no tiene un formato v√°lido';
          this.classList.add('input-error');
          updateSubmitButtonState();
          return;
        }

        emailError.textContent = '';
        this.classList.remove('input-error');

        // Si estamos en modo registro, verificar disponibilidad con debounce
        if (!isLoginMode) {
          emailCheckTimeout = setTimeout(async () => {
            try {
              const exists = await api.checkEmail(emailValue);
              if (exists) {
                emailError.textContent = 'Este correo ya est√° registrado';
                this.classList.add('input-error');
              } else {
                emailError.textContent = '';
                this.classList.remove('input-error');
              }
            } catch (error) {
              // Error silencioso, no bloquear al usuario
              console.error('Error al verificar email:', error);
            }
            updateSubmitButtonState();
          }, 500); // 500ms de debounce
        }

        updateSubmitButtonState();
      });

      // Validar email al perder foco
      email.addEventListener('blur', function() {
        const emailValue = this.value.trim();
        const emailError = document.getElementById('emailError');
        if (!emailValue) {
          emailError.textContent = 'El email es requerido';
          this.classList.add('input-error');
        } else if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(emailValue)) {
          emailError.textContent = 'El email no tiene un formato v√°lido';
          this.classList.add('input-error');
        }
        updateSubmitButtonState();
      });

      // Validar contrase√±a con indicador de fortaleza
      password.addEventListener('input', function() {
        const passwordValue = this.value;
        const passwordError = document.getElementById('passwordError');
        const passwordStrength = document.getElementById('passwordStrength');
        const passwordStrengthFill = document.getElementById('passwordStrengthFill');
        const passwordStrengthText = document.getElementById('passwordStrengthText');
        const requirements = {
          length: document.getElementById('req-length'),
          uppercase: document.getElementById('req-uppercase'),
          lowercase: document.getElementById('req-lowercase'),
          number: document.getElementById('req-number')
        };

        // Mostrar/ocultar indicador solo en modo registro
        if (!isLoginMode && passwordStrength) {
          passwordStrength.style.display = passwordValue.length > 0 ? 'block' : 'none';
        }

        // Validar longitud m√≠nima (8 caracteres)
        const hasLength = passwordValue.length >= 8;
        const hasUppercase = /[A-Z]/.test(passwordValue);
        const hasLowercase = /[a-z]/.test(passwordValue);
        const hasNumber = /\d/.test(passwordValue);

        // Actualizar indicadores visuales
        if (!isLoginMode && requirements.length) {
          if (hasLength) {
            requirements.length.classList.add('valid');
            requirements.length.classList.remove('invalid');
          } else {
            requirements.length.classList.remove('valid');
            requirements.length.classList.add('invalid');
          }

          if (hasUppercase) {
            requirements.uppercase.classList.add('valid');
            requirements.uppercase.classList.remove('invalid');
          } else {
            requirements.uppercase.classList.remove('valid');
            requirements.uppercase.classList.add('invalid');
          }

          if (hasLowercase) {
            requirements.lowercase.classList.add('valid');
            requirements.lowercase.classList.remove('invalid');
          } else {
            requirements.lowercase.classList.remove('valid');
            requirements.lowercase.classList.add('invalid');
          }

          if (hasNumber) {
            requirements.number.classList.add('valid');
            requirements.number.classList.remove('invalid');
          } else {
            requirements.number.classList.remove('valid');
            requirements.number.classList.add('invalid');
          }

          // Calcular fortaleza
          const validCount = [hasLength, hasUppercase, hasLowercase, hasNumber].filter(Boolean).length;
          
          if (validCount === 4) {
            passwordStrengthFill.className = 'password-strength-fill strong';
            passwordStrengthText.className = 'password-strength-text strong';
            passwordStrengthText.textContent = 'Contrase√±a fuerte';
          } else if (validCount >= 2) {
            passwordStrengthFill.className = 'password-strength-fill medium';
            passwordStrengthText.className = 'password-strength-text medium';
            passwordStrengthText.textContent = 'Contrase√±a media';
          } else if (validCount >= 1) {
            passwordStrengthFill.className = 'password-strength-fill weak';
            passwordStrengthText.className = 'password-strength-text weak';
            passwordStrengthText.textContent = 'Contrase√±a d√©bil';
          } else {
            passwordStrengthFill.className = 'password-strength-fill';
            passwordStrengthText.className = 'password-strength-text';
            passwordStrengthText.textContent = '';
          }
        }

        // Validaci√≥n de errores
        if (passwordValue.length > 0 && passwordValue.length < 8) {
          passwordError.textContent = 'La contrase√±a debe tener al menos 8 caracteres';
          this.classList.add('input-error');
        } else if (passwordValue.length >= 8 && !/(?=.*[a-z])(?=.*[A-Z])(?=.*\d)/.test(passwordValue)) {
          passwordError.textContent = 'Debe contener al menos una may√∫scula, una min√∫scula y un n√∫mero';
          this.classList.add('input-error');
        } else {
          passwordError.textContent = '';
          this.classList.remove('input-error');
        }

        // Validar match con confirmaci√≥n si existe
        if (!isLoginMode && confirmPassword && confirmPassword.value) {
          validatePasswordMatch();
        }

        updateSubmitButtonState();
      });

      // Validar confirmaci√≥n de contrase√±a en tiempo real
      if (confirmPassword) {
        confirmPassword.addEventListener('input', function() {
          validatePasswordMatch();
          updateSubmitButtonState();
        });
      }

      // Funci√≥n para validar match de contrase√±as
      function validatePasswordMatch() {
        const confirmPasswordValue = confirmPassword.value;
        const passwordValue = password.value;
        const confirmPasswordError = document.getElementById('confirmPasswordError');
        const passwordMatchIndicator = document.getElementById('passwordMatchIndicator');

        if (!isLoginMode && passwordValue && confirmPasswordValue) {
          if (confirmPasswordValue !== passwordValue) {
            confirmPasswordError.textContent = 'Las contrase√±as no coinciden';
            confirmPassword.classList.add('input-error');
            if (passwordMatchIndicator) {
              passwordMatchIndicator.className = 'password-match-indicator no-match';
              passwordMatchIndicator.textContent = '‚úó Las contrase√±as no coinciden';
              passwordMatchIndicator.style.display = 'block';
            }
          } else {
            confirmPasswordError.textContent = '';
            confirmPassword.classList.remove('input-error');
            if (passwordMatchIndicator) {
              passwordMatchIndicator.className = 'password-match-indicator match';
              passwordMatchIndicator.textContent = '‚úì Las contrase√±as coinciden';
              passwordMatchIndicator.style.display = 'block';
            }
          }
        } else {
          if (passwordMatchIndicator) {
            passwordMatchIndicator.style.display = 'none';
          }
        }
      }

      // Validar nombres
      if (firstName) {
        firstName.addEventListener('blur', function() {
          const firstNameValue = this.value.trim();
          const firstNameError = document.getElementById('firstNameError');
          if (!firstNameValue) {
            firstNameError.textContent = 'El nombre es requerido';
            this.classList.add('input-error');
          } else if (!/^[a-zA-Z√°√©√≠√≥√∫√Å√â√ç√ì√ö√±√ë\s]+$/.test(firstNameValue)) {
            firstNameError.textContent = 'Solo se permiten letras y espacios';
            this.classList.add('input-error');
          } else {
            firstNameError.textContent = '';
            this.classList.remove('input-error');
          }
        });
      }

      if (lastName) {
        lastName.addEventListener('blur', function() {
          const lastNameValue = this.value.trim();
          const lastNameError = document.getElementById('lastNameError');
          if (!lastNameValue) {
            lastNameError.textContent = 'El apellido es requerido';
            this.classList.add('input-error');
          } else if (!/^[a-zA-Z√°√©√≠√≥√∫√Å√â√ç√ì√ö√±√ë\s]+$/.test(lastNameValue)) {
            lastNameError.textContent = 'Solo se permiten letras y espacios';
            this.classList.add('input-error');
          } else {
            lastNameError.textContent = '';
            this.classList.remove('input-error');
          }
        });
      }
    }

    // Funci√≥n para actualizar estado del bot√≥n de env√≠o
    function updateSubmitButtonState() {
      const submitButton = document.querySelector('button[type="submit"]');
      if (!submitButton) return;

      if (isLoginMode) {
        // En modo login, solo validar email y password b√°sico
        const email = document.getElementById('email').value.trim();
        const password = document.getElementById('password').value;
        const emailError = document.getElementById('emailError').textContent;
        const passwordError = document.getElementById('passwordError').textContent;
        
        const isValid = email && password && !emailError && !passwordError;
        submitButton.disabled = !isValid;
      } else {
        // En modo registro, validar todos los campos
        const email = document.getElementById('email').value.trim();
        const password = document.getElementById('password').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        const firstName = document.getElementById('firstName').value.trim();
        const lastName = document.getElementById('lastName').value.trim();
        
        const emailError = document.getElementById('emailError').textContent;
        const passwordError = document.getElementById('passwordError').textContent;
        const confirmPasswordError = document.getElementById('confirmPasswordError').textContent;
        const firstNameError = document.getElementById('firstNameError').textContent;
        const lastNameError = document.getElementById('lastNameError').textContent;

        // Validar que todos los campos est√©n llenos y sin errores
        const hasAllFields = email && password && confirmPassword && firstName && lastName;
        const hasNoErrors = !emailError && !passwordError && !confirmPasswordError && !firstNameError && !lastNameError;
        const passwordsMatch = password === confirmPassword;
        const passwordMeetsRequirements = password.length >= 8 && /(?=.*[a-z])(?=.*[A-Z])(?=.*\d)/.test(password);

        submitButton.disabled = !(hasAllFields && hasNoErrors && passwordsMatch && passwordMeetsRequirements);
      }
    }

    // Inicializar validaciones al cargar
    document.addEventListener('DOMContentLoaded', () => {
      setupValidation();
      
      // Actualizar estado del bot√≥n cuando cambia el modo
      const originalToggleMode = toggleMode;
      toggleMode = function(e) {
        originalToggleMode(e);
        // Ocultar indicador de fortaleza en modo login
        const passwordStrength = document.getElementById('passwordStrength');
        if (passwordStrength) {
          passwordStrength.style.display = 'none';
        }
        const passwordMatchIndicator = document.getElementById('passwordMatchIndicator');
        if (passwordMatchIndicator) {
          passwordMatchIndicator.style.display = 'none';
        }
        updateSubmitButtonState();
      };

      // Actualizar estado del bot√≥n en cada cambio
      document.getElementById('email').addEventListener('input', updateSubmitButtonState);
      document.getElementById('password').addEventListener('input', updateSubmitButtonState);
      if (document.getElementById('confirmPassword')) {
        document.getElementById('confirmPassword').addEventListener('input', updateSubmitButtonState);
      }
      if (document.getElementById('firstName')) {
        document.getElementById('firstName').addEventListener('input', updateSubmitButtonState);
      }
      if (document.getElementById('lastName')) {
        document.getElementById('lastName').addEventListener('input', updateSubmitButtonState);
      }
    });

    async function handleSubmit(e) {
      e.preventDefault();
      const errorDiv = document.getElementById('errorMessage');
      errorDiv.style.display = 'none';
      
      // Limpiar errores previos
      document.querySelectorAll('.field-error').forEach(el => el.textContent = '');
      document.querySelectorAll('.input-error').forEach(el => el.classList.remove('input-error'));

      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;

      // Validaci√≥n b√°sica
      if (!email || !password) {
        errorDiv.textContent = 'Por favor completa todos los campos requeridos';
        errorDiv.style.display = 'block';
        return;
      }

      // Validar formato de email
      if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
        document.getElementById('emailError').textContent = 'El email no tiene un formato v√°lido';
        document.getElementById('email').classList.add('input-error');
        return;
      }

      const submitButton = e.target.querySelector('button[type="submit"]');
      const loaderId = submitButton ? loadingManager.showInButton(submitButton, isLoginMode ? 'Iniciando sesi√≥n...' : 'Creando cuenta...') : null;

      try {
        if (isLoginMode) {
          await api.login(email, password);
        } else {
          const firstName = document.getElementById('firstName').value.trim();
          const lastName = document.getElementById('lastName').value.trim();
          const confirmPassword = document.getElementById('confirmPassword').value;

          // Validaciones de registro
          if (!firstName || !lastName) {
            errorDiv.textContent = 'Por favor completa todos los campos';
            errorDiv.style.display = 'block';
            if (!firstName) {
              document.getElementById('firstNameError').textContent = 'El nombre es requerido';
              document.getElementById('firstName').classList.add('input-error');
            }
            if (!lastName) {
              document.getElementById('lastNameError').textContent = 'El apellido es requerido';
              document.getElementById('lastName').classList.add('input-error');
            }
            return;
          }

          // Validar formato de nombres
          if (!/^[a-zA-Z√°√©√≠√≥√∫√Å√â√ç√ì√ö√±√ë\s]+$/.test(firstName)) {
            document.getElementById('firstNameError').textContent = 'Solo se permiten letras y espacios';
            document.getElementById('firstName').classList.add('input-error');
            return;
          }

          if (!/^[a-zA-Z√°√©√≠√≥√∫√Å√â√ç√ì√ö√±√ë\s]+$/.test(lastName)) {
            document.getElementById('lastNameError').textContent = 'Solo se permiten letras y espacios';
            document.getElementById('lastName').classList.add('input-error');
            return;
          }

          // Comparar contrase√±as sin espacios
          const passwordTrimmed = password.trim();
          const confirmPasswordTrimmed = confirmPassword.trim();

          if (passwordTrimmed !== confirmPasswordTrimmed) {
            document.getElementById('confirmPasswordError').textContent = 'Las contrase√±as no coinciden';
            document.getElementById('confirmPassword').classList.add('input-error');
            return;
          }

          if (passwordTrimmed.length < 8) {
            document.getElementById('passwordError').textContent = 'La contrase√±a debe tener al menos 8 caracteres';
            document.getElementById('password').classList.add('input-error');
            return;
          }

          // Validar complejidad de contrase√±a
          if (!/(?=.*[a-z])(?=.*[A-Z])(?=.*\d)/.test(passwordTrimmed)) {
            document.getElementById('passwordError').textContent = 'Debe contener al menos una may√∫scula, una min√∫scula y un n√∫mero';
            document.getElementById('password').classList.add('input-error');
            return;
          }

          await api.register({ 
            email, 
            password: passwordTrimmed, 
            confirmPassword: confirmPasswordTrimmed,
            firstName, 
            lastName 
          });
        }

        // Verificar si el usuario es admin y redirigir al panel de administraci√≥n
        const userRoles = JSON.parse(localStorage.getItem('userRoles') || '[]');
        
        // Verificar si es admin (case-insensitive)
        const isAdmin = Array.isArray(userRoles) && (
          userRoles.some(role => role && role.toLowerCase() === 'admin')
        );
        
        console.log('üîê [login] Roles del usuario:', userRoles, 'Es admin:', isAdmin);
        console.log('üîê [login] User response:', response.user);
        
        // Prioridad 1: Verificar si hay un par√°metro redirect
        const urlParams = new URLSearchParams(window.location.search);
        const redirectParam = urlParams.get('redirect');
        
        if (redirectParam && !isAdmin) {
          // Solo respetar redirect si NO es admin
          console.log('üë§ [login] Redirigiendo seg√∫n par√°metro redirect:', redirectParam);
          window.location.href = redirectParam;
          return;
        }
        
        if (isAdmin) {
          // Si es admin, SIEMPRE redirigir al panel de administraci√≥n
          console.log('üë®‚Äçüíº [login] Redirigiendo a panel de administraci√≥n');
          window.location.href = '/admin.html';
        } else {
          // Si no es admin (cliente), redirigir a Mis Reservas por defecto
          console.log('üë§ [login] Redirigiendo a Mis Reservas (cliente)');
          window.location.href = '/reservas.html';
        }
      } catch (error) {
        if (submitButton && loaderId) {
          loadingManager.hideInButton(submitButton);
        }
        console.error('Error completo:', error);
        
        // Manejar error 409 (Email ya registrado) espec√≠ficamente
        let errorMessage = error.message || 'Error al procesar la solicitud';
        
        // Verificar si es un error HTTP 409
        if (error.status === 409 || error.statusCode === 409 || 
            errorMessage.toLowerCase().includes('ya est√° registrado') ||
            errorMessage.toLowerCase().includes('already exists') ||
            errorMessage.toLowerCase().includes('email_already_exists')) {
          errorMessage = 'Este correo electr√≥nico ya est√° registrado. Por favor usa otro correo o inicia sesi√≥n.';
          document.getElementById('email').classList.add('input-error');
          document.getElementById('email').focus();
          document.getElementById('emailError').textContent = 'Este correo ya est√° registrado';
        }
        // Manejar errores de validaci√≥n del backend
        else if (error.errors || (error.response && error.response.errors)) {
          const errors = error.errors || error.response.errors;
          const errorList = Object.entries(errors)
            .map(([field, messages]) => {
              const fieldName = field === 'Email' ? 'email' : 
                              field === 'Password' ? 'password' :
                              field === 'ConfirmPassword' ? 'confirmPassword' :
                              field === 'FirstName' ? 'firstName' :
                              field === 'LastName' ? 'lastName' : field;
              
              // Resaltar campo con error
              const fieldElement = document.getElementById(fieldName);
              if (fieldElement) {
                fieldElement.classList.add('input-error');
                const errorElement = document.getElementById(fieldName + 'Error');
                if (errorElement && Array.isArray(messages) && messages.length > 0) {
                  errorElement.textContent = messages[0];
                }
              }
              
              return Array.isArray(messages) ? messages.map(msg => msg).join(', ') : messages;
            })
            .flat();
          
          errorDiv.innerHTML = '<strong>Por favor, corrige los siguientes errores:</strong><ul style="margin: 8px 0 0 20px; padding-left: 20px;">' +
            errorList.map(err => `<li>${err}</li>`).join('') +
            '</ul>';
        }
        // Si el error tiene m√∫ltiples l√≠neas (errores de validaci√≥n), mostrarlos todos
        else if (errorMessage.includes('\n')) {
          const errorLines = errorMessage.split('\n').filter(line => line.trim());
          errorDiv.innerHTML = '<strong>Por favor, corrige los siguientes errores:</strong><ul style="margin: 8px 0 0 20px; padding-left: 20px;">' +
            errorLines.map(err => `<li>${err}</li>`).join('') +
            '</ul>';
        } else {
          errorDiv.textContent = errorMessage;
        }
        
        errorDiv.style.display = 'block';
        
        // Hacer scroll al mensaje de error
        errorDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        
        // Resaltar campos con error (fallback)
        if (errorMessage.toLowerCase().includes('email') && !document.getElementById('email').classList.contains('input-error')) {
          document.getElementById('email').classList.add('input-error');
          document.getElementById('email').focus();
        }
        if ((errorMessage.toLowerCase().includes('contrase√±a') || errorMessage.toLowerCase().includes('password')) && 
            !document.getElementById('password').classList.contains('input-error')) {
          document.getElementById('password').classList.add('input-error');
          if (!isLoginMode && document.getElementById('confirmPassword')) {
            document.getElementById('confirmPassword').classList.add('input-error');
          }
        }
        if ((errorMessage.toLowerCase().includes('nombre') || errorMessage.toLowerCase().includes('firstname')) && 
            document.getElementById('firstName') && !document.getElementById('firstName').classList.contains('input-error')) {
          document.getElementById('firstName').classList.add('input-error');
          document.getElementById('firstName').focus();
        }
        if ((errorMessage.toLowerCase().includes('apellido') || errorMessage.toLowerCase().includes('lastname')) && 
            document.getElementById('lastName') && !document.getElementById('lastName').classList.contains('input-error')) {
          document.getElementById('lastName').classList.add('input-error');
          document.getElementById('lastName').focus();
        }
        
        updateSubmitButtonState();
      }
    }
  </script>
</body>
</html>