<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Iniciar Sesión — ToursPanama</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="stylesheet" href="/css/main.css" />
  <link rel="stylesheet" href="/css/auth.css" />
  <link rel="stylesheet" href="/css/loading.css" />
</head>
<body>
  <nav class="nav">
    <div class="nav-inner wrap">
      <div class="brand">
        <div class="mark"></div>
        <a href="/"><span class="brand-text">ToursPanama</span></a>
      </div>
      <div class="nav-links">
        <a href="/" class="nav-link">Tours</a>
      </div>
    </div>
  </nav>

  <div class="auth-container">
    <div class="auth-card">
      <div class="auth-header">
        <h1 id="authTitle">Iniciar Sesión</h1>
        <p id="authSubtitle">Accede a tu cuenta para reservar tours</p>
      </div>

      <div id="errorMessage" class="error-message"></div>

      <form id="authForm" onsubmit="handleSubmit(event)">
        <div class="form-group">
          <label class="form-label" for="email">Correo Electrónico</label>
          <input type="email" id="email" class="form-input" required autocomplete="email" placeholder="tu@email.com" />
          <span class="field-error" id="emailError"></span>
        </div>

        <div class="form-group">
          <label class="form-label" for="password">Contraseña</label>
          <input type="password" id="password" class="form-input" required autocomplete="current-password" placeholder="••••••••" minlength="6" />
          <span class="field-error" id="passwordError"></span>
        </div>

        <div class="form-group" id="confirmPasswordGroup" style="display:none;">
          <label class="form-label" for="confirmPassword">Confirmar Contraseña</label>
          <input type="password" id="confirmPassword" class="form-input" autocomplete="new-password" placeholder="••••••••" minlength="6" />
          <span class="field-error" id="confirmPasswordError"></span>
        </div>

        <div class="form-group" id="nameGroup" style="display:none;">
          <label class="form-label" for="firstName">Nombre</label>
          <input type="text" id="firstName" class="form-input" autocomplete="given-name" placeholder="Tu nombre" pattern="[a-zA-ZáéíóúÁÉÍÓÚñÑ\s]+" maxlength="100" />
          <span class="field-error" id="firstNameError"></span>
        </div>

        <div class="form-group" id="lastNameGroup" style="display:none;">
          <label class="form-label" for="lastName">Apellido</label>
          <input type="text" id="lastName" class="form-input" autocomplete="family-name" placeholder="Tu apellido" pattern="[a-zA-ZáéíóúÁÉÍÓÚñÑ\s]+" maxlength="100" />
          <span class="field-error" id="lastNameError"></span>
        </div>

        <button type="submit" class="btn-primary" style="width: 100%; margin-top: 8px;">
          <span id="submitText">Iniciar Sesión</span>
        </button>
      </form>

      <div class="form-toggle">
        <span id="toggleText">¿No tienes cuenta? </span>
        <a href="#" id="toggleLink" onclick="toggleMode(event)">Regístrate</a>
      </div>
    </div>
  </div>

  <script src="/js/loading.js"></script>
  <script src="/js/api.js"></script>
  <script>
    let isLoginMode = true;

    function toggleMode(e) {
      e.preventDefault();
      isLoginMode = !isLoginMode;

      const title = document.getElementById('authTitle');
      const subtitle = document.getElementById('authSubtitle');
      const submitText = document.getElementById('submitText');
      const toggleText = document.getElementById('toggleText');
      const toggleLink = document.getElementById('toggleLink');
      const confirmPasswordGroup = document.getElementById('confirmPasswordGroup');
      const nameGroup = document.getElementById('nameGroup');
      const lastNameGroup = document.getElementById('lastNameGroup');
      const confirmPassword = document.getElementById('confirmPassword');
      const firstName = document.getElementById('firstName');
      const lastName = document.getElementById('lastName');

      if (isLoginMode) {
        title.textContent = 'Iniciar Sesión';
        subtitle.textContent = 'Accede a tu cuenta para reservar tours';
        submitText.textContent = 'Iniciar Sesión';
        toggleText.textContent = '¿No tienes cuenta? ';
        toggleLink.textContent = 'Regístrate';
        confirmPasswordGroup.style.display = 'none';
        nameGroup.style.display = 'none';
        lastNameGroup.style.display = 'none';
        confirmPassword.removeAttribute('required');
        firstName.removeAttribute('required');
        lastName.removeAttribute('required');
      } else {
        title.textContent = 'Crear Cuenta';
        subtitle.textContent = 'Únete a ToursPanama y descubre Panamá';
        submitText.textContent = 'Registrarse';
        toggleText.textContent = '¿Ya tienes cuenta? ';
        toggleLink.textContent = 'Inicia Sesión';
        confirmPasswordGroup.style.display = 'block';
        nameGroup.style.display = 'block';
        lastNameGroup.style.display = 'block';
        confirmPassword.setAttribute('required', 'required');
        firstName.setAttribute('required', 'required');
        lastName.setAttribute('required', 'required');
      }
    }

    // Validación en tiempo real
    function setupValidation() {
      const email = document.getElementById('email');
      const password = document.getElementById('password');
      const confirmPassword = document.getElementById('confirmPassword');
      const firstName = document.getElementById('firstName');
      const lastName = document.getElementById('lastName');

      // Validar email
      email.addEventListener('blur', function() {
        const emailValue = this.value.trim();
        const emailError = document.getElementById('emailError');
        if (!emailValue) {
          emailError.textContent = 'El email es requerido';
          this.classList.add('input-error');
        } else if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(emailValue)) {
          emailError.textContent = 'El email no tiene un formato válido';
          this.classList.add('input-error');
        } else {
          emailError.textContent = '';
          this.classList.remove('input-error');
        }
      });

      // Validar contraseña
      password.addEventListener('input', function() {
        const passwordValue = this.value;
        const passwordError = document.getElementById('passwordError');
        if (passwordValue.length > 0 && passwordValue.length < 6) {
          passwordError.textContent = 'La contraseña debe tener al menos 6 caracteres';
          this.classList.add('input-error');
        } else if (passwordValue.length >= 6 && !/(?=.*[a-z])(?=.*[A-Z])(?=.*\d)/.test(passwordValue)) {
          passwordError.textContent = 'Debe contener al menos una mayúscula, una minúscula y un número';
          this.classList.add('input-error');
        } else {
          passwordError.textContent = '';
          this.classList.remove('input-error');
        }
      });

      // Validar confirmación de contraseña
      if (confirmPassword) {
        confirmPassword.addEventListener('blur', function() {
          const confirmPasswordValue = this.value;
          const passwordValue = password.value;
          const confirmPasswordError = document.getElementById('confirmPasswordError');
          if (confirmPasswordValue !== passwordValue) {
            confirmPasswordError.textContent = 'Las contraseñas no coinciden';
            this.classList.add('input-error');
          } else {
            confirmPasswordError.textContent = '';
            this.classList.remove('input-error');
          }
        });
      }

      // Validar nombres
      if (firstName) {
        firstName.addEventListener('blur', function() {
          const firstNameValue = this.value.trim();
          const firstNameError = document.getElementById('firstNameError');
          if (!firstNameValue) {
            firstNameError.textContent = 'El nombre es requerido';
            this.classList.add('input-error');
          } else if (!/^[a-zA-ZáéíóúÁÉÍÓÚñÑ\s]+$/.test(firstNameValue)) {
            firstNameError.textContent = 'Solo se permiten letras y espacios';
            this.classList.add('input-error');
          } else {
            firstNameError.textContent = '';
            this.classList.remove('input-error');
          }
        });
      }

      if (lastName) {
        lastName.addEventListener('blur', function() {
          const lastNameValue = this.value.trim();
          const lastNameError = document.getElementById('lastNameError');
          if (!lastNameValue) {
            lastNameError.textContent = 'El apellido es requerido';
            this.classList.add('input-error');
          } else if (!/^[a-zA-ZáéíóúÁÉÍÓÚñÑ\s]+$/.test(lastNameValue)) {
            lastNameError.textContent = 'Solo se permiten letras y espacios';
            this.classList.add('input-error');
          } else {
            lastNameError.textContent = '';
            this.classList.remove('input-error');
          }
        });
      }
    }

    // Inicializar validaciones al cargar
    document.addEventListener('DOMContentLoaded', setupValidation);

    async function handleSubmit(e) {
      e.preventDefault();
      const errorDiv = document.getElementById('errorMessage');
      errorDiv.style.display = 'none';
      
      // Limpiar errores previos
      document.querySelectorAll('.field-error').forEach(el => el.textContent = '');
      document.querySelectorAll('.input-error').forEach(el => el.classList.remove('input-error'));

      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;

      // Validación básica
      if (!email || !password) {
        errorDiv.textContent = 'Por favor completa todos los campos requeridos';
        errorDiv.style.display = 'block';
        return;
      }

      // Validar formato de email
      if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
        document.getElementById('emailError').textContent = 'El email no tiene un formato válido';
        document.getElementById('email').classList.add('input-error');
        return;
      }

      const submitButton = e.target.querySelector('button[type="submit"]');
      const loaderId = submitButton ? loadingManager.showInButton(submitButton, isLoginMode ? 'Iniciando sesión...' : 'Creando cuenta...') : null;

      try {
        if (isLoginMode) {
          await api.login(email, password);
        } else {
          const firstName = document.getElementById('firstName').value.trim();
          const lastName = document.getElementById('lastName').value.trim();
          const confirmPassword = document.getElementById('confirmPassword').value;

          // Validaciones de registro
          if (!firstName || !lastName) {
            errorDiv.textContent = 'Por favor completa todos los campos';
            errorDiv.style.display = 'block';
            if (!firstName) {
              document.getElementById('firstNameError').textContent = 'El nombre es requerido';
              document.getElementById('firstName').classList.add('input-error');
            }
            if (!lastName) {
              document.getElementById('lastNameError').textContent = 'El apellido es requerido';
              document.getElementById('lastName').classList.add('input-error');
            }
            return;
          }

          // Validar formato de nombres
          if (!/^[a-zA-ZáéíóúÁÉÍÓÚñÑ\s]+$/.test(firstName)) {
            document.getElementById('firstNameError').textContent = 'Solo se permiten letras y espacios';
            document.getElementById('firstName').classList.add('input-error');
            return;
          }

          if (!/^[a-zA-ZáéíóúÁÉÍÓÚñÑ\s]+$/.test(lastName)) {
            document.getElementById('lastNameError').textContent = 'Solo se permiten letras y espacios';
            document.getElementById('lastName').classList.add('input-error');
            return;
          }

          // Comparar contraseñas sin espacios
          const passwordTrimmed = password.trim();
          const confirmPasswordTrimmed = confirmPassword.trim();

          if (passwordTrimmed !== confirmPasswordTrimmed) {
            document.getElementById('confirmPasswordError').textContent = 'Las contraseñas no coinciden';
            document.getElementById('confirmPassword').classList.add('input-error');
            return;
          }

          if (passwordTrimmed.length < 6) {
            document.getElementById('passwordError').textContent = 'La contraseña debe tener al menos 6 caracteres';
            document.getElementById('password').classList.add('input-error');
            return;
          }

          // Validar complejidad de contraseña
          if (!/(?=.*[a-z])(?=.*[A-Z])(?=.*\d)/.test(passwordTrimmed)) {
            document.getElementById('passwordError').textContent = 'Debe contener al menos una mayúscula, una minúscula y un número';
            document.getElementById('password').classList.add('input-error');
            return;
          }

          await api.register({ 
            email, 
            password: passwordTrimmed, 
            confirmPassword: confirmPasswordTrimmed,
            firstName, 
            lastName 
          });
        }

        // Verificar si el usuario es admin y redirigir al panel de administración
        const userRoles = JSON.parse(localStorage.getItem('userRoles') || '[]');
        const isAdmin = userRoles.includes('Admin') || userRoles.includes('admin');
        
        if (isAdmin) {
          // Si es admin, redirigir al panel de administración
          window.location.href = '/admin.html';
        } else {
          // Si no es admin, redirigir según el parámetro redirect o a la página principal
          const urlParams = new URLSearchParams(window.location.search);
          const redirect = urlParams.get('redirect') || '/';
          window.location.href = redirect;
        }
      } catch (error) {
        if (submitButton && loaderId) {
          loadingManager.hideInButton(submitButton);
        }
        console.error('Error completo:', error);
        
        // Mostrar mensaje de error más descriptivo
        let errorMessage = error.message || 'Error al procesar la solicitud';
        
        // Si el error tiene múltiples líneas (errores de validación), mostrarlos todos
        if (errorMessage.includes('\n')) {
          const errors = errorMessage.split('\n');
          errorDiv.innerHTML = '<strong>Por favor, corrige los siguientes errores:</strong><ul style="margin: 8px 0 0 20px; padding-left: 20px;">' +
            errors.map(err => `<li>${err}</li>`).join('') +
            '</ul>';
        } else {
          errorDiv.textContent = errorMessage;
        }
        
        errorDiv.style.display = 'block';
        
        // Hacer scroll al mensaje de error
        errorDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        
        // Resaltar campos con error
        if (errorMessage.toLowerCase().includes('email')) {
          document.getElementById('email').classList.add('input-error');
          document.getElementById('email').focus();
        }
        if (errorMessage.toLowerCase().includes('contraseña') || errorMessage.toLowerCase().includes('password')) {
          document.getElementById('password').classList.add('input-error');
          if (!isLoginMode) {
            document.getElementById('confirmPassword').classList.add('input-error');
          }
        }
        if (errorMessage.toLowerCase().includes('nombre') || errorMessage.toLowerCase().includes('firstname')) {
          document.getElementById('firstName').classList.add('input-error');
          document.getElementById('firstName').focus();
        }
        if (errorMessage.toLowerCase().includes('apellido') || errorMessage.toLowerCase().includes('lastname')) {
          document.getElementById('lastName').classList.add('input-error');
          document.getElementById('lastName').focus();
        }
      }
    }
  </script>
</body>
</html>