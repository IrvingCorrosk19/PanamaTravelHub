<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Panel Administrativo — ToursPanama</title>
  <link rel="stylesheet" href="/css/main.css" />
  <link rel="stylesheet" href="/css/admin.css" />
</head>
<body>
  <nav class="nav">
    <div class="nav-inner wrap">
      <div class="brand">
        <div class="mark"></div>
        <a href="/"><span class="brand-text">ToursPanama</span></a>
      </div>
      <div class="nav-links">
        <a href="/" class="nav-link">Tours</a>
        <a href="/admin.html" class="nav-link active">Admin</a>
        <button class="btn-primary" id="logoutBtn">Cerrar Sesión</button>
      </div>
    </div>
  </nav>

  <main class="admin-container wrap">
    <div class="section-header">
      <h1>Panel Administrativo</h1>
      <p class="section-subtitle">Gestiona tours, reservas y usuarios</p>
    </div>

    <div id="authRequired" style="display:none; text-align: center; padding: var(--spacing-2xl);">
      <p style="color: var(--text-muted); margin-bottom: var(--spacing-lg);">Acceso restringido. Debes ser administrador.</p>
      <a href="/login.html" class="btn-primary">Iniciar Sesión</a>
    </div>

    <div id="adminContent" style="display:none;">
      <div class="admin-tabs">
        <button class="admin-tab active" onclick="switchTab('tours')">Tours</button>
        <button class="admin-tab" onclick="switchTab('bookings')">Reservas</button>
        <button class="admin-tab" onclick="switchTab('stats')">Estadísticas</button>
      </div>

      <!-- Tours Tab -->
      <div id="tours" class="admin-content active">
        <div class="admin-header">
          <h2>Tours</h2>
          <button class="btn-primary" onclick="showAddTourModal()">+ Nuevo Tour</button>
        </div>
        <div class="admin-card">
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Imagen</th>
                  <th>Nombre</th>
                  <th>Precio</th>
                  <th>Capacidad</th>
                  <th>Disponibles</th>
                  <th>Estado</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody id="toursTableBody">
                <tr>
                  <td colspan="7" style="text-align: center; color: var(--text-muted);">Cargando...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Bookings Tab -->
      <div id="bookings" class="admin-content">
        <div class="admin-header">
          <h2>Reservas</h2>
        </div>
        <div class="admin-card">
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Tour</th>
                  <th>Cliente</th>
                  <th>Email</th>
                  <th>Participantes</th>
                  <th>Total</th>
                  <th>Estado</th>
                  <th>Fecha</th>
                </tr>
              </thead>
              <tbody id="bookingsTableBody">
                <tr>
                  <td colspan="7" style="text-align: center; color: var(--text-muted);">Cargando...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Stats Tab -->
      <div id="stats" class="admin-content">
        <div class="admin-header">
          <h2>Estadísticas</h2>
        </div>
        <div class="admin-card" id="statsContent">
          <p style="color: var(--text-muted);">Cargando estadísticas...</p>
        </div>
      </div>
    </div>
  </main>

  <!-- Tour Modal -->
  <div id="tourModal" class="modal">
    <div class="modal-content">
      <h2 id="modalTitle">Nuevo Tour</h2>
      <form id="tourForm" onsubmit="saveTour(event)">
        <div class="form-group">
          <label>Nombre del Tour *</label>
          <input type="text" id="tourName" required />
        </div>
        <div class="form-group">
          <label>Descripción *</label>
          <textarea id="tourDescription" required></textarea>
        </div>
        <div class="form-group">
          <label>Itinerario</label>
          <textarea id="tourItinerary"></textarea>
        </div>
        <div class="form-group">
          <label>Precio (USD) *</label>
          <input type="number" id="tourPrice" step="0.01" min="0" required />
        </div>
        <div class="form-group">
          <label>Capacidad Máxima *</label>
          <input type="number" id="tourMaxCapacity" min="1" required />
        </div>
        <div class="form-group">
          <label>Duración (horas) *</label>
          <input type="number" id="tourDurationHours" min="1" required />
        </div>
        <div class="form-group">
          <label>Ubicación</label>
          <input type="text" id="tourLocation" />
        </div>
        <div class="form-group">
          <label>Estado</label>
          <select id="tourIsActive">
            <option value="true">Activo</option>
            <option value="false">Inactivo</option>
          </select>
        </div>
        <div class="form-group">
          <label>Imágenes del Tour</label>
          <div id="imagesContainer">
            <div class="image-input-group">
              <input type="url" class="image-url-input" placeholder="https://ejemplo.com/imagen.jpg" />
              <button type="button" class="btn-secondary btn-sm" onclick="removeImage(this)">Eliminar</button>
            </div>
          </div>
          <button type="button" id="addImageBtn" class="btn-secondary" onclick="addImageInput()" style="margin-top: var(--spacing-sm);">
            <span id="addImageText">+ Agregar Imagen</span>
          </button>
          <div id="imagesPreview"></div>
          <div id="imageLimitInfo" class="image-limit-info">
            <span>La primera imagen será la imagen principal. Máximo 5 imágenes.</span>
          </div>
        </div>
        <div class="form-actions">
          <button type="button" class="btn-secondary" onclick="closeTourModal()">Cancelar</button>
          <button type="submit" class="btn-primary">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <script src="/js/api.js"></script>
  <script>
    let currentTourId = null;

    function checkAdminAuth() {
      const token = localStorage.getItem('authToken');
      const userRoles = JSON.parse(localStorage.getItem('userRoles') || '[]');
      const authRequired = document.getElementById('authRequired');
      const adminContent = document.getElementById('adminContent');

      if (!token) {
        authRequired.style.display = 'block';
        adminContent.style.display = 'none';
        return false;
      }

      // Verificar si el usuario tiene rol Admin
      const isAdmin = userRoles.includes('Admin') || userRoles.includes('admin');
      
      if (!isAdmin) {
        authRequired.style.display = 'block';
        adminContent.style.display = 'none';
        authRequired.innerHTML = `
          <p style="color: var(--text-muted); margin-bottom: var(--spacing-lg);">
            Acceso restringido. Debes ser administrador para acceder a esta sección.
          </p>
          <a href="/" class="btn-primary">Volver al Inicio</a>
        `;
        return false;
      }

      authRequired.style.display = 'none';
      adminContent.style.display = 'block';
      return true;
    }

    function switchTab(tabName) {
      // Update tabs
      document.querySelectorAll('.admin-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      event.target.classList.add('active');

      // Update content
      document.querySelectorAll('.admin-content').forEach(content => {
        content.classList.remove('active');
      });
      document.getElementById(tabName).classList.add('active');

      // Load tab data
      if (tabName === 'tours') loadTours();
      if (tabName === 'bookings') loadBookings();
      if (tabName === 'stats') loadStats();
    }

    async function loadTours() {
      try {
        const tours = await api.getAdminTours();
        const tbody = document.getElementById('toursTableBody');
        
        if (!tours || tours.length === 0) {
          tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--text-muted);">No hay tours disponibles</td></tr>';
          return;
        }

        tbody.innerHTML = tours.map(tour => `
          <tr>
            <td>
              ${tour.imageUrl ? `<img src="${tour.imageUrl}" class="tour-image-preview" alt="${tour.name}" />` : '—'}
            </td>
            <td>${tour.name}</td>
            <td>$${tour.price.toFixed(2)}</td>
            <td>${tour.maxCapacity}</td>
            <td>${tour.availableSpots}</td>
            <td>
              <span class="badge ${tour.isActive ? 'active' : 'inactive'}">
                ${tour.isActive ? 'Activo' : 'Inactivo'}
              </span>
            </td>
            <td>
              <div class="action-buttons">
                <button class="btn-sm btn-primary" onclick="editTour('${tour.id}')">Editar</button>
                <button class="btn-sm btn-secondary" onclick="deleteTour('${tour.id}')">Eliminar</button>
              </div>
            </td>
          </tr>
        `).join('');
      } catch (error) {
        console.error('Error loading tours:', error);
        document.getElementById('toursTableBody').innerHTML = 
          '<tr><td colspan="7" style="text-align: center; color: var(--error);">Error al cargar tours</td></tr>';
      }
    }

    async function loadBookings() {
      try {
        const bookings = await api.getAdminBookings();
        const tbody = document.getElementById('bookingsTableBody');
        
        if (!bookings || bookings.length === 0) {
          tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--text-muted);">No hay reservas disponibles</td></tr>';
          return;
        }

        tbody.innerHTML = bookings.map(booking => `
          <tr>
            <td>${booking.tourName || 'N/A'}</td>
            <td>${booking.userName || 'N/A'}</td>
            <td>${booking.userEmail || 'N/A'}</td>
            <td>${booking.numberOfParticipants}</td>
            <td>$${booking.totalAmount.toFixed(2)}</td>
            <td>
              <span class="badge ${booking.status === 'Confirmed' ? 'active' : 'inactive'}">
                ${booking.status}
              </span>
            </td>
            <td>${new Date(booking.createdAt).toLocaleDateString('es-PA')}</td>
          </tr>
        `).join('');
      } catch (error) {
        console.error('Error loading bookings:', error);
        document.getElementById('bookingsTableBody').innerHTML = 
          '<tr><td colspan="7" style="text-align: center; color: var(--error);">Error al cargar reservas</td></tr>';
      }
    }

    async function loadStats() {
      try {
        const stats = await api.request('/api/admin/stats');
        const content = document.getElementById('statsContent');
        
        content.innerHTML = `
          <div class="stats-grid">
            <div class="stat-card">
              <h3>${stats.totalTours}</h3>
              <p>Tours Totales</p>
            </div>
            <div class="stat-card">
              <h3>${stats.activeTours}</h3>
              <p>Tours Activos</p>
            </div>
            <div class="stat-card">
              <h3>${stats.totalBookings}</h3>
              <p>Reservas Totales</p>
            </div>
            <div class="stat-card">
              <h3>$${stats.totalRevenue.toFixed(2)}</h3>
              <p>Ingresos Totales</p>
            </div>
            <div class="stat-card">
              <h3>${stats.totalUsers}</h3>
              <p>Usuarios</p>
            </div>
          </div>
        `;
      } catch (error) {
        console.error('Error loading stats:', error);
        document.getElementById('statsContent').innerHTML = 
          '<p style="color: var(--error);">Error al cargar estadísticas</p>';
      }
    }

    function showAddTourModal() {
      currentTourId = null;
      document.getElementById('modalTitle').textContent = 'Nuevo Tour';
      document.getElementById('tourForm').reset();
      
      // Limpiar imágenes
      const imagesContainer = document.getElementById('imagesContainer');
      imagesContainer.innerHTML = `
        <div class="image-input-group">
          <input type="url" class="image-url-input" placeholder="https://ejemplo.com/imagen.jpg" />
          <button type="button" class="btn-secondary btn-sm" onclick="removeImage(this)">Eliminar</button>
        </div>
      `;
      document.getElementById('imagesPreview').innerHTML = '';
      
      // Agregar event listeners a los inputs de imágenes
      setupImageInputs();
      updateImageLimitInfo();
      
      // Limpiar errores
      document.querySelectorAll('.field-error').forEach(el => el.remove());
      document.querySelectorAll('.input-error').forEach(el => el.classList.remove('input-error'));
      
      document.getElementById('tourModal').classList.add('active');
    }
    
    function setupImageInputs() {
      document.querySelectorAll('.image-url-input').forEach(input => {
        input.addEventListener('input', updateImagesPreview);
        input.addEventListener('blur', validateImageUrl);
      });
    }
    
    function addImageInput() {
      const container = document.getElementById('imagesContainer');
      const imageCount = container.querySelectorAll('.image-input-group').length;
      const addImageBtn = document.getElementById('addImageBtn');
      const imageLimitInfo = document.getElementById('imageLimitInfo');
      
      if (imageCount >= 5) {
        return; // No hacer nada si ya hay 5 imágenes
      }
      
      const newInput = document.createElement('div');
      newInput.className = 'image-input-group';
      newInput.innerHTML = `
        <input type="url" class="image-url-input" placeholder="https://ejemplo.com/imagen.jpg" />
        <button type="button" class="btn-secondary btn-sm" onclick="removeImage(this)">Eliminar</button>
      `;
      container.appendChild(newInput);
      
      setupImageInputs();
      updateImageLimitInfo();
    }
    
    function updateImageLimitInfo() {
      const container = document.getElementById('imagesContainer');
      const imageCount = container.querySelectorAll('.image-input-group').length;
      const addImageBtn = document.getElementById('addImageBtn');
      const addImageText = document.getElementById('addImageText');
      const imageLimitInfo = document.getElementById('imageLimitInfo');
      
      // Actualizar botón
      if (imageCount >= 5) {
        addImageBtn.disabled = true;
        addImageText.textContent = 'Máximo 5 imágenes alcanzado';
        imageLimitInfo.className = 'image-limit-info max';
        imageLimitInfo.innerHTML = `<span>⚠️ Has alcanzado el límite de 5 imágenes</span>`;
      } else {
        addImageBtn.disabled = false;
        addImageText.textContent = `+ Agregar Imagen (${imageCount}/5)`;
        if (imageCount >= 3) {
          imageLimitInfo.className = 'image-limit-info warning';
          imageLimitInfo.innerHTML = `<span>⚠️ Puedes agregar ${5 - imageCount} imagen${5 - imageCount > 1 ? 'es' : ''} más</span>`;
        } else {
          imageLimitInfo.className = 'image-limit-info';
          imageLimitInfo.innerHTML = `<span>La primera imagen será la imagen principal. Máximo 5 imágenes. (${imageCount}/5)</span>`;
        }
      }
    }
    
    function removeImage(button) {
      const container = document.getElementById('imagesContainer');
      if (container.querySelectorAll('.image-input-group').length <= 1) {
        alert('Debe haber al menos una imagen');
        return;
      }
      button.closest('.image-input-group').remove();
      updateImagesPreview();
      updateImageLimitInfo();
    }
    
    function validateImageUrl(event) {
      const input = event.target;
      const url = input.value.trim();
      
      if (!url) {
        input.classList.remove('input-error');
        return;
      }
      
      try {
        new URL(url);
        input.classList.remove('input-error');
      } catch {
        input.classList.add('input-error');
      }
    }
    
    function updateImagesPreview() {
      const preview = document.getElementById('imagesPreview');
      const inputs = document.querySelectorAll('.image-url-input');
      preview.innerHTML = '';
      
      inputs.forEach((input, index) => {
        const url = input.value.trim();
        if (url) {
          const previewItem = document.createElement('div');
          previewItem.className = 'image-preview-item';
          previewItem.innerHTML = `
            ${index === 0 ? '<span class="primary-badge">Principal</span>' : ''}
            <img src="${url}" alt="Preview" onerror="this.parentElement.classList.add('error')" />
          `;
          preview.appendChild(previewItem);
        }
      });
    }

    async function editTour(id) {
      try {
        const tour = await api.request(`/api/admin/tours/${id}`);
        currentTourId = id;
        
        document.getElementById('modalTitle').textContent = 'Editar Tour';
        document.getElementById('tourName').value = tour.name || '';
        document.getElementById('tourDescription').value = tour.description || '';
        document.getElementById('tourItinerary').value = tour.itinerary || '';
        document.getElementById('tourPrice').value = tour.price || '';
        document.getElementById('tourMaxCapacity').value = tour.maxCapacity || '';
        document.getElementById('tourDurationHours').value = tour.durationHours || '';
        document.getElementById('tourLocation').value = tour.location || '';
        document.getElementById('tourIsActive').value = tour.isActive ? 'true' : 'false';
        
        // Cargar imágenes
        const imagesContainer = document.getElementById('imagesContainer');
        imagesContainer.innerHTML = '';
        
        if (tour.images && tour.images.length > 0) {
          tour.images.forEach((url, index) => {
            const imageGroup = document.createElement('div');
            imageGroup.className = 'image-input-group';
            imageGroup.innerHTML = `
              <input type="url" class="image-url-input" value="${url}" placeholder="https://ejemplo.com/imagen.jpg" />
              <button type="button" class="btn-secondary btn-sm" onclick="removeImage(this)">Eliminar</button>
            `;
            imagesContainer.appendChild(imageGroup);
          });
        } else {
          // Al menos un input vacío
          const imageGroup = document.createElement('div');
          imageGroup.className = 'image-input-group';
          imageGroup.innerHTML = `
            <input type="url" class="image-url-input" placeholder="https://ejemplo.com/imagen.jpg" />
            <button type="button" class="btn-secondary btn-sm" onclick="removeImage(this)">Eliminar</button>
          `;
          imagesContainer.appendChild(imageGroup);
        }
        
        setupImageInputs();
        updateImagesPreview();
        updateImageLimitInfo();
        
        // Limpiar errores
        document.querySelectorAll('.field-error').forEach(el => el.remove());
        document.querySelectorAll('.input-error').forEach(el => el.classList.remove('input-error'));
        
        document.getElementById('tourModal').classList.add('active');
      } catch (error) {
        console.error('Error loading tour:', error);
        alert('Error al cargar el tour: ' + (error.message || 'Error desconocido'));
      }
    }

    function closeTourModal() {
      document.getElementById('tourModal').classList.remove('active');
      currentTourId = null;
    }

    function validateTourForm() {
      let isValid = true;
      const errors = [];
      
      // Limpiar errores previos
      document.querySelectorAll('.field-error').forEach(el => el.remove());
      document.querySelectorAll('.input-error').forEach(el => el.classList.remove('input-error'));
      
      // Validar nombre
      const name = document.getElementById('tourName').value.trim();
      if (!name) {
        showFieldError('tourName', 'El nombre del tour es requerido');
        isValid = false;
      } else if (name.length > 200) {
        showFieldError('tourName', 'El nombre no puede exceder 200 caracteres');
        isValid = false;
      }
      
      // Validar descripción
      const description = document.getElementById('tourDescription').value.trim();
      if (!description) {
        showFieldError('tourDescription', 'La descripción es requerida');
        isValid = false;
      } else if (description.length < 50) {
        showFieldError('tourDescription', 'La descripción debe tener al menos 50 caracteres');
        isValid = false;
      } else if (description.length > 2000) {
        showFieldError('tourDescription', 'La descripción no puede exceder 2000 caracteres');
        isValid = false;
      }
      
      // Validar precio
      const price = parseFloat(document.getElementById('tourPrice').value);
      if (isNaN(price) || price <= 0) {
        showFieldError('tourPrice', 'El precio debe ser mayor a 0');
        isValid = false;
      } else if (price > 10000) {
        showFieldError('tourPrice', 'El precio no puede exceder $10,000');
        isValid = false;
      }
      
      // Validar capacidad
      const maxCapacity = parseInt(document.getElementById('tourMaxCapacity').value);
      if (isNaN(maxCapacity) || maxCapacity <= 0) {
        showFieldError('tourMaxCapacity', 'La capacidad máxima debe ser mayor a 0');
        isValid = false;
      } else if (maxCapacity > 100) {
        showFieldError('tourMaxCapacity', 'La capacidad máxima no puede exceder 100 personas');
        isValid = false;
      }
      
      // Validar duración
      const durationHours = parseInt(document.getElementById('tourDurationHours').value);
      if (isNaN(durationHours) || durationHours <= 0) {
        showFieldError('tourDurationHours', 'La duración debe ser mayor a 0 horas');
        isValid = false;
      } else if (durationHours > 48) {
        showFieldError('tourDurationHours', 'La duración no puede exceder 48 horas');
        isValid = false;
      }
      
      // Validar imágenes
      const imageInputs = document.querySelectorAll('.image-url-input');
      const images = Array.from(imageInputs)
        .map(input => input.value.trim())
        .filter(url => url.length > 0);
      
      if (images.length > 5) {
        alert('No se pueden agregar más de 5 imágenes');
        isValid = false;
      }
      
      // Validar URLs de imágenes
      images.forEach((url, index) => {
        try {
          new URL(url);
        } catch {
          const input = imageInputs[index];
          input.classList.add('input-error');
          isValid = false;
        }
      });
      
      if (!isValid && errors.length > 0) {
        alert('Por favor corrige los siguientes errores:\n\n' + errors.join('\n'));
      }
      
      return isValid;
    }
    
    function showFieldError(fieldId, message) {
      const field = document.getElementById(fieldId);
      field.classList.add('input-error');
      const errorDiv = document.createElement('span');
      errorDiv.className = 'field-error';
      errorDiv.textContent = message;
      field.parentElement.appendChild(errorDiv);
    }

    async function saveTour(event) {
      event.preventDefault();
      
      if (!validateTourForm()) {
        return;
      }
      
      // Obtener imágenes de los inputs
      const imageInputs = document.querySelectorAll('.image-url-input');
      const images = Array.from(imageInputs)
        .map(input => input.value.trim())
        .filter(url => url.length > 0);

      const tourData = {
        name: document.getElementById('tourName').value.trim(),
        description: document.getElementById('tourDescription').value.trim(),
        itinerary: document.getElementById('tourItinerary').value.trim() || null,
        price: parseFloat(document.getElementById('tourPrice').value),
        maxCapacity: parseInt(document.getElementById('tourMaxCapacity').value),
        durationHours: parseInt(document.getElementById('tourDurationHours').value),
        location: document.getElementById('tourLocation').value.trim() || null,
        isActive: document.getElementById('tourIsActive').value === 'true',
        images: images.length > 0 ? images : null
      };

      try {
        if (currentTourId) {
          await api.updateTour(currentTourId, tourData);
          alert('Tour actualizado exitosamente');
        } else {
          await api.createTour(tourData);
          alert('Tour creado exitosamente');
        }
        
        closeTourModal();
        loadTours();
      } catch (error) {
        console.error('Error saving tour:', error);
        alert('Error al guardar el tour: ' + (error.message || 'Error desconocido'));
      }
    }

    async function deleteTour(id) {
      if (!confirm('¿Estás seguro de que deseas eliminar este tour?')) {
        return;
      }

      try {
        await api.deleteTour(id);
        alert('Tour eliminado exitosamente');
        loadTours();
      } catch (error) {
        console.error('Error deleting tour:', error);
        alert('Error al eliminar el tour: ' + (error.message || 'Error desconocido'));
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      if (checkAdminAuth()) {
        loadTours();
        loadStats();
      }
      
      // Inicializar inputs de imágenes
      setupImageInputs();
    });

    if (document.getElementById('logoutBtn')) {
      document.getElementById('logoutBtn').addEventListener('click', () => {
        api.logout();
        window.location.href = '/';
      });
    }

    // Cerrar modal al hacer click fuera
    document.getElementById('tourModal').addEventListener('click', (e) => {
      if (e.target.id === 'tourModal') {
        closeTourModal();
      }
    });
  </script>
</body>
</html>
