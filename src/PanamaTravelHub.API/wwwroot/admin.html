<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Panel Administrativo ‚Äî ToursPanama</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="stylesheet" href="/css/main.css" />
  <link rel="stylesheet" href="/css/admin.css" />
  <link rel="stylesheet" href="/css/loading.css" />
  <!-- TinyMCE Editor -->
  <script src="https://cdn.tiny.cloud/1/no-api-key/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>
</head>
<body>
  <nav class="nav">
    <div class="nav-inner wrap">
      <div class="brand">
        <div class="mark"></div>
        <a href="/"><span class="brand-text">ToursPanama</span></a>
      </div>
      <div class="nav-links">
        <a href="/" class="nav-link">Tours</a>
        <a href="/admin.html" class="nav-link active">Admin</a>
        <button class="btn-primary" id="logoutBtn">Cerrar Sesi√≥n</button>
      </div>
    </div>
  </nav>

  <main class="admin-container wrap">
    <div class="section-header">
      <h1>Panel Administrativo</h1>
      <p class="section-subtitle">Gestiona tours, reservas y usuarios</p>
    </div>

    <div id="authRequired" style="display:none; text-align: center; padding: var(--spacing-2xl);">
      <p style="color: var(--text-muted); margin-bottom: var(--spacing-lg);">Acceso restringido. Debes ser administrador.</p>
      <a href="/login.html" class="btn-primary">Iniciar Sesi√≥n</a>
    </div>

    <div id="adminContent" style="display:none;">
      <div class="admin-tabs">
        <button class="admin-tab active" onclick="switchTab('tours')">Tours</button>
        <button class="admin-tab" onclick="switchTab('bookings')">Reservas</button>
        <button class="admin-tab" onclick="switchTab('users')">Usuarios</button>
        <button class="admin-tab" onclick="switchTab('cms')">CMS</button>
        <button class="admin-tab" onclick="switchTab('media')">Media</button>
        <button class="admin-tab" onclick="switchTab('pages')">P√°ginas</button>
        <button class="admin-tab" onclick="switchTab('stats')">Estad√≠sticas</button>
      </div>

      <!-- Tours Tab -->
      <div id="tours" class="admin-content active">
        <div class="admin-header">
          <h2>Tours</h2>
          <button class="btn-primary" onclick="showAddTourModal()">+ Nuevo Tour</button>
        </div>
        <div class="admin-card">
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Imagen</th>
                  <th>Nombre</th>
                  <th>Precio</th>
                  <th>Capacidad</th>
                  <th>Disponibles</th>
                  <th>Estado</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody id="toursTableBody">
                <tr>
                  <td colspan="7" style="text-align: center; color: var(--text-muted);">Cargando...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Bookings Tab -->
      <div id="bookings" class="admin-content">
        <div class="admin-header">
          <h2>Reservas</h2>
        </div>
        <div class="admin-card">
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Tour</th>
                  <th>Cliente</th>
                  <th>Email</th>
                  <th>Participantes</th>
                  <th>Total</th>
                  <th>Estado</th>
                  <th>Fecha</th>
                </tr>
              </thead>
              <tbody id="bookingsTableBody">
                <tr>
                  <td colspan="7" style="text-align: center; color: var(--text-muted);">Cargando...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Users Tab -->
      <div id="users" class="admin-content">
        <div class="admin-header">
          <h2>Usuarios</h2>
          <div style="display: flex; gap: var(--space-md); align-items: center;">
            <input type="text" id="userSearch" class="form-input" placeholder="Buscar por email, nombre..." 
                   style="width: 300px;" onkeyup="debounceSearchUsers()" />
            <select id="userFilterRole" class="form-input" style="width: 150px;" onchange="loadUsers()">
              <option value="">Todos los roles</option>
              <option value="Admin">Admin</option>
              <option value="Customer">Customer</option>
            </select>
            <select id="userFilterStatus" class="form-input" style="width: 150px;" onchange="loadUsers()">
              <option value="">Todos</option>
              <option value="true">Activos</option>
              <option value="false">Inactivos</option>
            </select>
          </div>
        </div>
        <div class="admin-card">
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Email</th>
                  <th>Nombre</th>
                  <th>Tel√©fono</th>
                  <th>Roles</th>
                  <th>Estado</th>
                  <th>Reservas</th>
                  <th>√öltimo Login</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody id="usersTableBody">
                <tr>
                  <td colspan="8" style="text-align: center; color: var(--text-muted);">Cargando...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- CMS Tab -->
      <div id="cms" class="admin-content">
        <div class="admin-header">
          <h2>Gesti√≥n de Contenido</h2>
          <p class="section-subtitle">Edita el contenido de la p√°gina de inicio</p>
        </div>
        <div class="admin-card">
          <form id="cmsForm" onsubmit="saveHomePageContent(event)">
            <!-- Secci√≥n Hero -->
            <div class="form-section">
              <div class="form-section-header">
                <h3>
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 8px;">
                    <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                    <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
                    <line x1="12" y1="22.08" x2="12" y2="12"></line>
                  </svg>
                  Secci√≥n Hero
                </h3>
                <p class="form-section-description">Contenido principal de la p√°gina de inicio</p>
              </div>
              <div class="form-group">
                <label class="form-label">
                  <span class="label-text">T√≠tulo Principal</span>
                  <span class="label-required">*</span>
                </label>
                <div class="input-with-icon">
                  <input type="text" id="heroTitle" class="form-input" placeholder="Ej: Descubre Panam√°" required />
                  <span class="input-icon">üìù</span>
                </div>
                <div class="form-hint">T√≠tulo principal que aparece en la secci√≥n hero</div>
              </div>
              <div class="form-group">
                <label class="form-label">
                  <span class="label-text">Subt√≠tulo</span>
                  <span class="label-required">*</span>
                </label>
                <div class="input-with-icon">
                  <input type="text" id="heroSubtitle" class="form-input" placeholder="Ej: Explora los destinos m√°s incre√≠bles" required />
                  <span class="input-icon">üí¨</span>
                </div>
                <div class="form-hint">Subt√≠tulo descriptivo debajo del t√≠tulo principal</div>
              </div>
              <div class="form-row form-row-2">
                <div class="form-group">
                  <label class="form-label">
                    <span class="label-text">Placeholder de B√∫squeda</span>
                    <span class="label-required">*</span>
                  </label>
                  <div class="input-with-icon">
                    <input type="text" id="heroSearchPlaceholder" class="form-input" placeholder="Ej: Buscar tours..." required />
                    <span class="input-icon">üîç</span>
                  </div>
                </div>
                <div class="form-group">
                  <label class="form-label">
                    <span class="label-text">Texto del Bot√≥n Buscar</span>
                    <span class="label-required">*</span>
                  </label>
                  <div class="input-with-icon">
                    <input type="text" id="heroSearchButton" class="form-input" placeholder="Ej: Buscar" required />
                    <span class="input-icon">üîé</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Secci√≥n de Tours -->
            <div class="form-section">
              <div class="form-section-header">
                <h3>
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 8px;">
                    <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
                  </svg>
                  Secci√≥n de Tours
                </h3>
                <p class="form-section-description">Textos relacionados con la visualizaci√≥n de tours</p>
              </div>
              <div class="form-row form-row-2">
                <div class="form-group">
                  <label class="form-label">
                    <span class="label-text">T√≠tulo de Secci√≥n</span>
                    <span class="label-required">*</span>
                  </label>
                  <div class="input-with-icon">
                    <input type="text" id="toursSectionTitle" class="form-input" placeholder="Ej: Tours Disponibles" required />
                    <span class="input-icon">üìã</span>
                  </div>
                </div>
                <div class="form-group">
                  <label class="form-label">
                    <span class="label-text">Subt√≠tulo de Secci√≥n</span>
                    <span class="label-required">*</span>
                  </label>
                  <div class="input-with-icon">
                    <input type="text" id="toursSectionSubtitle" class="form-input" placeholder="Ej: Selecciona tu pr√≥xima aventura" required />
                    <span class="input-icon">‚ú®</span>
                  </div>
                </div>
              </div>
              <div class="form-group">
                <label class="form-label">
                  <span class="label-text">Texto "Cargando tours..."</span>
                  <span class="label-required">*</span>
                </label>
                <div class="input-with-icon">
                  <input type="text" id="loadingToursText" class="form-input" placeholder="Ej: Cargando tours..." required />
                  <span class="input-icon">‚è≥</span>
                </div>
              </div>
              <div class="form-group">
                <label class="form-label">
                  <span class="label-text">Texto de Error</span>
                  <span class="label-required">*</span>
                </label>
                <div class="input-with-icon">
                  <input type="text" id="errorLoadingToursText" class="form-input" placeholder="Ej: Error al cargar los tours..." required />
                  <span class="input-icon">‚ö†Ô∏è</span>
                </div>
              </div>
              <div class="form-group">
                <label class="form-label">
                  <span class="label-text">Texto "No se encontraron tours"</span>
                  <span class="label-required">*</span>
                </label>
                <div class="input-with-icon">
                  <input type="text" id="noToursFoundText" class="form-input" placeholder="Ej: No se encontraron tours disponibles." required />
                  <span class="input-icon">üì≠</span>
                </div>
              </div>
            </div>

            <!-- Navegaci√≥n -->
            <div class="form-section">
              <div class="form-section-header">
                <h3>
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 8px;">
                    <line x1="3" y1="12" x2="21" y2="12"></line>
                    <line x1="3" y1="6" x2="21" y2="6"></line>
                    <line x1="3" y1="18" x2="21" y2="18"></line>
                  </svg>
                  Navegaci√≥n
                </h3>
                <p class="form-section-description">Textos de los elementos de navegaci√≥n</p>
              </div>
              <div class="form-row form-row-2">
                <div class="form-group">
                  <label class="form-label">
                    <span class="label-text">Texto de Marca</span>
                    <span class="label-required">*</span>
                  </label>
                  <div class="input-with-icon">
                    <input type="text" id="navBrandText" class="form-input" placeholder="Ej: ToursPanama" required />
                    <span class="input-icon">üè∑Ô∏è</span>
                  </div>
                </div>
                <div class="form-group">
                  <label class="form-label">
                    <span class="label-text">Enlace Tours</span>
                    <span class="label-required">*</span>
                  </label>
                  <div class="input-with-icon">
                    <input type="text" id="navToursLink" class="form-input" placeholder="Ej: Tours" required />
                    <span class="input-icon">üó∫Ô∏è</span>
                  </div>
                </div>
              </div>
              <div class="form-row form-row-2">
                <div class="form-group">
                  <label class="form-label">
                    <span class="label-text">Enlace Reservas</span>
                    <span class="label-required">*</span>
                  </label>
                  <div class="input-with-icon">
                    <input type="text" id="navBookingsLink" class="form-input" placeholder="Ej: Mis Reservas" required />
                    <span class="input-icon">üìÖ</span>
                  </div>
                </div>
                <div class="form-group">
                  <label class="form-label">
                    <span class="label-text">Enlace Iniciar Sesi√≥n</span>
                    <span class="label-required">*</span>
                  </label>
                  <div class="input-with-icon">
                    <input type="text" id="navLoginLink" class="form-input" placeholder="Ej: Iniciar Sesi√≥n" required />
                    <span class="input-icon">üîê</span>
                  </div>
                </div>
              </div>
              <div class="form-group">
                <label class="form-label">
                  <span class="label-text">Bot√≥n Cerrar Sesi√≥n</span>
                  <span class="label-required">*</span>
                </label>
                <div class="input-with-icon">
                  <input type="text" id="navLogoutButton" class="form-input" placeholder="Ej: Cerrar Sesi√≥n" required />
                  <span class="input-icon">üö™</span>
                </div>
              </div>
            </div>

            <!-- Pie de P√°gina -->
            <div class="form-section">
              <div class="form-section-header">
                <h3>
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 8px;">
                    <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                    <circle cx="12" cy="10" r="3"></circle>
                  </svg>
                  Pie de P√°gina
                </h3>
                <p class="form-section-description">Contenido del footer de la p√°gina</p>
              </div>
              <div class="form-group">
                <label class="form-label">
                  <span class="label-text">Texto de Marca</span>
                  <span class="label-required">*</span>
                </label>
                <div class="input-with-icon">
                  <input type="text" id="footerBrandText" class="form-input" placeholder="Ej: ToursPanama" required />
                  <span class="input-icon">üè¢</span>
                </div>
              </div>
              <div class="form-group">
                <label class="form-label">
                  <span class="label-text">Descripci√≥n</span>
                  <span class="label-required">*</span>
                </label>
                <div class="input-with-icon">
                  <textarea id="footerDescription" class="form-input" rows="3" placeholder="Ej: Tu plataforma de confianza para descubrir Panam√°" required></textarea>
                  <span class="input-icon">üìÑ</span>
                </div>
                <div class="form-hint">Descripci√≥n breve de la empresa o plataforma</div>
              </div>
              <div class="form-group">
                <label class="form-label">
                  <span class="label-text">Copyright</span>
                  <span class="label-required">*</span>
                </label>
                <div class="input-with-icon">
                  <input type="text" id="footerCopyright" class="form-input" placeholder="Ej: ¬© 2024 ToursPanama. Todos los derechos reservados." required />
                  <span class="input-icon">¬©Ô∏è</span>
                </div>
              </div>
            </div>

            <!-- SEO y Meta Tags -->
            <div class="form-section">
              <div class="form-section-header">
                <h3>
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 8px;">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="12" y1="16" x2="12" y2="12"></line>
                    <line x1="12" y1="8" x2="12.01" y2="8"></line>
                  </svg>
                  SEO y Meta Tags
                </h3>
                <p class="form-section-description">Configuraci√≥n para motores de b√∫squeda</p>
              </div>
              <div class="form-group">
                <label class="form-label">
                  <span class="label-text">T√≠tulo de la P√°gina (Title)</span>
                  <span class="label-required">*</span>
                </label>
                <div class="input-with-icon">
                  <input type="text" id="pageTitle" class="form-input" placeholder="Ej: ToursPanama ‚Äî Descubre los Mejores Tours" required />
                  <span class="input-icon">üåê</span>
                </div>
                <div class="form-hint">Aparece en la pesta√±a del navegador y en los resultados de b√∫squeda (m√°x. 60 caracteres recomendado)</div>
              </div>
              <div class="form-group">
                <label class="form-label">
                  <span class="label-text">Meta Descripci√≥n</span>
                  <span class="label-required">*</span>
                </label>
                <div class="input-with-icon">
                  <textarea id="metaDescription" class="form-input" rows="3" placeholder="Ej: Plataforma moderna de reservas de tours en Panam√°..." required></textarea>
                  <span class="input-icon">üìù</span>
                </div>
                <div class="form-hint">Descripci√≥n que aparece en los resultados de b√∫squeda (m√°x. 160 caracteres recomendado)</div>
              </div>
            </div>

            <div class="form-actions">
              <button type="button" class="btn-secondary" onclick="document.getElementById('cmsForm').reset(); loadHomePageContent();">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="1 4 1 10 7 10"></polyline>
                  <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path>
                </svg>
                Cancelar
              </button>
              <button type="submit" class="btn-primary">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                  <polyline points="17 21 17 13 7 13 7 21"></polyline>
                  <polyline points="7 3 7 8 15 8"></polyline>
                </svg>
                Guardar Cambios
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- Media Library Tab -->
      <div id="media" class="admin-content">
        <div class="admin-header">
          <h2>Media Library</h2>
          <p class="section-subtitle">Gestiona tus archivos multimedia</p>
        </div>
        
        <div class="admin-card">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-lg);">
            <div>
              <button class="btn-primary" onclick="showUploadMediaModal()">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="12" y1="5" x2="12" y2="19"></line>
                  <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
                Subir Archivo
              </button>
            </div>
            <div style="display: flex; gap: var(--spacing-md);">
              <select id="mediaCategoryFilter" class="form-input" style="width: 200px;" onchange="loadMediaFiles()">
                <option value="">Todas las categor√≠as</option>
                <option value="Tours">Tours</option>
                <option value="Hero">Hero / Banner</option>
                <option value="Gallery">Galer√≠a</option>
                <option value="Testimonials">Testimonios</option>
                <option value="Blog">Blog</option>
                <option value="Documents">Documentos</option>
                <option value="Other">Otros</option>
              </select>
              <select id="mediaTypeFilter" class="form-input" style="width: 150px;" onchange="loadMediaFiles()">
                <option value="">Todos los tipos</option>
                <option value="true">Solo im√°genes</option>
                <option value="false">Otros archivos</option>
              </select>
            </div>
          </div>
          
          <div id="mediaFilesGrid" class="media-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: var(--spacing-lg);">
            <p style="color: var(--text-muted); grid-column: 1 / -1;">Cargando archivos...</p>
          </div>
          
          <div id="mediaPagination" style="margin-top: var(--spacing-lg); text-align: center;"></div>
        </div>
      </div>

      <!-- Pages Tab -->
      <div id="pages" class="admin-content">
        <div class="admin-header">
          <h2>Gesti√≥n de P√°ginas</h2>
          <p class="section-subtitle">Crea y gestiona p√°ginas din√°micas</p>
        </div>
        
        <div class="admin-card">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-lg);">
            <button class="btn-primary" onclick="showAddPageModal()">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
              </svg>
              Nueva P√°gina
            </button>
            <select id="pagesStatusFilter" class="form-input" style="width: 200px;" onchange="loadPages()">
              <option value="">Todas las p√°ginas</option>
              <option value="true">Publicadas</option>
              <option value="false">Borradores</option>
            </select>
          </div>
          
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>T√≠tulo</th>
                  <th>Slug</th>
                  <th>Estado</th>
                  <th>Orden</th>
                  <th>Actualizada</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody id="pagesTableBody">
                <tr>
                  <td colspan="6" style="text-align: center; color: var(--text-muted);">Cargando...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Stats Tab -->
      <div id="stats" class="admin-content">
        <div class="admin-header">
          <h2>Estad√≠sticas</h2>
        </div>
        <div class="admin-card" id="statsContent">
          <p style="color: var(--text-muted);">Cargando estad√≠sticas...</p>
        </div>
      </div>
    </div>
  </main>

  <!-- Tour Modal -->
  <div id="tourModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-header-content">
          <h2 id="modalTitle">Nuevo Tour</h2>
          <p class="modal-subtitle">Completa la informaci√≥n del tour</p>
        </div>
        <button type="button" class="modal-close" onclick="closeTourModal()" aria-label="Cerrar">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <form id="tourForm" onsubmit="saveTour(event)">
          <!-- Informaci√≥n B√°sica -->
          <div class="form-section">
            <div class="form-section-header">
              <h3>Informaci√≥n B√°sica</h3>
              <p class="form-section-description">Datos principales del tour</p>
            </div>
            <div class="form-row">
              <div class="form-group form-group-full">
                <label class="form-label">
                  <span class="label-text">Nombre del Tour</span>
                  <span class="label-required">*</span>
                </label>
                <input type="text" id="tourName" class="form-input" placeholder="Ej: Tour del Canal de Panam√°" required />
              </div>
            </div>
            <div class="form-row">
              <div class="form-group form-group-full">
                <label class="form-label">
                  <span class="label-text">Descripci√≥n</span>
                  <span class="label-required">*</span>
                </label>
                <textarea id="tourDescription" class="form-input form-textarea" placeholder="Describe el tour de manera atractiva..." required></textarea>
                <div class="form-hint">M√≠nimo 50 caracteres. Describe los aspectos m√°s destacados del tour.</div>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group form-group-full">
                <label class="form-label">
                  <span class="label-text">Itinerario</span>
                  <span class="label-optional">(Opcional)</span>
                </label>
                <textarea id="tourItinerary" class="form-input form-textarea" placeholder="Detalla el itinerario del tour..."></textarea>
                <div class="form-hint">Incluye los puntos de inter√©s y actividades del tour.</div>
              </div>
            </div>
          </div>

          <!-- Detalles del Tour -->
          <div class="form-section">
            <div class="form-section-header">
              <h3>Detalles del Tour</h3>
              <p class="form-section-description">Precio, capacidad y duraci√≥n</p>
            </div>
            <div class="form-row form-row-3">
              <div class="form-group">
                <label class="form-label">
                  <span class="label-text">Precio (USD)</span>
                  <span class="label-required">*</span>
                </label>
                <div class="input-with-icon">
                  <span class="input-icon">$</span>
                  <input type="number" id="tourPrice" class="form-input" step="0.01" min="0" placeholder="0.00" required />
                </div>
              </div>
              <div class="form-group">
                <label class="form-label">
                  <span class="label-text">Capacidad M√°xima</span>
                  <span class="label-required">*</span>
                </label>
                <div class="input-with-icon">
                  <span class="input-icon">üë•</span>
                  <input type="number" id="tourMaxCapacity" class="form-input" min="1" placeholder="20" required />
                </div>
              </div>
              <div class="form-group">
                <label class="form-label">
                  <span class="label-text">Duraci√≥n (horas)</span>
                  <span class="label-required">*</span>
                </label>
                <div class="input-with-icon">
                  <span class="input-icon">‚è±</span>
                  <input type="number" id="tourDurationHours" class="form-input" min="1" placeholder="4" required />
                </div>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group form-group-half">
                <label class="form-label">
                  <span class="label-text">Ubicaci√≥n</span>
                  <span class="label-optional">(Opcional)</span>
                </label>
                <div class="input-with-icon">
                  <span class="input-icon">üìç</span>
                  <input type="text" id="tourLocation" class="form-input" placeholder="Ej: Ciudad de Panam√°" />
                </div>
              </div>
              <div class="form-group form-group-half">
                <label class="form-label">
                  <span class="label-text">Estado</span>
                </label>
                <select id="tourIsActive" class="form-input form-select">
                  <option value="true">Activo</option>
                  <option value="false">Inactivo</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Im√°genes -->
          <div class="form-section">
            <div class="form-section-header">
              <h3>Im√°genes del Tour</h3>
              <p class="form-section-description">Agrega hasta 5 im√°genes. La primera ser√° la imagen principal.</p>
            </div>
            <div class="form-group">
              <!-- √Årea de Drag and Drop -->
              <div id="dropZone" class="drop-zone">
                <div class="drop-zone-content">
                  <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="drop-zone-icon">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="17 8 12 3 7 8"></polyline>
                    <line x1="12" y1="3" x2="12" y2="15"></line>
                  </svg>
                  <p class="drop-zone-text">Arrastra y suelta im√°genes aqu√≠</p>
                  <p class="drop-zone-hint">o</p>
                  <label for="fileInput" class="btn-primary btn-upload">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                      <polyline points="17 8 12 3 7 8"></polyline>
                      <line x1="12" y1="3" x2="12" y2="15"></line>
                    </svg>
                    Examinar archivos
                  </label>
                  <input type="file" id="fileInput" multiple accept="image/*" style="display: none;" />
                  <p class="drop-zone-info">Formatos: JPG, PNG, GIF, WEBP (m√°x. 5MB cada una)</p>
                </div>
              </div>

              <!-- Inputs de URL (alternativa) -->
              <div class="image-url-section">
                <button type="button" class="btn-toggle-url" onclick="toggleUrlInputs()">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                    <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                  </svg>
                  <span id="toggleUrlText">O usar URLs de im√°genes</span>
                </button>
                <div id="urlInputsContainer" class="url-inputs-container" style="display: none;">
                  <div id="imagesContainer" class="images-container">
                    <div class="image-input-group">
                      <div class="input-with-icon">
                        <span class="input-icon">üñºÔ∏è</span>
                        <input type="url" class="image-url-input form-input" placeholder="https://ejemplo.com/imagen.jpg" />
                      </div>
                      <button type="button" class="btn-icon btn-danger" onclick="removeImage(this)" title="Eliminar imagen">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <polyline points="3 6 5 6 21 6"></polyline>
                          <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                        </svg>
                      </button>
                    </div>
                  </div>
                  <button type="button" id="addImageBtn" class="btn-add-image" onclick="addImageInput()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <line x1="12" y1="5" x2="12" y2="19"></line>
                      <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    <span id="addImageText">Agregar URL</span>
                  </button>
                </div>
              </div>

              <!-- Preview de im√°genes -->
              <div id="imagesPreview" class="images-preview"></div>
              
              <!-- Informaci√≥n de l√≠mite -->
              <div id="imageLimitInfo" class="image-limit-info">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"></circle>
                  <line x1="12" y1="16" x2="12" y2="12"></line>
                  <line x1="12" y1="8" x2="12.01" y2="8"></line>
                </svg>
                <span>La primera imagen ser√° la imagen principal. M√°ximo 5 im√°genes.</span>
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="form-actions">
        <button type="button" class="btn-secondary btn-cancel" onclick="closeTourModal()">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
          Cancelar
        </button>
        <button type="submit" class="btn-primary btn-save" form="tourForm">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
            <polyline points="17 21 17 13 7 13 7 21"></polyline>
            <polyline points="7 3 7 8 15 8"></polyline>
          </svg>
          Guardar Tour
        </button>
      </div>
    </div>
  </div>

  <!-- Modal para Media Library Upload -->
  <div id="uploadMediaModal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h2>Subir Archivo a Media Library</h2>
        <button class="close" onclick="closeUploadMediaModal()">√ó</button>
      </div>
      <div class="modal-body">
        <form id="uploadMediaForm" onsubmit="uploadMediaFile(event)">
          <div class="form-group">
            <label class="form-label">Archivo</label>
            <input type="file" id="mediaFileInput" class="form-input" required accept="image/*,video/*,.pdf,.doc,.docx" />
          </div>
          <div class="form-group">
            <label class="form-label">Alt Text (para im√°genes)</label>
            <input type="text" id="mediaAltText" class="form-input" placeholder="Descripci√≥n de la imagen" />
          </div>
          <div class="form-group">
            <label class="form-label">Descripci√≥n</label>
            <textarea id="mediaDescription" class="form-input" rows="3" placeholder="Descripci√≥n opcional del archivo"></textarea>
          </div>
          <div class="form-group">
            <label class="form-label">Categor√≠a</label>
            <select id="mediaCategory" class="form-input">
              <option value="">Sin categor√≠a</option>
              <option value="Tours">Tours</option>
              <option value="Hero">Hero / Banner</option>
              <option value="Gallery">Galer√≠a</option>
              <option value="Testimonials">Testimonios</option>
              <option value="Blog">Blog</option>
              <option value="Documents">Documentos</option>
              <option value="Other">Otros</option>
            </select>
            <div class="form-hint">Organiza tus archivos por categor√≠as para facilitar la b√∫squeda</div>
          </div>
          <div class="form-actions">
            <button type="button" class="btn-secondary" onclick="closeUploadMediaModal()">Cancelar</button>
            <button type="submit" class="btn-primary">Subir Archivo</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal para P√°ginas -->
  <div id="pageModal" class="modal">
    <div class="modal-content" style="max-width: 900px;">
      <div class="modal-header">
        <h2 id="pageModalTitle">Nueva P√°gina</h2>
        <button class="close" onclick="closePageModal()">√ó</button>
      </div>
      <div class="modal-body">
        <form id="pageForm" onsubmit="savePage(event)">
          <div class="form-row form-row-2">
            <div class="form-group">
              <label class="form-label">
                <span class="label-text">T√≠tulo</span>
                <span class="label-required">*</span>
              </label>
              <input type="text" id="pageTitle" class="form-input" required />
            </div>
            <div class="form-group">
              <label class="form-label">
                <span class="label-text">Slug (URL)</span>
                <span class="label-required">*</span>
              </label>
              <input type="text" id="pageSlug" class="form-input" required placeholder="ejemplo-pagina" />
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Contenido</label>
            <textarea id="pageContent" class="form-input" rows="15"></textarea>
          </div>
          <div class="form-group">
            <label class="form-label">Resumen (Excerpt)</label>
            <textarea id="pageExcerpt" class="form-input" rows="2" placeholder="Breve descripci√≥n de la p√°gina"></textarea>
          </div>
          <div class="form-section">
            <h3>SEO</h3>
            <div class="form-group">
              <label class="form-label">Meta Title</label>
              <input type="text" id="pageMetaTitle" class="form-input" />
            </div>
            <div class="form-group">
              <label class="form-label">Meta Description</label>
              <textarea id="pageMetaDescription" class="form-input" rows="2"></textarea>
            </div>
            <div class="form-group">
              <label class="form-label">Meta Keywords</label>
              <input type="text" id="pageMetaKeywords" class="form-input" placeholder="palabra1, palabra2, palabra3" />
            </div>
          </div>
          <div class="form-row form-row-2">
            <div class="form-group">
              <label class="form-label">Template</label>
              <select id="pageTemplate" class="form-input">
                <option value="default">Default (P√°gina est√°ndar)</option>
                <option value="full-width">Full Width (Ancho completo)</option>
                <option value="sidebar">Sidebar (Con barra lateral)</option>
                <option value="landing">Landing Page (P√°gina de aterrizaje)</option>
                <option value="about">About (Sobre nosotros)</option>
                <option value="contact">Contact (Contacto)</option>
                <option value="blog">Blog (Entrada de blog)</option>
                <option value="gallery">Gallery (Galer√≠a)</option>
              </select>
              <div class="form-hint">Selecciona el template que mejor se adapte al contenido</div>
            </div>
            <div class="form-group">
              <label class="form-label">Orden de Visualizaci√≥n</label>
              <input type="number" id="pageDisplayOrder" class="form-input" value="0" min="0" />
              <div class="form-hint">Menor n√∫mero = aparece primero en men√∫s</div>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">
              <input type="checkbox" id="pageIsPublished" />
              Publicar p√°gina
            </label>
          </div>
          <div class="form-actions">
            <button type="button" class="btn-secondary" onclick="closePageModal()">Cancelar</button>
            <button type="submit" class="btn-primary">Guardar P√°gina</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script src="/js/loading.js"></script>
  <script src="/js/logger.js"></script>
  <script src="/js/api.js"></script>
  <script>
    // ‚úÖ Funci√≥n helper para formatear precios de forma segura
    function formatPrice(value, fallbackText = '$0.00') {
      const rawPrice = value ?? null;
      let price = Number(rawPrice ?? 0);
      
      // Validaci√≥n: asegurar que price es un n√∫mero v√°lido y finito
      if (typeof price !== 'number' || isNaN(price) || !isFinite(price)) {
        console.warn('‚ö†Ô∏è [formatPrice] Precio inv√°lido, usando 0:', { value, rawPrice, price });
        price = 0;
      }
      
      // Formatear precio
      const formattedPrice = price.toFixed(2);
      return price > 0 ? `$${formattedPrice}` : fallbackText;
    }

    let currentTourId = null;

    function checkAdminAuth() {
      const token = localStorage.getItem('authToken');
      const userRoles = JSON.parse(localStorage.getItem('userRoles') || '[]');
      const authRequired = document.getElementById('authRequired');
      const adminContent = document.getElementById('adminContent');

      if (!token) {
        authRequired.style.display = 'block';
        adminContent.style.display = 'none';
        return false;
      }

      // Verificar si el usuario tiene rol Admin
      const isAdmin = userRoles.includes('Admin') || userRoles.includes('admin');
      
      if (!isAdmin) {
        authRequired.style.display = 'block';
        adminContent.style.display = 'none';
        authRequired.innerHTML = `
          <p style="color: var(--text-muted); margin-bottom: var(--spacing-lg);">
            Acceso restringido. Debes ser administrador para acceder a esta secci√≥n.
          </p>
          <a href="/" class="btn-primary">Volver al Inicio</a>
        `;
        return false;
      }

      authRequired.style.display = 'none';
      adminContent.style.display = 'block';
      return true;
    }

    function switchTab(tabName) {
      // Update tabs
      document.querySelectorAll('.admin-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      event.target.classList.add('active');

      // Update content
      document.querySelectorAll('.admin-content').forEach(content => {
        content.classList.remove('active');
      });
      document.getElementById(tabName).classList.add('active');

      // Load tab data
      if (tabName === 'tours') loadTours();
      if (tabName === 'bookings') loadBookings();
      if (tabName === 'users') loadUsers();
      if (tabName === 'cms') loadHomePageContent();
      if (tabName === 'media') loadMediaFiles();
      if (tabName === 'pages') loadPages();
      if (tabName === 'stats') loadStats();
    }

    let searchUsersTimeout;
    function debounceSearchUsers() {
      clearTimeout(searchUsersTimeout);
      searchUsersTimeout = setTimeout(() => {
        loadUsers();
      }, 500);
    }

    async function loadUsers() {
      try {
        const search = document.getElementById('userSearch')?.value || '';
        const role = document.getElementById('userFilterRole')?.value || '';
        const isActive = document.getElementById('userFilterStatus')?.value;
        const isActiveBool = isActive === '' ? null : isActive === 'true';

        const users = await api.getAdminUsers(search, isActiveBool, role);
        const tbody = document.getElementById('usersTableBody');
        
        if (!users || users.length === 0) {
          tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: var(--text-muted);">No hay usuarios disponibles</td></tr>';
          return;
        }

        tbody.innerHTML = users.map(user => {
          const rolesBadges = user.roles.map(role => 
            `<span class="badge ${role === 'Admin' ? 'active' : 'inactive'}" style="margin-right: 4px;">${role}</span>`
          ).join('');
          
          const isLocked = user.lockedUntil && new Date(user.lockedUntil) > new Date();
          const statusBadge = user.isActive 
            ? `<span class="badge active">Activo</span>`
            : `<span class="badge inactive">Inactivo</span>`;
          
          const lockedBadge = isLocked 
            ? `<span class="badge" style="background: #ef4444; margin-left: 4px;">Bloqueado</span>`
            : '';

          return `
            <tr>
              <td>${user.email}</td>
              <td>${user.firstName} ${user.lastName}</td>
              <td>${user.phone || '‚Äî'}</td>
              <td>${rolesBadges}</td>
              <td>${statusBadge}${lockedBadge}</td>
              <td>${user.totalBookings}</td>
              <td>${user.lastLoginAt ? new Date(user.lastLoginAt).toLocaleDateString('es-PA') : 'Nunca'}</td>
              <td>
                <div class="action-buttons">
                  <button class="btn-sm btn-primary" onclick="viewUser('${user.id}')">Ver</button>
                  <button class="btn-sm btn-secondary" onclick="editUser('${user.id}')">Editar</button>
                  ${isLocked ? `<button class="btn-sm" style="background: #10b981;" onclick="unlockUser('${user.id}')">Desbloquear</button>` : ''}
                </div>
              </td>
            </tr>
          `;
        }).join('');
      } catch (error) {
        console.error('Error loading users:', error);
        document.getElementById('usersTableBody').innerHTML = 
          '<tr><td colspan="8" style="text-align: center; color: var(--error);">Error al cargar usuarios</td></tr>';
      }
    }

    async function viewUser(userId) {
      try {
        const user = await api.getAdminUser(userId);
        
        // Crear modal para ver detalles del usuario
        const modal = document.createElement('div');
        modal.className = 'modal active';
        modal.innerHTML = `
          <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
              <h2>Detalles del Usuario</h2>
              <button class="close" onclick="this.closest('.modal').remove()">√ó</button>
            </div>
            <div class="modal-body">
              <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" class="form-input" value="${user.email}" readonly />
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">Nombre</label>
                  <input type="text" class="form-input" value="${user.firstName}" readonly />
                </div>
                <div class="form-group">
                  <label class="form-label">Apellido</label>
                  <input type="text" class="form-input" value="${user.lastName}" readonly />
                </div>
              </div>
              <div class="form-group">
                <label class="form-label">Tel√©fono</label>
                <input type="text" class="form-input" value="${user.phone || ''}" readonly />
              </div>
              <div class="form-group">
                <label class="form-label">Roles</label>
                <div style="display: flex; gap: 8px; margin-top: 8px;">
                  ${user.roles.map(role => `<span class="badge ${role === 'Admin' ? 'active' : 'inactive'}">${role}</span>`).join('')}
                </div>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">Estado</label>
                  <span class="badge ${user.isActive ? 'active' : 'inactive'}">${user.isActive ? 'Activo' : 'Inactivo'}</span>
                </div>
                <div class="form-group">
                  <label class="form-label">Reservas Totales</label>
                  <span>${user.totalBookings || 0}</span>
                </div>
              </div>
              ${user.bookings && user.bookings.length > 0 ? `
                <div class="form-group" style="margin-top: 20px;">
                  <label class="form-label">Historial de Reservas</label>
                  <div class="table-container" style="max-height: 300px; overflow-y: auto;">
                    <table>
                      <thead>
                        <tr>
                          <th>Tour</th>
                          <th>Fecha</th>
                          <th>Participantes</th>
                          <th>Total</th>
                          <th>Estado</th>
                        </tr>
                      </thead>
                      <tbody>
                        ${user.bookings.map(booking => `
                          <tr>
                            <td>${booking.tourName}</td>
                            <td>${booking.tourDate ? new Date(booking.tourDate).toLocaleDateString('es-PA') : '‚Äî'}</td>
                            <td>${booking.numberOfParticipants}</td>
                            <td>${formatPrice(booking.totalAmount)}</td>
                            <td><span class="badge ${booking.status === 'Confirmed' ? 'active' : 'inactive'}">${booking.status}</span></td>
                          </tr>
                        `).join('')}
                      </tbody>
                    </table>
                  </div>
                </div>
              ` : ''}
            </div>
            <div class="modal-footer">
              <button class="btn-secondary" onclick="this.closest('.modal').remove()">Cerrar</button>
              <button class="btn-primary" onclick="editUser('${user.id}'); this.closest('.modal').remove();">Editar</button>
            </div>
          </div>
        `;
        document.body.appendChild(modal);
      } catch (error) {
        console.error('Error loading user:', error);
        alert('Error al cargar los detalles del usuario');
      }
    }

    async function editUser(userId) {
      try {
        const user = await api.getAdminUser(userId);
        const roles = await api.getAdminRoles();
        
        const modal = document.createElement('div');
        modal.className = 'modal active';
        modal.innerHTML = `
          <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
              <h2>Editar Usuario</h2>
              <button class="close" onclick="this.closest('.modal').remove()">√ó</button>
            </div>
            <div class="modal-body">
              <form id="editUserForm" onsubmit="saveUser(event, '${user.id}')">
                <div class="form-group">
                  <label class="form-label">Email</label>
                  <input type="email" class="form-input" value="${user.email}" readonly style="background: #f3f4f6;" />
                </div>
                <div class="form-row">
                  <div class="form-group">
                    <label class="form-label">Nombre</label>
                    <input type="text" id="editFirstName" class="form-input" value="${user.firstName}" required />
                  </div>
                  <div class="form-group">
                    <label class="form-label">Apellido</label>
                    <input type="text" id="editLastName" class="form-input" value="${user.lastName}" required />
                  </div>
                </div>
                <div class="form-group">
                  <label class="form-label">Tel√©fono</label>
                  <input type="text" id="editPhone" class="form-input" value="${user.phone || ''}" />
                </div>
                <div class="form-group">
                  <label class="form-label">Estado</label>
                  <select id="editIsActive" class="form-input">
                    <option value="true" ${user.isActive ? 'selected' : ''}>Activo</option>
                    <option value="false" ${!user.isActive ? 'selected' : ''}>Inactivo</option>
                  </select>
                </div>
                <div class="form-group">
                  <label class="form-label">Roles</label>
                  <div style="display: flex; flex-direction: column; gap: 8px; margin-top: 8px;">
                    ${roles.map(role => `
                      <label style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" name="roles" value="${role.name}" 
                               ${user.roles.includes(role.name) ? 'checked' : ''} />
                        <span>${role.name} ${role.description ? `- ${role.description}` : ''}</span>
                      </label>
                    `).join('')}
                  </div>
                </div>
              </form>
            </div>
            <div class="modal-footer">
              <button class="btn-secondary" onclick="this.closest('.modal').remove()">Cancelar</button>
              <button class="btn-primary" onclick="document.getElementById('editUserForm').dispatchEvent(new Event('submit'))">Guardar</button>
            </div>
          </div>
        `;
        document.body.appendChild(modal);
      } catch (error) {
        console.error('Error loading user for edit:', error);
        alert('Error al cargar los datos del usuario');
      }
    }

    async function saveUser(event, userId) {
      event.preventDefault();
      try {
        const form = event.target;
        const selectedRoles = Array.from(form.querySelectorAll('input[name="roles"]:checked')).map(cb => cb.value);
        
        const userData = {
          firstName: document.getElementById('editFirstName').value,
          lastName: document.getElementById('editLastName').value,
          phone: document.getElementById('editPhone').value || null,
          isActive: document.getElementById('editIsActive').value === 'true',
          roles: selectedRoles
        };

        await api.updateAdminUser(userId, userData);
        alert('Usuario actualizado exitosamente');
        document.querySelector('.modal.active').remove();
        loadUsers();
      } catch (error) {
        console.error('Error saving user:', error);
        alert('Error al guardar el usuario: ' + (error.message || 'Error desconocido'));
      }
    }

    async function unlockUser(userId) {
      if (!confirm('¬øEst√°s seguro de desbloquear este usuario?')) {
        return;
      }
      
      try {
        await api.unlockAdminUser(userId);
        alert('Usuario desbloqueado exitosamente');
        loadUsers();
      } catch (error) {
        console.error('Error unlocking user:', error);
        alert('Error al desbloquear el usuario');
      }
    }

    async function loadTours() {
      const tbody = document.getElementById('toursTableBody');
      const loaderId = loadingManager.showInline(tbody, 'Cargando tours...');
      
      try {
        const tours = await api.getAdminTours();
        loadingManager.hideInline(tbody);
        
        if (!tours || tours.length === 0) {
          tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--text-muted);">No hay tours disponibles</td></tr>';
          return;
        }

        tbody.innerHTML = tours.map(tour => `
          <tr>
            <td>
              ${tour.imageUrl ? `<img src="${tour.imageUrl}" class="tour-image-preview" alt="${tour.name}" />` : '‚Äî'}
            </td>
            <td>${tour.name}</td>
            <td>${formatPrice(tour.price ?? tour.Price)}</td>
            <td>${tour.maxCapacity}</td>
            <td>${tour.availableSpots}</td>
            <td>
              <span class="badge ${tour.isActive ? 'active' : 'inactive'}">
                ${tour.isActive ? 'Activo' : 'Inactivo'}
              </span>
            </td>
            <td>
              <div class="action-buttons">
                <button class="btn-sm btn-primary" onclick="editTour('${tour.id}')">Editar</button>
                <button class="btn-sm btn-secondary" onclick="deleteTour('${tour.id}')">Eliminar</button>
              </div>
            </td>
          </tr>
        `).join('');
      } catch (error) {
        console.error('Error loading tours:', error);
        loadingManager.hideInline(tbody);
        document.getElementById('toursTableBody').innerHTML = 
          '<tr><td colspan="7" style="text-align: center; color: var(--error);">Error al cargar tours</td></tr>';
      }
    }

    async function loadBookings() {
      const tbody = document.getElementById('bookingsTableBody');
      const loaderId = loadingManager.showInline(tbody, 'Cargando reservas...');
      
      try {
        const bookings = await api.getAdminBookings();
        loadingManager.hideInline(tbody);
        
        if (!bookings || bookings.length === 0) {
          tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--text-muted);">No hay reservas disponibles</td></tr>';
          return;
        }

        tbody.innerHTML = bookings.map(booking => `
          <tr>
            <td>${booking.tourName || 'N/A'}</td>
            <td>${booking.userName || 'N/A'}</td>
            <td>${booking.userEmail || 'N/A'}</td>
            <td>${booking.numberOfParticipants}</td>
            <td>${formatPrice(booking.totalAmount)}</td>
            <td>
              <span class="badge ${booking.status === 'Confirmed' ? 'active' : 'inactive'}">
                ${booking.status}
              </span>
            </td>
            <td>${new Date(booking.createdAt).toLocaleDateString('es-PA')}</td>
          </tr>
        `).join('');
      } catch (error) {
        console.error('Error loading bookings:', error);
        document.getElementById('bookingsTableBody').innerHTML = 
          '<tr><td colspan="7" style="text-align: center; color: var(--error);">Error al cargar reservas</td></tr>';
      }
    }

    async function loadStats() {
      try {
        const stats = await api.request('/api/admin/stats');
        const content = document.getElementById('statsContent');
        
        content.innerHTML = `
          <div class="stats-grid">
            <div class="stat-card">
              <h3>${stats.totalTours}</h3>
              <p>Tours Totales</p>
            </div>
            <div class="stat-card">
              <h3>${stats.activeTours}</h3>
              <p>Tours Activos</p>
            </div>
            <div class="stat-card">
              <h3>${stats.totalBookings}</h3>
              <p>Reservas Totales</p>
            </div>
            <div class="stat-card">
              <h3>${formatPrice(stats.totalRevenue)}</h3>
              <p>Ingresos Totales</p>
            </div>
            <div class="stat-card">
              <h3>${stats.totalUsers}</h3>
              <p>Usuarios</p>
            </div>
          </div>
        `;
      } catch (error) {
        console.error('Error loading stats:', error);
        document.getElementById('statsContent').innerHTML = 
          '<p style="color: var(--error);">Error al cargar estad√≠sticas</p>';
      }
    }

    function showAddTourModal() {
      currentTourId = null;
      document.getElementById('modalTitle').textContent = 'Nuevo Tour';
      document.getElementById('tourForm').reset();
      
      // Limpiar im√°genes
      uploadedImages = [];
      const imagesContainer = document.getElementById('imagesContainer');
      imagesContainer.innerHTML = `
        <div class="image-input-group">
          <div class="input-with-icon">
            <span class="input-icon">üñºÔ∏è</span>
            <input type="url" class="image-url-input form-input" placeholder="https://ejemplo.com/imagen.jpg" />
          </div>
          <button type="button" class="btn-icon btn-danger" onclick="removeImage(this)" title="Eliminar imagen">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="3 6 5 6 21 6"></polyline>
              <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
            </svg>
          </button>
        </div>
      `;
      document.getElementById('imagesPreview').innerHTML = '';
      document.getElementById('urlInputsContainer').style.display = 'none';
      document.getElementById('toggleUrlText').textContent = 'O usar URLs de im√°genes';
      
      // Agregar event listeners a los inputs de im√°genes
      setupImageInputs();
      updateImageLimitInfo();
      
      // Limpiar errores
      document.querySelectorAll('.field-error').forEach(el => el.remove());
      document.querySelectorAll('.input-error').forEach(el => el.classList.remove('input-error'));
      
      document.getElementById('tourModal').classList.add('active');
      
      // Inicializar TinyMCE despu√©s de abrir el modal
      setTimeout(() => {
        if (typeof tinymce !== 'undefined') {
          tinymce.init({
            selector: '#tourDescription, #tourItinerary',
            height: 400,
            menubar: false,
            plugins: [
              'advlist', 'autolink', 'lists', 'link', 'image', 'charmap', 'preview',
              'anchor', 'searchreplace', 'visualblocks', 'code', 'fullscreen',
              'insertdatetime', 'media', 'table', 'code', 'help', 'wordcount'
            ],
            toolbar: 'undo redo | blocks | ' +
              'bold italic forecolor | alignleft aligncenter ' +
              'alignright alignjustify | bullist numlist outdent indent | ' +
              'removeformat | help | link image',
            content_style: 'body { font-family: Inter, sans-serif; font-size: 14px; }',
            language: 'es',
            branding: false,
            promotion: false
          });
        }
      }, 100);
    }
    
    function setupImageInputs() {
      document.querySelectorAll('.image-url-input').forEach(input => {
        input.addEventListener('input', updateImagesPreview);
        input.addEventListener('blur', validateImageUrl);
      });
    }
    
    function addImageInput() {
      const container = document.getElementById('imagesContainer');
      const imageCount = container.querySelectorAll('.image-input-group').length;
      const addImageBtn = document.getElementById('addImageBtn');
      const imageLimitInfo = document.getElementById('imageLimitInfo');
      
      if (imageCount >= 5) {
        return; // No hacer nada si ya hay 5 im√°genes
      }
      
      const newInput = document.createElement('div');
      newInput.className = 'image-input-group';
      newInput.innerHTML = `
        <div class="input-with-icon">
          <span class="input-icon">üñºÔ∏è</span>
          <input type="url" class="image-url-input form-input" placeholder="https://ejemplo.com/imagen.jpg" />
        </div>
        <button type="button" class="btn-icon btn-danger" onclick="removeImage(this)" title="Eliminar imagen">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="3 6 5 6 21 6"></polyline>
            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
          </svg>
        </button>
      `;
      container.appendChild(newInput);
      
      setupImageInputs();
      updateImageLimitInfo();
    }
    
    function updateImageLimitInfo() {
      const allImages = getAllImageUrls();
      const imageCount = allImages.length;
      const addImageBtn = document.getElementById('addImageBtn');
      const addImageText = document.getElementById('addImageText');
      const imageLimitInfo = document.getElementById('imageLimitInfo');
      const dropZone = document.getElementById('dropZone');
      
      // Actualizar bot√≥n
      if (imageCount >= 5) {
        if (addImageBtn) {
          addImageBtn.disabled = true;
          addImageText.textContent = 'M√°ximo 5 im√°genes alcanzado';
        }
        dropZone.style.pointerEvents = 'none';
        dropZone.style.opacity = '0.5';
        imageLimitInfo.className = 'image-limit-info max';
        imageLimitInfo.innerHTML = `
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="16" x2="12" y2="12"></line>
            <line x1="12" y1="8" x2="12.01" y2="8"></line>
          </svg>
          <span>Has alcanzado el l√≠mite de 5 im√°genes</span>
        `;
      } else {
        if (addImageBtn) {
          addImageBtn.disabled = false;
          addImageText.textContent = `+ Agregar URL (${imageCount}/5)`;
        }
        dropZone.style.pointerEvents = 'auto';
        dropZone.style.opacity = '1';
        if (imageCount >= 3) {
          imageLimitInfo.className = 'image-limit-info warning';
          imageLimitInfo.innerHTML = `
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="12" y1="16" x2="12" y2="12"></line>
              <line x1="12" y1="8" x2="12.01" y2="8"></line>
            </svg>
            <span>Puedes agregar ${5 - imageCount} imagen${5 - imageCount > 1 ? 'es' : ''} m√°s</span>
          `;
        } else {
          imageLimitInfo.className = 'image-limit-info';
          imageLimitInfo.innerHTML = `
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="12" y1="16" x2="12" y2="12"></line>
              <line x1="12" y1="8" x2="12.01" y2="8"></line>
            </svg>
            <span>La primera imagen ser√° la imagen principal. M√°ximo 5 im√°genes. (${imageCount}/5)</span>
          `;
        }
      }
    }
    
    function removeImage(button) {
      const container = document.getElementById('imagesContainer');
      if (container.querySelectorAll('.image-input-group').length <= 1) {
        alert('Debe haber al menos una imagen');
        return;
      }
      button.closest('.image-input-group').remove();
      updateImagesPreview();
      updateImageLimitInfo();
    }
    
    function validateImageUrl(event) {
      const input = event.target;
      const url = input.value.trim();
      
      if (!url) {
        input.classList.remove('input-error');
        return;
      }
      
      try {
        new URL(url);
        input.classList.remove('input-error');
      } catch {
        input.classList.add('input-error');
      }
    }
    
    function updateImagesPreview() {
      const preview = document.getElementById('imagesPreview');
      const allImages = getAllImageUrls();
      preview.innerHTML = '';
      
      allImages.forEach((url, index) => {
        const previewItem = document.createElement('div');
        previewItem.className = 'image-preview-item';
        previewItem.innerHTML = `
          ${index === 0 ? '<span class="primary-badge">Principal</span>' : ''}
          <img src="${url}" alt="Preview" onerror="this.parentElement.classList.add('error')" />
          <button type="button" class="preview-remove-btn" onclick="removePreviewImage(${index})" title="Eliminar">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
        `;
        preview.appendChild(previewItem);
      });
    }

    function removePreviewImage(index) {
      const allImages = getAllImageUrls();
      if (index < uploadedImages.length) {
        // Es una imagen subida
        uploadedImages.splice(index, 1);
      } else {
        // Es una URL
        const urlIndex = index - uploadedImages.length;
        const urlInputs = Array.from(document.querySelectorAll('.image-url-input'));
        const filledInputs = urlInputs.filter(input => input.value.trim().length > 0);
        if (filledInputs[urlIndex]) {
          filledInputs[urlIndex].value = '';
        }
      }
      updateImagesPreview();
      updateImageLimitInfo();
    }

    async function editTour(id) {
      try {
        const tour = await api.request(`/api/admin/tours/${id}`);
        currentTourId = id;
        
        document.getElementById('modalTitle').textContent = 'Editar Tour';
        document.getElementById('tourName').value = tour.name || '';
        document.getElementById('tourDescription').value = tour.description || '';
        document.getElementById('tourItinerary').value = tour.itinerary || '';
        document.getElementById('tourPrice').value = tour.price || '';
        document.getElementById('tourMaxCapacity').value = tour.maxCapacity || '';
        document.getElementById('tourDurationHours').value = tour.durationHours || '';
        document.getElementById('tourLocation').value = tour.location || '';
        document.getElementById('tourIsActive').value = tour.isActive ? 'true' : 'false';
        
        // Cargar im√°genes
        const imagesContainer = document.getElementById('imagesContainer');
        imagesContainer.innerHTML = '';
        
        if (tour.images && tour.images.length > 0) {
          tour.images.forEach((url, index) => {
            const imageGroup = document.createElement('div');
            imageGroup.className = 'image-input-group';
            imageGroup.innerHTML = `
              <div class="input-with-icon">
                <span class="input-icon">üñºÔ∏è</span>
                <input type="url" class="image-url-input form-input" value="${url}" placeholder="https://ejemplo.com/imagen.jpg" />
              </div>
              <button type="button" class="btn-icon btn-danger" onclick="removeImage(this)" title="Eliminar imagen">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="3 6 5 6 21 6"></polyline>
                  <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                </svg>
              </button>
            `;
            imagesContainer.appendChild(imageGroup);
          });
        } else {
          // Al menos un input vac√≠o
          const imageGroup = document.createElement('div');
          imageGroup.className = 'image-input-group';
          imageGroup.innerHTML = `
            <div class="input-with-icon">
              <span class="input-icon">üñºÔ∏è</span>
              <input type="url" class="image-url-input form-input" placeholder="https://ejemplo.com/imagen.jpg" />
            </div>
            <button type="button" class="btn-icon btn-danger" onclick="removeImage(this)" title="Eliminar imagen">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="3 6 5 6 21 6"></polyline>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
              </svg>
            </button>
          `;
          imagesContainer.appendChild(imageGroup);
        }
        
        setupImageInputs();
        updateImagesPreview();
        updateImageLimitInfo();
        
        // Limpiar errores
        document.querySelectorAll('.field-error').forEach(el => el.remove());
        document.querySelectorAll('.input-error').forEach(el => el.classList.remove('input-error'));
        
        document.getElementById('tourModal').classList.add('active');
        
        // Inicializar TinyMCE despu√©s de abrir el modal y cargar datos
        setTimeout(() => {
          if (typeof tinymce !== 'undefined') {
            // Remover instancias existentes
            tinymce.remove('#tourDescription, #tourItinerary');
            // Inicializar nuevas instancias
            tinymce.init({
              selector: '#tourDescription, #tourItinerary',
              height: 400,
              menubar: false,
              plugins: [
                'advlist', 'autolink', 'lists', 'link', 'image', 'charmap', 'preview',
                'anchor', 'searchreplace', 'visualblocks', 'code', 'fullscreen',
                'insertdatetime', 'media', 'table', 'code', 'help', 'wordcount'
              ],
              toolbar: 'undo redo | blocks | ' +
                'bold italic forecolor | alignleft aligncenter ' +
                'alignright alignjustify | bullist numlist outdent indent | ' +
                'removeformat | help | link image',
              content_style: 'body { font-family: Inter, sans-serif; font-size: 14px; }',
              language: 'es',
              branding: false,
              promotion: false
            });
            // Establecer contenido despu√©s de inicializar
            if (tinymce.get('tourDescription')) {
              tinymce.get('tourDescription').setContent(tour.description || '');
            }
            if (tinymce.get('tourItinerary')) {
              tinymce.get('tourItinerary').setContent(tour.itinerary || '');
            }
          }
        }, 200);
      } catch (error) {
        console.error('Error loading tour:', error);
        alert('Error al cargar el tour: ' + (error.message || 'Error desconocido'));
      }
    }

    function closeTourModal() {
      // Remover instancias de TinyMCE al cerrar
      if (typeof tinymce !== 'undefined') {
        tinymce.remove('#tourDescription, #tourItinerary');
      }
      document.getElementById('tourModal').classList.remove('active');
      currentTourId = null;
    }

    function validateTourForm() {
      let isValid = true;
      const errors = [];
      
      // Limpiar errores previos
      document.querySelectorAll('.field-error').forEach(el => el.remove());
      document.querySelectorAll('.input-error').forEach(el => el.classList.remove('input-error'));
      
      // Validar nombre
      const name = document.getElementById('tourName').value.trim();
      if (!name) {
        showFieldError('tourName', 'El nombre del tour es requerido');
        isValid = false;
      } else if (name.length > 200) {
        showFieldError('tourName', 'El nombre no puede exceder 200 caracteres');
        isValid = false;
      }
      
      // Validar descripci√≥n
      const description = document.getElementById('tourDescription').value.trim();
      if (!description) {
        showFieldError('tourDescription', 'La descripci√≥n es requerida');
        isValid = false;
      } else if (description.length < 50) {
        showFieldError('tourDescription', 'La descripci√≥n debe tener al menos 50 caracteres');
        isValid = false;
      } else if (description.length > 2000) {
        showFieldError('tourDescription', 'La descripci√≥n no puede exceder 2000 caracteres');
        isValid = false;
      }
      
      // Validar precio
      const price = parseFloat(document.getElementById('tourPrice').value);
      if (isNaN(price) || price <= 0) {
        showFieldError('tourPrice', 'El precio debe ser mayor a 0');
        isValid = false;
      } else if (price > 10000) {
        showFieldError('tourPrice', 'El precio no puede exceder $10,000');
        isValid = false;
      }
      
      // Validar capacidad
      const maxCapacity = parseInt(document.getElementById('tourMaxCapacity').value);
      if (isNaN(maxCapacity) || maxCapacity <= 0) {
        showFieldError('tourMaxCapacity', 'La capacidad m√°xima debe ser mayor a 0');
        isValid = false;
      } else if (maxCapacity > 100) {
        showFieldError('tourMaxCapacity', 'La capacidad m√°xima no puede exceder 100 personas');
        isValid = false;
      }
      
      // Validar duraci√≥n
      const durationHours = parseInt(document.getElementById('tourDurationHours').value);
      if (isNaN(durationHours) || durationHours <= 0) {
        showFieldError('tourDurationHours', 'La duraci√≥n debe ser mayor a 0 horas');
        isValid = false;
      } else if (durationHours > 48) {
        showFieldError('tourDurationHours', 'La duraci√≥n no puede exceder 48 horas');
        isValid = false;
      }
      
      // Validar im√°genes
      const imageInputs = document.querySelectorAll('.image-url-input');
      const images = Array.from(imageInputs)
        .map(input => input.value.trim())
        .filter(url => url.length > 0);
      
      if (images.length > 5) {
        alert('No se pueden agregar m√°s de 5 im√°genes');
        isValid = false;
      }
      
      // Validar URLs de im√°genes
      images.forEach((url, index) => {
        try {
          new URL(url);
        } catch {
          const input = imageInputs[index];
          input.classList.add('input-error');
          isValid = false;
        }
      });
      
      if (!isValid && errors.length > 0) {
        alert('Por favor corrige los siguientes errores:\n\n' + errors.join('\n'));
      }
      
      return isValid;
    }
    
    function showFieldError(fieldId, message) {
      const field = document.getElementById(fieldId);
      field.classList.add('input-error');
      const errorDiv = document.createElement('span');
      errorDiv.className = 'field-error';
      errorDiv.textContent = message;
      field.parentElement.appendChild(errorDiv);
    }

    async function saveTour(event) {
      event.preventDefault();
      
      if (!validateTourForm()) {
        return;
      }
      
      const submitButton = event.target.querySelector('button[type="submit"]') || 
                          document.querySelector('button[form="tourForm"][type="submit"]');
      const form = document.getElementById('tourForm');
      
      // Mostrar estado de carga
      if (submitButton) {
        submitButton.classList.add('btn-loading');
        submitButton.disabled = true;
      }
      if (form) {
        form.classList.add('form-loading');
      }
      
      // Obtener todas las im√°genes (subidas + URLs)
      const images = getAllImageUrls();

      const tourData = {
        name: document.getElementById('tourName').value.trim(),
        description: (typeof tinymce !== 'undefined' && tinymce.get('tourDescription')) 
          ? tinymce.get('tourDescription').getContent() 
          : document.getElementById('tourDescription').value.trim(),
        itinerary: (typeof tinymce !== 'undefined' && tinymce.get('tourItinerary')) 
          ? tinymce.get('tourItinerary').getContent() 
          : document.getElementById('tourItinerary').value.trim() || null,
        price: parseFloat(document.getElementById('tourPrice').value),
        maxCapacity: parseInt(document.getElementById('tourMaxCapacity').value),
        durationHours: parseInt(document.getElementById('tourDurationHours').value),
        location: document.getElementById('tourLocation').value.trim() || null,
        isActive: document.getElementById('tourIsActive').value === 'true',
        images: images.length > 0 ? images : null
      };

      const submitButton = event.target.querySelector('button[type="submit"]') || document.querySelector('button[form="tourForm"][type="submit"]');
      const loaderId = submitButton ? loadingManager.showInButton(submitButton, currentTourId ? 'Guardando cambios...' : 'Creando tour...') : null;

      try {
        if (currentTourId) {
          await api.updateTour(currentTourId, tourData);
          if (submitButton && loaderId) loadingManager.hideInButton(submitButton);
          alert('‚úÖ Tour actualizado exitosamente');
        } else {
          await api.createTour(tourData);
          if (submitButton && loaderId) loadingManager.hideInButton(submitButton);
          alert('‚úÖ Tour creado exitosamente');
        }
        
        closeTourModal();
        loadTours();
      } catch (error) {
        if (submitButton && loaderId) loadingManager.hideInButton(submitButton);
        console.error('Error saving tour:', error);
        alert('‚ùå Error al guardar el tour: ' + (error.message || 'Error desconocido'));
      } finally {
        // Remover estado de carga
        if (submitButton) {
          submitButton.classList.remove('btn-loading');
          submitButton.disabled = false;
        }
        if (form) {
          form.classList.remove('form-loading');
        }
      }
    }

    async function deleteTour(id) {
      if (!confirm('¬øEst√°s seguro de que deseas eliminar este tour?')) {
        return;
      }

      try {
        await api.deleteTour(id);
        alert('Tour eliminado exitosamente');
        loadTours();
      } catch (error) {
        console.error('Error deleting tour:', error);
        alert('Error al eliminar el tour: ' + (error.message || 'Error desconocido'));
      }
    }

    async function loadHomePageContent() {
      try {
        const content = await api.request('/api/admin/homepage-content');
        
        document.getElementById('heroTitle').value = content.heroTitle || '';
        document.getElementById('heroSubtitle').value = content.heroSubtitle || '';
        document.getElementById('heroSearchPlaceholder').value = content.heroSearchPlaceholder || '';
        document.getElementById('heroSearchButton').value = content.heroSearchButton || '';
        document.getElementById('toursSectionTitle').value = content.toursSectionTitle || '';
        document.getElementById('toursSectionSubtitle').value = content.toursSectionSubtitle || '';
        document.getElementById('loadingToursText').value = content.loadingToursText || '';
        document.getElementById('errorLoadingToursText').value = content.errorLoadingToursText || '';
        document.getElementById('noToursFoundText').value = content.noToursFoundText || '';
        document.getElementById('footerBrandText').value = content.footerBrandText || '';
        document.getElementById('footerDescription').value = content.footerDescription || '';
        document.getElementById('footerCopyright').value = content.footerCopyright || '';
        document.getElementById('navBrandText').value = content.navBrandText || '';
        document.getElementById('navToursLink').value = content.navToursLink || '';
        document.getElementById('navBookingsLink').value = content.navBookingsLink || '';
        document.getElementById('navLoginLink').value = content.navLoginLink || '';
        document.getElementById('navLogoutButton').value = content.navLogoutButton || '';
        document.getElementById('pageTitle').value = content.pageTitle || '';
        document.getElementById('metaDescription').value = content.metaDescription || '';
      } catch (error) {
        console.error('Error loading homepage content:', error);
        alert('Error al cargar el contenido: ' + (error.message || 'Error desconocido'));
      }
    }

    async function saveHomePageContent(event) {
      event.preventDefault();
      
      const contentData = {
        heroTitle: document.getElementById('heroTitle').value.trim(),
        heroSubtitle: document.getElementById('heroSubtitle').value.trim(),
        heroSearchPlaceholder: document.getElementById('heroSearchPlaceholder').value.trim(),
        heroSearchButton: document.getElementById('heroSearchButton').value.trim(),
        toursSectionTitle: document.getElementById('toursSectionTitle').value.trim(),
        toursSectionSubtitle: document.getElementById('toursSectionSubtitle').value.trim(),
        loadingToursText: document.getElementById('loadingToursText').value.trim(),
        errorLoadingToursText: document.getElementById('errorLoadingToursText').value.trim(),
        noToursFoundText: document.getElementById('noToursFoundText').value.trim(),
        footerBrandText: document.getElementById('footerBrandText').value.trim(),
        footerDescription: document.getElementById('footerDescription').value.trim(),
        footerCopyright: document.getElementById('footerCopyright').value.trim(),
        navBrandText: document.getElementById('navBrandText').value.trim(),
        navToursLink: document.getElementById('navToursLink').value.trim(),
        navBookingsLink: document.getElementById('navBookingsLink').value.trim(),
        navLoginLink: document.getElementById('navLoginLink').value.trim(),
        navLogoutButton: document.getElementById('navLogoutButton').value.trim(),
        pageTitle: document.getElementById('pageTitle').value.trim(),
        metaDescription: document.getElementById('metaDescription').value.trim()
      };

      try {
        await api.request('/api/admin/homepage-content', {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(contentData)
        });
        
        if (submitButton && loaderId) loadingManager.hideInButton(submitButton);
        alert('Contenido guardado exitosamente');
      } catch (error) {
        if (submitButton && loaderId) loadingManager.hideInButton(submitButton);
        console.error('Error saving homepage content:', error);
        alert('Error al guardar el contenido: ' + (error.message || 'Error desconocido'));
      }
    }

    // Drag and Drop Functions
    let uploadedImages = [];

    function initDragAndDrop() {
      const dropZone = document.getElementById('dropZone');
      const fileInput = document.getElementById('fileInput');

      // Drag and Drop events
      dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('drag-over');
      });

      dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('drag-over');
      });

      dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('drag-over');
        const files = Array.from(e.dataTransfer.files).filter(file => file.type.startsWith('image/'));
        handleFiles(files);
      });

      // Click en drop zone
      dropZone.addEventListener('click', () => {
        fileInput.click();
      });

      // File input change
      fileInput.addEventListener('change', (e) => {
        const files = Array.from(e.target.files).filter(file => file.type.startsWith('image/'));
        handleFiles(files);
        e.target.value = ''; // Reset input
      });
    }

    async function handleFiles(files) {
      console.log('üìÅ Archivos recibidos:', files.length);
      
      const currentCount = uploadedImages.length + document.querySelectorAll('.image-url-input').length;
      const remainingSlots = 5 - currentCount;

      console.log('üìä Estado actual:', {
        uploadedImages: uploadedImages.length,
        urlInputs: document.querySelectorAll('.image-url-input').length,
        currentCount: currentCount,
        remainingSlots: remainingSlots
      });

      if (files.length === 0) {
        console.warn('‚ö†Ô∏è No se recibieron archivos');
        alert('Por favor selecciona archivos de imagen v√°lidos');
        return;
      }

      if (files.length > remainingSlots) {
        console.warn('‚ö†Ô∏è Demasiados archivos:', files.length, 'slots disponibles:', remainingSlots);
        alert(`Solo puedes agregar ${remainingSlots} imagen${remainingSlots > 1 ? 'es' : ''} m√°s. M√°ximo 5 im√°genes.`);
        files = files.slice(0, remainingSlots);
      }

      for (const file of files) {
        if (uploadedImages.length >= 5) {
          console.warn('‚ö†Ô∏è L√≠mite de im√°genes alcanzado');
          break;
        }

        // Validar tama√±o (5MB)
        if (file.size > 5 * 1024 * 1024) {
          console.warn('‚ö†Ô∏è Archivo demasiado grande:', file.name, file.size);
          alert(`El archivo "${file.name}" es demasiado grande. Tama√±o m√°ximo: 5MB`);
          continue;
        }

        try {
          await uploadImage(file);
        } catch (error) {
          console.error('‚ùå Error en handleFiles:', error);
          // Continuar con el siguiente archivo
        }
      }
    }

    async function uploadImage(file) {
      console.log('üì§ Iniciando subida de imagen:', {
        name: file.name,
        size: file.size,
        type: file.type
      });

      const formData = new FormData();
      formData.append('file', file);

      try {
        const token = localStorage.getItem('authToken');
        console.log('üîë Token disponible:', !!token);

        const url = '/api/admin/upload-image';
        console.log('üåê URL de subida:', url);

        const response = await fetch(url, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`
            // NO incluir Content-Type para FormData, el navegador lo hace autom√°ticamente
          },
          body: formData
        });

        console.log('üì• Response recibido:', {
          status: response.status,
          statusText: response.statusText,
          ok: response.ok,
          headers: Object.fromEntries(response.headers.entries())
        });

        if (!response.ok) {
          let errorMessage = `Error ${response.status}: ${response.statusText}`;
          
          try {
            const contentType = response.headers.get('content-type');
            console.log('üìÑ Content-Type del error:', contentType);
            
            if (contentType && contentType.includes('application/json')) {
              const error = await response.json();
              console.error('‚ùå Error JSON:', error);
              errorMessage = error.message || error.detail || errorMessage;
            } else {
              const text = await response.text();
              console.error('‚ùå Error texto:', text);
              errorMessage = text || errorMessage;
            }
          } catch (parseError) {
            console.error('‚ùå Error al parsear respuesta de error:', parseError);
          }
          
          throw new Error(errorMessage);
        }

        const contentType = response.headers.get('content-type');
        console.log('üìÑ Content-Type de respuesta:', contentType);

        if (!contentType || !contentType.includes('application/json')) {
          const text = await response.text();
          console.warn('‚ö†Ô∏è Respuesta no es JSON:', text);
          throw new Error('Respuesta del servidor no es JSON v√°lido');
        }

        const result = await response.json();
        console.log('‚úÖ Imagen subida exitosamente:', result);

        uploadedImages.push(result.url);
        updateImagesPreview();
        updateImageLimitInfo();
      } catch (error) {
        console.error('‚ùå Error completo al subir imagen:', {
          message: error.message,
          stack: error.stack,
          name: error.name
        });
        alert('Error al subir la imagen: ' + error.message);
      }
    }

    function toggleUrlInputs() {
      const container = document.getElementById('urlInputsContainer');
      const toggleText = document.getElementById('toggleUrlText');
      
      if (container.style.display === 'none') {
        container.style.display = 'block';
        toggleText.textContent = 'Ocultar URLs';
      } else {
        container.style.display = 'none';
        toggleText.textContent = 'O usar URLs de im√°genes';
      }
    }

    function getAllImageUrls() {
      const urlInputs = Array.from(document.querySelectorAll('.image-url-input'))
        .map(input => input.value.trim())
        .filter(url => url.length > 0);
      
      return [...uploadedImages, ...urlInputs].slice(0, 5);
    }

    // Inicializar TinyMCE para campos de texto enriquecido
    function initTinyMCE() {
      if (typeof tinymce !== 'undefined') {
        tinymce.init({
          selector: '#tourDescription, #tourItinerary',
          height: 400,
          menubar: false,
          plugins: [
            'advlist', 'autolink', 'lists', 'link', 'image', 'charmap', 'preview',
            'anchor', 'searchreplace', 'visualblocks', 'code', 'fullscreen',
            'insertdatetime', 'media', 'table', 'code', 'help', 'wordcount'
          ],
          toolbar: 'undo redo | blocks | ' +
            'bold italic forecolor | alignleft aligncenter ' +
            'alignright alignjustify | bullist numlist outdent indent | ' +
            'removeformat | help | link image',
          content_style: 'body { font-family: Inter, sans-serif; font-size: 14px; }',
          language: 'es',
          branding: false,
          promotion: false,
          setup: function(editor) {
            editor.on('change', function() {
              editor.save();
            });
          }
        });
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      initTinyMCE();
      if (checkAdminAuth()) {
        loadTours();
        loadStats();
      }
      
      // Inicializar drag and drop
      initDragAndDrop();
      
      // Inicializar inputs de im√°genes
      setupImageInputs();
    });

    if (document.getElementById('logoutBtn')) {
      document.getElementById('logoutBtn').addEventListener('click', async () => {
        await api.logout();
        window.location.href = '/';
      });
    }

    // Cerrar modal al hacer click fuera
    document.getElementById('tourModal').addEventListener('click', (e) => {
      if (e.target.id === 'tourModal') {
        closeTourModal();
      }
    });

    // ============================================
    // MEDIA LIBRARY FUNCTIONS
    // ============================================
    let currentMediaPage = 1;
    const mediaPageSize = 20;

    async function loadMediaFiles() {
      try {
        const category = document.getElementById('mediaCategoryFilter')?.value || '';
        const isImage = document.getElementById('mediaTypeFilter')?.value || '';
        
        const params = new URLSearchParams({
          page: currentMediaPage.toString(),
          pageSize: mediaPageSize.toString()
        });
        if (category) params.append('category', category);
        if (isImage) params.append('isImage', isImage);

        const mediaFiles = await api.request(`/api/admin/media?${params}`);
        
        // Actualizar lista de categor√≠as disponibles en el filtro
        updateMediaCategories(mediaFiles);
        
        renderMediaFiles(mediaFiles);
      } catch (error) {
        console.error('Error loading media files:', error);
        const grid = document.getElementById('mediaFilesGrid');
        if (grid) {
          grid.innerHTML = '<p style="color: var(--error); grid-column: 1 / -1;">Error al cargar archivos</p>';
        }
      }
    }

    function updateMediaCategories(mediaFiles) {
      // Extraer categor√≠as √∫nicas de los archivos
      const categories = new Set();
      if (mediaFiles && Array.isArray(mediaFiles)) {
        mediaFiles.forEach(file => {
          if (file.category) {
            categories.add(file.category);
          }
        });
      }
      
      // Agregar categor√≠as din√°micas al filtro (manteniendo las predefinidas)
      const filterSelect = document.getElementById('mediaCategoryFilter');
      if (filterSelect) {
        const existingOptions = Array.from(filterSelect.options).map(opt => opt.value);
        categories.forEach(cat => {
          if (!existingOptions.includes(cat)) {
            const option = document.createElement('option');
            option.value = cat;
            option.textContent = cat;
            filterSelect.appendChild(option);
          }
        });
      }
    }

    function renderMediaFiles(mediaFiles) {
      const grid = document.getElementById('mediaFilesGrid');
      if (!grid) return;
      
      if (!mediaFiles || mediaFiles.length === 0) {
        grid.innerHTML = '<p style="color: var(--text-muted); grid-column: 1 / -1;">No hay archivos</p>';
        return;
      }

      grid.innerHTML = mediaFiles.map(file => `
        <div class="media-item" style="border: 1px solid var(--border); border-radius: var(--radius); padding: var(--spacing-md); transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'" onmouseout="this.style.transform=''; this.style.boxShadow=''">
          ${file.isImage ? `
            <img src="${file.fileUrl}" alt="${file.altText || ''}" style="width: 100%; height: 150px; object-fit: cover; border-radius: var(--radius); margin-bottom: var(--spacing-sm); cursor: pointer;" onclick="selectMediaFile('${file.fileUrl}', ${file.isImage})" />
          ` : `
            <div style="width: 100%; height: 150px; background: var(--bg-secondary); display: flex; align-items: center; justify-content: center; border-radius: var(--radius); margin-bottom: var(--spacing-sm); cursor: pointer;" onclick="selectMediaFile('${file.fileUrl}', ${file.isImage})">
              <span style="font-size: 48px;">üìÑ</span>
            </div>
          `}
          <div style="font-size: 12px; color: var(--text-muted); margin-bottom: var(--spacing-xs); font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${file.fileName}">${file.fileName}</div>
          ${file.category ? `<div style="font-size: 10px; color: var(--primary); background: var(--bg-secondary); padding: 2px 6px; border-radius: 4px; display: inline-block; margin-bottom: var(--spacing-xs);">${file.category}</div>` : ''}
          <div style="font-size: 11px; color: var(--text-muted); margin-bottom: var(--spacing-xs);">${formatFileSize(file.fileSize)}</div>
          <div style="margin-top: var(--spacing-sm); display: flex; gap: var(--spacing-xs);">
            <button class="btn-secondary" style="flex: 1; font-size: 12px; padding: 4px 8px;" onclick="selectMediaFile('${file.fileUrl}', ${file.isImage})" title="Insertar en editor">Usar</button>
            <button class="btn-danger" style="font-size: 12px; padding: 4px 8px;" onclick="deleteMediaFile('${file.id}')" title="Eliminar">√ó</button>
          </div>
        </div>
      `).join('');
    }

    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }

    function showUploadMediaModal() {
      const modal = document.getElementById('uploadMediaModal');
      if (modal) {
        modal.classList.add('active');
        const form = document.getElementById('uploadMediaForm');
        if (form) form.reset();
      }
    }

    function closeUploadMediaModal() {
      const modal = document.getElementById('uploadMediaModal');
      if (modal) modal.classList.remove('active');
    }

    async function uploadMediaFile(event) {
      event.preventDefault();
      const fileInput = document.getElementById('mediaFileInput');
      const file = fileInput?.files[0];

      if (!file) {
        alert('Por favor selecciona un archivo');
        return;
      }

      const formData = new FormData();
      formData.append('file', file);
      formData.append('altText', document.getElementById('mediaAltText')?.value || '');
      formData.append('description', document.getElementById('mediaDescription')?.value || '');
      formData.append('category', document.getElementById('mediaCategory')?.value || '');

      try {
        const token = localStorage.getItem('authToken');
        const response = await fetch('/api/admin/media', {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}` },
          body: formData
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.message || 'Error al subir archivo');
        }

        closeUploadMediaModal();
        loadMediaFiles();
        alert('Archivo subido exitosamente');
      } catch (error) {
        console.error('Error uploading media:', error);
        alert('Error al subir archivo: ' + error.message);
      }
    }

    function selectMediaFile(url, isImage) {
      if (typeof tinymce !== 'undefined') {
        const editor = tinymce.activeEditor;
        if (editor && isImage) {
          editor.insertContent(`<img src="${url}" alt="" />`);
          alert('Imagen insertada en el editor');
        } else {
          navigator.clipboard.writeText(url);
          alert('URL copiada al portapapeles');
        }
      } else {
        navigator.clipboard.writeText(url);
        alert('URL copiada');
      }
    }

    async function deleteMediaFile(id) {
      if (!confirm('¬øEst√°s seguro de eliminar este archivo?')) return;
      try {
        await api.request(`/api/admin/media/${id}`, { method: 'DELETE' });
        loadMediaFiles();
        alert('Archivo eliminado');
      } catch (error) {
        console.error('Error deleting media:', error);
        alert('Error al eliminar archivo');
      }
    }

    // ============================================
    // PAGES FUNCTIONS
    // ============================================
    let currentPageId = null;

    async function loadPages() {
      try {
        const isPublished = document.getElementById('pagesStatusFilter')?.value || '';
        const params = new URLSearchParams();
        if (isPublished) params.append('isPublished', isPublished);

        const pages = await api.request(`/api/admin/pages?${params}`);
        renderPages(pages);
      } catch (error) {
        console.error('Error loading pages:', error);
        const tbody = document.getElementById('pagesTableBody');
        if (tbody) {
          tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--error);">Error al cargar p√°ginas</td></tr>';
        }
      }
    }

    function renderPages(pages) {
      const tbody = document.getElementById('pagesTableBody');
      if (!tbody) return;
      
      if (!pages || pages.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--text-muted);">No hay p√°ginas. Crea tu primera p√°gina usando el bot√≥n "Nueva P√°gina".</td></tr>';
        return;
      }

      tbody.innerHTML = pages.map(page => `
        <tr>
          <td><strong>${page.title}</strong>${page.template ? `<br><small style="color: var(--text-muted); font-size: 11px;">Template: ${page.template}</small>` : ''}</td>
          <td><code style="font-size: 12px; background: var(--bg-secondary); padding: 2px 6px; border-radius: 4px;">/${page.slug}</code></td>
          <td><span class="badge ${page.isPublished ? 'active' : 'inactive'}">${page.isPublished ? 'Publicada' : 'Borrador'}</span></td>
          <td>${page.displayOrder}</td>
          <td>${page.updatedAt ? new Date(page.updatedAt).toLocaleDateString('es-ES', { year: 'numeric', month: 'short', day: 'numeric' }) : '-'}</td>
          <td>
            <button class="btn-icon" onclick="editPage('${page.id}')" title="Editar">‚úèÔ∏è</button>
            ${page.isPublished ? `<a href="/${page.slug}" target="_blank" class="btn-icon" title="Ver p√°gina" style="text-decoration: none; display: inline-block;">üëÅÔ∏è</a>` : ''}
            <button class="btn-icon btn-danger" onclick="deletePage('${page.id}')" title="Eliminar">üóëÔ∏è</button>
          </td>
        </tr>
      `).join('');
    }

    function showAddPageModal() {
      currentPageId = null;
      const titleEl = document.getElementById('pageModalTitle');
      if (titleEl) titleEl.textContent = 'Nueva P√°gina';
      const form = document.getElementById('pageForm');
      if (form) form.reset();
      const modal = document.getElementById('pageModal');
      if (modal) modal.classList.add('active');
      
      setTimeout(() => {
        if (typeof tinymce !== 'undefined') {
          tinymce.init({
            selector: '#pageContent',
            height: 400,
            menubar: false,
            plugins: ['advlist', 'autolink', 'lists', 'link', 'image', 'charmap', 'preview', 'anchor', 'searchreplace', 'visualblocks', 'code', 'fullscreen', 'insertdatetime', 'media', 'table', 'code', 'help', 'wordcount'],
            toolbar: 'undo redo | blocks | bold italic forecolor | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | removeformat | help | link image',
            content_style: 'body { font-family: Inter, sans-serif; font-size: 14px; }',
            language: 'es',
            branding: false,
            promotion: false
          });
        }
      }, 100);
    }

    function closePageModal() {
      if (typeof tinymce !== 'undefined') {
        tinymce.remove('#pageContent');
      }
      const modal = document.getElementById('pageModal');
      if (modal) modal.classList.remove('active');
      currentPageId = null;
    }

    async function editPage(id) {
      try {
        const page = await api.request(`/api/admin/pages/${id}`);
        currentPageId = id;
        
        const titleEl = document.getElementById('pageModalTitle');
        if (titleEl) titleEl.textContent = 'Editar P√°gina';
        document.getElementById('pageTitle').value = page.title || '';
        document.getElementById('pageSlug').value = page.slug || '';
        document.getElementById('pageExcerpt').value = page.excerpt || '';
        document.getElementById('pageMetaTitle').value = page.metaTitle || '';
        document.getElementById('pageMetaDescription').value = page.metaDescription || '';
        document.getElementById('pageMetaKeywords').value = page.metaKeywords || '';
        document.getElementById('pageTemplate').value = page.template || '';
        document.getElementById('pageDisplayOrder').value = page.displayOrder || 0;
        document.getElementById('pageIsPublished').checked = page.isPublished || false;
        
        const modal = document.getElementById('pageModal');
        if (modal) modal.classList.add('active');
        
        setTimeout(() => {
          if (typeof tinymce !== 'undefined') {
            tinymce.remove('#pageContent');
            tinymce.init({
              selector: '#pageContent',
              height: 400,
              menubar: false,
              plugins: ['advlist', 'autolink', 'lists', 'link', 'image', 'charmap', 'preview', 'anchor', 'searchreplace', 'visualblocks', 'code', 'fullscreen', 'insertdatetime', 'media', 'table', 'code', 'help', 'wordcount'],
              toolbar: 'undo redo | blocks | bold italic forecolor | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | removeformat | help | link image',
              content_style: 'body { font-family: Inter, sans-serif; font-size: 14px; }',
              language: 'es',
              branding: false,
              promotion: false
            });
            setTimeout(() => {
              const editor = tinymce.get('pageContent');
              if (editor) editor.setContent(page.content || '');
            }, 200);
          }
        }, 100);
      } catch (error) {
        console.error('Error loading page:', error);
        alert('Error al cargar la p√°gina');
      }
    }

    async function savePage(event) {
      event.preventDefault();
      
      // Validaciones
      const title = document.getElementById('pageTitle').value.trim();
      const slug = document.getElementById('pageSlug').value.trim();
      
      if (!title) {
        alert('El t√≠tulo es requerido');
        return;
      }
      
      if (!slug) {
        alert('El slug es requerido');
        return;
      }
      
      // Validar formato de slug
      const slugRegex = /^[a-z0-9]+(?:-[a-z0-9]+)*$/;
      if (!slugRegex.test(slug)) {
        alert('El slug solo puede contener letras min√∫sculas, n√∫meros y guiones. No puede empezar ni terminar con gui√≥n.');
        return;
      }
      
      const content = (typeof tinymce !== 'undefined' && tinymce.get('pageContent')) 
        ? tinymce.get('pageContent').getContent() 
        : document.getElementById('pageContent').value;

      const pageData = {
        title: title,
        slug: slug,
        content: content,
        excerpt: document.getElementById('pageExcerpt').value.trim() || null,
        metaTitle: document.getElementById('pageMetaTitle').value.trim() || null,
        metaDescription: document.getElementById('pageMetaDescription').value.trim() || null,
        metaKeywords: document.getElementById('pageMetaKeywords').value.trim() || null,
        template: document.getElementById('pageTemplate').value || 'default',
        displayOrder: parseInt(document.getElementById('pageDisplayOrder').value) || 0,
        isPublished: document.getElementById('pageIsPublished').checked
      };

      try {
        const submitButton = event.target.querySelector('button[type="submit"]');
        if (submitButton) {
          submitButton.disabled = true;
          submitButton.textContent = 'Guardando...';
        }
        
        if (currentPageId) {
          await api.request(`/api/admin/pages/${currentPageId}`, {
            method: 'PUT',
            body: JSON.stringify(pageData)
          });
        } else {
          await api.request('/api/admin/pages', {
            method: 'POST',
            body: JSON.stringify(pageData)
          });
        }
        
        closePageModal();
        loadPages();
        alert('P√°gina guardada exitosamente');
      } catch (error) {
        console.error('Error saving page:', error);
        const errorMessage = error.message || 'Error desconocido';
        if (errorMessage.includes('slug')) {
          alert('Error: Ya existe una p√°gina con este slug. Por favor, usa un slug diferente.');
        } else {
          alert('Error al guardar la p√°gina: ' + errorMessage);
        }
      } finally {
        const submitButton = event.target.querySelector('button[type="submit"]');
        if (submitButton) {
          submitButton.disabled = false;
          submitButton.textContent = 'Guardar P√°gina';
        }
      }
    }

    async function deletePage(id) {
      if (!confirm('¬øEst√°s seguro de eliminar esta p√°gina?')) return;
      try {
        await api.request(`/api/admin/pages/${id}`, { method: 'DELETE' });
        loadPages();
        alert('P√°gina eliminada');
      } catch (error) {
        console.error('Error deleting page:', error);
        alert('Error al eliminar p√°gina');
      }
    }

    // Auto-generar slug desde t√≠tulo
    const pageTitleInput = document.getElementById('pageTitle');
    if (pageTitleInput) {
      pageTitleInput.addEventListener('input', function() {
        if (!currentPageId) {
          const slugInput = document.getElementById('pageSlug');
          if (slugInput && slugInput.value === '') {
            // Generar slug v√°lido: min√∫sculas, sin acentos, solo letras/n√∫meros/guiones
            const slug = this.value
              .toLowerCase()
              .normalize('NFD')
              .replace(/[\u0300-\u036f]/g, '') // Eliminar acentos
              .replace(/[^a-z0-9\s-]/g, '') // Solo letras, n√∫meros, espacios y guiones
              .trim()
              .replace(/\s+/g, '-') // Espacios a guiones
              .replace(/-+/g, '-') // M√∫ltiples guiones a uno
              .replace(/(^-|-$)/g, ''); // Eliminar guiones al inicio/final
            slugInput.value = slug;
          }
        }
      });
      
      // Validar slug en tiempo real
      const slugInput = document.getElementById('pageSlug');
      if (slugInput) {
        slugInput.addEventListener('input', function() {
          const slug = this.value;
          const slugRegex = /^[a-z0-9]+(?:-[a-z0-9]+)*$/;
          if (slug && !slugRegex.test(slug)) {
            this.style.borderColor = 'var(--error)';
            this.title = 'El slug solo puede contener letras min√∫sculas, n√∫meros y guiones';
          } else {
            this.style.borderColor = '';
            this.title = '';
          }
        });
      }
    }
  </script>
</body>
</html>
