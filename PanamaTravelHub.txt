=====================================================================
PROYECTO: TOURSPANAMA / TOURAPANAMA
STACK: ASP.NET CORE 8 + POSTGRESQL
DOCUMENTO: PROMPTS PROFESIONALES DE DESARROLLO (ENTERPRISE)
=====================================================================


=====================================================================
PROMPT 0 – CONTEXTO GLOBAL (OBLIGATORIO)
=====================================================================

Actúa como un Arquitecto de Software Senior especializado en
ASP.NET Core, PostgreSQL y sistemas transaccionales críticos.

Debes diseñar y construir una plataforma web de administración y
reservas de tours en Panamá.

FUNCIONALIDADES PRINCIPALES:
- Registro y login por correo y contraseña
- Catálogo de tours con imágenes, precios e itinerario
- Reservas en línea con control de disponibilidad
- Pagos en línea (Stripe, PayPal, Yappy)
- Correos automáticos (confirmación y recordatorio)
- Panel administrativo con:
  - CRUD de clientes
  - CRUD de tours
  - Gestión de reservas
  - Reportes básicos de ventas y reservas

REQUISITOS NO FUNCIONALES (OBLIGATORIOS):
- Seguridad nivel OWASP ASVS
- Arquitectura limpia (Clean Architecture)
- API REST desacoplada
- Código mantenible y testeable
- Auditoría completa de acciones críticas
- Observabilidad (logs, métricas, trazabilidad)

Todo debe ser implementable en ASP.NET Core + PostgreSQL.
No entregues teoría: entrega estructuras, código y decisiones técnicas.


=====================================================================
PROMPT 1 – ARQUITECTURA GENERAL (.NET CORE)
=====================================================================

Define una arquitectura completa usando ASP.NET Core:

- ASP.NET Core Web API
- Entity Framework Core + PostgreSQL (Npgsql)
- Autenticación JWT
- Background Services (Hosted Services)
- Redis opcional para cache/cola
- SMTP / proveedor de email
- Stripe / PayPal / Yappy como providers externos

Incluye:
1. Diagrama textual de componentes
2. Flujo completo de una reserva
3. Separación por capas (API, Application, Domain, Infrastructure)
4. Estrategia de escalabilidad horizontal
5. Estrategia de despliegue (Docker + CI/CD)
6. Justificación técnica de cada decisión


=====================================================================
PROMPT 2 – DISEÑO DE BASE DE DATOS (POSTGRESQL)
=====================================================================

Diseña el esquema completo en PostgreSQL para el sistema.

TABLAS:
- users
- roles
- user_roles
- tours
- tour_images
- tour_dates
- bookings
- booking_participants
- payments
- email_notifications
- audit_logs

REQUISITOS:
- UUID como PK
- Constraints, checks y foreign keys
- Índices para performance
- Estados controlados con enums
- Control de concurrencia para cupos
- Auditoría con before/after en JSONB

Entrega:
- Scripts SQL (up/down)
- Explicación de índices y locks
- Estrategia anti-sobreventa


=====================================================================
PROMPT 3 – ESTRUCTURA DEL BACKEND (CLEAN ARCHITECTURE)
=====================================================================

Crea la estructura del proyecto ASP.NET Core usando Clean Architecture.

CAPAS:
- Domain
  - Entities
  - Enums
  - ValueObjects
- Application
  - Interfaces
  - UseCases
  - DTOs
  - Validators (FluentValidation)
- Infrastructure
  - DbContext (EF Core)
  - Repositories
  - Email
  - Payments
  - Audit
- API
  - Controllers
  - Middlewares
  - Filters
  - Auth
  - Swagger

Incluye:
- Manejo global de errores
- Logging estructurado (Serilog)
- Correlation-Id middleware
- Configuración por appsettings + ENV


=====================================================================
PROMPT 4 – AUTENTICACIÓN Y AUTORIZACIÓN
=====================================================================

Implementa autenticación segura en ASP.NET Core:

- Registro y login por email/password
- Hash Argon2id o BCrypt
- JWT Access + Refresh Tokens
- Roles: ADMIN y CUSTOMER
- Rate limiting en login
- Bloqueo por intentos fallidos
- Protección contra user enumeration

ENDPOINTS:
- POST /api/auth/register
- POST /api/auth/login
- POST /api/auth/refresh
- POST /api/auth/logout
- GET /api/auth/me

Incluye:
- Policies por rol
- Claims seguros
- Tests unitarios y de integración


=====================================================================
PROMPT 5 – CATÁLOGO DE TOURS
=====================================================================

Implementa el catálogo de tours.

BACKEND:
- GET /api/tours
- GET /api/tours/{id}
- POST /api/admin/tours
- PUT /api/admin/tours/{id}
- DELETE /api/admin/tours/{id}

FRONTEND:
- Cards responsive
- Galería de imágenes
- Vista detalle

SEGURIDAD:
- Validaciones estrictas
- Sanitización de inputs
- Protección XSS


=====================================================================
PROMPT 6 – MOTOR DE RESERVAS
=====================================================================

Implementa el sistema de reservas.

REGLAS:
- Reserva inicia como PENDING
- Expira si no se paga
- Se confirma solo tras pago exitoso
- Cupo se bloquea transaccionalmente
- Cupo se libera si expira o se cancela

ENDPOINTS:
- POST /api/bookings
- GET /api/bookings/my
- GET /api/admin/bookings
- PATCH /api/admin/bookings/{id}/status

Usa transacciones EF Core y control de concurrencia.
Incluye pruebas de concurrencia.


=====================================================================
PROMPT 7 – PAGOS (STRIPE, PAYPAL, YAPPY)
=====================================================================

Implementa pagos con arquitectura extensible:

- IPaymentProvider interface
- StripePaymentProvider
- PayPalPaymentProvider
- YappyPaymentProvider (stub MVP)

REQUISITOS:
- Webhooks verificados
- Idempotencia
- Estados claros del pago
- Asociación fuerte pago-reserva

ESTADOS:
- Initiated
- Authorized
- Captured
- Failed
- Refunded


=====================================================================
PROMPT 8 – CORREOS AUTOMÁTICOS
=====================================================================

Implementa sistema de correos:

- Confirmación de reserva
- Recordatorio 24h antes

REQUISITOS:
- BackgroundService / HostedService
- Plantillas HTML
- Tabla email_notifications
- Manejo de reintentos
- Auditoría de envíos


=====================================================================
PROMPT 9 – PANEL ADMINISTRATIVO
=====================================================================

Implementa panel admin:

- CRUD clientes
- CRUD tours
- Gestión de reservas
- Cambio de estados
- Reportes básicos

REQUISITOS:
- Solo rol ADMIN
- Auditoría obligatoria
- UI profesional
- Paginación y filtros


=====================================================================
PROMPT 10 – REPORTES
=====================================================================

Implementa reportes con EF Core optimizado:

- Total reservas
- Reservas confirmadas/canceladas
- Ingresos
- Ticket promedio
- Top tours

ENDPOINTS:
- /api/admin/reports/summary
- /api/admin/reports/tours
- /api/admin/reports/timeseries

Incluye índices y consultas optimizadas.


=====================================================================
PROMPT 11 – SEGURIDAD (OWASP)
=====================================================================

Aplica seguridad completa:

- Headers HTTP seguros
- CSRF protection
- Rate limiting
- CORS restrictivo
- Secrets en ENV
- Backups automáticos
- Encriptación TLS

Entrega checklist OWASP + configuración real.


=====================================================================
PROMPT 12 – AUDITORÍA Y OBSERVABILIDAD
=====================================================================

Implementa:

- AuditLogs con JSONB before/after
- Correlation-Id por request
- Logs estructurados
- Métricas básicas

ENDPOINT:
- GET /api/admin/audit-logs


=====================================================================
PROMPT 13 – INFRAESTRUCTURA
=====================================================================

Entrega:

- docker-compose (API + PostgreSQL)
- appsettings por ambiente
- Migraciones automáticas
- CI/CD básico
- Deploy con HTTPS
- Estrategia de backups


=====================================================================
PROMPT 14 – CALIDAD Y MANTENIBILIDAD
=====================================================================

Implementa:

- Tests unitarios
- Tests de integración
- FluentValidation
- OpenAPI / Swagger
- Versionado de API
- Convenciones de código

Define estándares mínimos de calidad.


=====================================================================
FIN DEL DOCUMENTO
=====================================================================
